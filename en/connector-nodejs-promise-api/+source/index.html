<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Connector/Node.js Promise API - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.9a0d7dcebefd.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Connector/Node.js Promise API - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/connector-nodejs-promise-api/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/connector-nodejs-promise-api/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2023 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/connector-nodejs-promise-api/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/server-client-software/">Server &amp; Client Software</a>
    

    
    » <a class="crumb" href="/kb/en/client-libraries/">Client Libraries</a>
    

    
    » <a class="crumb" href="/kb/en/connectors/">Application Programming Interfaces</a>
    

    
    » <a class="crumb" href="/kb/en/nodejs-connector/">Node.js Connector</a>
    


    » <a class="node_link crumb" href="/kb/en/connector-nodejs-promise-api/">Connector/Node.js Promise API</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/connector-nodejs-promise-api/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Connector/Node.js Promise API - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/connector-nodejs-promise-api/+r/89784/">89784</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-3114">
<a href="/kb/user/id/3114" title="Diego Dupin">Diego Dupin</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2019-10-04 08:20">2019-10-04 08:20</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;toc&gt;&gt;
= Promise API Documentation
The MariaDB Node.js Connector can use different APIs on the back-end: Promise and [[connectornodejs-callback-api|Callback]]. The default API is Promise. Callback is provided for compatibility with the mysql and mysql2 APIs.

Documentation provided on this page uses the Promise API.  If you would like to develop an application with the Callback API or have an existing application that you want to switch from the MySQL APIs to the MariaDB Connector, see the [[connector-nodejs-callback-api|Callback API]] documentation.


= Installation

Install the mariadb Connector using npm

&lt;&lt;code&gt;&gt;
$ npm install mariadb
&lt;&lt;/code&gt;&gt;

To use the Connector, you need to import the package into your application code. 

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
&lt;&lt;/code&gt;&gt;

You can then uses the Connector in your application code with the Promise API.  For instance,

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
  const mariadb = require(&#39;mariadb&#39;);

  mariadb.createConnection({host: &#39;mydb.com&#39;, user: &#39;myUser&#39;, password: &#39;myPwd&#39;})
    .then(conn =&gt; {
      conn.query(&#34;select 1&#34;, [2])
        .then(rows =&gt; {
          console.log(rows); // [{ &#34;1&#34;: 1 }]
          conn.end();
        })
        .catch(err =&gt; { 
          //handle query error
        });
    })
    .catch(err =&gt; {
      //handle connection error
    });
&lt;&lt;/code&gt;&gt;

== Timezone consideration

It&#39;s not recommended, but in some cases, Node.js and database are configured with different timezone. 

By default, `timezone` option is set to &#39;local&#39; value, indicating to use client timezone, so no conversion will be done.

If client and server timezone differ, `timezone` option has to be set to server timezone.
- &#39;auto&#39; value means client will request server timezone when creating a connection, and use server timezone afterwhile. 
- To avoid this additional command on connection, `timezone` can be set to [[https://en.wikipedia.org/wiki/List_of_tz_database_time_zones|IANA time zone]]. 

Connector will then convert date to server timezone, rather than the current Node.js timezone. 

== Security consideration
Connection details such as URL, username, and password are better hidden into environment variables.
using code like : 
&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
  const mariadb = require(&#39;mariadb&#39;);

  mariadb.createConnection({host: process.env.DB_HOST, user: process.env.DB_USER, password: process.env.DB_PWD})
    .then(conn =&gt; {
       ...
     });
&lt;&lt;/code&gt;&gt;
Then for example, run node.js setting those environment variable :
&lt;&lt;code&gt;&gt;
$ DB_HOST=localhost DB_USER=test DB_PASSWORD=secretPasswrd node my-app.js
&lt;&lt;/code&gt;&gt;

Another solution is using `dotenv` package. Dotenv loads environment variables from .env files into the process.env variable in Node.js :
&lt;&lt;code&gt;&gt;
$ npm install dotenv
&lt;&lt;/code&gt;&gt;

then configure dotenv to load all .env files
 
&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
  const mariadb = require(&#39;mariadb&#39;);
  require(&#39;dotenv&#39;).config()
  mariadb.createConnection({host: process.env.DB_HOST, user: process.env.DB_USER, password: process.env.DB_PWD})
    .then(conn =&gt; {
       ...
     });
&lt;&lt;/code&gt;&gt;

with a .env file containing
&lt;&lt;code&gt;&gt;
DB_HOST=localhost
DB_USER=test
DB_PWD=secretPasswrd
&lt;&lt;/code&gt;&gt;
.env files must NOT be pushed into repository,  using .gitignore


= Promise API

**Base:**

* [[#createconnectionoptions-promise|createConnection(options) → Promise]] : Creates a new connection.
* [[#createpooloptions-pool|createPool(options) → Pool]] : Creates a new Pool.
* [[#createpoolclusteroptions-poolcluster|createPoolCluster(options) → PoolCluster]] : Creates a new pool cluster.


**Connection:** 

* [[#connectionquerysql-values-promise|connection.query(sql[, values]) → Promise]]: Executes a query.
* [[#connectionquerystreamsql-values-emitter|`connection.queryStream(sql[, values]) → Emitter`]]: Executes a query, returning an emitter object to stream rows.
* [[#connectionbatchsql-values-promise|connection.batch(sql, values) → Promise]]: fast batch processing.
* [[#connectionbegintransaction-promise|connection.beginTransaction() → Promise]]: Begins a transaction.
* [[#connectioncommit-promise|connection.commit() → Promise]]: Commits the current transaction, if any.
* [[#connectionrollback-promise|connection.rollback() → Promise]]: Rolls back the current transaction, if any.
* [[#connectionchangeuseroptions-promise|connection.changeUser(options) → Promise]]: Changes the current connection user.
* [[#connectionping-promise|connection.ping() → Promise]]: Sends a 1 byte packet to the database to validate the connection.
* [[#connectionreset-promise|connection.reset() → Promise]]: reset current connection state.
* [[#connectionisvalid-boolean|connection.isValid() → boolean]]: Checks that the connection is active without checking socket state.
* [[#connectionend-promise|connection.end() → Promise]]: Gracefully close the connection.
* [[#connectiondestroy|connection.destroy()]]: Forces the connection to close. 
* [[#connectionpause|connection.pause()]]: Pauses the socket output.
* [[#connectionresume|connection.resume()]]: Resumes the socket output.
* [[#connectionserverversion|connection.serverVersion()]]: Retrieves the current server version.
* [[#events|events]]: Subscribes to connection error events.

**Pool:**


* [[#poolgetconnection-promise|pool.getConnection() → Promise]] : Creates a new connection.
* [[#poolquerysql-values-promise|pool.query(sql[, values]) → Promise]]: Executes a query.
* [[#poolbatchsql-values-promise|pool.batch(sql, values) → Promise]]: Executes a batch
* [[#poolend-promise|pool.end() → Promise]]: Gracefully closes the connection.
* pool.activeConnections() → Number`: Gets current active connection number.
* pool.totalConnections() → Number`: Gets current total connection number.
* pool.idleConnections() → Number`: Gets current idle connection number.
* pool.taskQueueSize() → Number`: Gets current stacked request.
* [[#pool-events|pool events]]: Subscribes to pool events.


**PoolCluster**

* [[#poolclusteraddid-config|poolCluster.add(id, config)]] : add a pool to cluster.
* [[#poolclusterremovepattern|poolCluster.remove(pattern)]] : remove and end pool according to pattern.
* [[#poolclusterend-promise|poolCluster.end() → Promise]] : end cluster.
* [[#poolclustergetconnectionpattern-selector-promise|poolCluster.getConnection(pattern, selector) → Promise]] : return a connection from cluster.
* [[#poolclusterofpattern-selector-filteredpoolcluster|poolCluster.of(pattern, selector) → FilteredPoolCluster]] : return a subset of cluster.
* [[#poolcluster-events|poolCluster events]]: Subscribes to pool cluster events.


= Base API
== createConnection(options) → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
* `options`: *JSON/String* [[#connection-options|connection option documentation]]

Returns a promise that :
 * resolves with a [[#connection-api|Connection]] object,
 * raises an [[#error|Error]].
Returns a [[#pool-api|Pool]] object,
&lt;&lt;/style&gt;&gt;

Creates a new [[#connection-api|Connection]] object.

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
mariadb.createConnection({
      host: &#39;mydb.com&#39;, 
      user:&#39;myUser&#39;,
      password: &#39;myPwd&#39;
    })
    .then(conn =&gt; {
      console.log(&#34;connected ! connection id is &#34; + conn.threadId);
    })
    .catch(err =&gt; {
      console.log(&#34;not connected due to error: &#34; + err);
    });
&lt;&lt;/code&gt;&gt;


=== Connection options

Essential options list:
&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**user** | User to access database. |*string* | | 
|=**password** | User password. |*string* | | 
|=**host** | IP address or DNS of the database server. *Not used when using option `socketPath`*. |*string*| &#34;localhost&#34;|
|=**port** | Database server port number. *Not used when using option `socketPath`*|*integer*| 3306|
|=**ssl** | Enables TLS support. For more information, see the [[nodejs-connection-options#ssl|`ssl` option]] documentation. |*mixed*| |
|=**database** | Default database to use when establishing the connection. | *string* | |
|=**socketPath** | Permits connections to the database through the Unix domain socket or named pipe. |  *string* | |
|=**compress** | Compresses the exchange with the database through gzip.  This permits better performance when the database is not in the same location.  |*boolean*| false|
|=**connectTimeout** | Sets the connection timeout in milliseconds. |*integer* | 10 000|
|=**socketTimeout** | Sets the socket timeout in milliseconds after connection succeeds. A value of `0` disables the timeout. |*integer* | 0|
|=**rowsAsArray** | Returns result-sets as arrays, rather than JSON. This is a faster way to get results. For more information, see Query. |*boolean* | false|
&lt;&lt;/style&gt;&gt;
For more information, see the [[nodejs-connection-options|Connection option]] documentation. 

=== Connecting to Local Databases 

When working with a local database (that is, cases where MariaDB and your Node.js application run on the same host), you can connect to MariaDB through the Unix socket or Windows named pipe for better performance, rather than using the TCP/IP layer.

In order to set this up, you need to assign the connection a `socketPath` value.  When this is done, the Connector ignores the `host` and `port` options.

The specific socket path you need to set is defined by the 
[[https://mariadb.com/kb/en/library/server-system-variables/#socket|`socket`]] server system variable.  If you don&#39;t know it off hand, you can retrieve it from the server.

&lt;&lt;code  lang=&#34;sql&#34;&gt;&gt;
SHOW VARIABLES LIKE &#39;socket&#39;;
&lt;&lt;/code&gt;&gt;

It defaults to `/tmp/mysql.sock` on Unix-like operating systems and `MySQL` on Windows.  Additionally, on Windows, this feature only works when the server is started with the `--enable-named-pipe` option.

For instance, on Unix a connection might look like this:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
mariadb.createConnection({ socketPath: &#39;/tmp/mysql.sock&#39;, user: &#39;root&#39; })
    .then(conn =&gt; { ... })
    .catch(err =&gt; { ... });
&lt;&lt;/code&gt;&gt;

It has a similar syntax on Windows: 

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
mariadb.createConnection({ socketPath: &#39;\\\\.\\pipe\\MySQL&#39;, user: &#39;root&#39; })
    .then(conn =&gt; { ... })
    .catch(err =&gt; { ... });
&lt;&lt;/code&gt;&gt;

=== createPool(options) → Pool
&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `options`: *JSON/String* [[#pool-options|pool options]]

 Returns a [[#pool-api|Pool]] object,
&lt;&lt;/style&gt;&gt;

Creates a new pool.

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
pool.getConnection()
    .then(conn =&gt; {
      console.log(&#34;connected ! connection id is &#34; + conn.threadId);
      conn.release(); //release to pool
    })
    .catch(err =&gt; {
      console.log(&#34;not connected due to error: &#34; + err);
    });
&lt;&lt;/code&gt;&gt;

==== Pool options

Pool options includes [[nodejs-connection-options|Connection option]] that will be used when creating new connections. 

Specific options for pools are :

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**acquireTimeout** | Timeout to get a new connection from pool in ms. |*integer* | 10000 |
|=**connectionLimit** | Maximum number of connection in pool. |*integer* | 10 |
|=**idleTimeout** | Indicate idle time after which a pool connection is released. Value must be lower than [[https://mariadb.com/kb/en/library/server-system-variables/#wait_timeout|@@wait_timeout]]. In seconds (0 means never release) |*integer* | 1800 |
|=**minimumIdle** | Permit to set a minimum number of connection in pool. **Recommendation is to use fixed pool, so not setting this value**.|*integer* | *set to connectionLimit value* |
|=**minDelayValidation** | When asking a connection to pool, the pool will validate the connection state. &#34;minDelayValidation&#34; permits disabling this validation if the connection has been borrowed recently avoiding useless verifications in case of frequent reuse of connections. 0 means validation is done each time the connection is asked. (in ms) |*integer*| 500|
|=**noControlAfterUse** | After giving back connection to pool (connection.end) connector will reset or rollback connection to ensure a valid state. This option permit to disable those controls|*boolean*| false|
&lt;&lt;/style&gt;&gt;

=== createPoolCluster(options) → PoolCluster

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `options`: *JSON* [[#poolCluster-options|poolCluster options]]

 Returns a [[#poolCluster-api|PoolCluster]] object,
&lt;&lt;/style&gt;&gt;

Creates a new pool cluster. Cluster handle multiple pools, giving high availability / distributing load (using round robin / random / ordered ).

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);

const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });

//getting a connection from slave1 or slave2 using round-robin
cluster.getConnection(/^slave*$, &#34;RR&#34;)
  .then(conn =&gt; {
    return conn.query(&#34;SELECT 1&#34;)
       .then(row =&gt; {
           conn.end();
           return row[0][&#34;@node&#34;];
       })
       .finally(() =&gt; {
           conn.end();
       });
  });
&lt;&lt;/code&gt;&gt;

 
==== PoolCluster options

Pool cluster options includes [[#pool-options|pool option documentation]] that will be used when creating new pools. 

Specific options for pool cluster are :

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**canRetry** | When getting a connection from pool fails, can cluster retry with other pools |*boolean* | true |
|=**removeNodeErrorCount** | Maximum number of consecutive connection fail from a pool before pool is removed from cluster configuration. null means node won&#39;t be removed|*integer* | 5 |
|=**restoreNodeTimeout** | delay before a pool can be reused after a connection fails. 0 = can be reused immediately (in ms) |*integer*| 0|
|=**defaultSelector** | default pools selector. Can be &#39;RR&#39; (round-robin), &#39;RANDOM&#39; or &#39;ORDER&#39; (use in sequence = always use first pools unless fails) |*string*| &#39;RR&#39;|
&lt;&lt;/style&gt;&gt;


= Connection API

== connection.query(sql[, values]) -&gt; Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* SQL string or JSON object to supersede default connection options.  When using JSON object, object must have a &#34;sql&#34; key. For instance, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * `values`: *array | object* Placeholder values. Usually an array, but in cases of only one placeholder, it can be given as is. 

 Returns a promise that :
 * resolves with a JSON object for update/insert/delete or a [[#result-set-array|result-set]] object for result-set.
 * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Sends a query to database and return result as a Promise.

For instance, when using an SQL string:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection
  .query(&#34;SELECT NOW()&#34;)
  .then(rows =&gt; {
	console.log(rows); //[ { &#39;NOW()&#39;: 2018-07-02T17:06:38.000Z }, meta: [ ... ] ]
  })
  .catch(err =&gt; {
	//handle error
  });
&lt;&lt;/code&gt;&gt;

Alternatively, you could use the JSON object:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection
   .query({dateStrings:true, sql:&#39;SELECT NOW()&#39;})
   .then(rows =&gt; {
	  console.log(rows); //[ { &#39;NOW()&#39;: &#39;2018-07-02 19:06:38&#39; }, meta: [ ... ] ]
	})
	.catch(...)
&lt;&lt;/code&gt;&gt;

=== Placeholder

To prevent SQL Injection attacks, queries permit the use of question marks as placeholders.  The Connection escapes values according to their type.  Values can be of native JavaScript types, Buffers, Readables, objects with `toSQLString` methods, or objects that can be stringified (that is, `JSON.stringfy`).

When streaming, objects that implement Readable are streamed automatically.  But, there are two server system variables that may interfere:

- [[https://mariadb.com/kb/en/library/server-system-variables/#net_read_timeout|`net_read_timeout`]]: The server must receive queries before reaching this timeout, which defaults to 30 seconds.
- [[https://mariadb.com/kb/en/library/server-system-variables/#max_allowed_packet|`max_allowed_packet`]]: This system variable defines the maximum amount of data the Connector can send to the server.

For instance,

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection
  .query(
	 &#34;INSERT INTO someTable VALUES (?, ?, ?)&#34;, 
	 [1,Buffer.from(&#34;c327a97374&#34;, &#34;hex&#34;),&#34;mariadb&#34;]
  )
  .then(...)
  .catch(...);
  //will send INSERT INTO someTable VALUES (1, _BINARY &#39;.\&#39;.st&#39;, &#39;mariadb&#39;)
&lt;&lt;/code&gt;&gt;


In the case of streaming, 

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const https = require(&#34;https&#34;);
//3Mb page
https.get(&#34;https://node.green/#ES2018-features-Promise-prototype-finally-basic-support&#34;,
  readableStream =&gt; {
    connection.query(&#34;INSERT INTO StreamingContent (b) VALUE (?)&#34;, [readableStream]);
      .then(res =&gt; {
        //inserted
      })
      .catch(console.log);
  }
)
&lt;&lt;/code&gt;&gt;

=== JSON Result-sets 

Queries return two different kinds of results, depending on the type of query you execute.  When you execute write statements, (such as `INSERT`, `DELETE` and `UPDATE`), the method returns a JSON object with the following properties:

* `affectedRows`: An integer listing the number of affected rows.
* `insertId`: An integer noting the auto-increment ID of the last row written to the table.
* `warningStatus`: An integer indicating whether the query ended with a warning.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection.query(&#39;CREATE TABLE animals (&#39; +
                       &#39;id MEDIUMINT NOT NULL AUTO_INCREMENT,&#39; +
                       &#39;name VARCHAR(30) NOT NULL,&#39; +
                       &#39;PRIMARY KEY (id))&#39;);
connection.query(&#39;INSERT INTO animals(name) value (?)&#39;, [&#39;sea lions&#39;])
    .then(res =&gt; {
      console.log(res); 
      //log : { affectedRows: 1, insertId: 1, warningStatus: 0 }
    })
    .catch(...);
&lt;&lt;/code&gt;&gt;

=== Array Result-sets 

When the query executes a `SELECT` statement, the method returns the result-set as an array.  Each value in the array is a returned row as a JSON object.  Additionally, the method returns a special `meta` array that contains the [[#column-metadata|column metadata]] information. 

The rows default to JSON objects, but two other formats are also possible with the `nestTables` and `rowsAsArray` options.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection.query(&#39;select * from animals&#39;)
    .then(res =&gt; {
      console.log(res); 
      // [ 
      //    { id: 1, name: &#39;sea lions&#39; }, 
      //    { id: 2, name: &#39;bird&#39; }, 
      //    meta: [ ... ]
      // ]
    });
&lt;&lt;/code&gt;&gt;

=== Query options

* [[#namedPlaceholders|`namedPlaceholders`]]
* [[#typeCast|`typeCast`]]
* [[#rowsAsArray|`rowsAsArray`]]
* [[#nestTables|`nestTables`]]
* [[#dateStrings|`dateStrings`]]
* [[#supportBigNumbers|`supportBigNumbers`]]
* [[##bigNumberStrings|`bigNumberStrings`]]²

Those options can be set on the query level, but are usually set at the connection level, and will then apply to all queries. 

==== namedPlaceholders

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*boolean, default false*
&lt;&lt;/style&gt;&gt;

While the recommended method is to use the question mark [[#placeholder|placeholder]], you can alternatively allow named placeholders by setting this query option.  Values given in the query must contain keys corresponding  to the placeholder names. 

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection
  .query(
	{ namedPlaceholders: true, sql: &#34;INSERT INTO someTable VALUES (:id, :img, :db)&#34; },
	{ id: 1, img: Buffer.from(&#34;c327a97374&#34;, &#34;hex&#34;), db: &#34;mariadb&#34; }
  )
  .then(...)
  .catch(...);
&lt;&lt;/code&gt;&gt;

==== rowsAsArray

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*boolean, default false*
&lt;&lt;/style&gt;&gt;

Using this option causes the Connector to format rows in the result-set  as arrays, rather than JSON objects.  Doing so allows you to save memory and avoid having the Connector parse [[#column-metadata|column metadata]] completely.  It is the fastest row format, (by 5-10%), with a local database.

Default format : `{ id: 1, name: &#39;sea lions&#39; }`
with option `rowsAsArray` : `[ 1, &#39;sea lions&#39; ]`

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection.query({ rowsAsArray: true, sql: &#39;select * from animals&#39; })
    .then(res =&gt; {
      console.log(res); 
      // [ 
      //    [ 1, &#39;sea lions&#39; ], 
      //    [ 2, &#39;bird&#39; ],
      //    meta: [...]
      // ]
    });
&lt;&lt;/code&gt;&gt;

==== nestTables

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*boolean / string, default false*
&lt;&lt;/style&gt;&gt;

Occasionally, you may have issue with queries that return columns with the **same** name.  The standard JSON format does not permit key duplication.  To get around this, you can set the `nestTables` option to `true`.  This causes the Connector to group data by table.  When using string parameters, it prefixes the JSON field name with the table name and the `nestTables` value.

For instance, when using a boolean value:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection.query({nestTables:true, 
                sql:&#39;select a.name, a.id, b.name from animals a, animals b where b.id=1&#39;})
    .then(res =&gt; {
      console.log(res); 
      //[ 
      //  { 
      //     a: { name: &#39;sea lions&#39;, id: 1 }, 
      //     b: { name: &#39;sea lions&#39; } 
      //  },
      //  { 
      //     a: { name: &#39;bird&#39;, id: 2 }, 
      //     b: { name: &#39;sea lions&#39; } 
      //  },
      //  meta: [...]
      //]
    });
&lt;&lt;/code&gt;&gt;

Alternatively, using a string value:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection.query({nestTables: &#39;_&#39;, 
                sql:&#39;select a.name, a.id, b.name from animals a, animals b where b.id=1&#39;})
    .then(res =&gt; {
      console.log(res); 
      //[ 
      //  { a_name: &#39;sea lions&#39;, a_id: 1, b_name: &#39;sea lions&#39; }, 
      //  { a_name: &#39;bird&#39;, a_id: 2, b_name: &#39;sea lions&#39; },
      //  meta: [...]
      //]
    });
&lt;&lt;/code&gt;&gt;

==== dateStrings

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*boolean, default: false*
&lt;&lt;/style&gt;&gt;

Whether you want the Connector to retrieve date values as strings, rather than `Date` objects.


==== supportBigNumbers

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*boolean, default: false*
&lt;&lt;/style&gt;&gt;

Whether the query should return integers as [[https://www.npmjs.com/package/long|`Long`]] objects when they are not in the [[nodejs-connection-options/#support-for-big-integer|safe]] range.


==== bigNumberStrings

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*boolean, default: false*
&lt;&lt;/style&gt;&gt;

Whether the query should return integers as strings when they are not in the [[nodejs-connection-options/#support-for-big-integer|safe]] range.


==== typeCast

*Experimental*

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt;
*function(column, next)*
&lt;&lt;/style&gt;&gt;

In the event that you need certain values returned as a different type, you can use this function to cast the value into that type yourself.

For instance, casting all `TINYINT(1)` values as boolean values:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const tinyToBoolean = (column, next) =&gt; {
  if (column.type == &#34;TINY&#34; &amp;&amp; column.length === 1) {
    const val = column.int();
    return val === null ? null : val === 1;
  }
  return next();
};
connection.query({typeCast: tinyToBoolean, sql:&#34;...&#34;});
&lt;&lt;/code&gt;&gt;

=== Column Metadata

* `collation`: Object indicates the column collation.  It has the properties: `index`, `name`, `encoding`, and `maxlen`.  For instance, `33, &#34;UTF8_GENERAL_CI&#34;, &#34;utf8&#34;, 3`
* `columnLength`: Shows the column&#39;s maximum length if there&#39;s a limit and `0` if there is no limit, (such as with a `BLOB` column).
* `type`: 
Shows the column type as an integer value.  For more information on the relevant values, see	[[https://github.com/MariaDB/mariadb-connector-nodejs/blob/master/lib/const/field-type.js|`field-type.js`]]
* `columnType`: Shows the column type as a string value.  For more information on the relevant values, see	[[https://github.com/MariaDB/mariadb-connector-nodejs/blob/master/lib/const/field-type.js|`field-type.js`]]
* `scale`: Provides the decimal part length.
* `flags`: Shows the byte-encoded flags.  For more information, see [[https://github.com/MariaDB/mariadb-connector-nodejs/blob/master/lib/const/field-detail.js|`field-detail.js`]].
* `db()`: Name of the database schema.    You can also retrieve this using `schema()`.
* `table()`: Table alias.
* `orgTable()`: Real table name.
* `name()`: Column alias. 
* `orgName()`: Real column name.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection
  .query(&#34;SELECT 1, &#39;a&#39;&#34;)
  .then(rows =&gt; {
	console.log(rows);
	// [ 
	//   { &#39;1&#39;: 1, a: &#39;a&#39; },
	//   meta: [ 
	//     { 
	//       collation: [Object],
	//       columnLength: 1,
	//       columnType: 8,
	//       scale: 0,
	//       type: &#39;LONGLONG&#39;,
	//       flags: 129,
	//       db: [Function],
	//       schema: [Function],
	//       table: [Function],
	//       orgTable: [Function],
	//       name: [Function],
	//       orgName: [Function] 
	//     },
	//     { 
	//       collation: [Object],
	//       columnLength: 4,
	//       columnType: 253,
	//       scale: 39,
	//       type: &#39;VAR_STRING&#39;,
	//       flags: 1,
	//       db: [Function],
	//       schema: [Function],
	//       table: [Function],
	//       orgTable: [Function],
	//       name: [Function],
	//       orgName: [Function] 
	//     } 
	//   ] 
	// ]
	assert.equal(rows.length, 1);
  })
&lt;&lt;/code&gt;&gt;


== connection.queryStream(sql[, values]) → Emitter

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* SQL string value or JSON object to supersede default connections options.  JSON objects must have an `&#34;sql&#34;` property.  For instance, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * `values`: *array | object* Defines placeholder values. This is usually an array, but in cases of only one placeholder, it can be given as a string. 

 Returns an Emitter object that emits different types of events:
 * error : Emits an [[#error|`Error`]] object when the query fails. (No `&#34;end&#34;` event will then be emitted).
 * columns : Emits when column metadata from the result-set are received (the parameter is an array of [[#metadata-field|Metadata]] fields).
 * data : Emits each time a row is received (parameter is a row). 
 * end : Emits when the query ends (no parameter). 
&lt;&lt;/style&gt;&gt;

When using the `query()` method, documented above, the Connector returns the entire result-set with all its data in a single call.  While this is fine for queries that return small result-sets, it can grow unmanageable in cases of huge result-sets.  Instead of retrieving all of the data into memory, you can use the `queryStream()` method, which uses the event drive architecture to process rows one by one, which allows you to avoid putting too much strain on memory.

Query times and result handlers take the same amount of time, but you may want to consider updating the [[https://mariadb.com/kb/en/library/server-system-variables/#net_read_timeout|`net_read_timeout`]] server system variable.  The query must be totally received before this timeout, which defaults to 30 seconds.


There is 2 differents methods to implement streaming:

* Events

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
connection.queryStream(&#34;SELECT * FROM mysql.user&#34;)
      .on(&#34;error&#34;, err =&gt; {
        console.log(err); //if error
      })
      .on(&#34;fields&#34;, meta =&gt; {
        console.log(meta); // [ ...]
      })
      .on(&#34;data&#34;, row =&gt; {
        console.log(row);
      })
      .on(&#34;end&#34;, () =&gt; {
        //ended
      });
&lt;&lt;/code&gt;&gt;

* streams

Note that queryStream produced Object data, so Transform/Writable implementation must be created with [[https://nodejs.org/api/stream.html#stream_object_mode|`objectMode`]] set to true.&lt;br/&gt;  
(example use [[https://nodejs.org/api/stream.html#stream_stream_pipeline_streams_callback|`stream.pipeline`]] only available since Node.js 10)

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const stream = require(&#34;stream&#34;);
const fs = require(&#34;fs&#34;);

//...create connection...

const someWriterStream = fs.createWriteStream(&#34;./someFile.txt&#34;);

const transformStream = new stream.Transform({
  objectMode: true,
  transform: function transformer(chunk, encoding, callback) {
    callback(null, JSON.stringify(chunk));
  }
});

const queryStream = connection.queryStream(&#34;SELECT * FROM mysql.user&#34;);

stream.pipeline(queryStream, transformStream, someWriterStream);

&lt;&lt;/code&gt;&gt;


== connection.batch(sql, values) → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* SQL string value or JSON object to supersede default connections options.  JSON objects must have an `&#34;sql&#34;` property.  For instance, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * `values`: *array* Array of parameter (array of array or array of object if using named placeholders). 

 Returns a promise that :
 * resolves with a JSON object.
 * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Implementation depend of server type and version. 
for MariaDB server version 10.2.7+, implementation use dedicated bulk protocol. 

For other, insert queries will be rewritten for optimization.
example:
insert into ab (i) values (?) with first batch values = 1, second = 2 will be rewritten
insert into ab (i) values (1), (2). 

If query cannot be re-writen will execute a query for each values.

result difference compared to execute multiple single query insert is that only first generated insert id will be returned. 

For instance,

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
  connection.query(
    &#34;CREATE TEMPORARY TABLE batchExample(id int, id2 int, id3 int, t varchar(128), id4 int)&#34;
  );
  connection
    .batch(&#34;INSERT INTO `batchExample` values (1, ?, 2, ?, 3)&#34;, [[1, &#34;john&#34;], [2, &#34;jack&#34;]])
    .then(res =&gt; {
      console.log(res.affectedRows); // 2
    });

&lt;&lt;/code&gt;&gt;

== connection.beginTransaction() → Promise

&gt;Returns a promise that :
&gt;  * resolves (no argument)
&gt;  * rejects with an [[#error|Error]].

Begins a new transaction.

== connection.commit() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
&gt;Returns a promise that :
  * resolves (no argument)
  * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Commits the current transaction, if there is one active.  The Connector tracks the current transaction state on the server.  In the event that you issue the `commit()` method when there&#39;s no active transaction, it ignores the method and sends no commands to MariaDB. 


== connection.rollback() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
Returns a promise that :
  * resolves (no argument)
  * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Rolls back the current transaction, if there is one active.  The Connector tracks the current transaction state on the server.  In the event that you issue the `rollback()` method when there&#39;s no active transaction, it ignores the method and sends no commands to MariaDB. 

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
conn.beginTransaction()
  .then(() =&gt; {
    conn.query(&#34;INSERT INTO testTransaction values (&#39;test&#39;)&#34;);
    return conn.query(&#34;INSERT INTO testTransaction values (&#39;test2&#39;)&#34;);
  })
  .then(() =&gt; {
    conn.commit();
  })
  .catch((err) =&gt; {
    conn.rollback();
  })
&lt;&lt;/code&gt;&gt;
 
== connection.changeUser(options) → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `options`: *JSON*, subset of [[nodejs-connection-options|connection option documentation]] = database / charset / password / user

 Returns a promise that :
   * resolves without result
   * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Resets the connection and re-authorizes it using the given credentials.  It is the equivalent of creating a new connection with a new user, reusing the open socket.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
conn.changeUser({user: &#39;changeUser&#39;, password: &#39;mypassword&#39;})
   .then(() =&gt; {
      //connection user is now changed. 
   })
   .catch(err =&gt; {
      //error
   });
&lt;&lt;/code&gt;&gt;

== connection.ping() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
Returns a promise that :
  * resolves (no argument)
  * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Sends a packet to the database containing one byte to check that the connection is still active.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
conn.ping()
  .then(() =&gt; {
    //connection is valid
  })
  .catch(err =&gt; {
    //connection is closed
  })
&lt;&lt;/code&gt;&gt;

== connection.reset() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
Returns a promise that :
  * resolves (no argument)
  * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;
reset the connection. Reset will:

   * rollback any open transaction
   * reset transaction isolation level
   * reset session variables
   * delete user variables
   * remove temporary tables
   * remove all PREPARE statement
   

== connection.isValid() → boolean

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 Returns a boolean
&lt;&lt;/style&gt;&gt;

Indicates the connection state as the Connector knows it.  If it returns false, there is an issue with the connection, such as the socket disconnected without the Connector knowing about it.

== connection.end() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
Returns a promise that :
  * resolves (no argument)
  * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Closes the connection gracefully, after waiting for any currently executing queries to finish.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
conn.end()
  .then(() =&gt; {
    //connection has ended properly
  })
  .catch(err =&gt; {
    //connection was closed but not due of current end command
  })
&lt;&lt;/code&gt;&gt;


== connection.destroy()

Closes the connection without waiting for any currently executing queries.  These queries are interrupted.  MariaDB logs the event as an unexpected socket close.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
conn.query(
  &#34;select * from information_schema.columns as c1, &#34; +
   &#34;information_schema.tables, information_schema.tables as t2&#34;
)
.then(rows =&gt; {
  //won&#39;t occur
})
.catch(err =&gt; {
  console.log(err);
  //Error: Connection destroyed, command was killed
  //    ...
  //  fatal: true,
  //  errno: 45004,
  //  sqlState: &#39;08S01&#39;,
  //  code: &#39;ER_CMD_NOT_EXECUTED_DESTROYED&#39; 
  done();
});
conn.destroy(); //will immediately close the connection, even if query above would have take a minute
&lt;&lt;/code&gt;&gt;

== connection.pause()

Pauses data reads.

== connection.resume()

Resumes data reads from a pause. 


== connection.serverVersion()

&gt; Returns a string 

Retrieves the version of the currently connected server.  Throws an error when not connected to a server.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
  console.log(connection.serverVersion()); //10.2.14-MariaDB
&lt;&lt;/code&gt;&gt;

== Error

When the Connector encounters an error, Promise returns an [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error|`Error`]] object.  In addition to the standard properties, this object has the following properties:
* `fatal`: A boolean value indicating whether the connection remains valid.
* `errno`: The error number. 
* `sqlState`: The SQL state code.
* `code`: The error code.

Example on `console.log(error)`: 
&lt;&lt;code&gt;&gt;
{ Error: (conn=116, no: 1146, SQLState: 42S02) Table &#39;testn.falsetable&#39; doesn&#39;t exist
  sql: INSERT INTO falseTable(t1, t2, t3, t4, t5) values (?, ?, ?, ?, ?)  - parameters:[1,0x01ff,&#39;hh&#39;,&#39;01/01/2001 00:00:00.000&#39;,null]
      ...
      at Socket.Readable.push (_stream_readable.js:134:10)
      at TCP.onread (net.js:559:20)
    From event:
      at C:\mariadb-connector-nodejs\lib\connection.js:185:29
      at Connection.query (C:\mariadb-connector-nodejs\lib\connection.js:183:12)
      at Context.&lt;anonymous&gt; (C:\mariadb-connector-nodejs\test\integration\test-error.js:250:8)
    fatal: false,
    errno: 1146,
    sqlState: &#39;42S02&#39;,
    code: &#39;ER_NO_SUCH_TABLE&#39; } }
&lt;&lt;/code&gt;&gt;

Errors contain an error stack, query and parameter values (the length of which is limited to 1,024 characters, by default).  To retrieve the initial stack trace (shown as `From event...` in the example above), you must have the Connection option `trace` enabled.

For more information on error numbers and SQL state signification, see the [[mariadb-error-codes|MariaDB Error Code]] documentation.


== events

Connection object that inherits from the Node.js [[https://nodejs.org/api/events.html|`EventEmitter`]].  Emits an error event when the connection closes unexpectedly.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
mariadb.createConnection({user: &#39;root&#39;, password: &#39;myPwd&#39;, host: &#39;localhost&#39;, socketTimeout: 100})
.then(conn =&gt; {
conn.on(&#39;error&#39;, err =&gt; {
  //will be executed after 100ms due to inactivity, socket has closed. 
  console.log(err);
  //log : 
  //{ Error: (conn=6283, no: 45026, SQLState: 08S01) socket timeout
  //    ...
  //    at Socket.emit (events.js:208:7)
  //    at Socket._onTimeout (net.js:410:8)
  //    at ontimeout (timers.js:498:11)
  //    at tryOnTimeout (timers.js:323:5)
  //    at Timer.listOnTimeout (timers.js:290:5)
  //  fatal: true,
  //  errno: 45026,
  //  sqlState: &#39;08S01&#39;,
  //  code: &#39;ER_SOCKET_TIMEOUT&#39; }
});
})
.catch(done);
&lt;&lt;/code&gt;&gt;


= Pool API

Each time a connection is asked, if the pool contains a connection that is not used, the pool will validate the connection, 
exchanging an empty MySQL packet with the server to ensure the connection state, then give the connection. 
The pool reuses connection intensively, so this validation is done only if a connection has not been used for a period 
(specified by the &#34;minDelayValidation&#34; option with the default value of 500ms).

If no connection is available, the request for a connection will be put in a queue until connection timeout. 
When a connection is available (new creation or released to the pool), it will be used to satisfy queued requests in FIFO order.

When a connection is given back to the pool, any remaining transactions will be rolled back.

== pool.getConnection() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;&gt; Returns a promise that :
 * resolves with a [[#connection-api|Connection]] object,
 * raises an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Creates a new [[#connection-api|Connection]] object with an additional release method. 
Calling connection.release() will give back connection to pool.  

Connection must be given back to pool using this connection.release() method.

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user:&#39;myUser&#39; });
pool.getConnection()
    .then(conn =&gt; {
      console.log(&#34;connected ! connection id is &#34; + conn.threadId);
      conn.release(); //release to pool
    })
    .catch(err =&gt; {
      console.log(&#34;not connected due to error: &#34; + err);
    });
&lt;&lt;/code&gt;&gt;

== pool.query(sql[, values]) -&gt; Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* SQL string or JSON object to supersede default connection options.  When using JSON object, object must have an &#34;sql&#34; key. For instance, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * `values`: *array | object* Placeholder values. Usually an array, but in cases of only one placeholder, it can be given as is. 

 Returns a promise that :
 * resolves with a JSON object for update/insert/delete or a [[#result-set-array|result-set]] object for result-set.
 * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

This is a shortcut to get a connection from pool, execute a query and release connection.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user:&#39;myUser&#39; });
pool
   .query(&#34;SELECT NOW()&#34;)
   .then(rows =&gt; {
    console.log(rows); //[ { &#39;NOW()&#39;: 2018-07-02T17:06:38.000Z }, meta: [ ... ] ]
   })
   .catch(err =&gt; {
    //handle error
   });
&lt;&lt;/code&gt;&gt;

== pool.batch(sql, values) -&gt; Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* SQL string or JSON object to supersede default connection options.  When using JSON object, object must have an &#34;sql&#34; key. For instance, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * `values`: *array* array of Placeholder values. Usually an array of array, but in cases of only one placeholder per value, it can be given as a single array. 

 Returns a promise that :
 * resolves with a JSON object.
 * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

This is a shortcut to get a connection from pool, execute a batch and release connection.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user:&#39;myUser&#39; });
pool.query(
  &#34;CREATE TABLE parse(autoId int not null primary key auto_increment, c1 int, c2 int, c3 int, c4 varchar(128), c5 int)&#34;
);
pool
  .batch(&#34;INSERT INTO `parse`(c1,c2,c3,c4,c5) values (1, ?, 2, ?, 3)&#34;, 
    [[1, &#34;john&#34;], [2, &#34;jack&#34;]])
  .then(res =&gt; {
    //res = { affectedRows: 2, insertId: 1, warningStatus: 0 }

    assert.equal(res.affectedRows, 2);
    pool
      .query(&#34;select * from `parse`&#34;)
      .then(res =&gt; {
        /*
        res = [ 
            { autoId: 1, c1: 1, c2: 1, c3: 2, c4: &#39;john&#39;, c5: 3 },
            { autoId: 2, c1: 1, c2: 2, c3: 2, c4: &#39;jack&#39;, c5: 3 },
            meta: ...
          }
        */ 
      })
      .catch(done);
  });
&lt;&lt;/code&gt;&gt;

== pool.end() → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
Returns a promise that :
  * resolves (no argument)
  * rejects with an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Closes the pool and underlying connections gracefully.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
pool.end()
  .then(() =&gt; {
    //connections have been ended properly
  })
  .catch(err =&gt; {});
&lt;&lt;/code&gt;&gt;

== Pool events

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**acquire** | This event emits a connection is acquired from pool.  |
|=**connection** | This event is emitted when a new connection is added to the pool. Has a connection object parameter |
|=**enqueue** | This event is emitted when a command cannot be satisfied immediately by the pool and is queued. |
|=**release** | This event is emitted when a connection is released back into the pool. Has a connection object parameter|
&lt;&lt;/style&gt;&gt;

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
pool.on(&#39;connection&#39;, (conn) =&gt; console.log(`connection ${conn.threadId} has been created in pool`);
&lt;&lt;/code&gt;&gt;

= Pool cluster API

Cluster handle multiple pools according to patterns and handle failover / distributed load (round robin / random / ordered ).

== poolCluster.add(id, config)

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `id`: *string* node identifier. example : &#39;master&#39;
 * `config`: *JSON* [[#pool-options|pool options]] to create pool. 
&lt;&lt;/style&gt;&gt;

Add a new Pool to cluster.

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
&lt;&lt;/code&gt;&gt;

== poolCluster.remove(pattern)

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `pattern`: *string* regex pattern to select pools. Example, `&#34;slave*&#34;`
&lt;&lt;/style&gt;&gt;

remove and end pool(s) configured in cluster.


== poolCluster.end() → Promise

&gt; Returns a promise that :
&gt;  * resolves (no argument)
&gt;  * rejects with an [[#error|Error]].

Closes the pool cluster and underlying pools.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
poolCluster.end()
  .then(() =&gt; {
    //pools have been ended properly
  })
  .catch(err =&gt; {});
&lt;&lt;/code&gt;&gt;



== poolCluster.getConnection(pattern, selector) → Promise

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `pattern`:  *string* regex pattern to select pools. Example, `&#34;slave*&#34;`. default `&#39;*&#39;`
 * `selector`: *string* pools selector. Can be &#39;RR&#39; (round-robin), &#39;RANDOM&#39; or &#39;ORDER&#39; (use in sequence = always use first pools unless fails). default to the  
 
 Returns a promise that :
 * resolves with a [[#connection-api|Connection]] object,
 * raises an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Creates a new [[#connection-api|Connection]] object.
Connection must be given back to pool with the connection.end() method.

**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.getConnection(&#34;slave*&#34;)
&lt;&lt;/code&gt;&gt;

== poolCluster events

PoolCluster object inherits from the Node.js [[https://nodejs.org/api/events.html|`EventEmitter`]]. 
Emits &#39;remove&#39; event when a node is removed from configuration if the option `removeNodeErrorCount` is defined 
(default to 5) and connector fails to connect more than `removeNodeErrorCount` times. 
(if other nodes are present, each attemps will wait for value of the option `restoreNodeTimeout`)

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);
const cluster = mariadb.createPoolCluster({ removeNodeErrorCount: 20, restoreNodeTimeout: 5000 });
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });*
cluster.on(&#39;remove&#39;, node =&gt; {
  console.log(`node ${node} was removed`);
})
&lt;&lt;/code&gt;&gt;

== poolCluster.of(pattern, selector) → FilteredPoolCluster

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `pattern`:  *string* regex pattern to select pools. Example, `&#34;slave*&#34;`. default `&#39;*&#39;`
 * `selector`: *string* pools selector. Can be &#39;RR&#39; (round-robin), &#39;RANDOM&#39; or &#39;ORDER&#39; (use in sequence = always use first pools unless fails). default to the  

 Returns :
 * resolves with a [[#filteredpoolcluster|filtered pool cluster]] object,
 * raises an [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Creates a new [[#filteredpoolcluster|filtered pool cluster]] object that is a subset of cluster.


**Example:**

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb&#39;);

const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master-north&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;master-south&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1-north&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2-north&#34;, { host: &#39;mydb4.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1-south&#34;, { host: &#39;mydb5.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });

const masterCluster = cluster.of(&#39;master*&#39;);
const northSlaves = cluster.of(/^slave?-north/, &#39;RANDOM&#39;);
northSlaves.getConnection()
  .then(conn =&gt; {
    //use that connection
  })
&lt;&lt;/code&gt;&gt;

=== filtered pool cluster

* `filteredPoolCluster.getConnection() → Promise` : Creates a new connection from pools that corresponds to pattern .
* `filteredPoolCluster.query(sql[, values]) → Promise` : this is a shortcut to get a connection from pools that corresponds to pattern, execute a query and release connection.</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row row-10">
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/products" title="Products">Products</a>
                    </h5>
                    <ul>
                        <li id="menu-item-7816" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7816"><a href="https://mariadb.com/products/mariadb-platform/">MariaDB Platform</a></li>
                        <li id="menu-item-7815" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7815"><a href="https://mariadb.com/products/skysql/">MariaDB SkySQL</a></li>
                        <li id="menu-item-4172" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4172"><a href="https://mariadb.com/pricing/">Pricing</a></li>
                        <li id="menu-item-4163" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4163"><a href="https://mariadb.com/downloads/">Download MariaDB</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/services" title="Services">Services</a>
                    </h5>
                    <ul>
                        <li id="menu-item-4169" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4169"><a href="https://mariadb.com/services/remote-dba/">Remote DBA</a></li>
                        <li id="menu-item-41691" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4169"><a href="https://mariadb.com/services/skydba/">SkyDBA</a></li>
                        <li id="menu-item-4167" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4167"><a href="https://mariadb.com/services/enterprise-architect/">Enterprise Architect</a></li>
                        <li id="menu-item-4170" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4170"><a href="https://mariadb.com/services/technical-support-services/">Technical Support</a></li>
                        <li id="menu-item-4168" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4168"><a href="https://mariadb.com/services/migration-practice/">Migration Practice</a></li>
                        <li id="menu-item-4166" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4166"><a href="https://mariadb.com/services/consulting/">Consulting</a></li>
                        <li id="menu-item-4171" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4171"><a href="https://mariadb.com/services/training/">Training</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/resources" title="Resources">Resources</a>
                    </h5>
                    <ul>
                        <li id="menu-item-41751" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/docs/">Documentation</a></li>
                        <li id="menu-item-41752" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/developers/">Developers</a></li>
                        <li id="menu-item-4175" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/resources/blog/">Blog</a></li>
                        <li id="menu-item-5462" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5462"><a href="https://support.mariadb.com">Support</a></li>
                        <li id="menu-item-6004" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6004"><a href="https://mariadb.com/openworks/">OpenWorks</a></li>
                        <li id="menu-item-60041" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6004"><a href="https://mariadb.com/resources/customer-stories/">Customer Stories</a></li>
                        <li id="menu-item-7817" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-7817"><a href="https://mariadb.com/resources/events/">Events</a></li>
                        <li id="menu-item-4177" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4177"><a href="https://mariadb.com/roadshow/">MariaDB Roadshow</a></li>
                    </ul>
                </div>
                <div class="visible-xs visible-sm clear"></div>
                <div class="col-md-2 col-xs-5 item">
                    <h5>
                        <a href="/about-us" title="About MariaDB">About</a>
                    </h5>
                    <ul>
                        <li id="menu-item-4173" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4173"><a href="https://mariadb.com/contact/">Contact</a></li>
                        <li id="menu-item-4161" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4161"><a href="https://mariadb.com/about-us/leadership/">Leadership</a></li>
                        <li id="menu-item-4162" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4162"><a href="https://mariadb.com/about-us/partners/">Partners</a></li>
                        <li id="menu-item-4174" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4174"><a href="https://mariadb.com/newsroom/">Newsroom</a></li>
                        <li id="menu-item-4160" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4160"><a href="https://mariadb.com/about-us/investors/">Investors</a></li>
                        <li id="menu-item-4159" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/about-us/careers/">Careers</a></li>
                        <li id="menu-item-41591" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/trust/">Trust Center</a></li>
                        <li id="menu-item-41592" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/vulnerability-reporting/">Vulnerability Reporting</a></li>
                    </ul>
                </div>
                <div class="col-md-4 col-xs-7 item">
                    <div id="block-footercontact" class="block block-block-content block-block-content22b3af28-0754-44ec-a5c6-4466568f37e3">
                        <h5><a href="/contact" title="Contact">Contact</a></h5>
                    </div>
                    <div class="social">
                        <ul class="list-inline">
                            <li>
                                <a target="_blank" href="https://www.facebook.com/MariaDB.dbms/" title="Facebook">
                                    <i class="fa fa-facebook" aria-hidden="true"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="https://twitter.com/mariadb" title="Twitter">
                                    <i class="fa fa-twitter" aria-hidden="true"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="https://www.linkedin.com/company/mariadb-corporation?trk=company_logo " title="LinkedIn">
                                    <i class="fa fa-linkedin" aria-hidden="true"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <p>Subscribe to our newsletter!</p>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container text-center">
            <ul class="list-inline no-margin">
                <li>
                    <a href="/legal" title="Legal">Legal</a>
                </li>
                <li>
                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                </li>
                <li>
                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                </li>
            </ul>
            <p>Copyright &copy; 2023 MariaDB. All rights reserved.</p>
        </div>
    </div>
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>