<?xml version="1.0" encoding="utf-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>MariaDB Knowledge Base Comments for: Deadlock with foreign key constraints</title><link>https://mariadb.com/kb/en/deadlock-with-foreign-key-constraints/+comments/feed/</link><description></description><atom:link href="https://mariadb.com/kb/en/deadlock-with-foreign-key-constraints/+comments/feed/" rel="self"></atom:link><language>en-us</language><lastBuildDate>Fri, 10 Mar 2023 12:19:52 +0000</lastBuildDate><item><title>Re: Deadlock with foreign key constraints</title><link>https://mariadb.com/kb/en/deadlock-with-foreign-key-constraints/+comments/2239</link><description>&lt;p&gt;Hi,&lt;/p&gt;
&lt;p&gt;Firstly, lets run above transactions on single node InnoDB without any Galera. First insert-statement will take row locks to avoid phantom inserts to dl1. This means that second insert-statement to dl2 has to wait for that lock. This is because that insert is dependent on parent row in dl1. Thus, on single node InnoDB above transactions fail on second insert with lock wait timeout. Remember ACID rules, transactions are run on isolation, so they do not know each other.&lt;/p&gt;
&lt;p&gt;Now lets consider Galera case. When node1 issues commit, the insert will be executed also on node2. This is problematic as transaction on node2 is still open (yes we did roll back the statement containing the insert but not whole transaction yet). This also means that all row locks are maintained. New select statement requires also shared locks to maintain repeatable read isolation level so it will compete with insert statement from node1. But, insert from node1 should commit and may not wait for locks so select in node2 is aborted. Now naturally the error is kind of misleading, but better than nothing.&lt;/p&gt;
</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Jan Lindstr√∂m</dc:creator><guid>https://mariadb.com/kb/en/deadlock-with-foreign-key-constraints/+comments/2239</guid></item></channel></rss>