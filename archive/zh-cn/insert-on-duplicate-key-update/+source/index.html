<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>INSERT ON DUPLICATE KEY UPDATE - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="INSERT ON DUPLICATE KEY UPDATE - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/zh-cn/insert-on-duplicate-key-update/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/zh-cn/insert-on-duplicate-key-update/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/zh-cn/insert-on-duplicate-key-update/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/zh-cn/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/zh-cn/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/zh-cn/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/zh-cn/mariadb/">MariaDB - 简体中文</a>
    

    
    » <a class="crumb" href="/kb/zh-cn/mariadb-server/">MariaDB Server文档</a>
    


    » <a class="node_link crumb" href="/kb/zh-cn/insert-on-duplicate-key-update/">INSERT ON DUPLICATE KEY UPDATE</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/zh-cn/">首页</a></li>
                            
                                
                                    <li><a href="/kb/zh-cn/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/zh-cn/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/zh-cn/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/zh-cn/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/zh-cn/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/zh-cn/insert-on-duplicate-key-update/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>INSERT ON DUPLICATE KEY UPDATE - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/zh-cn/insert-on-duplicate-key-update/+r/68204/">68204</a></dd>
            <dt>用户</dt>
            <dd>
<span class="user" id="user-5480">
<a href="/kb/user/id/5480" title="longshuai Ma">longshuai Ma</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2018-04-19 07:32">2018-04-19 07:32</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">== 语法

&lt;&lt;code&gt;&gt;
INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE]
  [INTO] tbl_name [PARTITION (partition_list)] [(col,...)]
  {VALUES | VALUE} ({expr | DEFAULT},...),(...),...
  [ ON DUPLICATE KEY UPDATE
    col=expr
      [, col=expr] ... ]
&lt;&lt;/code&gt;&gt;

或：

&lt;&lt;code&gt;&gt;
INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE]
    [INTO] tbl_name [PARTITION (partition_list)]
    SET col={expr | DEFAULT}, ...
    [ ON DUPLICATE KEY UPDATE
      col=expr
        [, col=expr] ... ]
&lt;&lt;/code&gt;&gt;

或：

&lt;&lt;code&gt;&gt;
INSERT [LOW_PRIORITY | HIGH_PRIORITY] [IGNORE]
    [INTO] tbl_name [PARTITION (partition_list)] [(col,...)]
    SELECT ...
    [ ON DUPLICATE KEY UPDATE
      col=expr
        [, col=expr] ... ]
&lt;&lt;/code&gt;&gt;
&lt;&lt;toc&gt;&gt;

== 描述

INSERT ... ON DUPLICATE KEY UPDATE是MariaDB/MySQL对[[INSERT]]语句的扩展，当插入数据的时候发现有重复值冲突，将对原记录执行[[UPDATE]]操作来替代INSERT操作。

当插入数据的时候没有执行##UPDATE##而是单纯地插入数据，受影响的行数为1，如果执行了##UPDATE##操作，受影响的行数为2，除非设置了API的##CLIENT_FOUND_ROWS##标记。

如果有多个unique索引被匹配，则只有第一个会被更新。因此，对于有多个唯一索引的表，不建议使用该语句来插入数据。

如果表具有##[[auto_increment|AUTO_INCREMENT]]##的主键列，且插入了或更新了一行，则##[[last_insert_id|LAST_INSERT_ID()]]##函数将返回它的AUTO_INCREMEN值。

##[[values|VALUES()]]##函数只能应用在##ON DUPLICATE KEY UPDATE##子句中，在其他格式的INSERT语句中该函数无意义。它会返回INSERT语句中列对应的值。该函数在多行插入的环境中非常有用。

如果使用了 ##ON DUPLICATE KEY UPDATE##子句，则##[[ignore|IGNORE]]##和##[[insert-delayed|DELAYED]]##选项会被忽略。

&lt;&lt;product MariaDB from=10.0&gt;&gt;
PARTITION子句是从MariaDB 10.0开始引入的，详细信息见[[partition-pruning-and-selection|Partition Pruning and Selection]]。
&lt;&lt;/product&gt;&gt;

该语句会激活INSERT和UPDATE触发器。详细信息见[[trigger-overview|Trigger Overview]]。

还有一个与之类似的语句[[replace|REPLACE]]。

== 示例
&lt;&lt;code&gt;&gt;
CREATE TABLE ins_duplicate (id INT PRIMARY KEY, animal VARCHAR(30));
INSERT INTO ins_duplicate VALUES (1,&#39;Aardvark&#39;), (2,&#39;Cheetah&#39;), (3,&#39;Zebra&#39;);
&lt;&lt;/code&gt;&gt;

由于没有键值重复冲突，下面的语句将以普通的INSERT操作插入数据：
&lt;&lt;code&gt;&gt;
INSERT INTO ins_duplicate VALUES (4,&#39;Gorilla&#39;) ON DUPLICATE KEY UPDATE animal=&#39;Gorilla&#39;;
Query OK, 1 row affected (0.07 sec)
&lt;&lt;/code&gt;&gt;

&lt;&lt;code&gt;&gt;
SELECT * FROM ins_duplicate;
+----+----------+
| id | animal   |
+----+----------+
|  1 | Aardvark |
|  2 | Cheetah  |
|  3 | Zebra    |
|  4 | Gorilla  |
+----+----------+
&lt;&lt;/code&gt;&gt;

由于键值重复，下面的INSERT语句插入失败：
&lt;&lt;code&gt;&gt;
INSERT INTO ins_duplicate VALUES (1,&#39;Antelope&#39;);
ERROR 1062 (23000): Duplicate entry &#39;1&#39; for key &#39;PRIMARY&#39;
&lt;&lt;/code&gt;&gt;

此时，可以使用INSERT ON DUPLICATE KEY UPDATE来更新重复值：
&lt;&lt;code&gt;&gt;
INSERT INTO ins_duplicate VALUES (1,&#39;Antelope&#39;) ON DUPLICATE KEY UPDATE animal=&#39;Antelope&#39;;
Query OK, 2 rows affected (0.09 sec)
&lt;&lt;/code&gt;&gt;

注意，上面的语句将会报告受影响的行数为2，这是UPDATE的行为。

&lt;&lt;code&gt;&gt;
SELECT * FROM ins_duplicate;
+----+----------+
| id | animal   |
+----+----------+
|  1 | Antelope |
|  2 | Cheetah  |
|  3 | Zebra    |
|  4 | Gorilla  |
+----+----------+
&lt;&lt;/code&gt;&gt;

添加一个新的具有唯一性的字段：
&lt;&lt;code&gt;&gt;
ALTER TABLE ins_duplicate ADD id2 INT;
UPDATE ins_duplicate SET id2=id+10;
ALTER TABLE ins_duplicate ADD UNIQUE KEY(id2);
&lt;&lt;/code&gt;&gt;

由于匹配了两个唯一键，因此只有第一个被匹配的键被更新。这是不安全的行为，因此不推荐在多个唯一键的表上执行INSERT ON DUPLICATE KEY UPDATE语句，除非你直到自己在做什么。注意，下面的警告只在MariaDB 5.5之前才会显示，在MariaDB 10.0中已经移除了，因为MariaDB假定按照顺序去检查各个键，顺序可由[[show-create-table|SHOW CREATE TABLE]]获取。
&lt;&lt;code&gt;&gt;
INSERT INTO ins_duplicate VALUES (2,&#39;Lion&#39;,13) ON DUPLICATE KEY UPDATE animal=&#39;Lion&#39;;
Query OK, 2 rows affected, 1 warning (0.06 sec)

SHOW WARNINGS;
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level | Code | Message                                                                                                                                                                                  |
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Note  | 1592 | Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT. INSERT... ON DUPLICATE KEY UPDATE  on a table with more than one UNIQUE KEY is unsafe |
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

SELECT * FROM ins_duplicate;
+----+----------+------+
| id | animal   | id2  |
+----+----------+------+
|  1 | Antelope |   11 |
|  2 | Lion     |   12 |
|  3 | Zebra    |   13 |
|  4 | Gorilla  |   14 |
+----+----------+------+
&lt;&lt;/code&gt;&gt;
尽管第三行id=3对应的id2=13也被INSERT语句匹配到了，但却没有去更新该行的记录。

将id字段更改为自增字段auto_increment。如果insert插入了一个新行，auto_increment的只将向前移动。如果更新了已存在的行，则auto_increment保留原有的值。
&lt;&lt;code&gt;&gt;
ALTER TABLE `ins_duplicate` CHANGE `id` `id` INT( 11 ) NOT NULL AUTO_INCREMENT;
ALTER TABLE ins_duplicate DROP id2;
SELECT Auto_increment FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME=&#39;ins_duplicate&#39;;
+----------------+
| Auto_increment |
+----------------+
|              5 |
+----------------+

INSERT INTO ins_duplicate VALUES (2,&#39;Leopard&#39;) ON DUPLICATE KEY UPDATE animal=&#39;Leopard&#39;;
Query OK, 2 rows affected (0.00 sec)

SELECT Auto_increment FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME=&#39;ins_duplicate&#39;;
+----------------+
| Auto_increment |
+----------------+
|              5 |
+----------------+

INSERT INTO ins_duplicate VALUES (5,&#39;Wild Dog&#39;) ON DUPLICATE KEY UPDATE animal=&#39;Wild Dog&#39;;
Query OK, 1 row affected (0.09 sec)

SELECT * FROM ins_duplicate;
+----+----------+
| id | animal   |
+----+----------+
|  1 | Antelope |
|  2 | Leopard  |
|  3 | Zebra    |
|  4 | Gorilla  |
|  5 | Wild Dog |
+----+----------+

SELECT Auto_increment FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME=&#39;ins_duplicate&#39;;
+----------------+
| Auto_increment |
+----------------+
|              6 |
+----------------+
&lt;&lt;/code&gt;&gt;

从INSERT语句中引用字段的值来更新数据：
&lt;&lt;code&gt;&gt;
INSERT INTO table (a,b,c) VALUES (1,2,3),(4,5,6)
    ON DUPLICATE KEY UPDATE c=VALUES(a)+VALUES(b);
&lt;&lt;/code&gt;&gt;
更多内容参见[[values|VALUES()]]函数。

== See Also
* [[insert|INSERT]]
* [[insert-delayed|INSERT DELAYED]]
* [[insert-select|INSERT SELECT]]
* [[high_priority-and-low_priority|HIGH_PRIORITY and LOW_PRIORITY]]
* [[concurrent-inserts|Concurrent Inserts]]
* [[insert-default-duplicate-values|INSERT - Default &amp; Duplicate Values]]
* [[insert-ignore|INSERT IGNORE]]
* [[values|VALUES()]]</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>