<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Le patch per le prestazioni su Windows di MariaDB 5.3/MySQL 5.5 - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Le patch per le prestazioni su Windows di MariaDB 5.3/MySQL 5.5 - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/it/mariadb-53mysql-55-windows-performance-patches/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/it/mariadb-53mysql-55-windows-performance-patches/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/it/mariadb-53mysql-55-windows-performance-patches/+source/" rel="nofollow">Accesso</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/it/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/it/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/it/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/it/mariadb-italiano/">MariaDB - Italiano</a>
    

    
    » <a class="crumb" href="/kb/it/sviluppo/">Sviluppo</a>
    

    
    » <a class="crumb" href="/kb/it/qualita/">Qualità</a>
    

    
    » <a class="crumb" href="/kb/it/benchmark-e-test-di-lunga-durata/">Benchmark e test di lunga durata</a>
    

    
    » <a class="crumb" href="/kb/it/benchmark/">Benchmark</a>
    


    » <a class="node_link crumb" href="/kb/it/mariadb-53mysql-55-windows-performance-patches/">Le patch per le prestazioni su Windows di MariaDB 5.3/MySQL 5.5</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/it/">Pagina iniziale</a></li>
                            
                                
                                    <li><a href="/kb/it/+questions/">Domande Aperte</a></li>
                                
                                <li><a href="/kb/it/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/it/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/it/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/it/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/it/mariadb-53mysql-55-windows-performance-patches/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Le patch per le prestazioni su Windows di MariaDB 5.3/MySQL 5.5 - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revisione</dt>
            <dd><a href="/kb/it/mariadb-53mysql-55-windows-performance-patches/+r/11148/">11148</a></dd>
            <dt>Utente</dt>
            <dd>
<span class="user" id="user-982">
<a href="/kb/user/id/982" title="Federico Razzoli">Federico Razzoli</a>
</span></dd>
            <dt>Data</dt>
            <dd>

<span class="datetime" title="2012-08-10 09:38">2012-08-10 09:38</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">Ho appena effettuato il backport delle patch per le prestazioni su Windows da 5.5 a MariaDB 5.3. In MariaDB ce ne sono più che in MySQL 5.5, ma su questo punto tornerò più tardi.

Prima di tutto, ritengo che i miglioramenti alle performance su Windows in 5.5 non sono mai stati descritti adeguatamente, quindi ecco un riassunto. Per coloro che hanno familiarità con la programmazione su Windows, il codice di MySQL aveva dei problemi di prestazioni. Ne ho risolti alcuni quando lavoravo a MySQL/Sun. Il benchmark dei risultati mostra una curva interessante: si veda [[http://blogs.innodb.com/wp/2010/09/mysql-5-5-innodb-performance-improvements-on-windows/|il post nel blog di Calvin]]. 

Se i grafi di questo blog vi sono familiari, è perché sono stati spesso usati dal marketing di Oracle come prova dell&#39;influenza positiva di &#34;big O&#34; su MySQL :)

Ci sono state tre patch per le performance su Windows. Farò anche qualche commento sulla storia dei bug.

* [[http://bugs.mysql.com/bug.php?id=24509|Bug#24509]]. Il fix ha eliminato il limite di 2048 file aperti per MyISAM e come gradito effetto collaterale permette di impostare una cache per le tabelle molto più grande. All&#39;avvio di mysqld legge il massimo di file che possono essere aperti, e corregge il valore della cache delle tabelle, se max_open_files è basso o se max_connection è alto. Questo è ciò che è accaduto anche durante i benchmark. Se si osserva il grafo dei benchmark a sola lettura nel post di Calvin sopracitato, si nota un angolo intorno ai 64 utenti concorrenti. Nessuna meraviglia: il server mysql ha ricalcolato le dimensioni della cache delle tabelle e l&#39;ha impostata al minimo assoluto, cioè 64.

 Con il fix è stata creata una sorta di libreria C runtime sopra il puro Win32, che è in grado di gestire più di 2048 file aperti (16K è il default). Anche altri aspetti sono stati migliorati rispetto al runtime di Microsoft C, per esempio non ci sono lock e vi è un&#39;implementazione accittabile di pread()/pwrite(). Il vantaggio principale, come ho detto, è il poter disporre di una cache delle tabelle più grandi - riscrivere il runtime C è probabilmente una strage, ma non sono riuscito a trovare niente di meglio.

* [[http://bugs.mysql.com/bug.php?id=52102|Bug#52102]]. Con questo bug sono stati risolti molti punti discutibili di InnoDB, probabilmente scritti ai tempi di NT 3.1.

Prima di tutto occorre capire come viene acquisita la struttura &#34;mutex&#34; da InnoDB. I dettagli sono complessi, il mutex è una struttura complessa che contiene un vero mutex del sistema operativo (che sotto Windows si chiama CRITICAL_SECTION) più un evento InnoDB (che sotto Windows si chiama evento). Ci sono stati un paio di cambiamenti nell&#39;implementazione - il mutex può essere una variabile atomica (chiamata così per i miei amici Unix), sotto Unix un evento è rappresentato come variabile di condizione.

L&#39;acquisizione viene effettuata in due passi - prima un trylock su un mutex di sistema, possibilmente più volte in un ciclo se non ha successo; l&#39;evento viene riservato in una tabella globale di eventi chiamata &#34;sync array&#34;; l&#39;evento entra in stato di attesa. Lo sblocco del mutex sveglia quelli che sono in attesa, se ce ne sono. Non chiedetemi perché l&#39;implementazione sia così complicata: è così :) Forse, questa struttura aiuta a trovare i deadlock.

Variazione di questa implementazione - invece di fare un trylock su mutex, ora c&#39;è un&#39;istruzione compare_exchange sulle variabili atomiche.

Tornando a Windows, l&#39;implementazione sopra spiegata espone un paio di interessanti bug che si compensano a vicenda.

# Prima ho corretto os_mutex_trylock() perché faccia davvero quello che dice. L&#39;implementazione era EnterCriticalSection, cioè &#34;riprovaci tante volte&#34;, ed effettivamente acquisiva il lock. Un trylock più coscienzioso è del tipo TryEnterCriticalSection. Quando l&#39;ho aggiustato, contrariamente dalle mie aspettative, ha rallentato molto mysqld.  Quando trylock() falliva, InnoDB entrava in una parte del codice che non aveva mai visto prima. Per esempio, riservando spazio nel suddetto &#34;sync array&#34;.  L&#39;accesso a sync array è protetto dal cosiddetto &#34;slow lock&#34; e questo appariva molto spesso nel profiler. Il passo successivo è stato sistemare lo &#34;slow lock&#34;
#  &#34;slow Innodb mutex&#34; è stato implementato come oggetto kernel, aka Windows mutex (per i miei amici Unix è una specie di semaforo di SysV). Può essere usato per sincronizzare i processi, ma per la sincronizzazione dei thread in un medesimo processo è una tortura. Era un &#34;really slow mutex&#34;. E&#39; diventato molto più veloce modificandolo in CRITICAL_SECTION...
# Una volta fatto tutto questo, ho capito che gli eventi di Windows non scalavano bene negli scenari con molti thread. Sui Windows più recenti (Vista+), ci sono le  CONDITION_VARIABLE che secondo la documentazione scalano meglio, e in effetti secondo le mie misurazioni funzionano molto bene. Così ho utilizzato le variabili di condizione quando ho potuto, il che è ironico, perché gli eventi di InnoDB erano realmente modellati come gli eventi di Windows.
# Ho riabilitato l&#39;implementazione dei mutex veloci come variabili atomiche. Prima della patch, i flag del precompilatore relativi alle variabili atomiche erano commentati, con un &#34;Windows atomics do not work well&#34; in CMakeLists.txt. Grande commento, dato che diversamente dagli sviluppatori software, le istruzioni atomiche non hanno preferenze per un particolare OS :) 

Quindi &#34;atomics did not work well on Windows&#34; era l&#39;effetto cumulativo di diversi fattori.

Prima della patch. Una volta abilitate le atomiche, l&#39;implementazione dei mutex veloci non usava CRITICAL_SECTION, ma l&#39;istruzione compare_exchange. L&#39;ingegnoso &#34;prova tante volte&#34; che abbiamo visto nel punto 1 non viene più utilizzato, ed è sostituito da un corretto lock &#34;prova&#34; . Quando try_lock() iniziava a fallire con molti thread concorrenti, il ritardo dovuto a sync array implementato come oggetto kernel di Windows, visto al punto 2, è divenuto chiaro e gli eventi di Windows assolutamente inefficienti visti al punto 3 completavano il quadretto.

* [[http://bugs.mysql.com/bug.php?id=56585|Bug#56585]]

Questa patch serve semplicemente a compensare gli effetti negativi dei lock sui metadati di 5.5 visti nei benchmark di MyISAM. Il fix utilizza i primitivi delle performance nativi di Vista. La patch di per se non è interessante e riproduce molto di ciò che è stato fatto per InnoDB. Quel che c&#39;è di grande è una discussione precedente alla patch tra me, Davi e Dmitry, sulle differenti implementazioni dei lock in lettura e in scrittura, tra cui due fatte in casa e una di [[http://blogs.msdn.com/b/vancem/archive/2006/03/28/563180.aspx|Vance Morrison]]. 

Senza dubbio, le discussioni sono state illuminanti nel breve periodo in cui ho lavorato a Oracle. Inoltre, se si vuole avere una revisione del codice MySQL in stile classico con 17 cose da sistemare, delle quali almeno 10 verrebbero segnate come &#34;Coding Style&#34; (sì, entrambe le parole, con le maiuscole), si provi ad avere Dmitry Lenev come revisore, è grande - eccone la prova http://lists.mysql.org/commits/118295 Comunque, la patch migliora le prestazioni di MyISAM del 10-20%, e penso che vada abbastanza bene. In qualche modo però queste percentuali sono state poi rosicchiate da MDL :)

== Note
Preso da una nota su Facebook: [[https://www.facebook.com/note.php?note_id=238505812835782]] di Vladislav Vaintroub.
</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>