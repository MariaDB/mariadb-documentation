<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Galera Cluster - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Galera Cluster" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/mariadb-enterprise-operator-galera-cluster/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Provision and operate Galera Enterprise clusters in Kubernetes" />

    <meta name="description" content="Provision and operate Galera Enterprise clusters in Kubernetes" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-enterprise-operator-galera-cluster/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-enterprise-operator-galera-cluster/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/solutions" title="Solutions">Solutions</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="Company">Company</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-enterprise-server/">MariaDB Enterprise Server</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-enterprise-operator/">MariaDB Enterprise Operator</a>
    


    » <a class="node_link crumb" href="/kb/en/mariadb-enterprise-operator-galera-cluster/">Galera Cluster</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-enterprise-operator-galera-cluster/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-enterprise-operator-galera-cluster/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/mariadb-enterprise-operator-galera-cluster/+flag"
                data-flag-url="/kb/en/mariadb-enterprise-operator-galera-cluster/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-enterprise-operator-galera-cluster/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2025-02-26 16:52">2 months, 2 weeks ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2025-04-22 08:34">2 weeks, 5 days ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/mariadb-enterprise-operator-galera-cluster/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/mariadb-enterprise-operator-galera-cluster/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/mariadb-enterprise-operator-galera-cluster/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/mariadb-enterprise-operator-galera-cluster/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Galera Cluster</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <p>MariaDB Enterprise Operator provides cloud native support for provisioning and operating multi-master MariaDB clusters using Galera. This setup enables the ability to perform writes on a single node and reads in all nodes, enhancing availability and allowing scalability across multiple nodes.</p>
<p>In certain circumstances, it could be the case that all the nodes of your cluster go down at the same time, something that Galera is not able to recover by itself, and it requires manual action to bring the cluster up again, as documented in the <a href="https://galeracluster.com/library/documentation/crash-recovery.html">Galera documentation</a>. The MariaDB Enterprise Operator encapsulates this operational expertise in the <code>MariaDB</code> CR. You just need to declaratively specify <code>spec.galera</code>, as explained in more detail <a href="#mariadb-configuration">later in this guide</a>.</p>
<p>To accomplish this, after the MariaDB cluster has been provisioned, the operator will regularly monitor the cluster's status to make sure it is healthy. If any issues are detected, the operator will initiate the <a href="#galera-cluster-recovery">recovery process</a> to restore the cluster to a healthy state. During this process, the operator will set status conditions in the <code>MariaDB</code> and emit <code>Events</code> so you have a better understanding of the recovery progress and the underlying activities being performed. For example, you may want to know which <code>Pods</code> were out of sync to further investigate infrastructure-related issues (i.e. networking, storage...) on the nodes where these <code>Pods</code> were scheduled.</p>
<h2 id="table-of-contents">Table of contents</h2>
<ul>
<li><a href="#data-plane">Data-plane</a></li>
<li><a href="#mariadb-configuration"><code>MariaDB</code> configuration</a></li>
<li><a href="#storage">Storage</a></li>
<li><a href="#wsrep-provider">Wsrep provider</a></li>
<li><a href="#ipv6-support">IPv6 support</a></li>
<li><a href="#agent-auth-methods">Agent auth methods</a></li>
<li><a href="#backup-and-restore">Backup and restore</a></li>
<li><a href="#galera-cluster-recovery">Galera cluster recovery</a></li>
<li><a href="#bootstrap-galera-cluster-from-existing-pvcs">Bootstrap Galera cluster from existing PVCs</a></li>
<li><a href="#quickstart">Quickstart</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
<h2 id="data-plane">Data-plane</h2>
<p>To be able to effectively provision and recover MariaDB Galera clusters, the following data-plane components run alongside MariaDB and co-operate with MariaDB Enterprise Operator:</p>
<ul>
<li><strong>init</strong>: Init container that dynamically provisions the Galera configuration file before the MariaDB container starts. Guarantees ordered deployment of <code>Pods</code> even if <code>spec.podManagementPolicy=Parallel</code> is set on the MariaDB <code>StatefulSet</code>, something crucial for performing the Galera recovery, as the operator needs to restart <code>Pods</code> independently.</li>
<li><strong>agent</strong>: Sidecar agent that exposes the Galera state (<a href="https://galeracluster.com/2016/11/introducing-the-safe-to-bootstrap-feature-in-galera-cluster/"><code>grastate.dat</code></a>) via HTTP and allows the operator to remotely bootstrap and recover the Galera cluster. It comes with <a href="#agent-auth-methods">multiple auth methods</a> to ensure that only the operator is able to call the agent.</li>
</ul>
<p>All these components are available in the operator image. More preciselly, they are subcommands of the CLI shipped as binary inside the image.</p>
<h2 id="mariadb-configuration"><code>MariaDB</code> configuration</h2>
<p>The easiest way to get a MariaDB Galera cluster up and running is setting <code>spec.galera.enabled = true</code>:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
<span>...</span>
  <span>replicas</span><span>:</span> <span>3</span>

  <span>galera</span><span>:</span>
    <span>enabled</span><span>:</span> <span>true</span>
</pre></div>


<p>This relies on sensible defaults set by the operator, which may not be suitable for your Kubernetes cluster. This can be solved by overriding the defaults, so you have fine-grained control over the Galera configuration.</p>
<p>Refer to the <a href="https://mariadb.com/kb/en/mariadb-enterprise-operator-api-reference/">API reference</a> to better understand the purpose of each field.</p>
<h2 id="storage">Storage</h2>
<p>By default, the operator provisions two PVCs for running Galera:</p>
<ul>
<li><strong>Storage PVC</strong>: Used to back the MariaDB data directory, mounted at <code>/var/lib/mysql</code>.</li>
<li><strong>Config PVC</strong>: Where the Galera config files are located, mounted at <code>/etc/mysql/conf.d</code>.</li>
</ul>
<p>However, you are also able to use just one PVC for keeping both the data and the config files:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>...</span>
  <span>galera</span><span>:</span>
    <span>enabled</span><span>:</span> <span>true</span>
    <span>config</span><span>:</span>
      <span>reuseStorageVolume</span><span>:</span> <span>true</span>
</pre></div>


<h2 id="wsrep-provider">Wsrep provider</h2>
<p>You are able to pass extra options to the Galera wsrep provider by using the <code>galera.providerOptions</code> field:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>...</span>
  <span>galera</span><span>:</span>
    <span>providerOptions</span><span>:</span>
      <span>gcs.fc_limit</span><span>:</span> <span>'64'</span>
</pre></div>


<p>It is important to note that, the <code>ist.recv_addr</code> cannot be set by the user, as it is automatically configured to the <code>Pod</code> IP by the operator, something that an user won't be able to know beforehand.</p>
<p>A list of the available options can be found in the <a href="https://mariadb.com/kb/en/wsrep_provider_options/">MariaDB documentation</a>.</p>
<h2 id="ipv6-support">IPv6 support</h2>
<p>If you have a Kubernetes cluster running with IPv6, the operator will automatically detect the IPv6 addresses of your <code>Pods</code> and it will configure several <a href="#wsrep-provider">wsrep provider</a> options to ensure that the Galera protocol runs smoothly with IPv6.</p>
<h2 id="agent-auth-methods">Agent auth methods</h2>
<p>As previously mentioned in the <a href="#data-plane">data-plane</a> section, the agent exposes an API to remotely manage the MariaDB Galera cluster. The following authentication methods are supported to ensure that only the operator is able to call the agent:</p>
<h4 id="serviceaccount-based-authentication"><code>ServiceAccount</code> based authentication</h4>
<p>The operator uses its <code>ServiceAccount</code> token as a mean of  authentication for communicating with the agent, which subsequently verifies the token by creating a <a href="https://kubernetes.io/docs/reference/kubernetes-api/authentication-resources/token-review-v1/"><code>TokenReview</code> object</a>. This is the default authentication method and will be automatically applied by setting:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>galera</span><span>:</span>
    <span>agent</span><span>:</span>
      <span>kubernetesAuth</span><span>:</span>
        <span>enabled</span><span>:</span> <span>true</span>
</pre></div>


<p>This Kubernetes-native authentication mechanism eliminates the need for the operator to manage credentials, as it relies entirely on Kubernetes for this purpose. However, the drawback is that the agent requires cluster-wide permissions to impersonate the <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#other-component-roles"><code>system:auth-delegator</code></a> <code>ClusterRole</code> and to create <a href="https://kubernetes.io/docs/reference/kubernetes-api/authentication-resources/token-review-v1/"><code>TokenReviews</code></a>, which are cluster-scoped objects.</p>
<h4 id="basic-authentication">Basic authentication</h4>
<p>As an alternative, the agent also supports basic authentication:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>galera</span><span>:</span>
    <span>agent</span><span>:</span>
      <span>basicAuth</span><span>:</span>
        <span>enabled</span><span>:</span> <span>true</span>
</pre></div>


<p>Unlike the <a href="#serviceaccount-based-authentication"><code>ServiceAccount</code> based authentication</a>, the operator needs to explicitly generate credentials to authenticate. The advantage of this approach is that it is entirely decoupled from Kubernetes and it does not require cluster-wide permissions on the Kubernetes API.</p>
<h2 id="backup-and-restore">Backup and restore</h2>
<p>Please refer to the <a href="https://mariadb.com/kb/en/mariadb-enterprise-operator-backup-and-restore/">backup documentation</a> to understand how to backup and restore Galera clusters. Specially, make sure you understand the <a href="https://mariadb.com/kb/en/mariadb-enterprise-operator-backup-and-restore/#galera-backup-limitations">Galera backup limitations</a>.</p>
<h2 id="galera-cluster-recovery">Galera cluster recovery</h2>
<p>MariaDB Enterprise Operator monitors the Galera cluster and acts accordinly to recover it if needed. This feature is enabled by default, but you may tune it as you need:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>...</span>
  <span>galera</span><span>:</span>
    <span>enabled</span><span>:</span> <span>true</span>
    <span>recovery</span><span>:</span>
      <span>enabled</span><span>:</span> <span>true</span>
      <span>minClusterSize</span><span>:</span> <span>1</span>
      <span>clusterMonitorInterval</span><span>:</span> <span>10s</span>
      <span>clusterHealthyTimeout</span><span>:</span> <span>30s</span>
      <span>clusterBootstrapTimeout</span><span>:</span> <span>10m</span>
      <span>podRecoveryTimeout</span><span>:</span> <span>5m</span>
      <span>podSyncTimeout</span><span>:</span> <span>5m</span>
</pre></div>


<p>The <code>minClusterSize</code> field indicates the minimum cluster size (either absolut number of replicas or percentage) for the operator to consider the cluster healthy. If the cluster is unhealthy for more than the period defined in <code>clusterHealthyTimeout</code> (<code>30s</code> by default), a cluster recovery process is initiated by the operator. The process is explained in the <a href="https://galeracluster.com/library/documentation/crash-recovery.html">Galera documentation</a> and consists of the following steps:</p>
<ul>
<li>Recover the sequence number from the <code>grastate.dat</code> on each node.</li>
<li>Trigger a <a href="#galera-recovery-job">recovery <code>Job</code></a> to obtain the sequence numbers in case that the previous step didn't manage to.</li>
<li>Mark the node with highest sequence (bootstrap node) as safe to bootstrap.</li>
<li>Bootstrap a new cluster in the bootstrap node.</li>
<li>Restart and wait until the bootstrap node becomes ready.</li>
<li>Restart the rest of the nodes one by one so they can join the new cluster.</li>
</ul>
<p>The operator monitors the Galera cluster health periodically and performs the cluster recovery described above if needed. You are able to tune the monitoring interval via the <code>clusterMonitorInterval</code> field.</p>
<p>Refer to the <a href="https://mariadb.com/kb/en/mariadb-enterprise-operator-api-reference/">API reference</a> to better understand the purpose of each field.</p>
<h4 id="galera-recovery-job">Galera recovery <code>Job</code></h4>
<p>During the recovery process, a <code>Job</code> is triggered for each <code>MariaDB</code> <code>Pod</code> to obtain the sequence numbers. It's crucial for this <code>Job</code> to succeed; otherwise, the recovery process will fail. As a user, you are responsible for adjusting this <code>Job</code> to allocate sufficient resources and provide the necessary metadata to ensure its successful completion.</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>...</span>
  <span>galera</span><span>:</span>
    <span>enabled</span><span>:</span> <span>true</span>
    <span>recovery</span><span>:</span>
      <span>job</span><span>:</span>
        <span>metadata</span><span>:</span>
          <span>labels</span><span>:</span>
            <span>sidecar.istio.io/inject</span><span>:</span> <span>"false"</span>
        <span>resources</span><span>:</span>
          <span>requests</span><span>:</span>
            <span>cpu</span><span>:</span> <span>100m</span>
            <span>memory</span><span>:</span> <span>128Mi</span>
          <span>limits</span><span>:</span>
            <span>memory</span><span>:</span> <span>256Mi</span>
</pre></div>


<p>For example, if you're using a service mesh like Istio, it's important to add the <code>sidecar.istio.io/inject=false</code> label. Without this label, the <code>Job</code> will not complete, which would prevent the recovery process from finishing successfully.</p>
<h4 id="force-cluster-bootstrap">Force cluster bootstrap</h4>
<blockquote>
<p><strong>CAUTION</strong>
Use this option only in exceptional circumstances. Not selecting the <code>Pod</code> with the highest sequence number may result in data loss.</p>
<p><strong>WARNING</strong>
Ensure you unset <code>forceClusterBootstrapInPod</code> after completing the bootstrap to allow the operator to choose the appropriate <code>Pod</code> to bootstrap from in an event of cluster recovery.</p>
</blockquote>
<p>You have the ability to manually select which <code>Pod</code> is used to bootstrap a new cluster during the recovery process by setting <code>forceClusterBootstrapInPod</code>:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>...</span>
  <span>galera</span><span>:</span>
    <span>enabled</span><span>:</span> <span>true</span>
    <span>recovery</span><span>:</span>
      <span>enabled</span><span>:</span> <span>true</span>
      <span>forceClusterBootstrapInPod</span><span>:</span> <span>"mariadb-galera-0"</span>
</pre></div>


<p>This should only be used in exceptional circumstances:</p>
<ul>
<li>You are absolutely certain that the chosen <code>Pod</code> has the highest sequence number.</li>
<li>The operator has not yet selected a <code>Pod</code> to bootstrap from.</li>
</ul>
<p>You can verify this with the following command:</p>
<div><pre><span></span>kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.galeraRecovery}"</span> <span>|</span> jq
<span>{</span>
  <span>"recovered"</span>: <span>{</span>
    <span>"mariadb-galera-0"</span>: <span>{</span>
      <span>"seqno"</span>: 350454,
      <span>"uuid"</span>: <span>"67a44ea9-63a8-11ef-98a2-2b0c0aa0a627"</span>
    <span>}</span>,
    <span>"mariadb-galera-1"</span>: <span>{</span>
      <span>"seqno"</span>: 350450,
      <span>"uuid"</span>: <span>"67a44ea9-63a8-11ef-98a2-2b0c0aa0a627"</span>
    <span>}</span>
  <span>}</span>,
  <span>"state"</span>: <span>{</span>
    <span>"mariadb-galera-0"</span>: <span>{</span>
      <span>"safeToBootstrap"</span>: false,
      <span>"seqno"</span>: -1,
      <span>"uuid"</span>: <span>"67a44ea9-63a8-11ef-98a2-2b0c0aa0a627"</span>,
      <span>"version"</span>: <span>"2.1"</span>
    <span>}</span>,
    <span>"mariadb-galera-1"</span>: <span>{</span>
      <span>"safeToBootstrap"</span>: false,
      <span>"seqno"</span>: -1,
      <span>"uuid"</span>: <span>"67a44ea9-63a8-11ef-98a2-2b0c0aa0a627"</span>,
      <span>"version"</span>: <span>"2.1"</span>
    <span>}</span>,
    <span>"mariadb-galera-2"</span>: <span>{</span>
      <span>"safeToBootstrap"</span>: false,
      <span>"seqno"</span>: -1,
      <span>"uuid"</span>: <span>"67a44ea9-63a8-11ef-98a2-2b0c0aa0a627"</span>,
      <span>"version"</span>: <span>"2.1"</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</pre></div>


<p>In this case, assuming that <code>mariadb-galera-2</code> sequence is lower than <code>350454</code>, it should be safe to bootstrap from <code>mariadb-galera-0</code>.</p>
<p>Finally, after your cluster has been bootstrapped, remember to unset <code>forceClusterBootstrapInPod</code> to allow the operator to select the appropriate node for bootstrapping in the event of a cluster recovery.</p>
<h2 id="bootstrap-galera-cluster-from-existing-pvcs">Bootstrap Galera cluster from existing PVCs</h2>
<p>MariaDB Enterprise Operator will never delete your <code>MariaDB</code> PVCs. Whenever you delete a <code>MariaDB</code> resource, the PVCs will remain intact so you could reuse them to re-provision a new cluster.</p>
<p>That said, Galera is unable to form a cluster from pre-existing state, it requires a <a href="#galera-cluster-recovery">cluster recovery</a> process to identify which <code>Pod</code> has the highest sequence number to bootstrap a new cluster. That's exactly what the operator does: whenever a new <code>MariaDB</code> Galera cluster is created and previously created PVCs exist, a cluster recovery process is automatically triggered.</p>
<h2 id="quickstart">Quickstart</h2>
<p>Apply the following manifests to get started with Galera in Kubernetes:</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>v1</span>
<span>kind</span><span>:</span> <span>Secret</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb</span>
<span>stringData</span><span>:</span>
  <span>root-password</span><span>:</span> <span>MariaDB11!</span>
<span>---</span>
<span>apiVersion</span><span>:</span> <span>enterprise.mariadb.com/v1alpha1</span>
<span>kind</span><span>:</span> <span>MariaDB</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>rootPasswordSecretKeyRef</span><span>:</span>
    <span>name</span><span>:</span> <span>mariadb</span>
    <span>key</span><span>:</span> <span>root-password</span>
  <span>storage</span><span>:</span>
    <span>size</span><span>:</span> <span>1Gi</span>
  <span>replicas</span><span>:</span> <span>3</span>
  <span>galera</span><span>:</span>
    <span>enabled</span><span>:</span> <span>true</span>
</pre></div>


<p>Next, check the <code>MariaDB</code> status and the resources created by the operator:</p>
<div><pre><span></span>kubectl get mariadbs
NAME             READY   STATUS    PRIMARY POD          AGE
mariadb-galera   True    Running   mariadb-galera-0     48m

kubectl get events --field-selector involvedObject.name<span>=</span>mariadb-galera --sort-by<span>=</span><span>'.lastTimestamp'</span>
LAST SEEN   TYPE     REASON                 OBJECT                               MESSAGE
...
45m         Normal   GaleraClusterHealthy   mariadb/mariadb-galera               Galera cluster is healthy

kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.conditions[?(@.type=='GaleraReady')]}"</span> <span>|</span> jq
<span>{</span>
  <span>"lastTransitionTime"</span>: <span>"2023-07-13T18:22:31Z"</span>,
  <span>"message"</span>: <span>"Galera ready"</span>,
  <span>"reason"</span>: <span>"GaleraReady"</span>,
  <span>"status"</span>: <span>"True"</span>,
  <span>"type"</span>: <span>"GaleraReady"</span>
<span>}</span>

kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.conditions[?(@.type=='GaleraConfigured')]}"</span> <span>|</span> jq
<span>{</span>
  <span>"lastTransitionTime"</span>: <span>"2023-07-13T18:22:31Z"</span>,
  <span>"message"</span>: <span>"Galera configured"</span>,
  <span>"reason"</span>: <span>"GaleraConfigured"</span>,
  <span>"status"</span>: <span>"True"</span>,
  <span>"type"</span>: <span>"GaleraConfigured"</span>
<span>}</span>

kubectl get statefulsets
NAME             READY   AGE
mariadb-galera   3/3     58m

kubectl get pods -o wide
NAME                                        READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES
mariadb-galera-0                            2/2     Running   <span>0</span>          58m   10.244.2.4   mdb-worker3   &lt;none&gt;           &lt;none&gt;
mariadb-galera-1                            2/2     Running   <span>0</span>          58m   10.244.1.9   mdb-worker2   &lt;none&gt;           &lt;none&gt;
mariadb-galera-2                            2/2     Running   <span>0</span>          58m   10.244.5.4   mdb-worker4   &lt;none&gt;           &lt;none&gt;
</pre></div>


<p>Let's now proceed with simulating a Galera cluster failure by deleting all the <code>Pods</code> at the same time:</p>
<div><pre><span></span>kubectl delete pods -l app.kubernetes.io/instance<span>=</span>mariadb-galera
pod <span>"mariadb-galera-0"</span> deleted
pod <span>"mariadb-galera-1"</span> deleted
pod <span>"mariadb-galera-2"</span> deleted
</pre></div>


<p>After some time, we will see the <code>MariaDB</code> entering a non <code>Ready</code> state:</p>
<div><pre><span></span>kubectl get mariadb mariadb-galera
NAME             READY   STATUS             PRIMARY POD             AGE
mariadb-galera   False   Galera not ready   mariadb-galera-0        67m

kubectl get events --field-selector involvedObject.name<span>=</span>mariadb-galera --sort-by<span>=</span><span>'.lastTimestamp'</span>
LAST SEEN   TYPE      REASON                    OBJECT                       MESSAGE
...
48s         Warning   GaleraClusterNotHealthy   mariadb/mariadb-galera       Galera cluster is not healthy

kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.conditions[?(@.type=='GaleraReady')]}"</span> <span>|</span> jq
<span>{</span>
  <span>"lastTransitionTime"</span>: <span>"2023-07-13T19:25:17Z"</span>,
  <span>"message"</span>: <span>"Galera not ready"</span>,
  <span>"reason"</span>: <span>"GaleraNotReady"</span>,
  <span>"status"</span>: <span>"False"</span>,
  <span>"type"</span>: <span>"GaleraReady"</span>
<span>}</span>
</pre></div>


<p>Eventually, the operator will kick in and recover the Galera cluster:</p>
<div><pre><span></span>kubectl get events --field-selector involvedObject.name<span>=</span>mariadb-galera --sort-by<span>=</span><span>'.lastTimestamp'</span>
LAST SEEN   TYPE      REASON                    OBJECT                       MESSAGE
...
16m         Warning   GaleraClusterNotHealthy   mariadb/mariadb-galera       Galera cluster is not healthy
16m         Normal    GaleraPodStateFetched     mariadb/mariadb-galera       Galera state fetched in Pod <span>'mariadb-galera-2'</span>
16m         Normal    GaleraPodStateFetched     mariadb/mariadb-galera       Galera state fetched in Pod <span>'mariadb-galera-1'</span>
16m         Normal    GaleraPodStateFetched     mariadb/mariadb-galera       Galera state fetched in Pod <span>'mariadb-galera-0'</span>
16m         Normal    GaleraPodRecovered        mariadb/mariadb-galera       Recovered Galera sequence in Pod <span>'mariadb-galera-1'</span>
16m         Normal    GaleraPodRecovered        mariadb/mariadb-galera       Recovered Galera sequence in Pod <span>'mariadb-galera-2'</span>
17m         Normal    GaleraPodRecovered        mariadb/mariadb-galera       Recovered Galera sequence in Pod <span>'mariadb-galera-0'</span>
17m         Normal    GaleraClusterBootstrap    mariadb/mariadb-galera       Bootstrapping Galera cluster in Pod <span>'mariadb-galera-2'</span>
20m         Normal    GaleraClusterHealthy      mariadb/mariadb-galera       Galera cluster is healthy

kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.galeraRecovery}"</span> <span>|</span> jq
<span>{</span>
  <span>"bootstrap"</span>: <span>{</span>
    <span>"pod"</span>: <span>"mariadb-galera-2"</span>,
    <span>"time"</span>: <span>"2023-07-13T19:25:28Z"</span>
  <span>}</span>,
  <span>"recovered"</span>: <span>{</span>
    <span>"mariadb-galera-0"</span>: <span>{</span>
      <span>"seqno"</span>: 3,
      <span>"uuid"</span>: <span>"bf00b9c3-21a9-11ee-984f-9ba9ff0e9285"</span>
    <span>}</span>,
    <span>"mariadb-galera-1"</span>: <span>{</span>
      <span>"seqno"</span>: 3,
      <span>"uuid"</span>: <span>"bf00b9c3-21a9-11ee-984f-9ba9ff0e9285"</span>
    <span>}</span>,
    <span>"mariadb-galera-2"</span>: <span>{</span>
      <span>"seqno"</span>: 3,
      <span>"uuid"</span>: <span>"bf00b9c3-21a9-11ee-984f-9ba9ff0e9285"</span>
    <span>}</span>
  <span>}</span>,
  <span>"state"</span>: <span>{</span>
    <span>"mariadb-galera-0"</span>: <span>{</span>
      <span>"safeToBootstrap"</span>: false,
      <span>"seqno"</span>: -1,
      <span>"uuid"</span>: <span>"bf00b9c3-21a9-11ee-984f-9ba9ff0e9285"</span>,
      <span>"version"</span>: <span>"2.1"</span>
    <span>}</span>,
    <span>"mariadb-galera-1"</span>: <span>{</span>
      <span>"safeToBootstrap"</span>: false,
      <span>"seqno"</span>: -1,
      <span>"uuid"</span>: <span>"bf00b9c3-21a9-11ee-984f-9ba9ff0e9285"</span>,
      <span>"version"</span>: <span>"2.1"</span>
    <span>}</span>,
    <span>"mariadb-galera-2"</span>: <span>{</span>
      <span>"safeToBootstrap"</span>: false,
      <span>"seqno"</span>: -1,
      <span>"uuid"</span>: <span>"bf00b9c3-21a9-11ee-984f-9ba9ff0e9285"</span>,
      <span>"version"</span>: <span>"2.1"</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</pre></div>


<p>Finally, the <code>MariaDB</code> resource will become <code>Ready</code> and your Galera cluster will be operational again:</p>
<div><pre><span></span>kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.conditions[?(@.type=='GaleraReady')]}"</span> <span>|</span> jq
<span>{</span>
  <span>"lastTransitionTime"</span>: <span>"2023-07-13T19:27:51Z"</span>,
  <span>"message"</span>: <span>"Galera ready"</span>,
  <span>"reason"</span>: <span>"GaleraReady"</span>,
  <span>"status"</span>: <span>"True"</span>,
  <span>"type"</span>: <span>"GaleraReady"</span>
<span>}</span>

kubectl get mariadb mariadb-galera
NAME             READY   STATUS    PRIMARY POD          AGE
mariadb-galera   True    Running   mariadb-galera-0     82m
</pre></div>


<h2 id="troubleshooting">Troubleshooting</h2>
<p>The aim of this section is showing you how to diagnose your Galera cluster when something goes wrong. In this situations, observability is a key factor to understand the problem, so we recommend following these steps before jumping into debugging the problem.</p>
<ul>
<li>Inspect <code>MariaDB</code> status conditions.</li>
</ul>
<div><pre><span></span>kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.conditions}"</span> <span>|</span> jq
<span>[</span>
  <span>{</span>
    <span>"lastTransitionTime"</span>: <span>"2023-08-05T14:58:57Z"</span>,
    <span>"message"</span>: <span>"Galera not ready"</span>,
    <span>"reason"</span>: <span>"GaleraNotReady"</span>,
    <span>"status"</span>: <span>"False"</span>,
    <span>"type"</span>: <span>"Ready"</span>
  <span>}</span>,
  <span>{</span>
    <span>"lastTransitionTime"</span>: <span>"2023-08-05T14:58:57Z"</span>,
    <span>"message"</span>: <span>"Galera not ready"</span>,
    <span>"reason"</span>: <span>"GaleraNotReady"</span>,
    <span>"status"</span>: <span>"False"</span>,
    <span>"type"</span>: <span>"GaleraReady"</span>
  <span>}</span>,
  <span>{</span>
    <span>"lastTransitionTime"</span>: <span>"2023-08-03T19:21:16Z"</span>,
    <span>"message"</span>: <span>"Galera configured"</span>,
    <span>"reason"</span>: <span>"GaleraConfigured"</span>,
    <span>"status"</span>: <span>"True"</span>,
    <span>"type"</span>: <span>"GaleraConfigured"</span>
  <span>}</span>
<span>]</span>
</pre></div>


<ul>
<li>Make sure network connectivity is fine by checking that you have an <code>Endpoint</code> per <code>Pod</code> in your Galera cluster.</li>
</ul>
<div><pre><span></span>kubectl get endpoints mariadb-galera-internal -o yaml
apiVersion: v1
kind: Endpoints
metadata:
  name: mariadb-internal
subsets:
- addresses:
  - hostname: mariadb-1
    ip: 10.255.140.181
    nodeName: k8s-worker-1
    targetRef:
      kind: Pod
      name: mariadb-1
      namespace: mariadb
  - hostname: mariadb-2
    ip: 10.255.20.156
    nodeName: k8s-worker-2
    targetRef:
      kind: Pod
      name: mariadb-2
      namespace: mariadb
  - hostname: mariadb-0
    ip: 10.255.214.164
    nodeName: k8s-worker-0
    targetRef:
      kind: Pod
      name: mariadb-0
      namespace: mariadb
  ports:
  - name: sst
    port: 4568
    protocol: TCP
  - name: ist
    port: 4567
    protocol: TCP
  - name: mariadb
    port: 3306
    protocol: TCP
  - name: agent
    port: 5555
    protocol: TCP
  - name: cluster
    port: 4444
    protocol: TCP
</pre></div>


<ul>
<li>Check the events associated with the <code>MariaDB</code> object, as they provide significant insights for diagnosis, particularly within the context of cluster recovery.</li>
</ul>
<div><pre><span></span>kubectl get events --field-selector involvedObject.name<span>=</span>mariadb-galera --sort-by<span>=</span><span>'.lastTimestamp'</span>
LAST SEEN   TYPE      REASON                    OBJECT                       MESSAGE
...
16m         Warning   GaleraClusterNotHealthy   mariadb/mariadb-galera       Galera cluster is not healthy
16m         Normal    GaleraPodStateFetched     mariadb/mariadb-galera       Galera state fetched in Pod <span>'mariadb-galera-2'</span>
16m         Normal    GaleraPodStateFetched     mariadb/mariadb-galera       Galera state fetched in Pod <span>'mariadb-galera-1'</span>
16m         Normal    GaleraPodStateFetched     mariadb/mariadb-galera       Galera state fetched in Pod <span>'mariadb-galera-0'</span>
16m         Normal    GaleraPodRecovered        mariadb/mariadb-galera       Recovered Galera sequence in Pod <span>'mariadb-galera-1'</span>
16m         Normal    GaleraPodRecovered        mariadb/mariadb-galera       Recovered Galera sequence in Pod <span>'mariadb-galera-2'</span>
17m         Normal    GaleraPodRecovered        mariadb/mariadb-galera       Recovered Galera sequence in Pod <span>'mariadb-galera-0'</span>
17m         Normal    GaleraClusterBootstrap    mariadb/mariadb-galera       Bootstrapping Galera cluster in Pod <span>'mariadb-galera-2'</span>
20m         Normal    GaleraClusterHealthy      mariadb/mariadb-galera       Galera cluster is healthy
</pre></div>


<ul>
<li>Enable <code>debug</code> logs in <code>mariadb-enterprise-operator</code>.</li>
</ul>
<div><pre><span></span>helm upgrade --install mariadb-enterprise-operator mariadb-enterprise-operator/mariadb-enterprise-operator --set <span>logLevel</span><span>=</span>debug
kubectl logs mariadb-enterprise-operator-546c78f4f5-gq44k
<span>{</span><span>"level"</span>:<span>"info"</span>,<span>"ts"</span>:1691090524.4911606,<span>"logger"</span>:<span>"galera.health"</span>,<span>"msg"</span>:<span>"Checking Galera cluster health"</span>,<span>"controller"</span>:<span>"statefulset"</span>,<span>"controllerGroup"</span>:<span>"apps"</span>,<span>"controllerKind"</span>:<span>"StatefulSet"</span>,<span>"statefulSet"</span>:<span>{</span><span>"name"</span>:<span>"mariadb-galera"</span>,<span>"namespace"</span>:<span>"default"</span><span>}</span>,<span>"namespace"</span>:<span>"default"</span>,<span>"name"</span>:<span>"mariadb-galera"</span>,<span>"reconcileID"</span>:<span>"098620db-4486-45cc-966a-9f3fec0d165e"</span><span>}</span>
<span>{</span><span>"level"</span>:<span>"debug"</span>,<span>"ts"</span>:1691090524.4911761,<span>"logger"</span>:<span>"galera.health"</span>,<span>"msg"</span>:<span>"StatefulSet ready replicas"</span>,<span>"controller"</span>:<span>"statefulset"</span>,<span>"controllerGroup"</span>:<span>"apps"</span>,<span>"controllerKind"</span>:<span>"StatefulSet"</span>,<span>"statefulSet"</span>:<span>{</span><span>"name"</span>:<span>"mariadb-galera"</span>,<span>"namespace"</span>:<span>"default"</span><span>}</span>,<span>"namespace"</span>:<span>"default"</span>,<span>"name"</span>:<span>"mariadb-galera"</span>,<span>"reconcileID"</span>:<span>"098620db-4486-45cc-966a-9f3fec0d165e"</span>,<span>"replicas"</span>:1<span>}</span>
</pre></div>


<ul>
<li>Get the logs of all the <code>MariaDB</code> <code>Pod</code> containers, not only of the main <code>mariadb</code> container but also the <code>agent</code> and <code>init</code> ones.</li>
</ul>
<div><pre><span></span>kubectl logs mariadb-galera-0 -c init
<span>{</span><span>"level"</span>:<span>"info"</span>,<span>"ts"</span>:1691090778.5239124,<span>"msg"</span>:<span>"Starting init"</span><span>}</span>
<span>{</span><span>"level"</span>:<span>"info"</span>,<span>"ts"</span>:1691090778.5305626,<span>"msg"</span>:<span>"Configuring Galera"</span><span>}</span>
<span>{</span><span>"level"</span>:<span>"info"</span>,<span>"ts"</span>:1691090778.5307593,<span>"msg"</span>:<span>"Already initialized. Init done"</span><span>}</span>

kubectl logs mariadb-galera-0 -c agent
<span>{</span><span>"level"</span>:<span>"info"</span>,<span>"ts"</span>:1691090779.3193653,<span>"logger"</span>:<span>"server"</span>,<span>"msg"</span>:<span>"server listening"</span>,<span>"addr"</span>:<span>":5555"</span><span>}</span>
2023/08/03 19:26:28 <span>"POST http://mariadb-galera-0.mariadb-galera-internal.default.svc.cluster.local:5555/api/recovery HTTP/1.1"</span> from 10.244.4.2:39162 - <span>200</span> 58B in 4.112086ms
2023/08/03 19:26:28 <span>"DELETE http://mariadb-galera-0.mariadb-galera-internal.default.svc.cluster.local:5555/api/recovery HTTP/1.1"</span> from 10.244.4.2:39162 - <span>200</span> 0B in 883.544µs

kubectl logs mariadb-galera-0 -c mariadb
2023-08-03 19:27:10 <span>0</span> <span>[</span>Note<span>]</span> WSREP: Member 2.0 <span>(</span>mariadb-galera-0<span>)</span> synced with group.
2023-08-03 19:27:10 <span>0</span> <span>[</span>Note<span>]</span> WSREP: Processing event queue:...100.0% <span>(</span>1/1 events<span>)</span> complete.
2023-08-03 19:27:10 <span>0</span> <span>[</span>Note<span>]</span> WSREP: Shifting JOINED -&gt; SYNCED <span>(</span>TO: 6<span>)</span>
2023-08-03 19:27:10 <span>2</span> <span>[</span>Note<span>]</span> WSREP: Server mariadb-galera-0 synced with group
2023-08-03 19:27:10 <span>2</span> <span>[</span>Note<span>]</span> WSREP: Server status change joined -&gt; synced
2023-08-03 19:27:10 <span>2</span> <span>[</span>Note<span>]</span> WSREP: Synchronized with group, ready <span>for</span> connections
</pre></div>


<p>Once you are done with these steps, you will have the context required to jump ahead to the <a href="#common-errors">Common errors</a> section to see if any of them matches your case.</p>
<h3 id="common-errors">Common errors</h3>
<h4 id="galera-cluster-recovery-not-progressing">Galera cluster recovery not progressing</h4>
<p>If your <code>MariaDB</code> Galera cluster has been in <code>GaleraNotReady</code> state for a long time, the recovery process might not be progressing. You can diagnose this by checking:</p>
<ul>
<li>Operator logs.</li>
<li>Galera recovery status:</li>
</ul>
<div><pre><span></span>kubectl get mariadb mariadb-galera -o <span>jsonpath</span><span>=</span><span>"{.status.galeraRecovery}"</span> <span>|</span> jq
</pre></div>


<ul>
<li><code>MariaDB</code> events:</li>
</ul>
<div><pre><span></span>kubectl get events --field-selector involvedObject.name<span>=</span>mariadb-galera
</pre></div>


<ul>
<li>If you have <code>Pods</code> named <code>&lt;mariadb-name&gt;-&lt;ordinal&gt;-recovery-&lt;suffix&gt;</code> running for a long time, check its logs to understand if something is wrong.</li>
</ul>
<p>One of the reasons could be misconfigured Galera recovery <code>Jobs</code>, please make sure you read <a href="#galera-recovery-job">this section</a>. If after checking all the points above, there are still no clear symptoms of what could be wrong, continue reading.</p>
<p>First af all, you could attempt to forcefully bootstrap a new cluster as it is described in <a href="#force-cluster-bootstrap">this section</a>. Please, refrain from doing so if the conditions described in the docs are not met.</p>
<p>Alternatively, if you can afford some downtime and your PVCs are in healthy state, you may follow this procedure:</p>
<ul>
<li>Delete your existing <code>MariaDB</code>, this will leave your PVCs intact.</li>
<li>Create your <code>MariaDB</code> again, this will trigger a Galera recovery process as described in <a href="#bootstrap-galera-cluster-from-existing-pvcs">this section</a>.</li>
</ul>
<p>As a last resource, you can always delete the PVCs and bootstrap a new <code>MariaDB</code> from a backup as documented <a href="./BACKUP.md#bootstrap-new-mariadb-instances">here</a>.</p>
<h4 id="permission-denied-writing-galera-configuration">Permission denied writing Galera configuration</h4>
<p>This error occurs when the user that runs the container does not have enough privileges to write in <code>/etc/mysql/mariadb.conf.d</code>:</p>
<div><pre><span></span> Error writing Galera config: open /etc/mysql/mariadb.conf.d/0-galera.cnf: permission denied
</pre></div>


<p>To mitigate this, by default, the operator sets the following <code>securityContext</code> in the <code>MariaDB</code>'s <code>StatefulSet</code> :</p>
<div><pre><span></span><span>apiVersion</span><span>:</span> <span>apps/v1</span>
<span>kind</span><span>:</span> <span>StatefulSet</span>
<span>metadata</span><span>:</span>
  <span>name</span><span>:</span> <span>mariadb-galera</span>
<span>spec</span><span>:</span>
  <span>securityContext</span><span>:</span>
    <span>fsGroup</span><span>:</span> <span>999</span>
    <span>runAsGroup</span><span>:</span> <span>999</span>
    <span>runAsNonRoot</span><span>:</span> <span>true</span>
    <span>runAsUser</span><span>:</span> <span>999</span>
</pre></div>


<p>This enables the <code>CSIDriver</code> and the kubelet to recursively set the ownership ofr the <code>/etc/mysql/mariadb.conf.d</code> folder to the group <code>999</code>, which is the one expected by MariaDB. It is important to note that not all the <code>CSIDrivers</code> implementations support this feature, see the <a href="https://kubernetes-csi.github.io/docs/support-fsgroup.html">CSIDriver documentation</a> for further information.</p>
<h4 id="unauthorized-error-disabling-bootstrap">Unauthorized error disabling bootstrap</h4>
<div><pre><span></span>Error reconciling Galera: error disabling bootstrap in Pod 0: unauthorized
</pre></div>


<p>This situation occurs when the <code>mariadb-enterprise-operator</code> credentials passed to the <code>agent</code> as authentication are either invalid or the <code>agent</code> is unable to verify them. To confirm this, ensure that both the <code>mariadb-enterprise-operator</code> and the <code>MariaDB</code> <code>ServiceAccounts</code> are able to create <code>TokenReview</code> objects:</p>
<div><pre><span></span>kubectl auth can-i --list --as<span>=</span>system:serviceaccount:default:mariadb-enterprise-operator <span>|</span> grep tokenreview
tokenreviews.authentication.k8s.io              <span>[]</span>                                    <span>[]</span>               <span>[</span>create<span>]</span>

kubectl auth can-i --list --as<span>=</span>system:serviceaccount:default:mariadb-galera <span>|</span> grep tokenreview
tokenreviews.authentication.k8s.io              <span>[]</span>                                    <span>[]</span>               <span>[</span>create<span>]</span>
</pre></div>


<p>If that's not the case, check that the following <code>ClusterRole</code> and <code>ClusterRoleBindings</code> are available in your cluster:</p>
<div><pre><span></span>kubectl get clusterrole system:auth-delegator
NAME                    CREATED AT
system:auth-delegator   2023-08-03T19:12:37Z

kubectl get clusterrolebinding <span>|</span> grep mariadb <span>|</span> grep auth-delegator
mariadb-galera:auth-delegator                     ClusterRole/system:auth-delegator                                                  108m
mariadb-enterprise-operator:auth-delegator                        ClusterRole/system:auth-delegator                                                  112m
</pre></div>


<p><code>mariadb-enterprise-operator:auth-delegator</code> is the <code>ClusterRoleBinding</code> bound to the <code>mariadb-enterprise-operator</code> <code>ServiceAccount</code> which is created by the helm chart, so you can re-install the helm release in order to recreate it:</p>
<div><pre><span></span> helm upgrade --install mariadb-enterprise-operator mariadb-enterprise-operator/mariadb-enterprise-operator
</pre></div>


<p><code>mariadb-galera:auth-delegator</code> is the <code>ClusterRoleBinding</code> bound to the <code>mariadb-galera</code> <code>ServiceAccount</code> which is created on the flight by the operator as part of the reconciliation logic. You may check the <code>mariadb-enterprise-operator</code> logs to see if there are any issues reconciling it.</p>
<p>Bear in mind that <code>ClusterRoleBindings</code> are cluster-wide resources that are not garbage collected when the <code>MariaDB</code> owner object is deleted, which means that creating and deleting <code>MariaDBs</code> could leave leftovers in your cluster. These leftovers can lead to RBAC misconfigurations, as the <code>ClusterRoleBinding</code> might not be pointing to the right <code>ServiceAccount</code>. To overcome this, you can override the <code>ClusterRoleBinding</code> name setting the <code>spec.galera.agent.kubernetesAuth.authDelegatorRoleName</code> field.</p>
<h4 id="timeout-waiting-for-pod-to-be-synced">Timeout waiting for Pod to be Synced</h4>
<div><pre><span></span>Timeout waiting <span>for</span> Pod <span>'mariadb-galera-2'</span> to be Synced
</pre></div>


<p>This error appears in the <code>mariadb-enterprise-operator</code> logs when a <code>Pod</code> is in non synced state for a duration exceeding the <code>spec.galera.recovery.podRecoveryTimeout</code>. Just after, the operator will restart the <code>Pod</code>.</p>
<p>Increase this timeout if you consider that your <code>Pod</code> may take longer to recover.</p>
<h4 id="galera-cluster-bootstrap-timed-out">Galera cluster bootstrap timed out</h4>
<div><pre><span></span>Galera cluster bootstrap timed out. Resetting recovery status
</pre></div>


<p>This is error is returned by the <code>mariadb-enterprise-operator</code> after exceeding the <code>spec.galera.recovery.clusterBootstrapTimeout</code> when recovering the cluster. At this point, the operator will reset the recovered sequence numbers and start again from a clean state.</p>
<p>Increase this timeout if you consider that your Galera cluster may take longer to recover.</p>
    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/mariadb-enterprise-operator-galera-cluster/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/mariadb-enterprise-operator-galera-cluster/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/standalone-mariadb/">
                        ← Standalone MariaDB
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/mariadb-enterprise-operator/">
                        ↑ MariaDB Enterprise Operator ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/high-availability/">
                        High Availability →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="15884" data-comments-url="/kb/en/mariadb-enterprise-operator-galera-cluster/+comments"
         data-reply-url="/kb/en/mariadb-enterprise-operator-galera-cluster/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/mariadb-enterprise-operator/">
                    ↑ MariaDB Enterprise Operator ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/mariadb-enterprise-operator-introduction/">
                            
                            Introduction
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/customer-access-to-docker-mariadb-com/">
                            
                            Customer access to docker.mariadb.com
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/docker-images/">
                            
                            Docker Images
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-enterprise-operator-installation/">
                            
                            MariaDB Enterprise Operator Installation
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/quickstart/">
                            
                            Quickstart
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/standalone-mariadb/">
                            
                            Standalone MariaDB
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Galera Cluster</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/high-availability/">
                            
                            High Availability
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/maxscale-database-proxy/">
                            
                            MaxScale Database Proxy
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/backup-and-restore/">
                            
                            Backup and Restore
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-enterprise-operator-storage/">
                            
                            Storage
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/tls/">
                            
                            TLS
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/configuration/">
                            
                            Configuration
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/updates/">
                            
                            Updates
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-enterprise-operator-metrics/">
                            
                            Metrics
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sql-resources/">
                            
                            SQL Resources
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/metadata/">
                            
                            Metadata
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/suspend-reconciliation/">
                            
                            Suspend Reconciliation
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/api-reference/">
                            
                            API Reference
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/examples-catalog/">
                            
                            Examples Catalog
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-enterprise-operator-migrations/">
                            
                            MariaDB Enterprise Operator Migrations
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-enterprise-operator-release-notes/">
                            
                            MariaDB Enterprise Operator Release Notes
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/solutions" title="Solutions">Solutions</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">Company</a></h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        
                        
                        <li>
                            <h5><a href="https://mariadb.com/downloads" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>