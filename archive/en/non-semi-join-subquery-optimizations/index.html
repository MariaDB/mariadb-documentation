<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Non-semi-join Subquery Optimizations - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.9a0d7dcebefd.css" rel="stylesheet" type="text/css" />

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Non-semi-join Subquery Optimizations" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/non-semi-join-subquery-optimizations/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Alternative strategies for IN-subqueries that cannot be flattened into semi-joins" />

    <meta name="description" content="Alternative strategies for IN-subqueries that cannot be flattened into semi-joins" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/non-semi-join-subquery-optimizations/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/non-semi-join-subquery-optimizations/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/replication-cluster-multi-master/">High Availability &amp; Performance Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/optimization-and-tuning/">Optimization and Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/query-optimizations/">Query Optimizations</a>
    

    
    » <a class="crumb" href="/kb/en/subquery-optimizations/">Subquery Optimizations</a>
    


    » <a class="node_link crumb" href="/kb/en/non-semi-join-subquery-optimizations/">Non-semi-join Subquery Optimizations</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/non-semi-join-subquery-optimizations/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/non-semi-join-subquery-optimizations/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/non-semi-join-subquery-optimizations/+flag"
                data-flag-url="/kb/en/non-semi-join-subquery-optimizations/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/non-semi-join-subquery-optimizations/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2011-07-29 10:28">12 years, 6 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2022-04-26 23:21">1 year, 9 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/non-semi-join-subquery-optimizations/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/non-semi-join-subquery-optimizations/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/non-semi-join-subquery-optimizations/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/non-semi-join-subquery-optimizations/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    
        

<div class="well well-small box"><div><h5>Localized Versions</h5></div><div>

        <ul>
            
            <li><a href="/kb/it/non-semi-join-subquery-optimizations/">Ottimizzazioni delle subquery non-semi-join</a> [it]</li>
            
        </ul>
        
</div>
</div>

    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Non-semi-join Subquery Optimizations</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#applicability" title="Applicability">Applicability</a>    <ol class="toc">

        <li class=""><a href="#subquery-in-a-disjunction-or" title="Subquery in a disjunction (OR)">Subquery in a disjunction (OR)</a></li>

        <li class=""><a href="#negated-subquery-predicate-not-in" title="Negated subquery predicate (NOT IN)">Negated subquery predicate (NOT IN)</a></li>

        <li class=""><a href="#subquery-in-the-select-or-having-clause" title="Subquery in the SELECT or HAVING clause">Subquery in the SELECT or HAVING clause</a></li>

        <li class=""><a href="#subquery-with-a-union" title="Subquery with a UNION">Subquery with a UNION</a>    </ol>
</li>

    <li class=""><a href="#materialization-for-non-correlated-in-subqueries" title="Materialization for non-correlated IN-subqueries">Materialization for non-correlated IN-subqueries</a>    <ol class="toc">

        <li class=""><a href="#materialization-basics" title="Materialization basics">Materialization basics</a></li>

        <li class=""><a href="#null-aware-efficient-execution" title="NULL-aware efficient execution">NULL-aware efficient execution</a></li>

        <li class=""><a href="#limitations" title="Limitations">Limitations</a>    </ol>
</li>

    <li class=""><a href="#the-in-to-exists-transformation" title="The IN-TO-EXISTS transformation">The IN-TO-EXISTS transformation</a></li>

    <li class=""><a href="#performance-discussion" title="Performance discussion">Performance discussion</a>    <ol class="toc">

        <li class=""><a href="#example-speedup-over-mysql-5x-and-mariadb-5152" title="Example speedup over MySQL 5.x and MariaDB 5.1/5.2">Example speedup over MySQL 5.x and MariaDB 5.1/5.2</a></li>

        <li class=""><a href="#performance-guidelines" title="Performance guidelines">Performance guidelines</a>    </ol>
</li>

    <li class=""><a href="#optimizer-control" title="Optimizer control">Optimizer control</a> </ol>
</li>
</div><p>
Certain kinds of IN-subqueries cannot be flattened into <a href="/kb/en/semi-join-subquery-optimizations/">semi-joins</a>. These
subqueries can be both correlated or non-correlated. In order to provide
consistent performance in all cases, MariaDB provides several alternative
strategies for these types of subqueries. Whenever several strategies are
possible, the optimizer chooses the optimal one based on cost estimates.</p>
<p>The two primary non-semi-join strategies are materialization (also called
outside-in materialization), and in-to-exists transformation. Materialization is
applicable only for non-correlated subqueries, while in-to-exist can be used
both for correlated and non-correlated subqueries.</p>
<h2 class="anchored_heading" id="applicability">Applicability</h2>
<p>An IN subquery cannot be flattened into a semi-join in the following cases.
The examples below use the <em>World</em> database from the MariaDB regression
test suite.</p>
<h3 class="anchored_heading" id="subquery-in-a-disjunction-or">Subquery in a disjunction (OR)</h3>
<p>The subquery is located directly or indirectly under an OR operation
in the WHERE clause of the outer query.</p>
<p>Query pattern:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="p">...</span> <span class="k">FROM</span> <span class="p">...</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">expr1</span><span class="p">,</span> <span class="p">...,</span> <span class="n">exprN</span><span class="p">)</span> <span class="p">[</span><span class="k">NOT</span><span class="p">]</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">...</span> <span class="p">)</span> <span class="k">OR</span> <span class="n">expr</span><span class="p">;</span>
</pre><p>Example:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="n">Name</span> <span class="k">FROM</span> <span class="n">Country</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">Code</span> <span class="k">IN</span> <span class="p">(</span><span class="k">select</span> <span class="n">Country</span> <span class="k">from</span> <span class="n">City</span> <span class="k">where</span> <span class="n">City</span><span class="p">.</span><span class="n">Population</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="k">OR</span>
       <span class="n">Name</span> <span class="k">LIKE</span> <span class="s1">&#39;L%&#39;</span><span class="p">)</span> <span class="k">AND</span>
      <span class="n">surfacearea</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">;</span>
</pre><h3 class="anchored_heading" id="negated-subquery-predicate-not-in">Negated subquery predicate (NOT IN)</h3>
<p>The subquery predicate itself is negated.</p>
<p>Query pattern:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="p">...</span> <span class="k">FROM</span> <span class="p">...</span> <span class="k">WHERE</span> <span class="p">...</span> <span class="p">(</span><span class="n">expr1</span><span class="p">,</span> <span class="p">...,</span> <span class="n">exprN</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">...</span> <span class="p">)</span> <span class="p">...;</span>
</pre><p>Example:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="n">Country</span><span class="p">.</span><span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Country</span><span class="p">,</span> <span class="n">CountryLanguage</span> 
<span class="k">WHERE</span> <span class="n">Code</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">Country</span> <span class="k">FROM</span> <span class="n">CountryLanguage</span> <span class="k">WHERE</span> <span class="k">Language</span> <span class="o">=</span> <span class="s1">&#39;English&#39;</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">CountryLanguage</span><span class="p">.</span><span class="k">Language</span> <span class="o">=</span> <span class="s1">&#39;French&#39;</span>
  <span class="k">AND</span> <span class="n">Code</span> <span class="o">=</span> <span class="n">Country</span><span class="p">;</span>
</pre><h3 class="anchored_heading" id="subquery-in-the-select-or-having-clause">Subquery in the SELECT or HAVING clause</h3>
<p>The subquery is located in the SELECT or HAVING clauses of the outer query.</p>
<p>Query pattern:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="n">field1</span><span class="p">,</span> <span class="p">...,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">...)</span>  <span class="k">WHERE</span> <span class="p">...;</span>
<span class="k">SELECT</span> <span class="p">...</span>  <span class="k">WHERE</span> <span class="p">...</span> <span class="k">HAVING</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">...);</span>
</pre><p>Example:</p>
<pre class="fixed"><span class="k">select</span> <span class="n">Name</span><span class="p">,</span> <span class="n">City</span><span class="p">.</span><span class="n">id</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">capital</span> <span class="k">from</span> <span class="n">Country</span> <span class="k">where</span> <span class="n">capital</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span> <span class="k">as</span> <span class="n">is_capital</span>
<span class="k">from</span> <span class="n">City</span>
<span class="k">where</span> <span class="n">City</span><span class="p">.</span><span class="n">population</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">;</span>
</pre><h3 class="anchored_heading" id="subquery-with-a-union">Subquery with a UNION</h3>
<p>The subquery itself is a UNION, while the IN predicate may be anywhere in the
query where IN is allowed.</p>
<p>Query pattern:</p>
<pre class="fixed"><span class="p">...</span> <span class="p">[</span><span class="k">NOT</span><span class="p">]</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="p">...</span> <span class="k">UNION</span> <span class="k">SELECT</span> <span class="p">...)</span>
</pre><p>Example:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">City</span> <span class="k">where</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="mi">91</span><span class="p">)</span> <span class="k">IN</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">Name</span><span class="p">,</span> <span class="n">round</span><span class="p">(</span><span class="n">Population</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">City</span> <span class="k">WHERE</span> <span class="n">Country</span> <span class="o">=</span> <span class="ss">&quot;IND&quot;</span> <span class="k">AND</span> <span class="n">Population</span> <span class="o">&gt;</span> <span class="mi">2500000</span>
<span class="k">UNION</span>
 <span class="k">SELECT</span> <span class="n">Name</span><span class="p">,</span> <span class="n">round</span><span class="p">(</span><span class="n">Population</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">City</span> <span class="k">WHERE</span> <span class="n">Country</span> <span class="o">=</span> <span class="ss">&quot;IND&quot;</span> <span class="k">AND</span> <span class="n">Population</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">);</span>
</pre><h2 class="anchored_heading" id="materialization-for-non-correlated-in-subqueries">Materialization for non-correlated IN-subqueries</h2>
<h3 class="anchored_heading" id="materialization-basics">Materialization basics</h3>
<p>The basic idea of subquery materialization is to execute the subquery and store
its result in an internal temporary table indexed on all its
columns. Naturally, this is possible only when the subquery is
non-correlated. The IN predicate tests whether its left operand is present in
the subquery result. Therefore it is not necessary to store duplicate subquery
result rows in the temporary table. Storing only unique subquery rows provides
two benefits - the size of the temporary table is smaller, and the index on all
its columns can be unique.</p>
<p>If the size of the temporary table is less than the tmp_table_size system
variable, the table is a hash-indexed in-memory HEAP table. In the rare cases
when the subquery result exceeds this limit, the temporary table is stored on
disk in an ARIA or MyISAM B-tree indexed table (ARIA is the default).</p>
<p>Subquery materialization happens on demand during the first execution of the IN
predicate. Once the subquery is materialized, the IN predicate is evaluated
very efficiently by index lookups of the outer expression into the unique index
of the materialized temporary table. If there is a match, IN is TRUE, otherwise
IN is FALSE.</p>
<h3 class="anchored_heading" id="null-aware-efficient-execution">NULL-aware efficient execution</h3>
<p>An IN predicate may produce a NULL result if there is a NULL value in either of
its arguments. Depending on its location in a query, a NULL predicate value is
equivalent to FALSE. These are the cases when substituting NULL with FALSE
would reject exactly the same result rows. A NULL result of IN is
indistinguishable from a FALSE if the IN predicate is:</p>
<ul start="1"><li>not negated,
</li><li>not a function argument,
</li><li>inside a WHERE or ON clause.
</li></ul>
<p>In all these cases the evaluation of IN is performed as described in the
previous paragraph via index lookups into the materialized subquery. In all
remaining cases when NULL cannot be substituted with FALSE, it is not possible
to use index lookups. This is not a limitation in the server, but a consequence
of the NULL semantics in the ANSI SQL standard.</p>
<p>Suppose an IN predicate is evaluated as </p><pre class="fixed"><span class="k">NULL</span> <span class="k">IN</span> <span class="p">(</span><span class="k">select</span>
<span class="n">not_null_col</span> <span class="k">from</span> <span class="n">t1</span><span class="p">)</span>
</pre><p>, that is, the left operand of IN is a NULL value,
and there are no NULLs in the subquery. In this case the value of IN is neither
FALSE, nor TRUE. Instead it is NULL. If we were to perform an index lookup with
the NULL as a key, such a value would not be found in not_null_col, and the IN
predicate would incorrectly produce a FALSE.</p>
<p>In general, an NULL value on either side of an IN acts as a "wildcard" that
matches any value, and if a match exists, the result of IN is NULL. Consider
the following example:</p>
<p>If the left argument of IN is the row: <code class="fixed" style="white-space:pre-wrap"><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</code>,
and the result of the right subquery operand of IN is the table:</p>
<pre class="fixed"><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span><span class="p">)</span>
<span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</pre><p>The the IN predicate matches the row <code class="fixed" style="white-space:pre-wrap"><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</code>,
and the result of IN is NULL. Matches where the differing values on either
side of the IN arguments are matched by a NULL in the other IN argument, are
called <em>partial matches</em>.</p>
<p>In order to efficiently compute the result of an IN predicate in the presence
of NULLs, MariaDB implements two special algorithms for
<a href="http://askmonty.org/worklog/Server-Sprint/?tid=68">partial matching, described
here in detail</a>.</p>
<ul start="1"><li>Rowid-merge partial matching<br>
This technique is used when the number of rows in the subquery result is above
a certain limit. The technique creates special indexes on some of the columns
of the temporary table, and merges them by alternative scanning of each index
thus performing an operation similar to set-intersection.
</li></ul>
<ul start="1"><li>Table scan partial matching<br>
This algorithm is used for very small tables when the overhead of the
rowid-merge algorithm is not justifiable. Then the server simply scans the
materialized subquery, and checks for partial matches. Since this strategy
doesn't need any in-memory buffers, it is also used when there is not
enough memory to hold the indexes of the rowid-merge strategy.
</li></ul>
<h3 class="anchored_heading" id="limitations">Limitations</h3>
<p>In principle the subquery materialization strategy is universal, however, due to
some technical limitations in the MariaDB server, there are few cases when the
server cannot apply this optimization. </p>
<ul start="1"><li>BLOB fields<br>
Either the left operand of an IN predicate refers to a BLOB field, or the subquery
selects one or more BLOBs.
</li></ul>
<ul start="1"><li>Incomparable fields<br>
TODO
</li></ul>
<p>In the above cases, the server reverts to the
<a href="/kb/en/non-semi-join-subquery-optimizations/#the-in-to-exists-transformation">IN-TO-EXISTS</a>
transformation.</p>
<h2 class="anchored_heading" id="the-in-to-exists-transformation">The IN-TO-EXISTS transformation</h2>
<p>This optimization is the only subquery execution strategy that existed in older
versions of MariaDB and MySQL prior to <a href="/kb/en/what-is-mariadb-53/">MariaDB 5.3</a>. We have made various
changes and fixed a number of bugs in this code as well, but in essence it
remains the same.</p>
<h2 class="anchored_heading" id="performance-discussion">Performance discussion</h2>
<h3 class="anchored_heading" id="example-speedup-over-mysql-5x-and-mariadb-5152">Example speedup over MySQL 5.x and <a href="/kb/en/what-is-mariadb-51/">MariaDB 5.1</a>/5.2</h3>
<p>Depending on the query and data, either of the two strategies described here
may result in orders of magnitude better/worse plan than the other strategy.</p>
<p>Older versions of MariaDB and any current MySQL version (including MySQL 5.5,
and MySQL 5.6 DMR as of July 2011) implement only the IN-TO-EXISTS
transformation. As illustrated below, this strategy is inferior in many
common cases to subquery materialization.</p>
<p>Consider the following query over the data of the DBT3 benchmark scale 10.
Find customers with top balance in their nations:</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">part</span>
<span class="k">WHERE</span> <span class="n">p_partkey</span> <span class="k">IN</span>
      <span class="p">(</span><span class="k">SELECT</span> <span class="n">l_partkey</span> <span class="k">FROM</span> <span class="n">lineitem</span>
       <span class="k">WHERE</span> <span class="n">l_shipdate</span> <span class="k">between</span> <span class="s1">&#39;1997-01-01&#39;</span> <span class="k">and</span> <span class="s1">&#39;1997-02-01&#39;</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">p_retailprice</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre><p>The times to run this query is as follows:</p>
<ul start="1"><li>Execution time in <a href="/kb/en/what-is-mariadb-52/">MariaDB 5.2</a>/MySQL 5.x (any MySQL): <strong>&gt; 1 h</strong><br>
  The query takes more than one hour (we didn't wait longer), which makes it
  impractical to use subqueries in such cases. The EXPLAIN below shows that
  the subquery was transformed into a correlated one, which indicates an
  IN-TO-EXISTS transformation.<br>
</li></ul>
<pre class="fixed wrap">+--+------------------+--------+--------------+-------------------+----+------+---------------------------+
|id|select_type       |table   |type          |key                |ref |rows  |Extra                      |
+--+------------------+--------+--------------+-------------------+----+------+---------------------------+
| 1|PRIMARY           |part    |ALL           |NULL               |NULL|199755|Using where; Using filesort|
| 2|DEPENDENT SUBQUERY|lineitem|index_subquery|i_l_suppkey_partkey|func|    14|Using where                |
+--+------------------+--------+--------------+-------------------+----+------+---------------------------+
</pre><ul start="1"><li>Execution time in <a href="/kb/en/what-is-mariadb-53/">MariaDB 5.3</a>: <strong>43 sec</strong><br>
  In <a href="/kb/en/what-is-mariadb-53/">MariaDB 5.3</a> it takes less than a minute to run the same query.
  The EXPLAIN shows that the subquery remains uncorrelated, which is an indication that
  it is being executed via subquery materialization.<br>
</li></ul>
<pre class="fixed">+--+------------+-----------+------+------------------+----+------+-------------------------------+
|id|select_type |table      |type  |key               |ref |rows  |Extra                          |
+--+------------+-----------+------+------------------+----+------+-------------------------------+
| 1|PRIMARY     |part       |ALL   |NULL              |NULL|199755|Using temporary; Using filesort|
| 1|PRIMARY     |&lt;subquery2&gt;|eq_ref|distinct_key      |func|     1|                               |
| 2|MATERIALIZED|lineitem   |range |l_shipdate_partkey|NULL|160060|Using where; Using index       |
+--+------------+-----------+------+------------------+----+------+-------------------------------+
</pre><p>The speedup here is practically infinite, because both MySQL and older MariaDB
versions cannot complete the query in any reasonable time.</p>
<p>In order to show the benefits of partial matching we extended the <em>customer</em>
table from the DBT3 benchmark with two extra columns:</p>
<ul start="1"><li>c_pref_nationkey - preferred nation to buy from,
</li><li>c_pref_brand - preferred brand.
</li></ul>
<p>Both columns are prefixed with the percent NULL values in the column, that is,
c_pref_nationkey_05 contains 5% NULL values.</p>
<p>Consider the query "Find all customers that didn't buy from a preferred
country, and from a preferred brand withing some date ranges":</p>
<pre class="fixed"><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">customer</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">c_custkey</span><span class="p">,</span> <span class="n">c_pref_nationkey_05</span><span class="p">,</span> <span class="n">c_pref_brand_05</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">IN</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">o_custkey</span><span class="p">,</span> <span class="n">s_nationkey</span><span class="p">,</span> <span class="n">p_brand</span>
   <span class="k">FROM</span> <span class="n">orders</span><span class="p">,</span> <span class="n">supplier</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">lineitem</span>
   <span class="k">WHERE</span> <span class="n">l_orderkey</span> <span class="o">=</span> <span class="n">o_orderkey</span> <span class="k">and</span>
         <span class="n">l_suppkey</span> <span class="o">=</span> <span class="n">s_suppkey</span> <span class="k">and</span>
         <span class="n">l_partkey</span> <span class="o">=</span> <span class="n">p_partkey</span> <span class="k">and</span>
         <span class="n">p_retailprice</span> <span class="o">&lt;</span> <span class="mi">1200</span> <span class="k">and</span>
         <span class="n">l_shipdate</span> <span class="o">&gt;=</span> <span class="s1">&#39;1996-04-01&#39;</span> <span class="k">and</span> <span class="n">l_shipdate</span> <span class="o">&lt;</span> <span class="s1">&#39;1996-04-05&#39;</span> <span class="k">and</span>
         <span class="n">o_orderdate</span> <span class="o">&gt;=</span> <span class="s1">&#39;1996-04-01&#39;</span> <span class="k">and</span> <span class="n">o_orderdate</span> <span class="o">&lt;</span> <span class="s1">&#39;1996-04-05&#39;</span><span class="p">);</span>
</pre><ul start="1"><li>Execution time in <a href="/kb/en/what-is-mariadb-52/">MariaDB 5.2</a>/MySQL 5.x (any MySQL): <strong>40 sec</strong>
</li><li>Execution time in <a href="/kb/en/what-is-mariadb-53/">MariaDB 5.3</a>: <strong>2 sec</strong>
</li></ul>
<p>The speedup for this query is 20 times.</p>
<h3 class="anchored_heading" id="performance-guidelines">Performance guidelines</h3>
<p>  TODO</p>
<h2 class="anchored_heading" id="optimizer-control">Optimizer control</h2>
<p>In certain cases it may be necessary to override the choice of the optimizer.
Typically this is needed for benchmarking or testing purposes, or to mimic the
behavior of an older version of the server, or if the optimizer made a poor
choice.</p>
<p>All the above strategies can be controlled via the following switches in
<a href="/kb/en/server-system-variables/#optimizer_switch">optimizer_switch</a> system variable.</p>
<ul start="1"><li>materialization=on/off<br>
In some very special cases, even if materialization was forced, the optimizer
may still revert to the IN-TO-EXISTS strategy if materialization is not
applicable. In the cases when materialization requres partial matching (because
of the presense of NULL values), there are two subordinate switches that
control the two partial matching strategies:<br>
<ul start="1"><li>partial_match_rowid_merge=on/off<br>
   This switch controls the Rowid-merge strategy. In addition to this switch,
   the system variable <a href="/kb/en/server-system-variables/#rowid_merge_buff_size">rowid_merge_buff_size</a> controls the
   maximum memory available to the Rowid-merge strategy. 
</li><li>partial_match_table_scan=on/off<br>
   Controls the alternative partial match strategy that performs matching
   via a table scan.
</li></ul>
</li></ul>
<ul start="1"><li>in_to_exists=on/off<br>
This switch controls the IN-TO-EXISTS transformation.
</li></ul>
<ul start="1"><li>tmp_table_size and max_heap_table_size system variables<br>
  The <em>tmp_table_size</em> system variable sets the upper limit for internal
  MEMORY temporary tables. If an internal temporary table exceeds this size, it
  is converted automatically into a Aria or MyISAM table on disk with a B-tree
  index. Notice however, that a MEMORY table cannot be larger than
  <em>max_heap_table_size</em>.
</li></ul>
<p>The two main optimizer switches - <em>materialization</em> and <em>in_to_exists</em>
cannot be simultaneously off. If both are set to off, the server will
issue an error.</p>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/non-semi-join-subquery-optimizations/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/non-semi-join-subquery-optimizations/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/table-pullout-optimization/">
                        ← Table Pullout Optimization
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/subquery-optimizations/">
                        ↑ Subquery Optimizations ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/subquery-cache/">
                        Subquery Cache →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="1731" data-comments-url="/kb/en/non-semi-join-subquery-optimizations/+comments"
         data-reply-url="/kb/en/non-semi-join-subquery-optimizations/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/subquery-optimizations/">
                    ↑ Subquery Optimizations ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/subquery-optimizations-map/">
                            
                            Subquery Optimizations Map
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/semi-join-subquery-optimizations/">
                            
                            Semi-join Subquery Optimizations
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/table-pullout-optimization/">
                            
                            Table Pullout Optimization
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Non-semi-join Subquery Optimizations</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/subquery-cache/">
                            
                            Subquery Cache
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/condition-pushdown-into-in-subqueries/">
                            
                            Condition Pushdown Into IN subqueries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/conversion-of-big-in-predicates-into-subqueries/">
                            
                            Conversion of Big IN Predicates Into Subqueries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/exists-to-in-optimization/">
                            
                            EXISTS-to-IN Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizing-group-by/">
                            
                            Optimizing GROUP BY and DISTINCT Clauses in Subqueries
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row row-10">
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/products" title="Products">Products</a>
                    </h5>
                    <ul>
                        <li id="menu-item-7816" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7816"><a href="https://mariadb.com/products/mariadb-platform/">MariaDB Platform</a></li>
                        <li id="menu-item-7815" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7815"><a href="https://mariadb.com/products/skysql/">MariaDB SkySQL</a></li>
                        <li id="menu-item-4172" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4172"><a href="https://mariadb.com/pricing/">Pricing</a></li>
                        <li id="menu-item-4163" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4163"><a href="https://mariadb.com/downloads/">Download MariaDB</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/services" title="Services">Services</a>
                    </h5>
                    <ul>
                        <li id="menu-item-4169" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4169"><a href="https://mariadb.com/services/remote-dba/">Remote DBA</a></li>
                        <li id="menu-item-41691" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4169"><a href="https://mariadb.com/services/skydba/">SkyDBA</a></li>
                        <li id="menu-item-4167" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4167"><a href="https://mariadb.com/services/enterprise-architect/">Enterprise Architect</a></li>
                        <li id="menu-item-4170" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4170"><a href="https://mariadb.com/services/technical-support-services/">Technical Support</a></li>
                        <li id="menu-item-4168" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4168"><a href="https://mariadb.com/services/migration-practice/">Migration Practice</a></li>
                        <li id="menu-item-4166" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4166"><a href="https://mariadb.com/services/consulting/">Consulting</a></li>
                        <li id="menu-item-4171" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4171"><a href="https://mariadb.com/services/training/">Training</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/resources" title="Resources">Resources</a>
                    </h5>
                    <ul>
                        <li id="menu-item-41751" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/docs/">Documentation</a></li>
                        <li id="menu-item-41752" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/developers/">Developers</a></li>
                        <li id="menu-item-4175" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/resources/blog/">Blog</a></li>
                        <li id="menu-item-5462" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5462"><a href="https://support.mariadb.com">Support</a></li>
                        <li id="menu-item-6004" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6004"><a href="https://mariadb.com/openworks/">OpenWorks</a></li>
                        <li id="menu-item-60041" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6004"><a href="https://mariadb.com/resources/customer-stories/">Customer Stories</a></li>
                        <li id="menu-item-7817" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-7817"><a href="https://mariadb.com/resources/events/">Events</a></li>
                        <li id="menu-item-4177" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4177"><a href="https://mariadb.com/roadshow/">MariaDB Roadshow</a></li>
                    </ul>
                </div>
                <div class="visible-xs visible-sm clear"></div>
                <div class="col-md-2 col-xs-5 item">
                    <h5>
                        <a href="/about-us" title="About MariaDB">About</a>
                    </h5>
                    <ul>
                        <li id="menu-item-4173" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4173"><a href="https://mariadb.com/contact/">Contact</a></li>
                        <li id="menu-item-4161" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4161"><a href="https://mariadb.com/about-us/leadership/">Leadership</a></li>
                        <li id="menu-item-4162" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4162"><a href="https://mariadb.com/about-us/partners/">Partners</a></li>
                        <li id="menu-item-4174" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4174"><a href="https://mariadb.com/newsroom/">Newsroom</a></li>
                        <li id="menu-item-4160" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4160"><a href="https://mariadb.com/about-us/investors/">Investors</a></li>
                        <li id="menu-item-4159" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/about-us/careers/">Careers</a></li>
                        <li id="menu-item-41591" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/trust/">Trust Center</a></li>
                        <li id="menu-item-41592" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/vulnerability-reporting/">Vulnerability Reporting</a></li>
                    </ul>
                </div>
                <div class="col-md-4 col-xs-7 item">
                    <div id="block-footercontact" class="block block-block-content block-block-content22b3af28-0754-44ec-a5c6-4466568f37e3">
                        <h5><a href="/contact" title="Contact">Contact</a></h5>
                    </div>
                    <div class="social">
                        <ul class="list-inline">
                            <li>
                                <a target="_blank" href="https://www.facebook.com/MariaDB.dbms/" title="Facebook">
                                    <i class="fa fa-facebook" aria-hidden="true"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="https://twitter.com/mariadb" title="Twitter">
                                    <i class="fa fa-twitter" aria-hidden="true"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="https://www.linkedin.com/company/mariadb-corporation?trk=company_logo " title="LinkedIn">
                                    <i class="fa fa-linkedin" aria-hidden="true"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <p>Subscribe to our newsletter!</p>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container text-center">
            <ul class="list-inline no-margin">
                <li>
                    <a href="/legal" title="Legal">Legal</a>
                </li>
                <li>
                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                </li>
                <li>
                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                </li>
            </ul>
            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
        </div>
    </div>
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>