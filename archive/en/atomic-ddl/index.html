<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Atomic DDL - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Atomic DDL" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/atomic-ddl/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Making DDL Atomic/Crash-safe." />

    <meta name="description" content="Making DDL Atomic/Crash-safe." />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/atomic-ddl/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/atomic-ddl/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/using-mariadb-server/">Using MariaDB Server</a>
    

    
    » <a class="crumb" href="/kb/en/sql-statements-structure/">SQL Statements &amp; Structure</a>
    

    
    » <a class="crumb" href="/kb/en/sql-statements/">SQL Statements</a>
    

    
    » <a class="crumb" href="/kb/en/data-definition/">Data Definition</a>
    


    » <a class="node_link crumb" href="/kb/en/atomic-ddl/">Atomic DDL</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/atomic-ddl/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/atomic-ddl/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/atomic-ddl/+flag"
                data-flag-url="/kb/en/atomic-ddl/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/atomic-ddl/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2021-05-21 11:32">2 years, 9 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2022-06-13 12:17">1 year, 8 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/atomic-ddl/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/atomic-ddl/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/atomic-ddl/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/atomic-ddl/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Atomic DDL</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <p>From <a href="/kb/en/mariadb-1061-release-notes/">MariaDB 10.6.1</a>, we have improved readability for DDL (Data Definition Language) operations to make most of them atomic, and the rest crash-safe, even if the server crashes in the middle of an operation.</p>
<p>The design of Atomic/Crash-safe DDL (<a href="https://jira.mariadb.org/browse/MDEV-17567">MDEV-17567</a>) allows it to work with all storage engines.</p>
<h2 class="anchored_heading" id="definitions">Definitions</h2>
<ul start="1"><li>Atomic means that either the operation succeeds (and is logged to the <a href="/kb/en/binary-log/">binary log</a> or is completely reversed.
</li><li>Crash-safe means that in case of a crash, after the server has restarted, all tables are consistent, there are no temporary files or tables on disk and the binary log matches the status of the server.
</li><li>DDL Data definition language.
</li><li>DML Data manipulation language.
</li><li>'DDL recovery log' or 'DDL log' for short, is the new log file, <code>ddl_recovery.log</code> by default, that stores all DDL operations in progress. This is used to recover the state of the server in case of sudden crash.
</li></ul>
<h2 class="anchored_heading" id="background">Background</h2>
<p>Before 10.6, in case of a crash, there was a small possibility that one of the following things could happen:</p>
<ul start="1"><li>There could be temporary tables starting with <code class="fixed" style="white-space:pre-wrap">#sql-alter</code> or <code class="fixed" style="white-space:pre-wrap">#sql-shadow</code> or temporary files ending with '' left.
</li><li>The table in the storage engine and the table's .frm file could be out of sync.
</li><li>During a multi-table rename, only some of the tables were renamed.
</li></ul>
<h2 class="anchored_heading" id="which-ddl-operations-are-now-atomic">Which DDL Operations are Now Atomic</h2>
<ul start="1"><li><a href="/kb/en/create-table/">CREATE TABLE</a>, except when used with <a href="/kb/en/create-table/">CREATE OR REPLACE</a>, which is only crash safe.
</li><li><a href="/kb/en/rename-table/">RENAME TABLE</a> and <a href="/kb/en/rename-table/">RENAME TABLES</a>.
</li><li><a href="/kb/en/create-view/">CREATE VIEW</a>
</li><li><a href="/kb/en/create-sequence/">CREATE SEQUENCE</a>
</li><li><a href="/kb/en/create-trigger/">CREATE TRIGGER</a>
</li><li><a href="/kb/en/drop-trigger/">DROP TRIGGER</a>
</li><li><a href="/kb/en/drop-table/">DROP TABLE</a> and <a href="/kb/en/drop-view/">DROP VIEW</a>. Dropping multiple tables is only crash safe.
</li><li><a href="/kb/en/alter-table/">ALTER TABLE</a>
</li></ul>
<ul start="1"><li><a href="/kb/en/alter-sequence/">ALTER SEQUENCE</a> is not listed above as it is internally implemented as a DML.
</li></ul>
<h2 class="anchored_heading" id="which-ddl-operations-are-now-crash-safe">Which DDL Operations are Now Crash Safe</h2>
<h3 class="anchored_heading" id="drop-table-of-multiple-tables">DROP TABLE of Multiple Tables.</h3>
<p><a href="/kb/en/drop-table/">DROP TABLE</a> over multiple tables is treated as if every DROP is a separate, atomic operation.  This means that after a crash, all fully, or partly, dropped tables will be dropped and logged to the binary log. The undropped tables will be left untouched.</p>
<h3 class="anchored_heading" id="create-or-replace-table">CREATE OR REPLACE TABLE</h3>
<p><a href="/kb/en/create-table/">CREATE OR REPLACE TABLE foo</a> is implemented as:</p>
<pre class="fixed"><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">foo</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">foo</span> <span class="p">...</span>
</pre><p>This means that if there is a crash during <code class="fixed" style="white-space:pre-wrap">CREATE TABLE</code> then the original table 'foo' will be dropped even if the new table was not created.
If the table was not re-created, the binary log will contain the
<code class="fixed" style="white-space:pre-wrap">DROP TABLE</code>.</p>
<h4 class="anchored_heading" id="drop-database">DROP DATABASE</h4>
<p><a href="/kb/en/drop-database/">DROP DATABASE</a> is implemented as:</p>
<pre class="fixed"><span class="n">loop</span> <span class="n">over</span> <span class="k">all</span> <span class="n">tables</span>
  <span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">table</span>
</pre><p>Each <a href="/kb/en/drop-table/">DROP TABLE</a> is atomic, but in case of a crash, things will
work the same way as <a href="/kb/en/drop-table/">DROP TABLE</a> with multiple tables.</p>
<h3 class="anchored_heading" id="atomic-with-different-storage-engines">Atomic with Different Storage Engines</h3>
<p>Atomic/Crash-safe DDL works with all storage engines that either have atomic DDLs internally or are able to re-execute <code>DROP</code> or <code>RENAME</code> in case of failure.</p>
<p>This should be true for most storage engines. The ones that still need some
work are:</p>
<ul start="1"><li>The <a href="/kb/en/s3-storage-engine/">S3 storage engine</a>.
</li><li>The <a href="/kb/en/partitioning-tables/">partitioning engine</a>.  Partitioning should be atomic for most cases, but there are still some known issues that need to be tested and fixed.
</li></ul>
<h3 class="anchored_heading" id="the-ddl-log-recovery-file">The DDL Log Recovery File</h3>
<p>The new startup option <a href="/kb/en/mysqld-options/#-log-ddl-recovery">--log-ddl-recovery=path</a> (<code>ddl_recovery.log</code> by default) can be used to specify the place for
the DDL log file.  This is mainly useful in the case when one has a
filesystem on persistent memory, as there is a lot of sync on this
file during DDL operations.</p>
<p>This file contains all DDL operations that are in progress.</p>
<p>At MariaDB server startup, the DDL log file is copied to a file with the same base name but with a <code>-backup.log</code> suffix. This is mainly done to be able to find out what went wrong if recovery fails.</p>
<p>If the server crashes during recovery (unlikely but possible), the
recovery will continue where it was before.  The recovery will retry each entry up
to 3 times before giving up and proceeding with the next entry.</p>
<h3 class="anchored_heading" id="conclusions">Conclusions</h3>
<ul start="1"><li>We believe that a clean separation of layers leads to an easier-to-maintain solution. The Atomic DDL implementation in <a href="/kb/en/what-is-mariadb-106/">MariaDB 10.6</a> introduced minimal changes to the storage engine API, mainly for native ALTER TABLE.
</li><li>In our InnoDB implementation, no file format changes were needed on top of the RENAME undo log that was introduced in <a href="/kb/en/mariadb-10219-release-notes/">MariaDB 10.2.19</a> for a backup-safe TRUNCATE re-implementation. Correct use of sound design principles (write-ahead logging and transactions; also file creation now follows the ARIES protocol) is sufficient. We removed the hacks (at most one CREATE or DROP per transaction) and correctly implemented <code class="fixed" style="white-space:pre-wrap">rollback</code> and <code class="fixed" style="white-space:pre-wrap">purge</code> triggers for the InnoDB SYS_INDEXES table.
</li><li>Numerous DDL recovery bugs in InnoDB were found and fixed quickly thanks to <a href="https://rr-project.org">https://rr-project.org</a>. We are still working on one: data files must not be deleted before the DDL transaction is committed.
</li></ul>
<p>Thanks to Atomic/Crash-safe DDL, the MariaDB server is now much more stable and reliable in unstable environments. There is still ongoing work to fix the few remaining issues mentioned above to make all DDL operations Atomic. The target for these is <a href="/kb/en/what-is-mariadb-107/">MariaDB 10.7</a>.</p>
<h3 class="anchored_heading" id="see-also">See Also</h3>
<ul start="1"><li><a href="https://jira.mariadb.org/browse/MDEV-17567">MDEV-17567</a> Atomic DDL.  This MDEV entry links to all other entries related to Atomic operations that contains a lot of information how things are implemented.</li></ul>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/atomic-ddl/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/atomic-ddl/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/drop/">
                        ← DROP
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/data-definition/">
                        ↑ Data Definition ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/constraint/">
                        CONSTRAINT →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="10701" data-comments-url="/kb/en/atomic-ddl/+comments"
         data-reply-url="/kb/en/atomic-ddl/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/data-definition/">
                    ↑ Data Definition ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/create/">
                            
                            CREATE
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/alter/">
                            
                            ALTER
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/drop/">
                            
                            DROP
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Atomic DDL</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/constraint/">
                            
                            CONSTRAINT
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/merge/">
                            <span class="pull-right not_primary"></span>
                            MERGE
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rename-table/">
                            
                            RENAME TABLE
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/truncate-table/">
                            <span class="pull-right not_primary"></span>
                            TRUNCATE TABLE
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>