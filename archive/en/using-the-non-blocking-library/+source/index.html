<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Using the Non-blocking Library - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Using the Non-blocking Library - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/using-the-non-blocking-library/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/using-the-non-blocking-library/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/using-the-non-blocking-library/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/training-tutorials/">Training &amp; Tutorials</a>
    

    
    » <a class="crumb" href="/kb/en/advanced-mariadb-articles/">Advanced MariaDB Articles</a>
    

    
    » <a class="crumb" href="/kb/en/development-articles/">Development Articles</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-internals-documentation/">MariaDB Internals Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/using-mariadb-with-your-programs-api/">Using MariaDB with Your Programs (API)</a>
    

    
    » <a class="crumb" href="/kb/en/non-blocking-client-library/">Non-Blocking Client Library</a>
    


    » <a class="node_link crumb" href="/kb/en/using-the-non-blocking-library/">Using the Non-blocking Library</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/using-the-non-blocking-library/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Using the Non-blocking Library - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/using-the-non-blocking-library/+r/54035/">54035</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-2">
<a href="/kb/user/id/2" title="Daniel Bartholomew">Daniel Bartholomew</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2015-11-25 15:52">2015-11-25 15:52</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;toc&gt;&gt;

The MariaDB non-blocking client API is modelled after the normal blocking
library calls. This makes it easy to learn and remember. It makes it easier to
translate code from using the blocking API to using the non-blocking API (or
vice versa). And it also makes it simple to mix blocking and non-blocking calls
in the same code path.

For every library call that may block on socket I/O, such as
&#39;&lt;&lt;code&gt;&gt;int mysql_real_query(MYSQL, query, query_length)&lt;&lt;/code&gt;&gt;&#39;, two
additional non-blocking calls are introduced:

&lt;&lt;code lang=c inline=false&gt;&gt;
int mysql_real_query_start(&amp;status, MYSQL, query, query_length)
int mysql_real_query_cont(&amp;status, MYSQL, wait_status)
&lt;&lt;/code&gt;&gt;

To do non-blocking operation, an application first calls
##mysql_real_query_start()## instead of ##mysql_real_query()##, passing the
same parameters.

If ##mysql_real_query_start()## returns zero, then the operation completed
without blocking, and &#39;status&#39; is set to the value that would normally be
returned from ##mysql_real_query()##.

Else, the return value from ##mysql_real_query_start()## is a bitmask of events
that the library is waiting on. This can be ##MYSQL_WAIT_READ##,
##MYSQL_WAIT_WRITE##, or ##MYSQL_WAIT_EXCEPT##, corresponding to the similar
flags for ##select()## or ##poll()##; and it can include ##MYSQL_WAIT_TIMEOUT##
when waiting for a timeout to occur (e.g. a connection timeout).

In this case, the application continues other processing and eventually checks
for the appropriate condition(s) to occur on the socket (or for timeout). When
this occurs, the application can resume the operation by calling
##mysql_real_query_cont()##, passing in &#39;wait_status&#39; a bitmask of the events
which actually occurred.

Just like ##mysql_real_query_start()##, ##mysql_real_query_cont()## returns
zero when done, or a bitmask of events it needs to wait on. Thus the
application continues to repeatedly call ##mysql_real_query_cont()##,
intermixed with other processing of its choice; until zero is returned, after
which the result of the operation is stored in &#39;status&#39;.

Some calls, like ##mysql_option()##, do not do any socket I/O, and so can never
block. For these, there are no separate ##_start()## or ##_cont()## calls. See
the &#34;[[non-blocking-api-reference|Non-blocking API reference]]&#34; page for a full
list of what functions can and can not block.

The checking for events on the socket / timeout can be done with ##select()##
or ##poll()## or a similar mechanism. Though often it will be done using a
higher-level framework (such as libevent), which supplies facilities for
registering and acting on such conditions.

The descriptor of the socket on which to check for events can be obtained by
calling ##mysql_get_socket()##. The duration of any timeout can be obtained
from ##mysql_get_timeout_value()##.

Here is a trivial (but full) example of running a query with the non-blocking
API. The example is found in the MariaDB source tree as
##client/async_example.c##. (A larger, more realistic example using libevent is
found as ##tests/async_queries.c## in the source):

&lt;&lt;code lang=c inline=false&gt;&gt;
static void run_query(const char *host, const char *user, const char *password) {
  int err, status;
  MYSQL mysql, *ret;
  MYSQL_RES *res;
  MYSQL_ROW row;

  mysql_init(&amp;mysql);
  mysql_options(&amp;mysql, MYSQL_OPT_NONBLOCK, 0);

  status = mysql_real_connect_start(&amp;ret, &amp;mysql, host, user, password, NULL, 0, NULL, 0);
  while (status) {
    status = wait_for_mysql(&amp;mysql, status);
    status = mysql_real_connect_cont(&amp;ret, &amp;mysql, status);
  }

  if (!ret)
    fatal(&amp;mysql, &#34;Failed to mysql_real_connect()&#34;);

  status = mysql_real_query_start(&amp;err, &amp;mysql, SL(&#34;SHOW STATUS&#34;));
  while (status) {
    status = wait_for_mysql(&amp;mysql, status);
    status = mysql_real_query_cont(&amp;err, &amp;mysql, status);
  }
  if (err)
    fatal(&amp;mysql, &#34;mysql_real_query() returns error&#34;);

  /* This method cannot block. */
  res= mysql_use_result(&amp;mysql);
  if (!res)
    fatal(&amp;mysql, &#34;mysql_use_result() returns error&#34;);

  for (;;) {
    status= mysql_fetch_row_start(&amp;row, res);
    while (status) {
      status= wait_for_mysql(&amp;mysql, status);
      status= mysql_fetch_row_cont(&amp;row, res, status);
    }
    if (!row)
      break;
    printf(&#34;%s: %s\n&#34;, row[0], row[1]);
  }
  if (mysql_errno(&amp;mysql))
    fatal(&amp;mysql, &#34;Got error while retrieving rows&#34;);
  mysql_free_result(res);
  mysql_close(&amp;mysql);
}

/* Helper function to do the waiting for events on the socket. */
static int wait_for_mysql(MYSQL *mysql, int status) {
  struct pollfd pfd;
  int timeout, res;

  pfd.fd = mysql_get_socket(mysql);
  pfd.events =
    (status &amp; MYSQL_WAIT_READ ? POLLIN : 0) |
    (status &amp; MYSQL_WAIT_WRITE ? POLLOUT : 0) |
    (status &amp; MYSQL_WAIT_EXCEPT ? POLLPRI : 0);
  if (status &amp; MYSQL_WAIT_TIMEOUT)
    timeout = 1000*mysql_get_timeout_value(mysql);
  else
    timeout = -1;
  res = poll(&amp;pfd, 1, timeout);
  if (res == 0)
    return MYSQL_WAIT_TIMEOUT;
  else if (res &lt; 0)
    return MYSQL_WAIT_TIMEOUT;
  else {
    int status = 0;
    if (pfd.revents &amp; POLLIN) status |= MYSQL_WAIT_READ;
    if (pfd.revents &amp; POLLOUT) status |= MYSQL_WAIT_WRITE;
    if (pfd.revents &amp; POLLPRI) status |= MYSQL_WAIT_EXCEPT;
    return status;
  }
}
&lt;&lt;/code&gt;&gt;


== Setting MYSQL_OPT_NONBLOCK

Before using any non-blocking operation, it is necessary to enable it first
by setting the ##MYSQL_OPT_NONBLOCK## option:

&lt;&lt;code lang=c inline=false&gt;&gt;
mysql_options(&amp;mysql, MYSQL_OPT_NONBLOCK, 0);
&lt;&lt;/code&gt;&gt;

This call can be made at any time &lt;&lt;entity&gt;&gt;mdash&lt;&lt;/entity&gt;&gt; typically it will
be done at the start, before ##mysql_real_connect()##, but it can be done at
any time to start using non-blocking operations.

If a non-blocking operation is attempted without setting the
##MYSQL_OPT_NONBLOCK## option, the program will typically crash with a ##NULL##
pointer exception.

The argument for ##MYSQL_OPT_NONBLOCK## is the size of the stack used to save
the state of a non-blocking operation while it is waiting for I/O and the
application is doing other processing. Normally, applications will not have to
change this, and it can be passed as zero to use the default value.


== Mixing blocking and non-blocking operation

It is possible to freely mix blocking and non-blocking calls on the same
##MYSQL## connection.

Thus, an application can do a normal blocking ##mysql_real_connect()## and
subsequently do a non-blocking ##mysql_real_query_start()##. Or vice versa, do
a non-blocking ##mysql_real_connect_start()##, and later do a blocking
##mysql_real_query()## on the resulting connection.

Mixing can be useful to allow code to use the simpler blocking API in parts of
the program where waiting is not a problem. For example establishing the
connection(s) at program startup, or doing small quick queries between large,
long-running ones.

The only restriction is that any previous non-blocking operation must have
finished before starting a new blocking (or non-blocking) operation, see the
next section: &#34;Terminating a non-blocking operation early&#34; below.


== Terminating a non-blocking operation early

When a non-blocking operation is started with ##mysql_real_query_start()## or
another ##_start()## function, it must be allowed to finish before starting a new
operation. Thus, the application must continue calling ##mysql_real_query_cont()##
until zero is returned, indicating that the operation is completed. It is not
allowed to leave one operation &#34;hanging&#34; in the middle of processing and then
start a new one on top of it.

It is, however, permissible to terminate the connection completely with
##mysql_close()## in the middle of processing a non-blocking call. A new
connection must then be initiated with ##mysql_real_connect## before new
queries can be run, either with a new ##MYSQL## object or re-using the old one.

In the future, we may implement an abort facility to force an on-going
operation to terminate as quickly as possible (but it will still be necessary
to call ##mysql_real_query_cont()## one last time after abort, allowing it to
clean up the operation and return immediately with an appropriate error code).


== Restrictions

=== DNS

When ##mysql_real_connect_start()## is passed a hostname (as opposed to a local
unix socket or an IP address, it may need to look up the hostname in DNS,
depending on local host configuration (e.g. if the name is not in
##/etc/hosts## or cached). Such DNS lookups do **not** happen in a non-blocking
way. This means that ##mysql_real_connect_start()## will not return control to
the application while waiting for the DNS response. Thus the application may
&#34;hang&#34; for some time if DNS is slow or non-functional.

If this is a problem, the application can pass an IP address to
##mysql_real_connect_start()## instead of a hostname, which avoids the problem.
The IP address can be obtained by the application with whatever non-blocking
DNS loopup operation is available to it from the operating system or event
framework used. Alternatively, a simple solution may be to just add the
hostname to the local host lookup file (##/etc/hosts## on Posix/Unix/Linux
machines).

=== Windows Named Pipes and Shared Memory connections

There is no support in the non-blocking API for connections using Windows named
pipes or shared memory

Named pipes and shared memory can still be used, using either the blocking or the non-blocking API. However, operations that need to wait on I/O on the named pipe will not return control to the application; instead they will &#34;hang&#34; waiting for the
operation to complete, just like the normal blocking API calls.
</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>