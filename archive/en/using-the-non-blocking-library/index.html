<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Using the Non-blocking Library - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Using the Non-blocking Library" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/using-the-non-blocking-library/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="How to use the non-blocking client library" />

    <meta name="description" content="How to use the non-blocking client library" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/using-the-non-blocking-library/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/using-the-non-blocking-library/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/solutions" title="Solutions">Solutions</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="Company">Company</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/training-tutorials/">Training &amp; Tutorials</a>
    

    
    » <a class="crumb" href="/kb/en/advanced-mariadb-articles/">Advanced MariaDB Articles</a>
    

    
    » <a class="crumb" href="/kb/en/development-articles/">Development Articles</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-internals-documentation/">MariaDB Internals Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/using-mariadb-with-your-programs-api/">Using MariaDB with Your Programs (API)</a>
    

    
    » <a class="crumb" href="/kb/en/non-blocking-client-library/">Non-Blocking Client Library</a>
    


    » <a class="node_link crumb" href="/kb/en/using-the-non-blocking-library/">Using the Non-blocking Library</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/using-the-non-blocking-library/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/using-the-non-blocking-library/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/using-the-non-blocking-library/+flag"
                data-flag-url="/kb/en/using-the-non-blocking-library/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/using-the-non-blocking-library/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2012-02-28 19:18">13 years, 2 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2015-11-25 15:52">9 years, 6 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/using-the-non-blocking-library/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/using-the-non-blocking-library/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/using-the-non-blocking-library/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/using-the-non-blocking-library/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    
        

<div class="well well-small box"><div><h5>Localized Versions</h5></div><div>

        <ul>
            
            <li><a href="/kb/it/using-the-non-blocking-library/">Usare la libreria client non-bloccante</a> [it]</li>
            
        </ul>
        
</div>
</div>

    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Using the Non-blocking Library</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#setting-mysql_opt_nonblock" title="Setting MYSQL_OPT_NONBLOCK">Setting MYSQL_OPT_NONBLOCK</a></li>

    <li class=""><a href="#mixing-blocking-and-non-blocking-operation" title="Mixing blocking and non-blocking operation">Mixing blocking and non-blocking operation</a></li>

    <li class=""><a href="#terminating-a-non-blocking-operation-early" title="Terminating a non-blocking operation early">Terminating a non-blocking operation early</a></li>

    <li class=""><a href="#restrictions" title="Restrictions">Restrictions</a>    <ol class="toc">

        <li class=""><a href="#dns" title="DNS">DNS</a></li>

        <li class=""><a href="#windows-named-pipes-and-shared-memory-connections" title="Windows Named Pipes and Shared Memory connections">Windows Named Pipes and Shared Memory connections</a>    </ol>
 </ol>
</li>
</div>
<p>The MariaDB non-blocking client API is modelled after the normal blocking
library calls. This makes it easy to learn and remember. It makes it easier to
translate code from using the blocking API to using the non-blocking API (or
vice versa). And it also makes it simple to mix blocking and non-blocking calls
in the same code path.</p>
<p>For every library call that may block on socket I/O, such as
'<code class="fixed" style="white-space:pre-wrap">int mysql_real_query(MYSQL, query, query_length)</code>', two
additional non-blocking calls are introduced:</p>
<pre class="fixed"><span class="kt">int</span> <span class="n">mysql_real_query_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">MYSQL</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_length</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">mysql_real_query_cont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">MYSQL</span><span class="p">,</span> <span class="n">wait_status</span><span class="p">)</span>
</pre><p>To do non-blocking operation, an application first calls
<code>mysql_real_query_start()</code> instead of <code>mysql_real_query()</code>, passing the
same parameters.</p>
<p>If <code>mysql_real_query_start()</code> returns zero, then the operation completed
without blocking, and 'status' is set to the value that would normally be
returned from <code>mysql_real_query()</code>.</p>
<p>Else, the return value from <code>mysql_real_query_start()</code> is a bitmask of events
that the library is waiting on. This can be <code>MYSQL_WAIT_READ</code>,
<code>MYSQL_WAIT_WRITE</code>, or <code>MYSQL_WAIT_EXCEPT</code>, corresponding to the similar
flags for <code>select()</code> or <code>poll()</code>; and it can include <code>MYSQL_WAIT_TIMEOUT</code>
when waiting for a timeout to occur (e.g. a connection timeout).</p>
<p>In this case, the application continues other processing and eventually checks
for the appropriate condition(s) to occur on the socket (or for timeout). When
this occurs, the application can resume the operation by calling
<code>mysql_real_query_cont()</code>, passing in 'wait_status' a bitmask of the events
which actually occurred.</p>
<p>Just like <code>mysql_real_query_start()</code>, <code>mysql_real_query_cont()</code> returns
zero when done, or a bitmask of events it needs to wait on. Thus the
application continues to repeatedly call <code>mysql_real_query_cont()</code>,
intermixed with other processing of its choice; until zero is returned, after
which the result of the operation is stored in 'status'.</p>
<p>Some calls, like <code>mysql_option()</code>, do not do any socket I/O, and so can never
block. For these, there are no separate <code>_start()</code> or <code>_cont()</code> calls. See
the "<a href="/kb/en/non-blocking-api-reference/">Non-blocking API reference</a>" page for a full
list of what functions can and can not block.</p>
<p>The checking for events on the socket / timeout can be done with <code>select()</code>
or <code>poll()</code> or a similar mechanism. Though often it will be done using a
higher-level framework (such as libevent), which supplies facilities for
registering and acting on such conditions.</p>
<p>The descriptor of the socket on which to check for events can be obtained by
calling <code>mysql_get_socket()</code>. The duration of any timeout can be obtained
from <code>mysql_get_timeout_value()</code>.</p>
<p>Here is a trivial (but full) example of running a query with the non-blocking
API. The example is found in the MariaDB source tree as
<code>client/async_example.c</code>. (A larger, more realistic example using libevent is
found as <code>tests/async_queries.c</code> in the source):</p>
<pre class="fixed"><span class="k">static</span> <span class="kt">void</span> <span class="nf">run_query</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
  <span class="n">MYSQL</span> <span class="n">mysql</span><span class="p">,</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
  <span class="n">MYSQL_RES</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
  <span class="n">MYSQL_ROW</span> <span class="n">row</span><span class="p">;</span>

  <span class="n">mysql_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">);</span>
  <span class="n">mysql_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">MYSQL_OPT_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">mysql_real_connect_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">wait_for_mysql</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">mysql_real_connect_cont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">fatal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&quot;Failed to mysql_real_connect()&quot;</span><span class="p">);</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">mysql_real_query_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">SL</span><span class="p">(</span><span class="s">&quot;SHOW STATUS&quot;</span><span class="p">));</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">wait_for_mysql</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">mysql_real_query_cont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="n">fatal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&quot;mysql_real_query() returns error&quot;</span><span class="p">);</span>

  <span class="cm">/* This method cannot block. */</span>
  <span class="n">res</span><span class="o">=</span> <span class="n">mysql_use_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
    <span class="n">fatal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&quot;mysql_use_result() returns error&quot;</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">status</span><span class="o">=</span> <span class="n">mysql_fetch_row_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">status</span><span class="o">=</span> <span class="n">wait_for_mysql</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
      <span class="n">status</span><span class="o">=</span> <span class="n">mysql_fetch_row_cont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">row</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mysql_errno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">))</span>
    <span class="n">fatal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&quot;Got error while retrieving rows&quot;</span><span class="p">);</span>
  <span class="n">mysql_free_result</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
  <span class="n">mysql_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Helper function to do the waiting for events on the socket. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_mysql</span><span class="p">(</span><span class="n">MYSQL</span> <span class="o">*</span><span class="n">mysql</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pfd</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

  <span class="n">pfd</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">mysql_get_socket</span><span class="p">(</span><span class="n">mysql</span><span class="p">);</span>
  <span class="n">pfd</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MYSQL_WAIT_READ</span> <span class="o">?</span> <span class="nl">POLLIN</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MYSQL_WAIT_WRITE</span> <span class="o">?</span> <span class="nl">POLLOUT</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MYSQL_WAIT_EXCEPT</span> <span class="o">?</span> <span class="nl">POLLPRI</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MYSQL_WAIT_TIMEOUT</span><span class="p">)</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mysql_get_timeout_value</span><span class="p">(</span><span class="n">mysql</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">MYSQL_WAIT_TIMEOUT</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">MYSQL_WAIT_TIMEOUT</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="n">status</span> <span class="o">|=</span> <span class="n">MYSQL_WAIT_READ</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLOUT</span><span class="p">)</span> <span class="n">status</span> <span class="o">|=</span> <span class="n">MYSQL_WAIT_WRITE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLPRI</span><span class="p">)</span> <span class="n">status</span> <span class="o">|=</span> <span class="n">MYSQL_WAIT_EXCEPT</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre><h2 class="anchored_heading" id="setting-mysql_opt_nonblock">Setting MYSQL_OPT_NONBLOCK</h2>
<p>Before using any non-blocking operation, it is necessary to enable it first
by setting the <code>MYSQL_OPT_NONBLOCK</code> option:</p>
<pre class="fixed"><span class="n">mysql_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">MYSQL_OPT_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre><p>This call can be made at any time <span>&mdash;</span> typically it will
be done at the start, before <code>mysql_real_connect()</code>, but it can be done at
any time to start using non-blocking operations.</p>
<p>If a non-blocking operation is attempted without setting the
<code>MYSQL_OPT_NONBLOCK</code> option, the program will typically crash with a <code>NULL</code>
pointer exception.</p>
<p>The argument for <code>MYSQL_OPT_NONBLOCK</code> is the size of the stack used to save
the state of a non-blocking operation while it is waiting for I/O and the
application is doing other processing. Normally, applications will not have to
change this, and it can be passed as zero to use the default value.</p>
<h2 class="anchored_heading" id="mixing-blocking-and-non-blocking-operation">Mixing blocking and non-blocking operation</h2>
<p>It is possible to freely mix blocking and non-blocking calls on the same
<code>MYSQL</code> connection.</p>
<p>Thus, an application can do a normal blocking <code>mysql_real_connect()</code> and
subsequently do a non-blocking <code>mysql_real_query_start()</code>. Or vice versa, do
a non-blocking <code>mysql_real_connect_start()</code>, and later do a blocking
<code>mysql_real_query()</code> on the resulting connection.</p>
<p>Mixing can be useful to allow code to use the simpler blocking API in parts of
the program where waiting is not a problem. For example establishing the
connection(s) at program startup, or doing small quick queries between large,
long-running ones.</p>
<p>The only restriction is that any previous non-blocking operation must have
finished before starting a new blocking (or non-blocking) operation, see the
next section: "Terminating a non-blocking operation early" below.</p>
<h2 class="anchored_heading" id="terminating-a-non-blocking-operation-early">Terminating a non-blocking operation early</h2>
<p>When a non-blocking operation is started with <code>mysql_real_query_start()</code> or
another <code>_start()</code> function, it must be allowed to finish before starting a new
operation. Thus, the application must continue calling <code>mysql_real_query_cont()</code>
until zero is returned, indicating that the operation is completed. It is not
allowed to leave one operation "hanging" in the middle of processing and then
start a new one on top of it.</p>
<p>It is, however, permissible to terminate the connection completely with
<code>mysql_close()</code> in the middle of processing a non-blocking call. A new
connection must then be initiated with <code>mysql_real_connect</code> before new
queries can be run, either with a new <code>MYSQL</code> object or re-using the old one.</p>
<p>In the future, we may implement an abort facility to force an on-going
operation to terminate as quickly as possible (but it will still be necessary
to call <code>mysql_real_query_cont()</code> one last time after abort, allowing it to
clean up the operation and return immediately with an appropriate error code).</p>
<h2 class="anchored_heading" id="restrictions">Restrictions</h2>
<h3 class="anchored_heading" id="dns">DNS</h3>
<p>When <code>mysql_real_connect_start()</code> is passed a hostname (as opposed to a local
unix socket or an IP address, it may need to look up the hostname in DNS,
depending on local host configuration (e.g. if the name is not in
<code>/etc/hosts</code> or cached). Such DNS lookups do <strong>not</strong> happen in a non-blocking
way. This means that <code>mysql_real_connect_start()</code> will not return control to
the application while waiting for the DNS response. Thus the application may
"hang" for some time if DNS is slow or non-functional.</p>
<p>If this is a problem, the application can pass an IP address to
<code>mysql_real_connect_start()</code> instead of a hostname, which avoids the problem.
The IP address can be obtained by the application with whatever non-blocking
DNS loopup operation is available to it from the operating system or event
framework used. Alternatively, a simple solution may be to just add the
hostname to the local host lookup file (<code>/etc/hosts</code> on Posix/Unix/Linux
machines).</p>
<h3 class="anchored_heading" id="windows-named-pipes-and-shared-memory-connections">Windows Named Pipes and Shared Memory connections</h3>
<p>There is no support in the non-blocking API for connections using Windows named
pipes or shared memory</p>
<p>Named pipes and shared memory can still be used, using either the blocking or the non-blocking API. However, operations that need to wait on I/O on the named pipe will not return control to the application; instead they will "hang" waiting for the
operation to complete, just like the normal blocking API calls.</p>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/using-the-non-blocking-library/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/using-the-non-blocking-library/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/about-non-blocking-operation-in-the-client-library/">
                        ← About Non-blocking Operation in the Client Library
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/non-blocking-client-library/">
                        ↑ Non-Blocking Client Library ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/non-blocking-api-reference/">
                        Non-blocking API Reference →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="2414" data-comments-url="/kb/en/using-the-non-blocking-library/+comments"
         data-reply-url="/kb/en/using-the-non-blocking-library/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/non-blocking-client-library/">
                    ↑ Non-Blocking Client Library ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/about-non-blocking-operation-in-the-client-library/">
                            
                            About Non-blocking Operation in the Client Library
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Using the Non-blocking Library</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/non-blocking-api-reference/">
                            
                            Non-blocking API Reference
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/javascript-mariasql-for-nodejs/">
                            <span class="pull-right not_primary"></span>
                            JavaScript - mariasql for node.js
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/solutions" title="Solutions">Solutions</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">Company</a></h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        
                        
                        <li>
                            <h5><a href="https://mariadb.com/downloads" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>