<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/aws-key-management-encryption-plugin-advanced-usage/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/aws-key-management-encryption-plugin-advanced-usage/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/aws-key-management-encryption-plugin-advanced-usage/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-administration/">MariaDB Administration</a>
    

    
    » <a class="crumb" href="/kb/en/user-server-security/">User &amp; Server Security</a>
    

    
    » <a class="crumb" href="/kb/en/securing-mariadb/">Securing MariaDB</a>
    

    
    » <a class="crumb" href="/kb/en/securing-mariadb-encryption/">Encryption</a>
    

    
    » <a class="crumb" href="/kb/en/encryption-data-at-rest-encryption/">Data-at-Rest Encryption</a>
    

    
    » <a class="crumb" href="/kb/en/key-management-and-encryption-plugins/">Key Management and Encryption Plugins</a>
    


    » <a class="node_link crumb" href="/kb/en/aws-key-management-encryption-plugin-advanced-usage/">Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/aws-key-management-encryption-plugin-advanced-usage/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/aws-key-management-encryption-plugin-advanced-usage/+r/116397/">116397</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-2087">
<a href="/kb/user/id/2087" title="Kolbe Kegel">Kolbe Kegel</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2022-05-19 13:02">2022-05-19 13:02</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;toc&gt;&gt;

This document assumes you&#39;ve already set up an Amazon Web Services (AWS) account, created a master key in the Key Management Service (KMS), and have done the basic work to set up the MariaDB AWS KMS plugin. These steps are all described in [[mariadb-enterprise-aws-kms-encryption-plugin-setup-guide|Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Setup Guide]].

Ultimately, keeping all the credentials required to read the key on a single host means that a user who has gained access to the host has enough information to read the encrypted files in the datadir, read the encrypted keys from the datadir, interact with AWS KMS to decrypt the encrypted keys, and then used the decrypted keys to decrypt the encrypted data.

Theoretically, a superuser can read the memory of the MariaDB server process to read the decrypted keys or restart MariaDB with password authentication disabled in order to dump data, or add new users to MariaDB in order to allow a user to connect and dump the data. Resolving these issues is beyond the scope of this document. A user who gains root access to your operating system or root access to your MariaDB server will have the ability to decrypt your data. Plan accordingly.

== Managing AWS credentials

Putting the AWS credentials in a file inside the MariaDB home directory is not ideal. By default, any user with the FILE privilege can read any files that the MariaDB server has permission to read, which would include the credentials file. To protect against this, you should set ##secure_file_priv## to restrict the location the server will allow a user to read from when executing ##LOAD DATA INFILE## or the ##LOAD_FILE()## function.

But putting them in other locations requires passing additional data to the server, which in the case of CentOS 7 requires customizing the systemd startup procedure. This is most easily done by creating a &#34;drop-in&#34; file in /etc/systemd/system/mariadb.service.d/. The file should end in &#34;.conf&#34; but can otherwise be named whatever you like. After making any changes to systemd files, execute ##systemctl daemon-reload## and then start (or restart) the service as usual.

You can place the credentials file in a location of your choosing and then refer to that file by setting the ##AWS_CREDENTIAL_PROFILES_FILE## environment variable in the drop-in file:

&lt;&lt;code&gt;&gt;
[Service]
Environment=AWS_CREDENTIAL_PROFILES_FILE=/etc/aws-kms-credentials
&lt;&lt;/code&gt;&gt;

The credentials file will need to be readable by the &#34;mysql&#34; user, but it does not need to be readable by any other user.

AWS credentials can also be put directly into a &#34;drop-in&#34; systemd file that will be read when starting the MariaDB service:

&lt;&lt;code&gt;&gt;
# cat /etc/systemd/system/mariadb.service.d/aws-kms.conf
[Service]
Environment=AWS_ACCESS_KEY_ID=AKIAIRSG2XYZATCJLZ4A
Environment=AWS_SECRET_ACCESS_KEY=ux91LZIxCp4ZXabcdefgIViQNtTan42QAmJqJVqV
&lt;&lt;/code&gt;&gt;

However, any OS user can read this information from systemd, which could be considered a security risk. Another solution is to put the credentials in a separate file that is only readable by root and then refer to that file using an ##EnvironmentFile## directive in a drop-in systemd file.

&lt;&lt;code&gt;&gt;
# cat /etc/systemd/system/mariadb.service.d/aws-kms.env
AWS_ACCESS_KEY_ID=AKIAIRSG2XYZATCJLZ4A
AWS_SECRET_ACCESS_KEY=ux91LZIxCp4ZXabcdefgIViQNtTan42QAmJqJVqV

# chown root /etc/systemd/system/mariadb.service.d/aws-kms.env
# chmod 600 /etc/systemd/system/mariadb.service.d/aws-kms.env

# cat /etc/systemd/system/mariadb.service.d/aws-kms.conf
[Service]
EnvironmentFile=/etc/systemd/system/mariadb.service.d/aws-kms.env
&lt;&lt;/code&gt;&gt;

That has the advantage the the credentials can only be read directly by root. systemd adds those variables to the environment of the MariaDB server when starting it, and MariaDB can use the credentials to interact with AWS. Note, though, that any process running as the &#34;mysql&#34; user can still read the credentials from the proc filesystem on Linux.

&lt;&lt;code&gt;&gt;
$ whoami
mysql
$ cat /proc/$(pgrep mysqld)/environ | tr &#39;\0&#39; &#39;\n&#39; | grep AWS
AWS_ACCESS_KEY_ID=AKIAIRSG2XYZATCJLZ4A
AWS_SECRET_ACCESS_KEY=ux91LZIxCp4ZXabcdefgIViQNtTan42QAmJqJVqV
&lt;&lt;/code&gt;&gt;

== AWS KMS Key Policy

AWS KMS allows flexible, user-editable key policy. This offers fine-grained control over which users can operate on keys. The possibilities range from simply restricting which IP addresses are allowed to perform operations on the key, to requiring a MFA (Multi-Factor Authentication) device to use the key, to enforcing separation of responsibilities by creating an additional user with limited privileges to enable and disable the key. All 3 of these options will be outlined in this section.

For more details about customizing the Key Policy for your master keys, please consult the [[http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-overview|AWS Key Management Service Key Policy]] documentation.

=== Source IP restrictions

A simple, common-sense restriction to put in place is to restrict the range of IP addresses that are allowed to use your master key. This way, even if someone obtains API credentials, they&#39;ll be unable to use them to decrypt your encryptions keys from a different host.

To restrict API access from only a specific IP address or range of IP addresses, you&#39;ll need to manually edit the key policy.

# Load the IAM console at https://console.aws.amazon.com/iam/.
# Click &#34;Encryption Keys&#34; in the left-hand sidebar.
# Click the name of your encryption key to view its details.
# Click the link labeled &#34;Switch to policy view&#34;, to the right of the heading of the &#34;Key Policy&#34; section.
# Locate the section that contains ##&#34;Sid&#34;: &#34;Allow use of the key&#34;##.
# Add this text below the ##&#34;Sid&#34;## line:&lt;&lt;code inline=false&gt;&gt;      &#34;Condition&#34;: {
        &#34;IpAddress&#34;: {
          &#34;aws:SourceIp&#34;: [
            &#34;10.1.2.3/32&#34;
          ]
        }
      },
&lt;&lt;/code&gt;&gt;
... replacing ##10.1.2.3/32## above with an IP address or range of IP addresses in CIDR format. For example, a single address would be ##192.168.12.34/32##, while a range of addresses might be ##192.168.0.0/24##.
# Click &#34;Save Changes&#34;.
# Click &#34;Proceed&#34; if prompted with a warning about using the default view in the future.

Access to the API will now be restricted to requests coming from the IP address or range of IP addresses specified in the policy.

=== Using a Multi-Factor Authentication (MFA) device

One approach is to modify the key policy for the master key so that MFA (Multi-Factor Authentication) is required in order to use the key. This is achieved with a wrapper that handles prompting the user for an MFA token, acquires temporary, limited-privilege credentials from the AWS Security Token Service (STS), and puts those credentials into the environment of the MariaDB server process. The credentials can expire after as little as 15 minutes.

To require an MFA token for users of the key, you&#39;ll need to manually edit the key policy.
# Load the IAM console at https://console.aws.amazon.com/iam/.
# Click &#34;Encryption Keys&#34; in the left-hand sidebar.
# Click the name of your encryption key to view its details.
# Click the link labeled &#34;Switch to policy view&#34;, to the right of the heading of the &#34;Key Policy&#34; section.
# Locate the section that contains ##&#34;Sid&#34;: &#34;Allow use of the key&#34;##.
# Add this text below the ##&#34;Sid&#34;## line:&lt;&lt;code inline=false&gt;&gt;      &#34;Condition&#34;: {
        &#34;Bool&#34;: {
          &#34;aws:MultiFactorAuthPresent&#34;: &#34;True&#34;
        }
      },
&lt;&lt;/code&gt;&gt;
# Click &#34;Save Changes&#34;.
# Click &#34;Proceed&#34; if prompted with a warning about using the default view in the future.

Now, add an MFA device for your user. You&#39;ll need to have a hardware MFA device or an application such as Google Authenticator installed on your smartphone.
# Click &#34;Users&#34; in the left-hand sidebar.
# Click the name of your user.
# Click the &#34;Security Credentials&#34; tab.
# In the &#34;Sign-In Credentials&#34; section, click the &#34;Manage MFA Device&#34; button.
# Complete the steps to activate your MFA device.
# Copy the ARN for your MFA device. You will need to use this when configuring the wrapper program.

Now, set up the wrapper program.
# Copy the iam-kms-wrapper file to /usr/local/bin/, and ensure that it is executable.
# Create a drop-in systemd config file in ##/etc/systemd/system/mariadb.service.d/##:&lt;&lt;code inline=false&gt;&gt;[Service]
EnvironmentFile=/etc/systemd/system/mariadb.service.d/aws-kms.env
ExecStart=
ExecStart=/usr/local/bin/iam-kms-wrapper --config=/etc/my.cnf.d/iam-kms-wrapper.config /usr/sbin/mysqld $MYSQLD_OPTS
&lt;&lt;/code&gt;&gt;
# Execute ##systemctl daemon-reload##.
# Create a file at ##/etc/my.cnf.d/iam-kms-wrapper.config## with these contents, using the ARN for your MFA device as the value for ##kms_mfa_id##:&lt;&lt;code inline=false&gt;&gt;[kms]
kms_mfa_id = arn:aws:iam::551888187628:mfa/MDBEnc
kms_mfa_socket = /tmp/kms_mfa_socket
&lt;&lt;/code&gt;&gt;

When you start the MariaDB service now, the wrapper will temporarily create a socket file at the location given by the ##kms_mfa_socket## option. The wrapper will read the MFA code from the socket and will use it to authenticate to KMS. To give the MFA code, simply write the digits to the socket file using ##echo##: ##echo 111676 &gt; /tmp/kms_mfa_socket##.

The ##systemctl## command will block until MariaDB starts, so you will need to write the code to the socket file via a separate terminal.

Note that the temporary credentials put into the environment of the MariaDB process will expire after a period of time defined by the request to the AWS Security Token Service (STS). In the example below, they will expire after 900 seconds. After that time, MariaDB may be unable to generate new encrypted data keys, which means that, for example, an attempt to create a table with a previously-unused key ID would fail.

==== Wrapper program example

Here&#39;s an example wrapper program written in go. Build this into an executable named ##iam-kms-wrapper## and use it as instructed above. This could of course be written in any language for which an appropriate AWS SDK exists, but go has the benefit of compiling to a static binary, which means you do not have to worry about interpreter versions or installing complex dependencies on the host that runs your MariaDB server.

&lt;&lt;code lang=go wrap=true&gt;&gt;
package main

import (
    &#34;syscall&#34;
    &#34;os&#34;
    &#34;log&#34;
    &#34;flag&#34;
    &#34;github.com/aws/aws-sdk-go/aws&#34;
    &#34;github.com/aws/aws-sdk-go/aws/session&#34;
    &#34;github.com/aws/aws-sdk-go/aws/awserr&#34;
    &#34;github.com/aws/aws-sdk-go/service/sts&#34;
    &#34;github.com/robfig/config&#34;
)

func main() {

    config_file_p := flag.String(&#34;config&#34;, &#34;&#34;, &#34;location of the config file&#34;)
    flag.Parse()

    if flag.NArg() &lt; 1 {
        log.Fatal(&#34;Command to wrap must be given as first command-line argument&#34;)
    }

    cmd := flag.Arg(0)
    args := flag.Args()[0:]

    conf, err := config.ReadDefault(*config_file_p)
    if err != nil {
        log.Fatal(err)
    }

    kms_mfa_id, err := conf.String(&#34;kms&#34;,&#34;kms_mfa_id&#34;)
    mfa_socket_file, err := conf.String(&#34;kms&#34;,&#34;kms_mfa_socket&#34;)

    sess := session.New()
    svc := sts.New(sess)

    syscall.Umask(0044)

    log.Printf(&#34;Reading MFA token from %s\n&#34;,mfa_socket_file)

    if err := syscall.Mknod(mfa_socket_file, syscall.S_IFIFO|uint32(os.FileMode(0622)), 0); err != nil {
        log.Fatal(err)
    }

    file, err := os.Open(mfa_socket_file)
    if err != nil {
        log.Fatal(err)
    }

    token := make([]byte, 6)

    if _, err := file.Read(token); err != nil {
        log.Fatal(err)
    }

    file.Close()

    if err := syscall.Unlink(mfa_socket_file); err != nil {
        log.Fatal(err)
    }

    mfa_token := string(token)

    token_params := &amp;sts.GetSessionTokenInput{
        DurationSeconds: aws.Int64(900),
        SerialNumber:    aws.String(kms_mfa_id),
        TokenCode:       aws.String(mfa_token),
    }

    resp, err := svc.GetSessionToken(token_params)
    if err != nil {
        if awsErr, ok := err.(awserr.Error); ok {
            // Prints out full error message, including original error if there was one.
            log.Fatal(&#34;Error:&#34;, awsErr.Error())
        } else {
            log.Fatal(&#34;Error:&#34;, err.Error())
        }
    }

    creds := resp.Credentials

    os.Setenv(&#34;AWS_ACCESS_KEY_ID&#34;,*creds.AccessKeyId)
    os.Setenv(&#34;AWS_SECRET_ACCESS_KEY&#34;,*creds.SecretAccessKey)
    os.Setenv(&#34;AWS_SESSION_TOKEN&#34;,*creds.SessionToken)

    execErr := syscall.Exec(cmd, args, os.Environ())
    if execErr != nil {
        panic(execErr)
    }
}
&lt;&lt;/code&gt;&gt;

=== Disabling keys when not needed

Another possibility is to use the API to disable access to the master key and enable it only when a trusted administrator knows that the MariaDB service needs to be started. A specialized tool on a separate host could be used to enable the key for a very short period of time while the service starts and then quickly disable the key.

To do this, you can create an extra IAM User that can only use the kms:EnableKey and kms:DisableKey API endpoints for your key. This user will not be able to encrypt or decrypt any data using the key.

First, create a new user.
# Load the IAM console at https://console.aws.amazon.com/iam/.
# Click &#34;Users&#34; in the left-hand sidebar.
# Click &#34;Create New Users&#34;.
# Enter a new user name. (The examples will use &#34;MDBEncAdmin&#34;.)
# Click &#34;Show User Security Credentials&#34;.
# Copy the credentials and put them in a ##credentials## file with this structure:&lt;&lt;code inline=false&gt;&gt;[MDBEncAdmin]
aws_access_key_id=AKIAJMPPNO7EBKABCDEF
aws_secret_access_key=pVdGwbuK5/jG64aBK1oEJOXRlkdM0aAylgabCDef
&lt;&lt;/code&gt;&gt;
# Click &#34;Close&#34;.
# Click &#34;Close&#34; again if prompted.
# Click the name of your new user to open the details view.
# Copy the &#34;User ARN&#34; value for your user (for example &#34;arn:aws:iam::551888181234:user/MDBEncAdmin&#34;). You will need this for the next step.

Now, give the new user permission to perform API operations on your key.
# Click &#34;Encryption Keys&#34; in the left-hand sidebar.
# Click the name of your key to open the details view.
# Click &#34;Switch to policy view&#34; if it is not already open. (The &#34;policy view&#34; is a large text field that contains JSON describing the key policy.)
# Create a new item in the ##Statement## array with this structure:&lt;&lt;code inline=false&gt;&gt;    {
      &#34;Sid&#34;: &#34;Allow Enable and Disable of the key&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;AWS&#34;: &#34;arn:aws:iam::551888181234:user/MDBEncAdmin&#34;
      },
      &#34;Action&#34;: [
        &#34;kms:EnableKey&#34;,
        &#34;kms:DisableKey&#34;
      ]
    },
&lt;&lt;/code&gt;&gt;
...so that your Key Policy looks like this:&lt;&lt;code inline=false&gt;&gt;{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Id&#34;: &#34;key-consolepolicy-2&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;Allow Enable and Disable of the key&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
      ...
&lt;&lt;/code&gt;&gt;
# Click &#34;Save Changes&#34;.

You&#39;ve now added a new IAM user and you&#39;ve given that user privileges to enable and disable your key. This user will be able to perform those operations using the AWS CLI or via a script of your own design using the AWS API. For example, using the [[https://aws.amazon.com/cli/|AWS CLI]]:

&lt;&lt;code wrap=true&gt;&gt;
$ cat ~/.aws/credentials
[MDBEncAdmin]
aws_access_key_id=AKIAJMPPNO7EBKABCDEF
aws_secret_access_key=pVdGwbuK5/jG64aBK1oEJOXRlkdM0aAylgabCDef

$ AWS_PROFILE=MDBEncAdmin aws --region us-east-1 kms disable-key --key-id arn:aws:kms:us-east-1:551888181234:key/abcdf8f6-084b-4cff-99ca-abcdef6c7907c
&lt;&lt;/code&gt;&gt;

In order for MariaDB to start, this new user will have to enable the master key, then the DBA can start MariaDB, and this user can once again disable the master key after the service has started. Note that in this workflow, MariaDB will be unable to create new encryption keys, such as would be done when a user creates a table that refers to a non-existent key ID. The AWS KMS plugin will encounter an error if it tries to generate a new encryption key while the master key is disabled. In that scenario, the key administrator would have to enable the key before the operation could succeed. Here&#39;s what you should expect to see in the journal if MariaDB tries to interact with a disabled master key:

&lt;&lt;code wrap=true&gt;&gt;
[ERROR] AWS KMS plugin : GenerateDataKeyWithoutPlaintext failed : DisabledException - Unable to parse ExceptionName: DisabledException Message: arn:aws:kms:us-east-1:551888181234:key/abcdf8f6-084b-4cff-99ca-abcdef6c7907c is disabled.
&lt;&lt;/code&gt;&gt;

==== Adding MFA

It&#39;s also possible to add MFA to this technique so that the user that enables &amp; disables the master key has to authenticate using an MFA device. Adapt the instructions in the MFA section above to add MFA to the policy section for the user with EnableKey and DisableKeys privileges, add an MFA device for that user, use Security Token Service (STS) to get temporary security credentials, and then use those credentials to make the API calls. Here&#39;s an example Python script that follows that workflow: 

&lt;&lt;code lang=python&gt;&gt;
#!/usr/bin/env python

import boto3
import sys

# Command-line argument processing should be more robust than this...
action= sys.argv[1]
mfa_token= sys.argv[2]

# These should perhaps go into a config file instead of here
mfa_serial= &#39;arn:aws:iam::551888181234:mfa/MDBEncAdmin&#39;
key_id= &#39;arn:aws:kms:us-east-1:551888181234:key/abcdf8f6-084b-4cff-99ca-abcdef6c7907c&#39;

# Make the connection to the Security Token Service to get temporary credentials
token_client= boto3.client(&#39;sts&#39;)
token_response= token_client.get_session_token(
    DurationSeconds= 900,
    SerialNumber= mfa_serial,
    TokenCode= mfa_token
)

cred= token_response[&#39;Credentials&#39;]

# Start new session using temporary, MFA-authenticated credentials
kms_session= boto3.session.Session(
    aws_access_key_id= cred[&#39;AccessKeyId&#39;],
    aws_secret_access_key= cred[&#39;SecretAccessKey&#39;],
    aws_session_token= cred[&#39;SessionToken&#39;],
    region_name= key_id.split(&#39;:&#39;)[3]
)

# Start KMS client and execute operation against key
kms_client= kms_session.client(&#39;kms&#39;)
if action == &#39;enable&#39; or action == &#39;e&#39;:
    action_f= kms_client.enable_key
elif action == &#39;disable&#39; or action == &#39;d&#39;:
    action_f= kms_client.disable_key
else:
    raise Exception(&#39;Action must be either &#34;disable&#34; or &#34;enable&#34;&#39;)

action_f(KeyId=key_id)
&lt;&lt;/code&gt;&gt;

&lt;&lt;code&gt;&gt;
$ AWS_PROFILE=MDBEncAdmin python kms-manage-key disable 575290
$ AWS_PROFILE=MDBEncAdmin python kms-manage-key enable 799870
&lt;&lt;/code&gt;&gt;

== Logging and auditing

=== CloudTrail

Amazon&#39;s CloudTrail service creates JSON-formatted text log files for every API interaction. Enabling CloudTrail requires S3, which incurs additional fees.

First, enable CloudTrail and add a trail.
# Load the CloudTrail console at https://console.aws.amazon.com/cloudtrail/.
# If you&#39;ve never used CloudTrail before, click &#34;Get Started Now&#34;.
# Enter a value for &#34;trail name&#34;. This example uses &#34;mariadb-encryption-key&#34;.
# Create a new S3 bucket, using a globally unique name, or use an existing S3 bucket, according to your needs.
# Click &#34;Turn On&#34;.

If you navigate to the S3 bucket you created, you should find log files that contain JSON-formatted descriptions of your API interactions.

=== CloudWatch

Amazon&#39;s CloudWatch service allows you to create alarms and event rules that monitor log information.

First, send your CloudTrail logs to CloudWatch.
# Load the CloudTrail console at https://console.aws.amazon.com/cloudtrail/.
# Click &#34;Trails&#34; in the left-hand navigation sidebar.
# Click the name of your trail to open the Configuration view.
# In the &#34;CloudWatch Logs&#34; section, click &#34;Configure&#34;.
# Click &#34;Continue&#34;.
# Click &#34;Allow&#34;.

Now, set up an SNS topic to facilitate email notifications.
# Open https://console.aws.amazon.com/sns/.
# //Make sure the region in the console (look in the upper-right corner) is the same as the region where you created your key!//
# Click &#34;Get Started&#34; is prompted.
# Click &#34;Events&#34; in the left-hand sidebar.
# Click &#34;Create new topic&#34;.
# Enter a //Topic name// of your choosing.
# Enter a //Display name// of your choosing.
# Click &#34;Create topic&#34;.
# Click the ARN of your new SNS topic.
# Click &#34;Create Subscription&#34;.
# Select &#34;Email&#34; from the Protocol dropdown.
# Enter the desired notification email address in the Endpoint field.
# Wait for the confirmation email to show up and follow the instructions.

Now, configure CloudWatch and create an Event Rule.
# Open https://console.aws.amazon.com/cloudwatch/.
# //Make sure the region in the console (look in the upper-right corner) is the same as the region where you created your key and your SNS topic!//
# Click &#34;Events&#34; in the left-hand sidebar.
# Click &#34;Create rule&#34;.
# Choose &#34;AWS API call&#34; from the &#34;Select event source&#34; dropdown.
# Choose &#34;KMS&#34; from the &#34;Service name&#34; dropdown.
# Decide which operations should trigger the event. (You can eep &#34;Any operation&#34; selected for simplicity.)
# Click &#34;Add target&#34;.
# Select &#34;SNS target&#34; from the dropdown.
# Select the SNS topic you created in the previous steps.
# Click &#34;Configure details&#34;.
# Enter a //Name// and //Description// of your choosing.
# Click &#34;Create rule&#34;.

You should now get emails any time someone executes API calls on the KMS service in the region where you&#39;ve created the CloudWatch Event rule. That means you should get email any time the key is enabled or disabled, and any time the AWS KMS plugin generates new keys or decrypts the keys stored on disk on the MariaDB server.

You may also wish to create an event rule (or an additional event) that matches only when an unauthorized user tries to access the key. You might accomplish that by manually editing the Event selector of the rule to look something like this:

&lt;&lt;code&gt;&gt;
{
  &#34;detail-type&#34;: [
    &#34;AWS API Call via CloudTrail&#34;
  ],
  &#34;detail&#34;: {
    &#34;eventSource&#34;: [
      &#34;kms.amazonaws.com&#34;
    ],
    &#34;errorCode&#34;: [
      &#34;AccessDenied&#34;,
      &#34;UnauthorizedOperation&#34;
    ]
  }
}
&lt;&lt;/code&gt;&gt;

The emails are formatted as JSON. Further customization of the CloudWatch email workflow is beyond the scope of this document.

There are many other workflows available using CloudWatch, including workflows with alarms and dashboards. Those are beyond the scope of this document.</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>