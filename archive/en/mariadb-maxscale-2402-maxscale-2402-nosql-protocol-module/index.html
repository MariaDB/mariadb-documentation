<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>MaxScale 24.02 NoSQL Protocol Module - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="MaxScale 24.02 NoSQL Protocol Module" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="NoSQL Protocol Module
The nosqlprotocol module allows a MariaDB server or cluster to be
used as the backend of an application using a MongoDB® client library.
Internally, all ..." />

    <meta name="description" content="NoSQL Protocol Module
The nosqlprotocol module allows a MariaDB server or cluster to be
used as the backend of an application using a MongoDB® client library.
Internally, all ..." />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/maxscale/">MariaDB MaxScale</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-maxscale-24-02-beta/">MariaDB MaxScale 24.02 Beta</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-maxscale-24-02-beta-protocols/">MaxScale 24.02Protocols</a>
    


    » <a class="node_link crumb" href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/">MaxScale 24.02 NoSQL Protocol Module</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+flag"
                data-flag-url="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2024-03-01 19:51">3 weeks, 3 days ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2024-03-01 19:51">3 weeks, 3 days ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
        <dt>Source</dt>
        <dd><a href="https://github.com/mariadb-corporation/MaxScale/blob/24.02.0/Documentation/Protocols/NoSQL.md">GitHub</a></dd>
        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>MaxScale 24.02 NoSQL Protocol Module</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <h1 id="nosql-protocol-module">NoSQL Protocol Module</h1>
<p>The <code>nosqlprotocol</code> module allows a MariaDB server or cluster to be
used as the backend of an application using a MongoDB® client library.
Internally, all documents are stored in a table containing two columns;
an <code>id</code> column for the object id and a <code>doc</code> column for the document itself.</p>
<p>When the MongoDB® client application issues MongoDB protocol <em>commands</em>,
either directly or indirectly via the client library, they are transparently
converted into the equivalent SQL and executed against the MariaDB backend.
The MariaDB responses are then in turn converted into the format expected by
the MongoDB® client library and application.</p>
<div>
<ul>
<li><a href="#nosql-protocol-module">NoSQL Protocol Module</a></li>
<li><a href="#configuring">Configuring</a></li>
<li><a href="#authentication">Authentication</a><ul>
<li><a href="#nosql-and-mariadb-users">NoSQL and MariaDB Users</a><ul>
<li><a href="#the-mariadb-database">The mariadb database</a></li>
</ul>
</li>
<li><a href="#roles-and-privileges">Roles and Privileges</a></li>
<li><a href="#client-authentication">Client Authentication</a><ul>
<li><a href="#anonymously">Anonymously</a></li>
<li><a href="#shared-credentials">Shared Credentials</a></li>
<li><a href="#unique-credentials">Unique Credentials</a></li>
<li><a href="#enforce-authentication">Enforce Authentication</a></li>
</ul>
</li>
<li><a href="#authorization">Authorization</a></li>
<li><a href="#bootstrapping-the-authenticationauthorization">Bootstrapping the Authentication/Authorization</a><ul>
<li><a href="#explicit-bootstrapping">Explicit bootstrapping</a></li>
<li><a href="#implicit-bootstrapping">Implicit bootstrapping</a><ul>
<li><a href="#grants">Grants</a></li>
<li><a href="#examples">Examples</a><ul>
<li><a href="#admin-user">Admin User</a></li>
<li><a href="#test-user">Test User</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tlsssl">TLS/SSL</a></li>
</ul>
</li>
<li><a href="#nosql-account-database">NoSQL Account Database</a><ul>
<li><a href="#private">Private</a></li>
</ul>
</li>
<li><a href="#shared">Shared</a></li>
</ul>
</li>
<li><a href="#wire-protocol">Wire Protocol</a></li>
<li><a href="#client-library">Client Library</a></li>
<li><a href="#parameters">Parameters</a><ul>
<li><a href="#user">user</a></li>
<li><a href="#password">password</a></li>
<li><a href="#authentication_required">authentication_required</a></li>
<li><a href="#authentication_shared">authentication_shared</a></li>
<li><a href="#authentication_db">authentication_db</a></li>
<li><a href="#authentication_key_id">authentication_key_id</a></li>
<li><a href="#authentication_user">authentication_user</a></li>
<li><a href="#authentication_password">authentication_password</a></li>
<li><a href="#authorization_enabled">authorization_enabled</a></li>
<li><a href="#host">host</a></li>
<li><a href="#on_unknown_command">on_unknown_command</a></li>
<li><a href="#log_unknown_command">log_unknown_command</a></li>
<li><a href="#auto_create_databases">auto_create_databases</a></li>
<li><a href="#auto_create_tables">auto_create_tables</a></li>
<li><a href="#id_length">id_length</a></li>
<li><a href="#ordered_insert_behavior">ordered_insert_behavior</a></li>
<li><a href="#cursor_timeout">cursor_timeout</a></li>
<li><a href="#debug">debug</a></li>
<li><a href="#internal_cache">internal_cache</a></li>
</ul>
</li>
<li><a href="#databases-and-tables">Databases and Tables</a></li>
<li><a href="#operators">Operators</a><ul>
<li><a href="#query-and-projection-operators">Query and Projection Operators</a><ul>
<li><a href="#comparison-query-operators">Comparison Query Operators</a></li>
<li><a href="#logical-query-operators">Logical Query Operators</a></li>
<li><a href="#element-query-operators">Element Query Operators</a><ul>
<li><a href="#type">$type</a></li>
</ul>
</li>
<li><a href="#evaluation-query-operators">Evaluation Query Operators</a></li>
<li><a href="#array-query-operators">Array Query Operators</a><ul>
<li><a href="#elemmatch">$elemMatch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#update-operators">Update Operators</a><ul>
<li><a href="#field-update-operators">Field Update Operators</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#database-commands">Database Commands</a><ul>
<li><a href="#aggregation-commands">Aggregation Commands</a><ul>
<li><a href="#count">count</a></li>
<li><a href="#distinct">distinct</a></li>
</ul>
</li>
<li><a href="#query-and-write-operation-commands">Query and Write Operation Commands</a><ul>
<li><a href="#delete">delete</a></li>
<li><a href="#find">find</a><ul>
<li><a href="#projection">Projection</a><ul>
<li><a href="#embedded-field-specification">Embedded Field Specification</a></li>
<li><a href="#_id-field-projection">_id Field Projection</a></li>
</ul>
</li>
<li><a href="#inclusion-or-exclusion">Inclusion or Exclusion</a></li>
<li><a href="#filtering-by-_id">Filtering by _id</a></li>
</ul>
</li>
<li><a href="#findandmodify">findAndModify</a></li>
<li><a href="#getlasterror">getLastError</a></li>
<li><a href="#getmore">getMore</a></li>
<li><a href="#insert">insert</a><ul>
<li><a href="#ordered">ordered</a><ul>
<li><a href="#default">default</a></li>
<li><a href="#atomic">atomic</a></li>
</ul>
</li>
<li><a href="#performance">Performance</a></li>
</ul>
</li>
<li><a href="#reseterror">resetError</a></li>
<li><a href="#update">update</a><ul>
<li><a href="#update-statements">Update Statements</a><ul>
<li><a href="#behavior">Behavior</a><ul>
<li><a href="#update-with-an-update-operator-expressions-document">Update with an Update Operator Expressions document</a></li>
<li><a href="#update-with-a-replacement-document">Update with a Replacement Document</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#authentication-commands">Authentication Commands</a><ul>
<li><a href="#logout">Logout</a></li>
</ul>
</li>
<li><a href="#user-management-commands">User Management Commands</a><ul>
<li><a href="#createuser">createUser</a></li>
<li><a href="#dropallusersfromdatabase">dropAllUsersFromDatabase</a></li>
<li><a href="#dropuser">dropUser</a></li>
<li><a href="#grantrolestouser">grantRolesToUser</a></li>
<li><a href="#revokerolesfromuser">revokeRolesFromUser</a></li>
<li><a href="#updateuser">updateUser</a></li>
<li><a href="#usersinfo">usersInfo</a></li>
</ul>
</li>
<li><a href="#replication-commands">Replication Commands</a><ul>
<li><a href="#ismaster">isMaster</a></li>
<li><a href="#replsetgetstatus">replSetGetStatus</a></li>
</ul>
</li>
<li><a href="#sessions-commands">Sessions Commands</a><ul>
<li><a href="#endsessions">endSessions</a></li>
</ul>
</li>
<li><a href="#administration-commands">Administration Commands</a><ul>
<li><a href="#create">create</a></li>
<li><a href="#createindexes">createIndexes</a></li>
<li><a href="#drop">drop</a></li>
<li><a href="#dropdatabase">dropDatabase</a></li>
<li><a href="#dropindexes">dropIndexes</a></li>
<li><a href="#fsync">fsync</a></li>
<li><a href="#killcursors">killCursors</a></li>
<li><a href="#listcollections">listCollections</a></li>
<li><a href="#listdatabases">listDatabases</a></li>
<li><a href="#listindexes">listIndexes</a></li>
<li><a href="#renamecollection">renameCollection</a></li>
<li><a href="#setparameter">setParameter</a></li>
</ul>
</li>
<li><a href="#diagnostic-commands">Diagnostic Commands</a><ul>
<li><a href="#buildinfo">buildInfo</a></li>
<li><a href="#explain">explain</a></li>
<li><a href="#getcmdlineopts">getCmdLineOpts</a></li>
<li><a href="#getlog">getLog</a></li>
<li><a href="#hostinfo">hostInfo</a></li>
<li><a href="#listcommands">listCommands</a></li>
<li><a href="#ping">ping</a></li>
<li><a href="#serverstatus">serverStatus</a></li>
<li><a href="#validate">validate</a></li>
<li><a href="#whatsmyuri">whatsmyuri</a></li>
</ul>
</li>
<li><a href="#free-monitoring-commands">Free Monitoring Commands</a><ul>
<li><a href="#getfreemonitoringstatus">getFreeMonitoringStatus</a></li>
</ul>
</li>
<li><a href="#maxscale-specific-commands">MaxScale Specific Commands</a><ul>
<li><a href="#mxsadduser">mxsAddUser</a><ul>
<li><a href="#definition">Definition</a><ul>
<li><a href="#mxsadduser_1">mxsAddUser</a></li>
</ul>
</li>
<li><a href="#syntax">Syntax</a><ul>
<li><a href="#command-fields">Command Fields</a></li>
<li><a href="#returns">Returns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mxscreatedatabase">mxsCreateDatabase</a><ul>
<li><a href="#definition_1">Definition</a><ul>
<li><a href="#mxscreatedatabase_1">mxsCreateDatabase</a></li>
</ul>
</li>
<li><a href="#syntax_1">Syntax</a><ul>
<li><a href="#command-fields_1">Command Fields</a></li>
<li><a href="#returns_1">Returns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mxsdiagnose">mxsDiagnose</a><ul>
<li><a href="#definition_2">Definition</a><ul>
<li><a href="#mxsdiagnose_1">mxsDiagnose</a></li>
</ul>
</li>
<li><a href="#syntax_2">Syntax</a><ul>
<li><a href="#command-fields_2">Command Fields</a></li>
<li><a href="#returns_2">Returns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mxsgetconfig">mxsGetConfig</a><ul>
<li><a href="#definition_3">Definition</a></li>
<li><a href="#mxsgetconfig_1">mxsGetConfig</a></li>
<li><a href="#syntax_3">Syntax</a><ul>
<li><a href="#command-fields_3">Command Fields</a></li>
<li><a href="#returns_3">Returns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mxsremoveuser">mxsRemoveUser</a><ul>
<li><a href="#definition_4">Definition</a><ul>
<li><a href="#mxsremoveuser_1">mxsRemoveUser</a></li>
</ul>
</li>
<li><a href="#syntax_4">Syntax</a><ul>
<li><a href="#command-fields_4">Command Fields</a></li>
<li><a href="#returns_4">Returns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mxssetconfig">mxsSetConfig</a><ul>
<li><a href="#definition_5">Definition</a></li>
<li><a href="#mxssetconfig_1">mxsSetConfig</a></li>
<li><a href="#syntax_5">Syntax</a><ul>
<li><a href="#command-fields_5">Command Fields</a></li>
<li><a href="#returns_5">Returns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mxsupdateuser">mxsUpdateUser</a><ul>
<li><a href="#definition_6">Definition</a><ul>
<li><a href="#mxsupdateuser_1">mxsUpdateUser</a></li>
</ul>
</li>
<li><a href="#syntax_6">Syntax</a><ul>
<li><a href="#command-fields_6">Command Fields</a></li>
<li><a href="#returns_6">Returns</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#object-id">Object Id</a></li>
<li><a href="#caching">Caching</a><ul>
<li><a href="#cached-commands">Cached Commands</a></li>
</ul>
</li>
<li><a href="#compatibility">Compatibility</a></li>
<li><a href="#example">Example</a><ul>
<li><a href="#configuring-maxscale">Configuring MaxScale</a></li>
<li><a href="#mongodb-shell">MongoDB® Shell</a></li>
<li><a href="#mongodb-nodejs-driver">MongoDB® Node.JS Driver</a><ul>
<li><a href="#inserting-a-document">Inserting a Document</a></li>
<li><a href="#finding-a-document">Finding a Document</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="configuring">Configuring</h1>
<p>There are a number of <a href="#parameters">parameters</a> with which the behavior
of <em>nosqlprotocol</em> can be adjusted. A minimal configuration looks
like:</p>
<div><pre><span></span>[TheService]
type=service
...

[NoSQL-Listener]
type=listener
service=TheService
protocol=nosqlprotocol
nosqlprotocol.user=the_user
nosqlprotocol.password=the_password
port=17017
</pre></div>


<p><code>nosqlprotocol.user</code> and <code>nosqlprotocol.password</code> specify the
credentials that will be used when accessing the backend database or
cluster. Note that the same credentials will be used for <em>all</em> connecting
MongoDB® clients.</p>
<p>Since <em>nosqlprotocol</em> is a <em>listener</em>, there must be a <em>service</em> to which
the client requests will be sent. <em>Nosqlprotocol</em> places no limitations
on what filters, routers or backends can be used.</p>
<p>To configure the same listener with MaxCtrl, the parameters must be passed in a
JSON object in the following manner:</p>
<div><pre><span></span>maxctrl create listener TheService MongoDB-Listener --protocol=nosqlprotocol 'nosqlprotocol={"user":"the_user", "password": "the_password"}'
</pre></div>


<p>All the parameters that the nosqlprotocol module takes must be passed in the
same JSON object.</p>
<p>A complete example can be found at the <a href="#example">end</a> of this document.</p>
<h1 id="authentication">Authentication</h1>
<p>Nosqlprotocol supports <em>SCRAM</em> <em>authentication</em> as implemented by MongoDB®.
The mechanisms <code>SCRAM-SHA-1</code> and <code>SCRAM-SHA-256</code> are both supported.</p>
<p>If nosqlprotocol has been setup so that no authentication is required, then
when connecting only the host and port should be provided, but neither a
username nor a password.</p>
<p>For instance, if the <em>MongoDB Node.JS Driver</em> is used, then the connection
string should look like:</p>
<div><pre><span></span>const uri = "mongodb://127.0.0.1:17017"
</pre></div>


<p>Similarly, if the <em>Mongo Shell</em> is used, only the host and port should
be provided:</p>
<div><pre><span></span>$ mongo --host 127.0.0.1 --port 17017
MongoDB shell version v4.4.1
...
&gt;
</pre></div>


<h2 id="nosql-and-mariadb-users">NoSQL and MariaDB Users</h2>
<p>A MariaDB user consists of a name and a host part. A user <code>'user'@'%'</code>
and a user <code>'user'@'127.0.0.1'</code> are completely different. The host part
specifies where a user may connect from, with <code>%</code> being a wildcard that
matches all hosts. What data a user is allowed to access and modify is
specified by what <em>privileges</em> are granted to the user.</p>
<p>A NoSQL user is somewhat different. It is created in the context of a
particular database, so there may be a user <code>userx</code> in the database <code>dbA</code>
and different user with the same name <code>userx</code> in the database <code>dbB</code>. What
hosts a user may connect from can be restricted, but that is a property of
the user and not an implicit part of it. What data a user is allowed to
access and modify is specified by the <em>roles</em> that have been assigned to
the user.</p>
<p>From the above it should be clear that there is not a 1-to-1
correspondence between the concept of a user in NoSQL and the concept
of a user in MariaDB, but that some additional conventions are needed.</p>
<p>To make it possible to have different NoSQL users with the same name,
the database in whose context the user is created is prepended to the
user name, separated with a dot, when the MariaDB user is created.</p>
<p>This is perhaps easiest to illustrate using an example:</p>
<div><pre><span></span>MariaDB [(none)]&gt; select user, host from mysql.user;
+-------------+-----------+
| User        | Host      |
+-------------+-----------+
| bob         | %         |
| mysql       | localhost |
+-------------+-----------+
2 rows in set (0.001 sec)
</pre></div>


<p>Currently there are two user accounts defined. Even though there is
a user <code>bob</code>, creating a NoSQL user <code>bob</code> succeeds.</p>
<div><pre><span></span>&gt; use test;
switched to db test
&gt; db.runCommand({createUser: "bob", pwd: "bobspwd", roles: []});
{ "ok" : 1 }
</pre></div>


<p>If we now, from the MariaDB prompt, check the users we will see:</p>
<div><pre><span></span>MariaDB [(none)]&gt; select user, host from mysql.user;
+-------------+-----------+
| User        | Host      |
+-------------+-----------+
| bob         | %         |
| test.bob    | %         |
| mysql       | localhost |
+-------------+-----------+
3 rows in set (0.001 sec)
</pre></div>


<p>The MariaDB user corresponding to the NoSQL user <code>bob</code>, created in the
context of the database <code>test</code>, has <code>test</code> as a prefix.</p>
<h3 id="the-mariadb-database">The <code>mariadb</code> database</h3>
<p>The fact that NoSQL users have the database embedded in the MariaDB
name may be inconvenient if the same data is accessed both as NoSQL
via nosqlprotocol and as SQL directly from MariaDB. It also makes
it impossible to use an existing MariaDB account from NoSQL.</p>
<p>To provide a solution for this problem, the database <code>mariadb</code> is treated
in a specific fashion. A user created in the context of the <code>mariadb</code>
database is created in the MariaDB server without the database prefix.
If we now try to create a user <code>bob</code> in the <code>mariadb</code> database it will fail,
because the user <code>'bob'@'%'</code> exists already.</p>
<div><pre><span></span>&gt; use mariadb
switched to db mariadb
&gt; db.runCommand({createUser: "bob", pwd: "bobspwd", roles: []});
{
    "ok" : 0,
    "errmsg" : "User \"bob\" already exists",
    "code" : 51003,
    "codeName" : "Location51003"
}
</pre></div>


<p>If we create a user with another name it will succeed.</p>
<div><pre><span></span>&gt; db.runCommand({createUser: "alice", pwd: "alicespwd", roles: []});
{ "ok" : 1 }
</pre></div>


<p>And if we check the situation from MariaDB,</p>
<div><pre><span></span>MariaDB [(none)]&gt; select user, host from mysql.user;
+-------------+-----------+
| User        | Host      |
+-------------+-----------+
| alice       | %         |
| bob         | %         |
| test.bob    | %         |
| mysql       | localhost |
+-------------+-----------+
4 rows in set (0.001 sec)
</pre></div>


<p>we will see that <code>alice</code> was created without a database prefix.</p>
<h2 id="roles-and-privileges">Roles and Privileges</h2>
<p>When creating a user nosqlprotocol accepts all roles as predefined by
MongoDB®, but not all of them are translated into GRANT privileges.
The following table shows what privilege(s) a particular role is
converted to.</p>
<table>
<thead>
<tr>
<th>Role</th>
<th>Privileges</th>
</tr>
</thead>
<tbody>
<tr>
<td>dbAdmin</td>
<td>ALTER, CREATE, DROP, SHOW DATABASES, SELECT</td>
</tr>
<tr>
<td>read</td>
<td>SELECT</td>
</tr>
<tr>
<td>readWrite</td>
<td>CREATE, DELETE, INDEX, INSERT, SELECT, UPDATE</td>
</tr>
<tr>
<td>userAdmin</td>
<td>CREATE USER, GRANT OPTION</td>
</tr>
</tbody>
</table>
<p>The following roles are shorthands for several other roles.</p>
<table>
<thead>
<tr>
<th>Role</th>
<th>Shorthand for</th>
</tr>
</thead>
<tbody>
<tr>
<td>dbOwner</td>
<td>dbAdmin, readWrite, userAdmin</td>
</tr>
<tr>
<td>root</td>
<td>dbAdmin, readWrite, userAdmin</td>
</tr>
</tbody>
</table>
<p><code>dbOwner</code> differs from <code>root</code> in that the privileges of the former
apply only to a particular database, while the privileges of the
latter apply to <em>all</em> databases. However, the role <code>root</code> can
only be assigned to a user in the <code>admin</code> database.</p>
<p>In addition there are <code>AnyDatabase</code> versions of <code>dbAdmin</code>, <code>read</code> and
<code>readWrite</code> (e.g <code>readAnyDatabase</code>) that can be assigned to a user in
the <code>admin</code> database. If so, then the privilege is granted on <code>*.*</code>,
otherwise on <code>&lt;db&gt;.*</code>.</p>
<p>If the <code>root</code> role is assigned to a user in the <code>admin</code> database,
then the privileges are granted on <code>*.*</code>, otherwise on <code>&lt;db&gt;.*</code>.</p>
<p>Other pre-defined roles are recognized and stored in the local
nosqlprotocol account database, but they do not affect what privileges
are granted to the MariaDB user. Currently user-defined roles are
not supported.</p>
<h2 id="client-authentication">Client Authentication</h2>
<p>Authenticationwise nosqlprotocol can be used in three different ways:
- Anonymously
- Shared credentials
- Unique credentials</p>
<h3 id="anonymously">Anonymously</h3>
<p>If there is an anonymous user on the MariaDB server and if nosqlprotocol
is configured without a user/password, then all nosqlprotocol clients will
access the MariaDB server as anonymous users.</p>
<p>Note that the anonymous MariaDB user is only intended for testing and
should in general not be used, but deleted.</p>
<h3 id="shared-credentials">Shared Credentials</h3>
<p>If nosqlprotocol is configured with</p>
<div><pre><span></span>...
nosqlprotocol.user=theuser
nosqlprotocol.password=thepassword
</pre></div>


<p>then each MongoDB® client will use those credentials when accessing the
MariaDB server. Note that from the perspective of the MariaDB server, it
is not possible to distinguish between different MongoDB® clients.</p>
<h3 id="unique-credentials">Unique Credentials</h3>
<p>If nosqlprotocol authentication has been taken into use and a MongoDB®
client authenticates, either when connecting or later, then the credentials
of MongoDB® client will be used when accessing the MariaDB server.</p>
<p>Note that even if nosqlprotocol authentication has been enabled, authentication
is not required, and if the MongoDB® client has not authenticated itself, the
credentials specified with <code>nosqlprotocol.[user|password]</code> (or the anonymous
user) will be used when accessing the MariaDB server.</p>
<h3 id="enforce-authentication">Enforce Authentication</h3>
<p>To enforce authentication, specify</p>
<div><pre><span></span>nosqlprotocol.authentication_required=true
</pre></div>


<p>in the configuration. If authentication is required, then any command
that requires access to the MariaDB server will fail, unless the client
has authenticated.</p>
<h2 id="authorization">Authorization</h2>
<p>By default nosqlprotocol does no authorization. However, a nosqlprotocol
client is <em>always</em> subject to the authorization performed by the MariaDB
server.</p>
<p>When nosqlprotocol authorization is enabled by adding</p>
<div><pre><span></span>nosqlprotocol.authorization_enabled=true
</pre></div>


<p>to the configuration file, some commands will be subject to authorization,
by nosqlprotocol. The following table lists the commands and what role they
require.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#createUser">createUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#dropUser">dropUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#grantRolesToUser">grantRolesToUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#revokeRolesFromUser">revokeRolesFromUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#mxsAddUser">mxsAddUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#mxsRemoveUser">mxsRemoveUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#mxsUpdateUser">mxsUpdateUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#updateUser">updateUser</a></td>
<td><code>userAdmin</code></td>
</tr>
<tr>
<td><a href="#usersInfo">usersInfo</a></td>
<td><code>userAdmin</code></td>
</tr>
</tbody>
</table>
<p>It is important to note that even if nosqlprotocol authorization
is enabled, the MariaDB server has the final word. That is, even if the
roles of a user would be sufficient for a particular operation, if the
granted privileges are not, the operation will not succeed. There may
be a mismatch between roles and grants, for instance, if the wrong roles
were specified when the user was added, or if the grants have been
altered directly and not via nosqlprotocol.</p>
<h2 id="bootstrapping-the-authenticationauthorization">Bootstrapping the Authentication/Authorization</h2>
<p>The authentication/authorization can be bootstrapped explicitly
or implicitly. Bootstrapping explicitly provides more control, while
bootstrapping implicitly is much more convenient.</p>
<h3 id="explicit-bootstrapping">Explicit bootstrapping</h3>
<p>In order to enable authorization you need to have NoSQL users and
those can be created with <a href="#createUser">createUser</a> or added
with <a href="#addUser">mxsAddUser</a>.</p>
<p>If you want to <em>create</em> a user, then you first need to configure
nosqlprotocol with credentials that are sufficient for creating a user:</p>
<div><pre><span></span>nosqlprotocol.user = user_with_privileges_for_creating_a_user
nosqlprotocol.password = the_users_password
</pre></div>


<p>At this point <code>nosqlprotocol.authentication_required</code> and
<code>nosqlprotocol.authorization_enabled</code> should both be <code>false</code>. Note that
as those are their default values, they do not have to be specified.</p>
<p>Start MaxScale and connect to it with the MongoDB® command line client</p>
<div><pre><span></span>$ mongo --port 17017
...
&gt;
</pre></div>


<p>Then create the user.</p>
<div><pre><span></span>&gt; use admin;
switched to db admin
&gt; db.runCommand({createUser: "nosql_admin", pwd: "nosql_pwd", roles: ["userAdmin"]});
{ "ok" : 1 }
</pre></div>


<p>Alternatively you can add an existing user. Note that it should be
added to the <code>mariadb</code> database, unless it was created with the
convention of having the database as a prefix, e.g. <code>db.bob</code>.</p>
<div><pre><span></span>&gt; use mariadb;
switched to db admin
&gt; db.runCommand({mxsAddUser: "bob", pwd: "bob_pwd", roles: ["userAdmin"]});
{ "ok" : 1 }
</pre></div>


<p>Now you should shutdown MaxScale and add the entries</p>
<div><pre><span></span>nosqlprotocol.authentication_required=true
nosqlprotocol.authorization_enabled=true
</pre></div>


<p>and start MaxScale.</p>
<p>The <code>nosqlprotocol.user</code> and <code>nosqlprotocol.password</code> can be removed but
as they will be ignored with <code>nosqlprotocol.authentication_required=true</code>
being present, it is not mandatory.</p>
<p>If you now try to create a user when not having been authenticated or
when authenticated as a user without the <code>userAdmin</code> role, the result
will be:</p>
<div><pre><span></span>&gt; use test;
switched to db test
&gt; db.runCommand({createUser: "alice", pwd: "alices_pwd", roles: []});
{
    "ok" : 0,
    "errmsg" : "command createUser requires authentication",
    "code" : 13,
    "codeName" : "Unauthorized"
}
</pre></div>


<p><strong>NOTE</strong> When a client authenticates, the password will not be
transferred in cleartext over the network, so, even without SSL,
it is not possible to gain access to a password by monitoring the
network traffic.</p>
<p>However, when a user is created or added (or the password is changed),
the password will be transferred in <em>cleartext</em>. To prevent eavesdropping,
create/add users when connecting over a domain socket, or use
<a href="#tlsssl">TLS/SSL</a></p>
<h3 id="implicit-bootstrapping">Implicit bootstrapping</h3>
<p>With implicit bootstrapping, you should first create the MariaDB
user that should appear as the initial NoSQL user. As explained
<a href="#nosql-and-mariadb-users">here</a>, the concept of a user is somewhat
different in MariaDB and NoSQL, which means that certain factors
must be taken into account when creating the MariaDB user. Then
at first startup, nosqlprotocol will create the corresponding
NoSQL user, which will enable the authenticated and authorized
use of nosqlprotocol.</p>
<p>When MaxScale is started, if the following hold</p>
<ul>
<li><code>nosqlprotocol.authentication_required</code> and
  <code>nosqlprotocol.authorization_enabled</code> are true in the configuration
  section of the nosqlprotocol listener,</li>
<li><code>nosqlprotocol.user</code> and <code>nosqlprotocol.password</code> are provided, and</li>
<li>there are <strong>no</strong> NoSQL users in the NoSQL account database.</li>
</ul>
<p>then, MaxScale will</p>
<ul>
<li>wait until the <em>primary</em> of the service pointed to by the listener
  is available,</li>
<li>connect using the credentials specified in <code>nosqlprotocol.user</code>
  and <code>nosqlprotocol.password</code>,</li>
<li>execute <code>SHOW GRANTS</code>,</li>
<li>translate the privileges into the equivalent NoSQL roles, and</li>
<li>create a corresponding NoSQL user into the NoSQL account database.</li>
</ul>
<p>Immediately thereafter it is possible to connect to the nosqlprotocol
port with a MongoDB® client using the specified credentials.</p>
<p>Note that after the bootstrapping, nosqlprotocol will not use
the <code>user</code> and <code>password</code> settings and they can be removed.</p>
<h4 id="grants">Grants</h4>
<p>When a NoSQL user is created using <a href="#createUser">createUser</a>
the MariaDB grants are obtained from the specified NoSQL roles
as explained <a href="#Roles_and_privileges">here</a>.</p>
<p>When implicitly creating a NoSQL user from an existing user in
MariaDB, the inverse operation must be performed. There are
many factors that affect what NoSQL roles the grants of a user
are translated into:</p>
<ul>
<li>whether the user is a <em>regular</em> or <em>admin</em> user,</li>
<li>whether the privileges are <em>on</em> <code>*.*</code> or some specific <code>db.*</code>, and</li>
<li>the privileges themselves, e.g. <code>SELECT</code>, <code>DELETE</code>, etc.</li>
</ul>
<p>In NoSQL, every user resides in a specific database. Note that
this does <strong>not</strong> mean that the database would have to exist
in MariaDB.</p>
<p>When it comes to users, the database effectively means a scope,
which in the case of nosqlprotocol is handled by prefixing the
corresponding MariaDB user name with the database/scope name.</p>
<p>When creating a user to be used from NoSQL, there are three
options for the user's name:</p>
<ul>
<li>The name can be of the format <code>some_db.user_name</code> where
  <code>some_db</code> can be anything (subject to the naming rules of
  MariaDB), except <code>admin</code> or <code>mariadb</code>. In this case, the
  user will be a <em>regular</em> user, who can access data in
  databases that she has been granted access to.</li>
<li>The name can be of the format <code>admin.user_name</code> where <code>admin</code>
  is exactly just that. In this case, the user will be an
  <em>admin</em> user, who can access any database.</li>
<li>The name can be of the format <code>user_name</code>. In this case, the
  user will be a <em>regular</em> user that from the NoSQL side appears
  to reside in the <code>mariadb</code> database. The primary purpose of
  this alternative is to enable the use of existing users from
  the NoSQL side.</li>
</ul>
<p>What database the privileges can be specified <code>ON</code> depends on
what kind of user is being created.</p>
<ul>
<li>If it is a regular user, the privileges <strong>must</strong> be granted on a
  specific database, such as <code>\</code>dbA`<code>.*</code>. Note that there is no
  dependency between this database and the (conceptual) database
  the user resides in.</li>
<li>If it is an admin user, the privileges <strong>must</strong> be granted on
  the <code>*.*</code> database.</li>
</ul>
<p>In NoSQL, a role can be database specific or generic. However,
a generic role can <em>only</em> be assigned to a user in the <em>admin</em>
database. In practice this means that if the privileges are
on <code>*.*</code>, then the user must reside in the <em>admin</em> database
(e.g. <code>admin.bob</code>) or it is treated as an error.</p>
<p>The following table shows what privileges are required for a
role to be assigned. Note that <code>ALL PRIVILEGES</code> can be used as
well.</p>
<table>
<thead>
<tr>
<th><code>ALTER</code></th>
<th><code>CREATE</code></th>
<th><code>CREATE USER</code></th>
<th><code>DROP</code></th>
<th><code>DELETE</code></th>
<th><code>INDEX</code></th>
<th><code>INSERT</code></th>
<th><code>SHOW DATABASES</code>(1)</th>
<th><code>SELECT</code></th>
<th><code>UPDATE</code></th>
<th><code>WITH GRANT OPTION</code></th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td>dbAdmin[AnyDatabase]</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td>read[AnyDatabase]</td>
</tr>
<tr>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td>X</td>
<td></td>
<td>readWrite[AnyDatabase]</td>
</tr>
<tr>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>X</td>
<td>userAdmin[AnyDatabase]</td>
</tr>
</tbody>
</table>
<ol>
<li>Only required if the user is an <em>admin</em> user.</li>
</ol>
<p>The <code>AnyDatabase</code> version will be assigned, if the user is
an <em>admin</em> user.</p>
<p>If certain roles are assigned, then other roles will be
assigned as well.</p>
<ul>
<li>If the roles <code>dbAdmin</code>, <code>readWrite</code> and <code>userAdmin</code> are
  assigned, then <code>dbOwner</code> will be assigned as well.</li>
<li>If the roles <code>dbAdminAnyDatabase</code>, <code>readWriteAnyDatabase</code>
  and <code>userAdminAnyDatabase</code> are assigned, then <code>root</code> will
  be assigned as well.</li>
</ul>
<p>Once the user has been created and the desired privileges have
been granted, the NoSQL listener should be configured as follows:</p>
<div><pre><span></span>[NoSQL-Listener]
...
nosqlprotocol.user=db.the_user
nosqlprotocol.password=the_password
nosqlprotocol.authentication_required=true
nosqlprotocol.authorization_enabled=true
...
</pre></div>


<p>At MaxScale startup, the NoSQL user will then be created.</p>
<h4 id="examples">Examples</h4>
<h5 id="admin-user">Admin User</h5>
<p>We want the initial NoSQL user to be an administrator, with
full rights.</p>
<div><pre><span></span>CREATE USER 'admin.nosql_admin'@'%' IDENTIFIED BY 'nosql_password';
GRANT ALL PRIVILEGES ON *.* TO 'admin.nosql_admin'@'%' WITH GRANT OPTION;
</pre></div>


<p>As we want an admin user, the name is prefixed with <code>admin</code>,
which will have that effect. And since it is an admin user, the
privileges are granted ON <code>*.*</code>.</p>
<p>Thereafter, we specify the following in the configuration file,</p>
<div><pre><span></span>[NoSQL-Listener]
type=listener
service=...
protocol=nosqlprotocol
nosqlprotocol.user=admin.nosql_admin
nosqlprotocol.password=nosql_password
nosqlprotocol.authentication_required=true
nosqlprotocol.authorization_enabled=true
</pre></div>


<p>and start MaxScale.</p>
<p>As the creation of the initial user can be made only after the
monitor for the listener's service has marked one server as primary,
whether the creation succeeded or not must be checked from MaxScale'
log file:</p>
<div><pre><span></span>... notice : [nosqlprotocol] Created initial NoSQL user 'admin.nosql_admin'.
</pre></div>


<p>Under normal conditions, the bootstrapping will be almost
instantaneous.</p>
<p>It is now possible to connect using any MongoDB® client application.</p>
<div><pre><span></span>$ mongo --quiet --port 17017 -u nosql_admin -p nosql_password admin
&gt;
</pre></div>


<p>Note that when connecting the user is passed as <code>nosql_admin</code> and <em>not</em>
as <code>admin.nosql_admin</code>. The fact that we want to authenticate against
the <code>admin</code> database is expressed by passing the database as the last
argument.</p>
<div><pre><span></span>&gt; db.runCommand({usersInfo: 1});
{
    "users" : [
        {
            "_id" : "admin.nosql_admin",
            "userId" : UUID("7d921459-3099-42a7-ad06-ed37ac002161"),
            "user" : "nosql_admin",
            "db" : "admin",
            "roles" : [
                {
                    "db" : "admin",
                    "role" : "dbAdminAnyDatabase"
                },
                {
                    "db" : "admin",
                    "role" : "readWriteAnyDatabase"
                },
                {
                    "db" : "admin",
                    "role" : "userAdminAnyDatabase"
                },
                {
                    "db" : "admin",
                    "role" : "root"
                }
            ],
            "mechanisms" : [
                "SCRAM-SHA-256"
            ]
        }
    ],
    "ok" : 1
}
</pre></div>


<p>As can be seen, the user has the <em>any</em> roles on the <code>admin</code>
database, which means that all databases can be accessed and
modified, and that new users can be created.</p>
<h5 id="test-user">Test User</h5>
<p>We want the initial NoSQL user to be a user with limited rights,
intended to be used for testing.</p>
<div><pre><span></span>CREATE USER 'test.test_user'@'%' IDENTIFIED BY 'test_password';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, INDEX ON `test`.* TO 'test.test_user'@'%';
</pre></div>


<p>As we want a user with limited rights, the name is <em>not</em> prefixed
with <code>admin</code>. The privileges are granted specifically on database
<code>test.*</code>. Indeed, if <code>*.*</code> had been used, the creation of the initial
NoSQL user would have failed with an error. Here, the user is created
in the same database that the user is given access to, but it could
have been another one. Further, several <code>GRANT</code> statements could have
been used, had we wanted to give access to several databases.</p>
<p>Thereafter, we specify the following in the configuration file,</p>
<div><pre><span></span>[NoSQL-Listener]
type=listener
service=...
protocol=nosqlprotocol
nosqlprotocol.user=test.test_user
nosqlprotocol.password=test_password
nosqlprotocol.authentication_required=true
nosqlprotocol.authorization_enabled=true
</pre></div>


<p>and start MaxScale.</p>
<p>As the creation of the initial user can be made only after the
monitor for the listener's service has marked one server as primary,
whether the creation succeeded or not must be checked from MaxScale'
log file:</p>
<div><pre><span></span>... notice : [nosqlprotocol] Created initial NoSQL user 'test.test_user'.
</pre></div>


<p>Under normal conditions, the bootstrapping will be almost
instantaneous.</p>
<p>It is now possible to connect using any MongoDB® client application.</p>
<div><pre><span></span>$ mongo --quiet --port 17017 -u test_user -p test_password test
&gt;
</pre></div>


<p>Note that when connecting the user is passed as <code>test_user</code> and <em>not</em>
as <code>test.test_user</code>. The fact that we want to authenticate against
the <code>test</code> database is expressed by passing the database as the last
argument.</p>
<div><pre><span></span>&gt; db.runCommand({usersInfo: 1});
{
    "users" : [
        {
            "_id" : "test.test_user",
            "userId" : UUID("714f35e7-4276-45af-863c-0be4d1f5dd74"),
            "user" : "test_user",
            "db" : "test",
            "roles" : [
                {
                    "db" : "test",
                    "role" : "readWrite"
                }
            ],
            "mechanisms" : [
                "SCRAM-SHA-256"
            ]
        }
    ],
    "ok" : 1
}
</pre></div>


<p>As can be seen, the user has the <code>readWrite</code> role on the <code>test</code> database,
which means that only the <code>test</code> database can be accessed and modified.</p>
<h3 id="tlsssl">TLS/SSL</h3>
<p>Since <code>nosqlprotocol</code> is a regular protocol module used in a listener,
the TLS/SSL support of listeners is available. Please see
<a href="Getting-Started/Configuration-Guide.md#tls-encryption">TLS/SSL encryption</a>
for details.</p>
<h2 id="nosql-account-database">NoSQL Account Database</h2>
<p>So as to be able to connect to the MariaDB server on behalf of
clients, nosqlprotocol must know their password. As the password
is not transferred to nosqlprotocol during the authentication in
a way that could be used when logging into MariaDB, the password
must be stored when the user is created with <a href="#createUser">createUser</a>
or added with <a href="#mxsAddUser">mxsAddUser</a>.</p>
<p>Note that the password is not stored in cleartext but as three
different hashes; hashed with sha1 for use with MariaDB, salted
and hashed with sha1 for use with the <code>SCRAM-SHA-1</code> authentication
mechanism (if that is enabled for the user) and salted and hashed
with sha256 for use with the <code>SCRAM-SHA-256</code> authentication mechanism
(if that is enabled for the user).</p>
<p>The account information can be stored <em>privately</em>, in which case it
can be used only by a particular MaxScale instance, or in a
<em>shared</em> manner, in which case multiple MaxScale instances can
share the information and a user created/added on one instance
can be used on another.</p>
<h3 id="private">Private</h3>
<p>In the private case, the account information of nosqlprotocol is
stored in an <a href="https://sqlite.org/index.html">sqlite3</a> database
whose name is <code>&lt;libdir&gt;/nosqlprotocol/&lt;listener-name&gt;-v1.db</code>,
where <code>&lt;libdir&gt;</code> is the <em>libdir</em> of MaxScale, typically
<code>/var/lib/maxscale</code>, <code>&lt;listener-name&gt;</code> is the name of the
listener section in the MaxScale configuration file, and <code>-v1</code>
a suffix for making schema evolution easier, should there be
a need for that.</p>
<p>For instance, given a configuration like</p>
<div><pre><span></span>[NoSQL-Listener]
type=listener
service=TheService
protocol=nosqlprotocol
...
</pre></div>


<p>the account information will be stored in the file
<code>&lt;libdir&gt;/nosqlprotocol/NoSQL-Listener-v1.db</code>.</p>
<p>Note that since the database name is derived from the listener
name, changing the name of the listener in the configuration
file will have the effect of making all accounts disappear.
To retain the accounts, the database file should also be
renamed.</p>
<p>At first startup, the <code>nosqlprotocol</code> directory and
the file <code>NoSQL-Listener-v1.db</code> will be created. They will
be created with file permissions that only allow MaxScale
access. At subsequent startups the permissions will be checked
and MaxScale will refuse to start if the permissions allow
access to others.</p>
<p><strong>We strongly recommend that no manual modifications are made
to the database.</strong></p>
<p>Note that we make <strong>no</strong> guarantees that the way in which the
account information is stored by <code>nosqlprotocol</code> will remain the
same <em>even</em> between maintenance releases. We do guarantee,
however, that even if the way in which the account information is
stored changes, existing account information will automatically
be converted and no manual intervention, such as re-creation of
accounts, will be needed.</p>
<h2 id="shared">Shared</h2>
<p>In the shared case, the account information of nosqlprotocol
is stored in the cluster of the service in front of which the
NoSQL listener resides. The primary of the cluster will be used
both for reading and writing data.</p>
<p>A table whose name is the same as the listener's name in the
MaxScale configuration will be created in the database
specified with the <a href="#authentication_db">authentication_db</a>
parameter. If it is not specified explicitly, the default is
<code>nosqlprotocol</code>. The name of the table will be the name of
the listener section in the MaxScale configuration file.</p>
<p>For instance, given a configuration like</p>
<div><pre><span></span>[NoSQL-Listener]
type=listener
service=TheService
protocol=nosqlprotocol
...
</pre></div>


<p>the account information will be stored in the table
<code>nosqlprotocol.NoSQL-Listener</code>.</p>
<p>Note that since the table name is derived from the listener
name, changing the name of the listener in the configuration
file will have the effect of making all accounts disappear.
To retain the accounts, the table should also be renamed.</p>
<p><code>nosqlprotocol</code> will create the table when needed, so the
user specified with <a href="#authentication_user">authentication_user</a>
must have sufficient grants to be able to do that.</p>
<p><code>nosqlprotocol</code> will store in the table, data that allow
any MaxScale to authenticate a MongoDB® client, irrespective
of which MaxScale instance was used when the user was created.</p>
<p><code>nosqlprotocol</code> also stores in the table the SHA1 of a user's
password, to be able to authenticate against the MariaDB server.
Therefore it is <strong>strongly</strong> suggested to enable encryption key
management in MaxScale and to provide an authentication
key ID with <a href="#authentication_key_id">authentication_key_id</a> so
that the data will be encrypted.</p>
<p>If shared authentication has been enabled with
<a href="#authentication_shared">authentication_shared</a> then
<a href="#authentication_user">authentication_user</a> and
<a href="#authentication_password">authentication_password</a> must also
be provided. With <a href="#authentication_db">authentication_db</a> the
database name can optionally be changed, and with
<a href="#authentication_key_id">authentication_key_id</a> an
encryption key ID, using which the sensitive data is encrypted,
can optionally be provided.</p>
<p>Note that we make <strong>no</strong> guarantees that the table in which the
account information is stored by <code>nosqlprotocol</code> will remain the
same <em>even</em> between maintenance releases. We do guarantee,
however, that even if the way in which the account information is
stored changes, existing account information will automatically
be converted and no manual intervention, such as re-creation of
accounts, will be needed.</p>
<h1 id="wire-protocol">Wire Protocol</h1>
<p><em>Nosqlprotocol</em> fully supports wire protocol version 6 and only provides
rudimentary support for earlier wire protocol versions, but reports at
startup that it would support versions 0 to 6. The reason is that some
client libraries are buggy and use an old wire protocol version if the
server claims to support only version 6. Consequently, one should use a
client library version that at least supports wire protocol version 6.</p>
<h1 id="client-library">Client Library</h1>
<p>As the goal of <em>nosqlprotocol</em> is to implement, to the extent that it
is feasible, the wire protocol and the database commands the way MongoDB®
implements them, it should be possible to use any language specific driver.</p>
<p>However, during the development of <em>nosqlprotocol</em>, the <em>only</em> client library
that has been verified to work is version 3.6 of <em>MongoDB Node.JS Driver</em>.</p>
<h1 id="parameters">Parameters</h1>
<p>Using the following parameters, the behavior of <em>nosqlprotocol</em> can be
adjusted. As they are not generic listener parameters, but specific to
<em>nosqlprotocol</em> they must be qualified with the <code>nosqlprotocol</code>-prefix.</p>
<p>For instance:</p>
<div><pre><span></span>[NoSQL-Listener]
type=listener
service=TheService
protocol=nosqlprotocol
nosqlprotocol.user=the_user
nosqlprotocol.password=the_password
nosqlprotocol.on_unknown_command=return_error
...
</pre></div>


<h2 id="user"><code>user</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>""</code></li>
</ul>
<p>Specifies the <em>user</em> to be used when connecting to the backend, if the MongoDB®
client is not authenticated.</p>
<h2 id="password"><code>password</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>""</code></li>
</ul>
<p>Specifies the <em>password</em> to be used when connecting to the backend, is the MongoDB®
client is not authenticated. Note that the same <em>user</em>/<em>password</em> combination will be
used for all unauthenticated MongoDB® clients connecting to the same listener port.</p>
<h2 id="authentication_required"><code>authentication_required</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
<p>Specifies whether the client always must authenticate. If authentication is required,
it does not matter whether <code>user</code> and <code>password</code> have been specified, the client must
authenticate.</p>
<p>Authentication should not be required before users have been created with
<a href="#createUser">createUser</a> or added with <a href="#mxsAddUser">mxsAddUser</a>,
with authentication being optional and authorization being disabled.</p>
<p>NOTE: All client activity is <em>always</em> subject to authorization performed by the
MariaDB server.</p>
<h2 id="authentication_shared"><code>authentication_shared</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
<p>Specifies whether the NoSQL account information should be stored in a shared
manner or privately.</p>
<h2 id="authentication_db"><code>authentication_db</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>"NoSQL"</code></li>
</ul>
<p>Specifies the database of the table where the NoSQL account information
is stored, if <code>authentication_shared</code> is <code>true</code>.  If the database does not
exist, nosqlprotocol will attempt to create it, so either is should be
manually created or the used specified with <code>authentication_user</code> should
have the grants required to do so.</p>
<h2 id="authentication_key_id"><code>authentication_key_id</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>""</code></li>
</ul>
<p>The encryption key ID, using which the NoSQL account information should be
encrypted with when stored in the MariaDB server. If an encryption key ID is
given, the encryption key manager in MaxScale must also be enabled.</p>
<p>The encryption key must be a 256-bit key. Keys of shorter length are rejected
as invalid encryption keys.</p>
<h2 id="authentication_user"><code>authentication_user</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: Yes, <strong>if</strong> <code>authentication_shared</code> is true.</li>
</ul>
<p>Specifies the <em>user</em> to be used when modifying and accessing the NoSQL
account information stored in the MariaDB server.</p>
<h2 id="authentication_password"><code>authentication_password</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>""</code></li>
</ul>
<p>Specifies the <em>password</em> of <code>authentication_user</code>.</p>
<h2 id="authorization_enabled"><code>authorization_enabled</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
<p>Specifies whether nosqlprotocol itself should perform authorization in the context
of the commands <a href="#mxsAddUser">mxsAddUser</a>, <a href="#mxsRemoveUser">mxsRemoveUser</a> and
<a href="#mxsUpdateUser">mxsUpdateUser</a>. Authorization should not be enabled before users
have been created with <a href="#createUser">createUser</a> or added with <a href="#mxsAddUser">mxsAddUser</a>
with authorization being disabled.</p>
<p>NOTE: All client activity is <em>always</em> subject to authorization performed by the
MariaDB server.</p>
<h2 id="host"><code>host</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>"%"</code></li>
</ul>
<p>Specifies the <em>host</em> to be used when a MariaDB user is created via nosqlprotocol.
By default all users are created as <code>...@'%'</code>, which means that it is possible to
connect to the MariaDB server from any host using the credentials of the created
user. For tighter security, the IP-address of the MaxScale host can be specified.</p>
<p>NOTE: This value does <strong>not</strong> specify from which host it is allowed to connect to
MaxScale.</p>
<h2 id="on_unknown_command"><code>on_unknown_command</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#enumerations">enum</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Values</strong>: <code>return_error</code>, <code>return_empty</code></li>
<li><strong>Default</strong>: <code>return_error</code></li>
</ul>
<p>Specifies what should happen in case a clients sends an unrecognized command.</p>
<p>Enumeration values:</p>
<ul>
<li><code>return_error</code>: An error document is returned.</li>
<li><code>return_empty</code>: An empty document is returned.</li>
</ul>
<h2 id="log_unknown_command"><code>log_unknown_command</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>false</code></li>
</ul>
<p>Specifies whether an unknown command should be logged. This is primarily
for debugging purposes, to find out whether a client uses a command that
currently is not supported.</p>
<h2 id="auto_create_databases"><code>auto_create_databases</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>true</code></li>
</ul>
<p>Specifies whether databases should automatically be created, as needed.</p>
<p>Note that setting this parameter to <code>true</code>, without also setting
<code>auto_create_tables</code> to <code>true</code>, has no effect at all.</p>
<h2 id="auto_create_tables"><code>auto_create_tables</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>true</code></li>
</ul>
<p>Specifies whether tables should automatically be created, as needed.</p>
<p>Note that this applies only if the relevant database already exists.
If a database should also be created if needed, then <code>auto_create_databases</code>
must also be set to <code>true</code>.</p>
<h2 id="id_length"><code>id_length</code></h2>
<ul>
<li><strong>Type</strong>: count</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Range</strong>: <code>[35, 2048]</code></li>
<li>*<em>Default</em>: <code>35</code></li>
</ul>
<p>Specifies the length of the id column in tables that are automatically created.</p>
<h2 id="ordered_insert_behavior"><code>ordered_insert_behavior</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#enumerations">enum</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Values</strong>: <code>atomic</code>, <code>default</code></li>
<li><strong>Default</strong>: <code>default</code></li>
</ul>
<p>Enumeration values:</p>
<ul>
<li><code>default</code>: Each document is inserted using a <em>separate</em> <code>INSERT</code>, either in a
     multi-statement or in a compound statement. Whether an error causes the remaining
     insertions to be aborted, depends on the value of <code>ordered</code> specified in the
     insert command.</li>
<li><code>atomic</code>: If the value of <code>ordered</code> in the insert command is <code>true</code>
     (the default) then all documents are inserted using a <em>single</em> <code>INSERT</code> statement,
     that is, either all insertions succeed or none will. If <code>ordered</code> is false, then
     the behavior is as in the <code>default</code> case.</li>
</ul>
<p>What combination of <code>ordered_insert_behavior</code> and <code>ordered</code> (in the insert command
document) is used, has an impact on the performance. Please see the discussion at
<a href="#insert">insert</a>.</p>
<h2 id="cursor_timeout"><code>cursor_timeout</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#durations">duration</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: <code>60s</code></li>
</ul>
<p>Specifies how long a cursor can be idle, that is, not accessed, before it is
automatically closed.</p>
<h2 id="debug"><code>debug</code></h2>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-02-mariadb-maxscale-configuration-guide/#enumerations">enum_mask</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Values</strong>: <code>none</code>, <code>in</code>, <code>out</code>, <code>back</code></li>
<li><strong>Default</strong>: <code>none</code></li>
</ul>
<p>Specifies what should be logged as <em>notice</em> messages.</p>
<p>Enumeration values:</p>
<ul>
<li><code>none</code>: Nothing is logged.</li>
<li><code>in</code>: The <em>incoming</em> protocol command is logged.</li>
<li><code>out</code>: The <em>outgoing</em> SQL sent to the backend is logged.</li>
<li><code>back</code>: The response sent <em>back</em> to the client is logged.</li>
</ul>
<p>So, specify</p>
<div><pre><span></span>nosqlprotocol.debug=in,out,back
</pre></div>


<p>to have the incoming command, the corresponding SQL sent to the backend
and the resulting response sent to the client logged.</p>
<h2 id="internal_cache"><code>internal_cache</code></h2>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Default</strong>: ''</li>
</ul>
<p>Specifies what internal cache to use if any. Currently, the only
permissible value is <code>cache</code>, which refers to the
<a href="../Filters/Cache.md">cache filter</a>.</p>
<p>Please see <a href="#caching">caching</a> for more information.</p>
<h1 id="databases-and-tables">Databases and Tables</h1>
<p>By default, <em>nosqlprotocol</em> automatically creates databases as needed.
The default behavior can be changed by setting <code>auto_create_databases</code> to
false. In that case, databases must manually be created.</p>
<p>Each MongoDB® <em>collection</em> corresponds to a MariaDB table with the same name.
However, it is always possible to access a collection irrespective of whether
the corresponding table exists or not; it will simply appear to be empty.</p>
<p>Inserting documents into a collection, whose corresponding table does not
exist, succeeds, provided <code>auto_create_tables</code> is <code>true</code>, as the table will
in that case be created.</p>
<p>When <em>nosqlprotocol</em> creates a table, it uses a statement like</p>
<div><pre><span></span>CREATE TABLE name (id VARCHAR(35) AS (JSON_COMPACT(JSON_EXTRACT(doc, "$._id"))) UNIQUE KEY,
                   doc JSON,
                   CONSTRAINT id_not_null CHECK(id IS NOT NULL));
</pre></div>


<p>where the length of the <code>VARCHAR</code> is specified by the value of <code>id_length</code>,
whose default and minimum is 35.</p>
<p><em>NOTE</em> If the tables are created manually, then the <code>CREATE</code> statement
<em>must</em> contain a similar <code>AS</code>-clause as the one above and <em>should</em> contain
a similar constraint.</p>
<p>Note that <em>nosqlprotocol</em> does not in any way verify that the table
corresponding to a collection being accessed or modified does indeed
have the expected columns <code>id</code> and <code>doc</code> of the expected types, but it
simply uses the table, which will fail if the layout is not the expected
one.</p>
<p>To reduce the risk for confusion, the recommendation is to use a specific
database for tables that contain documents.</p>
<h1 id="operators">Operators</h1>
<p>The following operators are currently supported.</p>
<h2 id="query-and-projection-operators">Query and Projection Operators</h2>
<h3 id="comparison-query-operators">Comparison Query Operators</h3>
<ul>
<li>$eq</li>
<li>$gt</li>
<li>$gte</li>
<li>$in</li>
<li>$lt</li>
<li>$lte</li>
<li>$ne</li>
<li>$nin</li>
</ul>
<h3 id="logical-query-operators">Logical Query Operators</h3>
<ul>
<li>$and</li>
<li>$not</li>
<li>$nor</li>
<li>$or</li>
<li>$alwaysFalse</li>
<li>$alwaysTrue</li>
</ul>
<h3 id="element-query-operators">Element Query Operators</h3>
<ul>
<li>$exists</li>
<li>$type</li>
</ul>
<h4 id="type"><code>$type</code></h4>
<p>When <code>$type</code> is used, it will be converted into a condition involving one or more
<a href="https://mariadb.com/kb/en/json_type/">JSON_TYPE</a> comparisons. The following subset
of types can be used in <code>$type</code> queries:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Number</th>
<th>Alias</th>
<th>MariaDB Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>Double</td>
<td>1</td>
<td>"double"</td>
<td><code>DOUBLE</code></td>
</tr>
<tr>
<td>String</td>
<td>2</td>
<td>"string"</td>
<td><code>STRING</code></td>
</tr>
<tr>
<td>object</td>
<td>3</td>
<td>"object"</td>
<td><code>OBJECT</code></td>
</tr>
<tr>
<td>Array</td>
<td>4</td>
<td>"array"</td>
<td><code>ARRAY</code></td>
</tr>
<tr>
<td>Boolean</td>
<td>5</td>
<td>"bool"</td>
<td><code>BOOLEAN</code></td>
</tr>
<tr>
<td>32-bit integer</td>
<td>16</td>
<td>"int"</td>
<td><code>INTEGER</code></td>
</tr>
</tbody>
</table>
<p>The <em>"number"</em> alias is supported and will match values whose MariaDB type is
<code>DOUBLE</code> or <code>INTEGER</code>.</p>
<h3 id="evaluation-query-operators">Evaluation Query Operators</h3>
<ul>
<li>$mod</li>
<li>$regex</li>
</ul>
<h3 id="array-query-operators">Array Query Operators</h3>
<ul>
<li>$all</li>
<li>$elemMatch</li>
<li>$size</li>
</ul>
<h4 id="elemmatch"><code>$elemMatch</code></h4>
<p>As arguments, only the operators <code>$eq</code> and <code>$ne</code> are supported.</p>
<h2 id="update-operators">Update Operators</h2>
<h3 id="field-update-operators">Field Update Operators</h3>
<ul>
<li>$bit</li>
<li>$currentDate</li>
<li>$inc</li>
<li>$max</li>
<li>$min</li>
<li>$mul</li>
<li>$pop</li>
<li>$push</li>
<li>$rename</li>
<li>$set</li>
<li>$unset</li>
</ul>
<h1 id="database-commands">Database Commands</h1>
<p>The following commands are supported. At each command is specified
what fields are relevant for the command.</p>
<p><strong>All</strong> non-listed fields are ignored; their presence or absence have no
impact, unless otherwise explicitly specified.</p>
<h2 id="aggregation-commands">Aggregation Commands</h2>
<h3 id="count">count</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>count</td>
<td>string</td>
<td>The name of the collection to count.</td>
</tr>
<tr>
<td>query</td>
<td>document</td>
<td>Optional. A query that selects which documents to count in the collection</td>
</tr>
<tr>
<td>limit</td>
<td>integer</td>
<td>Optional. The maximum number of matching documents to return.</td>
</tr>
<tr>
<td>skip</td>
<td>integer</td>
<td>Optional. The number of matching documents to skip before returning results.</td>
</tr>
</tbody>
</table>
<h3 id="distinct">distinct</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>distinct</td>
<td>string</td>
<td>The name of the collection to query for distinct values.</td>
</tr>
<tr>
<td>key</td>
<td>string</td>
<td>The field for which to return distinct values.</td>
</tr>
<tr>
<td>query</td>
<td>document</td>
<td>Optional. A query that selects which documents to count in the collection</td>
</tr>
</tbody>
</table>
<h2 id="query-and-write-operation-commands">Query and Write Operation Commands</h2>
<h3 id="delete">delete</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>delete</td>
<td>string</td>
<td>The name of the target table.</td>
</tr>
<tr>
<td>deletes</td>
<td>array</td>
<td>An array of one or more delete statements to perform in the named collection.</td>
</tr>
<tr>
<td>ordered</td>
<td>boolean</td>
<td>Optional. If <code>true</code>, then when a delete statement fails, return without performing the remaining delete statements. If <code>false</code>, then when a delete statement fails, continue with the remaining delete statements, if any. Defaults to <code>true</code>.</td>
</tr>
</tbody>
</table>
<p>Each element of the deletes array contains the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>q</td>
<td>document</td>
<td>The query that matches documents to delete.</td>
</tr>
<tr>
<td>limit</td>
<td>integer</td>
<td>The number of matching documents to delete. Specify either a 0 to delete all matching documents or 1 to delete a single document.</td>
</tr>
</tbody>
</table>
<h3 id="find">find</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>find</td>
<td>string</td>
<td>The name of the target table.</td>
</tr>
<tr>
<td>filter</td>
<td>document</td>
<td>Optional. The query predicate. If unspecified, then all documents in the collection will match the predicate.</td>
</tr>
<tr>
<td>sort</td>
<td>document</td>
<td>Optional. The sort specification for the ordering of the results.</td>
</tr>
<tr>
<td>projection</td>
<td>document</td>
<td>Optional. The projection specification to determine which fields to includein the returned documents.</td>
</tr>
<tr>
<td>skip</td>
<td>Positive integer</td>
<td>Optional. Number of documents to skip. Defaults to 0.</td>
</tr>
<tr>
<td>limit</td>
<td>Non-negative integer</td>
<td>Optional. The maximum number of documents to return. If unspecified, then defaults to no limit. A limit of 0 is equivalent to setting no limit.</td>
</tr>
<tr>
<td>batchSize</td>
<td>Non-negative integer</td>
<td>Optional. The number of documents to return in the first batch. Defaults to 101. A batchSize of 0 means that the cursor will be established, but no documents will be returned in the first batch.</td>
</tr>
<tr>
<td>singleBatch</td>
<td>boolean</td>
<td>Optional. Determines whether to close the cursor after the first batch. Defaults to false.</td>
</tr>
</tbody>
</table>
<p>All other fields are ignored.</p>
<h4 id="projection">Projection</h4>
<p>The <code>projection</code> parameter determines which fields are returned in the matching documents.
The <code>projection</code> parameter takes a document of the following form:</p>
<div><pre><span></span>{ &lt;field1&gt;: &lt;value&gt;, &lt;field2&gt;: &lt;value&gt; ... }
</pre></div>


<p>If a <code>projection</code> document is not provided or if it is empty, the entire document
will be returned.</p>
<table>
<thead>
<tr>
<th>Projection</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;field&gt;: &lt;1 or true&gt;</code></td>
<td>Specifies the inclusion of a field.</td>
</tr>
<tr>
<td><code>&lt;field&gt;: &lt;0 or false&gt;</code></td>
<td>Specifies the exclusion of a field.</td>
</tr>
</tbody>
</table>
<h5 id="embedded-field-specification">Embedded Field Specification</h5>
<p>For fields in an embedded documents, the field can be specified using:</p>
<ul>
<li><em>dot notation</em>; e.g. <code>"field.nestedfield": &lt;value&gt;</code></li>
</ul>
<p>In particular, specifying fields in embedded documents using nested form
is not supported.</p>
<h5 id="_id-field-projection"><code>_id</code> Field Projection</h5>
<p>The <code>_id</code> field is included in the returned documents by default unless you
explicitly specify <code>_id: 0</code> in the projection to suppress the field.</p>
<h4 id="inclusion-or-exclusion">Inclusion or Exclusion</h4>
<p>A <code>projection</code> cannot contain both include and exclude specifications,
with the exception of the <code>_id</code> field:</p>
<ul>
<li>In projections that <em>explicitly</em> include fields, the <code>_id</code> field is the only field that can be explicitly excluded.</li>
<li>In projections that <em>explicitly</em> excludes fields, the <code>_id</code> field is the only field that can be explicitly include; however, the <code>_id</code> field is included by default.</li>
</ul>
<p><em>NOTE</em> Currently <code>_id</code> is the only field that can be excluded, and <em>only</em>
if other fields are explicitly included.
<em>NOTE</em> Currently exclusion of other fields but <code>_id</code> is not supported.</p>
<h4 id="filtering-by-_id">Filtering by <code>_id</code></h4>
<p>Note that there is a significant difference between</p>
<div><pre><span></span>&gt; db.runCommand({find: "collection", filter: { _id: 4711 }});
</pre></div>


<p>and</p>
<div><pre><span></span>&gt; db.runCommand({find: "collection", filter: { _id: { $eq: 4711 }}});
</pre></div>


<p>In the former case the generated <code>WHERE</code> clause will be</p>
<div><pre><span></span>... WHERE (id = '4711')
</pre></div>


<p>and in the latter</p>
<div><pre><span></span>... WHERE (JSON_EXTRACT(doc, '$._id') = 4711)
</pre></div>


<p>That is, in the former case the <em>indexed</em> column <code>id</code> will be used, in the
latter it will not.</p>
<h3 id="findandmodify">findAndModify</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>findAndModify</td>
<td>string</td>
<td>The name of the target table.</td>
</tr>
<tr>
<td>query</td>
<td>document</td>
<td>Optional. The query predicate.</td>
</tr>
<tr>
<td>sort</td>
<td>document</td>
<td>Optional. The sort specification used when the document is selected.</td>
</tr>
<tr>
<td>remove</td>
<td>boolean</td>
<td>Mandatory, if <code>update</code> is <em>not</em> specified. If <code>true</code>, the document will be deleted.</td>
</tr>
<tr>
<td>update</td>
<td>document</td>
<td>Mandatory, if <code>remove</code> is <em>not</em> specified. See <a href="#behavior">Update.behavior</a> for details.</td>
</tr>
<tr>
<td>new</td>
<td>boolean</td>
<td>Optional. If <code>true</code> the modified document and not the original document is returned. If <code>remove</code> is specified, then the original document is always returned.</td>
</tr>
<tr>
<td>fields</td>
<td>document</td>
<td>Optional. Specified which fields to return. See <a href="#projection">Find.projection</a> for details.</td>
</tr>
<tr>
<td>upsert</td>
<td>boolean</td>
<td>Optional. If <code>true</code> then a document will be created, if one is not found.</td>
</tr>
</tbody>
</table>
<p>All other fields are ignored.</p>
<h3 id="getlasterror">getLastError</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>getLastError</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="getmore">getMore</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>getMore</td>
<td>long</td>
<td>The cursor id.</td>
</tr>
<tr>
<td>collection</td>
<td>string</td>
<td>The name of the collection over which the cursor is operating.</td>
</tr>
<tr>
<td>batchSize</td>
<td>positive integer</td>
<td>Optional. The number of documents to return in the batch.</td>
</tr>
</tbody>
</table>
<h3 id="insert">insert</h3>
<p>The <code>insert</code> command inserts one or more documents into the table whose
name is the same as that of the collection. If the option <code>auto_create_tables</code>
is <code>true</code>, then the table is created if it does not already exist. If the
value is <code>false</code>, then the insert will fail unless the table already exists.</p>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>insert</td>
<td>string</td>
<td>The name of the target collection (i.e. table).</td>
</tr>
<tr>
<td>documents</td>
<td>array</td>
<td>An array of one or more documents to be inserted to the named collection.</td>
</tr>
<tr>
<td>ordered</td>
<td>boolean</td>
<td>Optional, with default being <code>true</code>. See below for description.</td>
</tr>
</tbody>
</table>
<h4 id="ordered"><code>ordered</code></h4>
<p>The impact of <code>ordered</code> is dependent upon the value of <code>ordered_insert_behavior</code>.</p>
<h5 id="default"><code>default</code></h5>
<p>In this case <code>ordered</code> has the same impact as in MongoDB®. That is, if the value
is <code>true</code>, then when an insert of a document fails, return without inserting any
remaining documents listed in the inserts array. If <code>false</code>, then when an insert
of a document fails, continue to insert the remaining documents.</p>
<h5 id="atomic"><code>atomic</code></h5>
<p>If <code>ordered</code> is <code>true</code>, then all documents will be inserted using a single
INSERT command. That is, if the insertion of any document fails, for instance,
due to a duplicate id, then no document will be inserted. If <code>ordered</code> is <code>false</code>,
then the behavior is identical with that of <code>default</code>.</p>
<h4 id="performance">Performance</h4>
<p>What combination of <code>ordered_insert_behavior</code> and <code>ordered</code> is used, has an
impact on the performance.</p>
<table>
<thead>
<tr>
<th><code>ordered_insert_behavior</code></th>
<th><code>ordered = true</code></th>
<th><code>ordered = false</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>default</code></td>
<td>All documents are inserted within a compound statement, in a transaction containing as many <code>INSERT</code> statements as there are documents.</td>
<td>All documents are inserted in a single multi-statement transaction containing as many <code>INSERT IGNORE</code> statements as there are documents.</td>
</tr>
<tr>
<td><code>atomic</code></td>
<td>All documents are inserted using a single <code>INSERT</code> statement.</td>
<td><em>Same as above</em></td>
</tr>
</tbody>
</table>
<p>Of these, <code>atomic + true</code> is the fastest and <code>atomic|default + false</code> the slowest,
being roughly twice as slow. The performance of 'default + true' is halfway between
the two.</p>
<h3 id="reseterror">resetError</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>resetError</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="update">update</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>update</td>
<td>string</td>
<td>The name of the target table.</td>
</tr>
<tr>
<td>updates</td>
<td>array</td>
<td>An array of documents that describe what to updated.</td>
</tr>
</tbody>
</table>
<p>All other fields are ignored.</p>
<h4 id="update-statements">Update Statements</h4>
<p>Each element of the updates array is an update statement document.
Each document contains the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>q</td>
<td>document</td>
<td>The query that matches documents to update.</td>
</tr>
<tr>
<td>u</td>
<td>document</td>
<td>The modifications to apply. See <em>behavior</em> below for details.</td>
</tr>
<tr>
<td>multi</td>
<td>boolean</td>
<td>Optional. If <code>true</code>, updates all documents that meet the query criteria. If <code>false</code> limit the update to one document that meets the query criteria. Defaults to <code>false</code>.</td>
</tr>
</tbody>
</table>
<p>Note that currently it is possible to set <code>multi</code> to <code>true</code> in conjunction
with a <em>replacement-style</em> update, even though MongoDB® rejects that.</p>
<p>All other fields are ignored, with the exception of <code>upsert</code> that if present
with the value of <code>true</code> will cause the command to fail.</p>
<h5 id="behavior">Behavior</h5>
<p>Currently only updating using <em>update operator expressions</em> or with a
<em>replacement document</em> is supported. In particular, updating using an
<em>aggregation pipeline</em> is not supported.</p>
<h6 id="update-with-an-update-operator-expressions-document">Update with an <em>Update Operator Expressions</em> document</h6>
<p>The update statement field <code>u</code> can accept a document that only contains
<a href="#update-operators">update operator</a> expressions. For example:</p>
<div><pre><span></span>updates: [
   {
     q: &lt;query&gt;,
     u: { $set: { status: "D" } },
      ...
   },
   ...
]
</pre></div>


<p>In this case, the update command updates only the corresponding fields in the document.</p>
<h6 id="update-with-a-replacement-document">Update with a <em>Replacement Document</em></h6>
<p>The update statement field <code>u</code> field can accept a <em>replacement document</em>,
i.e. the document contains only <code>field:value</code> expressions. For example:</p>
<div><pre><span></span>updates: [
   {
      q: &lt;query&gt;,
      u: { status: "D", quantity: 4 },
      ...
   },
   ...
]
</pre></div>


<p>In this case, the update command replaces the matching document with the update document.
The update command can only replace a single matching document; i.e. the multi field
cannot be true.</p>
<p><strong>Note</strong> If the replacement document contains an <code>_id</code> field, it will be ignored and the
document id will remain non-changed while the document otherwise is replaced. This is
different from MongoDB® where the presence of the <code>_id</code> field in the replacement document
causes an error, if the value is not the same as it is in the document being replaced.</p>
<h2 id="authentication-commands">Authentication Commands</h2>
<h3 id="logout">Logout</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>logout</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>If you are not logged in and using authentication, <code>logout</code> has no effect.</p>
<p>Note that in order to be logged out, the logging out must be done while
using the same database that was used when you logged on.</p>
<p>Always returns</p>
<div><pre><span></span>{ ok: 1 }
</pre></div>


<h2 id="user-management-commands">User Management Commands</h2>
<h3 id="createuser">createUser</h3>
<p>Creates a new MariaDB user and adds an entry to the local nosqlprotocol
account database.</p>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>createUser</td>
<td>string</td>
<td>The name of the user to be added.</td>
</tr>
<tr>
<td>pwd</td>
<td>string</td>
<td>The password in cleartext.</td>
</tr>
<tr>
<td>customData</td>
<td>document</td>
<td>Optional. Any arbitrary information.</td>
</tr>
<tr>
<td>roles</td>
<td>array</td>
<td>The roles granted to the user.</td>
</tr>
<tr>
<td>mechanisms</td>
<td>array</td>
<td>Optional. The specific supported SCRAM mechanisms for this user. Must be a subset of the supported mechanisms.</td>
</tr>
<tr>
<td>digestPassword</td>
<td>boolean</td>
<td>Optional. If specified, must be <code>true</code>.</td>
</tr>
</tbody>
</table>
<p>The MariaDB user will be created as <code>'&lt;db&gt;.&lt;user&gt;'@'%'</code> where <code>&lt;db&gt;</code> is
the name of the NoSQL database in whose context the user is created, and
<code>&lt;user&gt;</code> the value of the <code>createUser</code> field. For instance, with the
following command</p>
<div><pre><span></span>&gt; use myDatabase;
&gt; db.runCommand({createUser: "user1", pwd: "pwd1", roles: []});
</pre></div>


<p>the MariaDB user <code>'myDatabase.user1'@'%'</code> will be created.</p>
<p>The elements of the <code>roles</code> array are converted into privileges
as explained in <a href="#roles_and_privileges">here</a>.</p>
<p>In practice the creation is performed as follows:
<em> First the MariaDB user is created.
</em> Then the privileges are granted.
* Finally the local nosqlprotocol account database is updated.</p>
<p>If the granting of privileges fails, an attempt will be made to
drop the user.</p>
<h3 id="dropallusersfromdatabase">dropAllUsersFromDatabase</h3>
<p>Drops all users from the local nosqlprotocol account database and
the corresponding MariaDB users.</p>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dropAllUsersFromDatabase</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>If <em>no</em> users can be dropped, e.g. due to an authorization error,
then an error will be returned. If even a single user can be dropped
the returned document tells how many were dropped, which does not
necessarily indicate that <em>all</em> users were dropped.</p>
<h3 id="dropuser">dropUser</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dropUser</td>
<td>string</td>
<td>The name of the user to be dropped.</td>
</tr>
</tbody>
</table>
<p>The user will first be dropped from the MariaDB server and if
that succeeds also from the local nosqlprotocol account database.</p>
<h3 id="grantrolestouser">grantRolesToUser</h3>
<p>This command <em>adds</em> more roles to a NoSQL user, which may imply
that additional privileges are granted to the corresponding MariaDB
user.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>grantRolesToUser</td>
<td>string</td>
<td>The name of the user to give additional roles.</td>
</tr>
<tr>
<td>roles</td>
<td>array</td>
<td>An array of additional roles.</td>
</tr>
</tbody>
</table>
<p>Note that roles assigned to different databases will result in separate
GRANT statements, which means that it is possible that some succeed and
others do not.</p>
<h3 id="revokerolesfromuser">revokeRolesFromUser</h3>
<p>This command <em>removes</em> roles from an NoSQL user, which may imply
that privileges are revoked from the corresponding MariaDB user.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>revokeRolesFromUser</td>
<td>string</td>
<td>The name of the user to remove roles from.</td>
</tr>
<tr>
<td>roles</td>
<td>array</td>
<td>An array of roles to remove.</td>
</tr>
</tbody>
</table>
<p>Note that roles to be removed from different databases will result in
separate REVOKE statements, which means that it is possible that some
succeed and others do not.</p>
<h3 id="updateuser">updateUser</h3>
<p>This command updates the information about a particular user.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>updateUser</td>
<td>string</td>
<td>The user whose information should be updated.</td>
</tr>
<tr>
<td>pwd</td>
<td>string</td>
<td>Optional. The new password in cleartext.</td>
</tr>
<tr>
<td>customData</td>
<td>document</td>
<td>Optional. Any arbitrary information.</td>
</tr>
<tr>
<td>roles</td>
<td>array</td>
<td>Optional. The roles granted to the user. Note that the existing ones are <em>replaced</em> and not amended with these roles.</td>
</tr>
<tr>
<td>mechanisms</td>
<td>array</td>
<td>Optional. The specific SCRAM mechanisms for user credentials. Note that if a new <code>pwd</code> is provided, then the array can contain all supported SCRAM mechanisms. If a new <code>pwd</code> is not provided, then the array must be a subset of the existing mechanisms of the user.</td>
</tr>
</tbody>
</table>
<p>Changes to <code>customData</code> or <code>mechanisms</code> are made only to the local
nosqlprotocol database, but changes to <code>pwd</code> or <code>roles</code> require
the MariaDB server to be updated.</p>
<h3 id="usersinfo">usersInfo</h3>
<p>This command returns information about one or more users.</p>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>usersInfo</td>
<td>various</td>
<td>Specifies what to return. See below.</td>
</tr>
<tr>
<td>showCredentials</td>
<td>boolean</td>
<td>Optional, default <code>false</code>. Specifies whether the credentials should be returned.</td>
</tr>
</tbody>
</table>
<p>The returned information depends the valie of <code>usersInfo</code>:</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{ usersInfo: 1 }</code></td>
<td>Returns information of all users in the database where the command is run.</td>
</tr>
<tr>
<td><code>{ usersInfo: &lt;username&gt; }</code></td>
<td>Returns information about a specific user in the database where the command is run.</td>
</tr>
<tr>
<td><code>{ usersInfo: { user: &lt;name&gt;, db: &lt;db&gt; }}</code></td>
<td>Returns information about the user specified by the name and database.</td>
</tr>
<tr>
<td><code>{ usersInfo: [{ user: &lt;name&gt;, db: &lt;db&gt; }, ...]}</code></td>
<td>Returns information about specified users.</td>
</tr>
<tr>
<td><code>{ usersInfo: [ &lt;username&gt;, ... ]}</code></td>
<td>Returns information about specified users in the database where the command is run.</td>
</tr>
</tbody>
</table>
<p>Note that users may always view their own information. Otherwise the user must
have the <code>userAdmin</code> or <code>userAdminAnyDatabase</code> role.</p>
<p>If <code>showCredentials</code> is true, the returned object(s) will contain a
<code>mariadb: { password: "*..."}</code> field, where <code>password</code> is the
<code>SHA1(SHA1())</code> value of the password used when logging to MariaDB.
That is, the same string that is found in the <code>password</code> column in
the <code>mysql.user</code> table.</p>
<h2 id="replication-commands">Replication Commands</h2>
<h3 id="ismaster">isMaster</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>isMaster</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="replsetgetstatus">replSetGetStatus</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>replSetGetStatus</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>All other fields are ignored.</p>
<p>This command will always return the document</p>
<div><pre><span></span>{
    "ok" : 0,
    "errmsg" : "not running with --replSet",
    "code" : 76,
    "codeName" : "NoReplicationEnabled"
}
</pre></div>


<h2 id="sessions-commands">Sessions Commands</h2>
<h3 id="endsessions">endSessions</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>endSessions</td>
<td>array</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>The following document will always be returned:</p>
<div><pre><span></span>{ "ok" : 1 }
</pre></div>


<h2 id="administration-commands">Administration Commands</h2>
<h3 id="create">create</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>string</td>
<td>The name of the collection to create.</td>
</tr>
<tr>
<td>capped</td>
<td>boolean</td>
<td>Optional. If specified, the value must be <code>false</code> as capped collections are not supported.</td>
</tr>
<tr>
<td>viewOn</td>
<td>string</td>
<td>Optional. If specified, the command will fail as views are not supported.</td>
</tr>
</tbody>
</table>
<p>Currently, <em>capped collections</em> and <em>views</em> are not supported. Consequently,
specifying that the collection should be capped or that it should be a
view on another collection, will cause the command to fail.</p>
<h3 id="createindexes">createIndexes</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>createIndexes</td>
<td>string</td>
<td>The collection for which to create indexes.</td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong> Currently it is not possible to create indexes, but the command
will nonetheless return success, provide the index specification passes
some rudimentary sanity checks. Note also that the collection will be
created if it does not exist.</p>
<h3 id="drop">drop</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>drop</td>
<td>string</td>
<td>The name of the collection to drop.</td>
</tr>
</tbody>
</table>
<h3 id="dropdatabase">dropDatabase</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dropDatabase</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="dropindexes">dropIndexes</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dropIndexes</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong> Currently it is not possible to create indexes and thus there
will never be any indexes that could be dropped. However, provided the
specified collection exists, dropping indexes will always succeed except
for an attempt to drop the built-in <code>_id_</code> index.</p>
<h3 id="fsync">fsync</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>fsync</td>
<td>any</td>
<td>Ignored</td>
</tr>
</tbody>
</table>
<p>The response will always be</p>
<div><pre><span></span>{
  "errmsg" : "fsync not supported by MaxScale:nosqlprotocol",
  "code" : 115,
  "codeName" : "CommandNotSupported",
  "ok" : 0
}
</pre></div>


<h3 id="killcursors">killCursors</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>killCursors</td>
<td>string</td>
<td>The name of the collection.</td>
</tr>
<tr>
<td>cursors</td>
<td>array</td>
<td>The ids of the cursors to kill.</td>
</tr>
</tbody>
</table>
<h3 id="listcollections">listCollections</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>listCollections</td>
<td>any</td>
<td>Ignored.</td>
</tr>
<tr>
<td>filter</td>
<td>document</td>
<td>The field <code>name</code> is honored, other fields are not but cause warnings to be logged.</td>
</tr>
<tr>
<td>nameOnly</td>
<td>boolean</td>
<td>Optional. A flag to indicate whether the command should return just the collection names and type or return both the name and other information.</td>
</tr>
</tbody>
</table>
<p>Note that the command lists all collections (that is, tables) that are found
in the current database. The listed collections may or may not be suitable
for being accessed using <em>nosqlprotocol</em>.</p>
<h3 id="listdatabases">listDatabases</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>listDatabases</td>
<td>any</td>
<td>Ignored.</td>
</tr>
<tr>
<td>nameOnly</td>
<td>boolean</td>
<td>Optional. A flag to indicate whether the command should return just the database names, or return both database names and size information.</td>
</tr>
</tbody>
</table>
<h3 id="listindexes">listIndexes</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>listIndexes</td>
<td>string</td>
<td>The name of the collection.</td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong> As it currently is not possible to actually create indexes,
although an attempt to do so using <code>createIndexes</code> will succeed, the
result will always only contain information about the built-in
index <code>_id_</code>.</p>
<h3 id="renamecollection">renameCollection</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>renameCollection</td>
<td>string</td>
<td>The namespace of the collection to rename. The namespace is a combination of the database name and the name of the collection.</td>
</tr>
<tr>
<td>to</td>
<td>string</td>
<td>The new namespace of the collection. Moving a collection/table from one database to another succeeds provided the databases reside in the same filesystem.</td>
</tr>
<tr>
<td>dropTarget</td>
<td>boolean</td>
<td>Optional. If <code>true</code>, the target collection/table will be dropped before the renaming is made. The default value is <code>false</code>.</td>
</tr>
</tbody>
</table>
<h3 id="setparameter">setParameter</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>setParameter</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>Any kind of parameter is accepted and the response will always be:</p>
<div><pre><span></span>{ "ok" : 1 }
</pre></div>


<h2 id="diagnostic-commands">Diagnostic Commands</h2>
<h3 id="buildinfo">buildInfo</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>buildInfo</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>The command returns a document containing the stable fields. In addition, there is a field <code>maxscale</code> whose value is the MaxScale version, expressed as a string.</p>
<h3 id="explain">explain</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>explain</td>
<td>document</td>
<td>Document specifying the command to be explained. The commands are <code>aggregate</code>, <code>count</code>, <code>delete</code>, <code>distinct</code>, <code>find</code>, <code>findAndModify</code>, <code>mapReduce</code> and <code>update</code>.</td>
</tr>
<tr>
<td>verbosity</td>
<td>string</td>
<td>Either <code>queryPlanner</code>, <code>executionStats</code> or <code>allPlansExecution</code>.</td>
</tr>
</tbody>
</table>
<p>The command will return a document of the expected layout, but the content is only rudimentary.</p>
<h3 id="getcmdlineopts">getCmdLineOpts</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>getCmdLineOpts</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="getlog">getLog</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>getLog</td>
<td>string</td>
<td><code>*</code>, <code>global</code> and <code>startupWarnings</code></td>
</tr>
</tbody>
</table>
<p>The command returns a document of the correct format, but <em>no</em> actual log data will be returned.</p>
<h3 id="hostinfo">hostInfo</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostInfo</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="listcommands">listCommands</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>listCommands</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="ping">ping</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ping</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="serverstatus">serverStatus</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>serverStatus</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h3 id="validate">validate</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>validate</td>
<td>string</td>
<td>The name of the collection to validate.</td>
</tr>
</tbody>
</table>
<p>The command does not actually perform any validation but for checking
that the collection exists. The response will contain in <code>nrecords</code>
the current number of documents/rows it contains.</p>
<h3 id="whatsmyuri">whatsmyuri</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>whatsmyri</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>This is an internal command, implemented only because the Mongo Shell uses it.</p>
<h2 id="free-monitoring-commands">Free Monitoring Commands</h2>
<h3 id="getfreemonitoringstatus">getFreeMonitoringStatus</h3>
<p>The following fields are relevant.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>getFreeMonitoringStatus</td>
<td>any</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<p>The following document will always be returned:</p>
<div><pre><span></span>{ "state" : "undecided", "ok" : 1 }
</pre></div>


<h2 id="maxscale-specific-commands">MaxScale Specific Commands</h2>
<h3 id="mxsadduser">mxsAddUser</h3>
<h4 id="definition">Definition</h4>
<h5 id="mxsadduser_1"><strong>mxsAddUser</strong></h5>
<p>The <code>mxsAddUser</code> command adds an <em>existing</em> MariaDB user to the local
nosqlprotocol account database. Use <a href="#createUser">createUser</a> if the
MariaDB user should be created as well.</p>
<p>Note that the <code>mxsAddUser</code> command does not check that the user exists
or that the specified roles are compatible with the grants of the user.</p>
<h4 id="syntax">Syntax</h4>
<p>The 'mxsAddUser' command has the following syntax:</p>
<div><pre><span></span>db.runCommand(
    {
        mxsAddUser: "&lt;name&gt;",
        pwd: passwordPrompt(),  // Or "&lt;cleartext password&gt;"
        customData: { &lt;any information&gt; },
        roles: [
            { role: "&lt;role&gt;", db: "&lt;database&gt;" } | "&lt;role&gt;",
            ...
        ],
        mechanisms: [ "&lt;scram-mechanism&gt;", ...],
        digestPassword: &lt;boolean&gt;
    }
)
</pre></div>


<h5 id="command-fields">Command Fields</h5>
<p>The command has the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsAddUser</td>
<td>string</td>
<td>The name of the user to be added.</td>
</tr>
<tr>
<td>pwd</td>
<td>string</td>
<td>The password in cleartext.</td>
</tr>
<tr>
<td>customData</td>
<td>document</td>
<td>Optional. Any arbitrary information.</td>
</tr>
<tr>
<td>roles</td>
<td>array</td>
<td>The roles granted to the user.</td>
</tr>
<tr>
<td>mechanisms</td>
<td>array</td>
<td>Optional. The specific supported SCRAM mechanisms for this user. Must be a subset of the supported mechanisms.</td>
</tr>
<tr>
<td>digestPassword</td>
<td>boolean</td>
<td>Optional. If specified, must be <code>true</code>.</td>
</tr>
</tbody>
</table>
<p>The value of <code>mxsAddUser</code> should be the name (without the host part) of
an existing user in the MariaDB server and the value of <code>pwd</code> should be
that user's password  in cleartext.</p>
<p>The <code>roles</code> array should contain roles that a compatible with the
grants of the user. Please check <a href="#roles_and_grants">roles and grants</a>
for a discussion on how to map roles map to grants.</p>
<h5 id="returns">Returns</h5>
<p>If the addition of the user succeeds, the command returns a document
with the single field <code>ok</code> whose value is <code>1</code>.</p>
<div><pre><span></span>&gt; db.runCommand({mxsAddUser: "user", pwd: "pwd", roles: ["readWrite"]});
{ "ok" : 1 }
</pre></div>


<p>If there is a failure of some kind, the command returns an error document</p>
<div><pre><span></span>&gt; db.runCommand({mxsAddUser: "user2", pwd: "pwd2", roles: ["redWrite"]});
{
    "ok" : 0,
    "errmsg" : "No role named redWrite@test",
    "code" : 31,
    "codeName" : "RoleNotFound"
}
</pre></div>


<h3 id="mxscreatedatabase">mxsCreateDatabase</h3>
<h4 id="definition_1">Definition</h4>
<h5 id="mxscreatedatabase_1"><strong>mxsCreateDatabase</strong></h5>
<p>The 'mxsCreateDatabase' command creates a new database and must be run
against the <code>admin</code> database.</p>
<h4 id="syntax_1">Syntax</h4>
<p>The 'mxsCreateDatabase' has the following syntax:</p>
<div><pre><span></span>db.adminCommand(
    {
       mxsCreateDatabase: &lt;name&gt;
    }
)
</pre></div>


<h5 id="command-fields_1">Command Fields</h5>
<p>The command takes the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsCreateDatabase</td>
<td>string</td>
<td>The name of the database to be created.</td>
</tr>
</tbody>
</table>
<h5 id="returns_1">Returns</h5>
<p>If database creation succeeds, the command returns a document with the
single field <code>ok</code> whose value is <code>1</code>.</p>
<div><pre><span></span>&gt; db.adminCommand({mxsCreateDatabase: "db"});
{ "ok" : 1 }
</pre></div>


<p>If the database creation fails, the command returns an error document.</p>
<div><pre><span></span>&gt; db.adminCommand({mxsCreateDatabase: "db"});
{
    "ok" : 0,
    "errmsg" : "The database 'db' exists already.",
    "code" : 48,
    "codeName" : "NamespaceExists"
}
</pre></div>


<h3 id="mxsdiagnose">mxsDiagnose</h3>
<h4 id="definition_2">Definition</h4>
<h5 id="mxsdiagnose_1"><strong>mxsDiagnose</strong></h5>
<p>The <code>mxsDiagnose</code> command provides diagnostics for any other command; that is, how
MaxScale will handle that command.</p>
<h4 id="syntax_2">Syntax</h4>
<p>The <code>mxsDiagnose</code> command has the following syntax:</p>
<div><pre><span></span>db.runCommand(
    {
       mxsDiagnose: &lt;command&gt;
    }
)
</pre></div>


<h5 id="command-fields_2">Command Fields</h5>
<p>The command takes the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsDiagnose</td>
<td>document</td>
<td>A command as provided to <code>db.runCommand(...)</code>.</td>
</tr>
</tbody>
</table>
<h5 id="returns_2">Returns</h5>
<p>The command returns a document that contains diagnostics of the command
provided as argument. For example:</p>
<div><pre><span></span>&gt; db.runCommand({mxsDiagnose: {ping:1}});
{ "kind" : "immediate", "response" : { "ok" : 1 }, "ok" : 1 }

&gt; db.runCommand({mxsDiagnose: {find:"person", filter: { name: "Bob"}}});
{
  "kind" : "single",
  "sql" : "SELECT doc FROM `test`.`person` WHERE ( JSON_EXTRACT(doc, '$.name') = 'Bob') ",
  "ok" : 1
}

&gt; db.runCommand({mxsDiagnose: {delete:"person", deletes: [{q: { name: "Bob"}, limit:0}, {q: {name: "Alice"}, limit:0}]}});
{
  "kind" : "single",
  "sql" : [
    "DELETE FROM `test`.`person` WHERE ( JSON_EXTRACT(doc, '$.name') = 'Bob') ",
    "DELETE FROM `test`.`person` WHERE ( JSON_EXTRACT(doc, '$.name') = 'Alice') "
  ],
  "ok" : 1
}
</pre></div>


<p><code>kind</code> specifies of what kind the command is; an <em>immediate</em> command is one for
which MaxScale autonomously can generate the response, a <em>single</em> command is one
where the command will cause a single SQL statement to be sent to the backend, and
a <em>multi</em> command is one where potentially multiple SQL statements will be sent to
the backend.</p>
<p>If the command is <em>immediate</em> then there will be a field <code>response</code> containing
the actual response of the command, if the command is <em>single</em> then there will be
a field <code>sql</code> containing the actual statement that would have been sent to the backend,
and if the command is <em>multi</em> then there will be a field <code>sql</code> containing an array
of statements that would have been sent to the backend.</p>
<p>If an error occurs while the command is being diagnosed, then there will be no
<code>response</code> field but an <code>error</code> field whose value is an error document. Note that
the value of <code>ok</code> will always be 1.</p>
<h3 id="mxsgetconfig">mxsGetConfig</h3>
<h4 id="definition_3">Definition</h4>
<h4 id="mxsgetconfig_1"><strong>mxsGetConfig</strong></h4>
<p>The <code>mxsGetConfig</code> command returns the current configuration of the session
and must be run against the 'admin' database.</p>
<h4 id="syntax_3">Syntax</h4>
<p>The <code>mxsGetConfig</code> has the following syntax:</p>
<div><pre><span></span>db.runCommand(
    {
        mxsGetConfig: &lt;any&gt;
    });
</pre></div>


<h5 id="command-fields_3">Command Fields</h5>
<p>The command takes the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsGetConfig</td>
<td>&lt;any&gt;</td>
<td>Ignored.</td>
</tr>
</tbody>
</table>
<h5 id="returns_3">Returns</h5>
<p>The command returns a document that contains the current configuration of
the session. For example:</p>
<div><pre><span></span>&gt; db.runCommand({mxsGetConfig: 1});
{
    "config" : {
        "on_unknown_command" : "return_error",
        "auto_create_tables" : true,
        "id_length" : 35
                ...
    },
    "ok" : 1
}
</pre></div>


<h3 id="mxsremoveuser">mxsRemoveUser</h3>
<h4 id="definition_4">Definition</h4>
<h5 id="mxsremoveuser_1"><strong>mxsRemoveUser</strong></h5>
<p>The <code>mxsRemoveUser</code> removes a user from the local nosqlprotocol account
database. Use <a href="#dropUser">dropUser</a> if the MariaDB user should be dropped
as well.</p>
<h4 id="syntax_4">Syntax</h4>
<p>The 'mxsRemoveUser' command has the following syntax:</p>
<div><pre><span></span>db.runCommand(
    {
        mxsRemoveUser: "&lt;name&gt;"
    }
)
</pre></div>


<h5 id="command-fields_4">Command Fields</h5>
<p>The command has the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsRemoveUser</td>
<td>string</td>
<td>The name of the user to be removed.</td>
</tr>
</tbody>
</table>
<h5 id="returns_4">Returns</h5>
<p>If the removal of the user succeeds, the command returns a document
with the single field <code>ok</code> whose value is <code>1</code>.</p>
<div><pre><span></span>&gt; db.runCommand({mxsRemoveUser: "user"});
{ "ok" : 1 }
</pre></div>


<p>If there is a failure of some kind, the command returns an error document</p>
<div><pre><span></span>&gt; db.runCommand({mxsRemoveUser: "user"});
{
    "ok" : 0,
    "errmsg" : "User 'user@test' not found",
    "code" : 11,
    "codeName" : "UserNotFound"
}
</pre></div>


<h3 id="mxssetconfig">mxsSetConfig</h3>
<h4 id="definition_5">Definition</h4>
<h4 id="mxssetconfig_1"><strong>mxsSetConfig</strong></h4>
<p>The <code>mxsSetConfig</code> command changes the configuration of the session
and must be run against the 'admin' database.</p>
<p>Note that the changes only affect the current session and are <strong>not</strong>
persisted.</p>
<h4 id="syntax_5">Syntax</h4>
<p>The <code>mxsSetConfig</code> has the following syntax:</p>
<div><pre><span></span>db.runCommand(
    {
        mxsSetConfig: document
    });
</pre></div>


<h5 id="command-fields_5">Command Fields</h5>
<p>The command takes the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsSetConfig</td>
<td>document</td>
<td>A document specifying the configuration.</td>
</tr>
</tbody>
</table>
<p>The document takes the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>on_unknown_command</td>
<td>string</td>
<td>Either <code>"return_error"</code> or <code>"return_empty"</code></td>
</tr>
<tr>
<td>auto_create_tables</td>
<td>boolean</td>
<td>Whether tables should be created as needed.</td>
</tr>
<tr>
<td>id_length</td>
<td>integer</td>
<td><code>id</code> column <code>VARCHAR</code> size in created tables.</td>
</tr>
</tbody>
</table>
<h5 id="returns_5">Returns</h5>
<p>The command returns a document that contains the changed configuration of
the session. For example:</p>
<div><pre><span></span>&gt; db.runCommand({mxsGetConfig: 1});
{
    "config" : {
        "on_unknown_command" : "return_error",
        "auto_create_tables" : true,
        "id_length" : 35
                ...
    },
    "ok" : 1
}
&gt; db.runCommand({mxsSetConfig: { auto_create_tables: false}});
{
    "config" : {
        "on_unknown_command" : "return_error",
        "auto_create_tables" : false,
        "id_length" : 35
                ...
    },
    "ok" : 1
}
</pre></div>


<h3 id="mxsupdateuser">mxsUpdateUser</h3>
<h4 id="definition_6">Definition</h4>
<h5 id="mxsupdateuser_1"><strong>mxsUpdateUser</strong></h5>
<p>The <code>mxsUpdateUser</code> command updates a user in the local nosqlprotocol
account database. Use <a href="#updateUser">updateUser</a> to update MariaDB user
as well.</p>
<p>Note that the <code>mxsUpdateUser</code> command does not check that the changed
data is compatible e.g. with the grants of the corresponding MariaDB
user.</p>
<h4 id="syntax_6">Syntax</h4>
<p>The 'mxsUpdateUser' command has the following syntax:</p>
<div><pre><span></span>db.runCommand(
    {
        mxsUpdateUser: "&lt;name&gt;",
        pwd: passwordPrompt(),  // Or "&lt;cleartext password&gt;"
        customData: { &lt;any information&gt; },
        roles: [
            { role: "&lt;role&gt;", db: "&lt;database&gt;" } | "&lt;role&gt;",
            ...
        ],
        mechanisms: [ "&lt;scram-mechanism&gt;", ...],
        digestPassword: &lt;boolean&gt;
    }
)
</pre></div>


<h5 id="command-fields_6">Command Fields</h5>
<p>The command has the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mxsUpdateUser</td>
<td>string</td>
<td>The name of the user to be updated.</td>
</tr>
<tr>
<td>pwd</td>
<td>string</td>
<td>The password in cleartext.</td>
</tr>
<tr>
<td>customData</td>
<td>document</td>
<td>Optional. Any arbitrary information.</td>
</tr>
<tr>
<td>roles</td>
<td>array</td>
<td>The roles granted to the user.</td>
</tr>
<tr>
<td>mechanisms</td>
<td>array</td>
<td>Optional. The specific supported SCRAM mechanisms for this user. If a new password is not provided, the specified mechanisms must be a subset of the current mechanisms.</td>
</tr>
<tr>
<td>digestPassword</td>
<td>boolean</td>
<td>Optional. If specified, must be <code>true</code>.</td>
</tr>
</tbody>
</table>
<p>The <code>roles</code> array should contain roles that a compatible with the
grants of the user. Please check <a href="#roles_and_grants">roles and grants</a>
for a discussion on how to map roles map to grants.</p>
<h5 id="returns_6">Returns</h5>
<p>If the updating of the user succeeds, the command returns a document
with the single field <code>ok</code> whose value is <code>1</code>.</p>
<div><pre><span></span>&gt; db.runCommand({mxsUpdateUser: "user", pwd: "pwd", roles: ["readWrite"]});
{ "ok" : 1 }
</pre></div>


<p>If there is a failure of some kind, the command returns an error document</p>
<div><pre><span></span>&gt; db.runCommand({mxsUpdateUser: "user", roles: ["redWrite"]});
{
    "ok" : 0,
    "errmsg" : "No role named redWrite@test",
    "code" : 31,
    "codeName" : "RoleNotFound"
}
</pre></div>


<h1 id="object-id">Object Id</h1>
<p>When a document is created, an id of type <code>ObjectId</code> will be autogenerated by
the MongoDB® client library. If the id is provided explicitly, by assigning a
value to the <code>_id</code> field, the value must be an <code>ObjectId</code>, a string or an
integer.</p>
<h1 id="caching">Caching</h1>
<p>The conversion of the BSON used in the communication between the client and
MaxScale, to the SQL used in the communication between MaxScale and the server
carries a not insignificant cost, as does the conversion of result sets
returned by the server to the BSON returned by MaxScale to the client. The
regular <a href="../Filters/Cache.md">cache filter</a> provides no remedy for this, as
it is located after the protocol and uses SQL as the key and stores result
sets as values.</p>
<p>From 23.08 onwards, the nosqlprotocol has a built-in cache that when used
under certain conditions diminishes the conversion cost. The cache is
enabled by adding the following line to the NoSQL listener.</p>
<div><pre><span></span>[My-NoSQL-Listener]
...
nosqlprotocol.internal_cache=cache
</pre></div>


<p>This effectively causes the <a href="../Filters/Cache.md">cache filter</a> to be used
inside the NoSQL protocol module. The internal cache can be configured just
like the cache filter is, by using the following nested configuration syntax.</p>
<div><pre><span></span>[My-NoSQL-Listener]
...
nosqlprotocol.internal_cache=cache
nosqlprotocol.cache.max_size=10M
nosqlprotocol.cache.soft_ttl=30s
nosqlprotocol.cache.hard_ttl=40s
...
</pre></div>


<p>A limitation is that <em>only</em> the default storage <code>storage_inmemory</code> is
supported; <code>storage_redis</code> and <code>storage_memcached</code> cannot be used.</p>
<p>The cache works on both the SQL and the BSON layer. When a NoSQL request
that potentially is cacheable arrives, a lookup for the BSON response is
made. If it is found, the response is returned to the client. That is, in
this case neither BSON -&gt; SQL, nor a Result Set -&gt; BSON translation will
be made.</p>
<p>If the request is not potentially cacheable or the response is not
available, the request is processed normally, which may mean that the
request is translated into SQL. If the SQL is a SELECT, a second lookup
will be made for the corresponding result set. If that is found, the
result set is processed, but the roundtrip to the server will be saved.</p>
<p>So, when a result set is received from the server, it will be cached and
if the generated NoSQL response is also cacheable, it will be cached as
well. The benefit of this approach is that two <code>Find</code> NoSQL requests
may effectively return the same documents, even though one but not the
other NoSQL response is cacheable. Both will benefit the result set being
in the cache. Since the used storage follows an LRU-approach when evicting
data from the cache, the less valuable result will be evicted first.</p>
<h2 id="cached-commands">Cached Commands</h2>
<p>The responses of the following commands are cached.</p>
<ul>
<li><a href="#count">count</a></li>
<li><a href="#distinct">distinct</a></li>
<li><a href="#find">find</a>, provided all found documents can be returned in one response,
     i.e., if <code>singleBatch</code> is <code>true</code> or <code>batchSize</code> is large enough.</li>
</ul>
<h1 id="compatibility">Compatibility</h1>
<p>Currently 30% of the tests in the
<a href="https://github.com/mongodb/mongo/tree/master/jstests/core">MongoDB® core</a>
test-suite pass.</p>
<h1 id="example">Example</h1>
<p>The following is a minimal setup for getting <em>nosqlprotocol</em> up and
running. It is assumed the reader knows how to configure MaxScale for
normal use. If not, please start with the
<a href="../Tutorials/MaxScale-Tutorial.md">MaxScale tutorial</a>.
Note that as <em>nosqlprotocol</em> is the first component in the MaxScale
routing chain, it can be used with all routers and filters.</p>
<h2 id="configuring-maxscale">Configuring MaxScale</h2>
<p>In the following it is assumed that MaxScale already has been configured
for normal use and that there exists a <em>service</em> <code>[TheService]</code>.</p>
<div><pre><span></span>[TheService]
type=service
...

[NoSQL-Listener]
type=listener
service=TheService
protocol=nosqlprotocol
nosqlprotocol.user=the_user
nosqlprotocol.password=the_password
port=17017
</pre></div>


<p>The values <code>the_user</code> and <code>the_password</code> must be replaced with the
actual credentials to be used for every MongoDB® client that connects.</p>
<p>If MaxScale is now started, the following entry should appear in the
log file.</p>
<div><pre><span></span>... notice : (NoSQL-Listener); Listening for connections at [127.0.0.1]:17017
</pre></div>


<h2 id="mongodb-shell">MongoDB® Shell</h2>
<p>The mongo Shell is a powerful tool with which to access and manipulate a
MongoDB database. It is part of the MongoDB® package. Having the native
MongoDB database installed is convenient, as it makes it easy to ascertain
whether a problem is due to <em>nosqlprotocol</em> not fully implementing something
or due to the API not being used in the correct fashion.</p>
<p>With the <em>mongo shell</em>, all that is needed is to invoke it with the port
<em>nosqlprotocol</em> is listening on:</p>
<div><pre><span></span>$ mongo --port 17017
MongoDB shell version v4.4.1
connecting to: mongodb://127.0.0.1:17017/?compressors=disabled&amp;gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("694f3eed-329f-487a-8d73-9a2d4cf82d62") }
MongoDB server version: 4.4.1
---
        ...
---
&gt;
</pre></div>


<p>If the shell prompt appears, then a connection was successfully
established and the shell can be used.</p>
<div><pre><span></span>&gt; db.runCommand({insert: "collection", documents: [{_id: 1, "hello": "world"}]});
{ "n" : 1, "ok" : 1 }
</pre></div>


<p>The <code>db</code> variable is implicitly available, and refers by default to
the <code>test</code> database.</p>
<p>The command inserted a document into the collection called <code>collection</code>.
The table corresponding to that collection is created implicitly because
the default value of <code>auto_create_tables</code> is <code>true</code>. Here, the object id
is specified explicitly, but there is no need for that, as one will be
created if needed.</p>
<p>To check whether the documents was inserted into the collection, the
<code>find</code> command can be issued:</p>
<div><pre><span></span>&gt; db.runCommand({find: "collection"});
{
    "cursor" : {
        "firstBatch" : [
            {
                "_id" : 1,
                "hello" : "world"
            }
        ],
        "id" : NumberLong(0),
        "ns" : "test.collection"
    },
    "ok" : 1
}
</pre></div>


<p>As can be seen, the document was indeed inserted into the collection</p>
<p>With the <code>mysql</code> shell, the content of the actual table can be checked.</p>
<div><pre><span></span>MariaDB [(none)]&gt; select * from test.collection;
+------+------------------------------------+
| id   | doc                                |
+------+------------------------------------+
| 1.0  | { "_id" : 1.0, "hello" : "world" } |
+------+------------------------------------+
</pre></div>


<p>The collection <code>collection</code> is represented by a table <code>collection</code> with
the two columns <code>id</code> and <code>doc</code>. <code>id</code> is a virtual column whose content is
the value of the <code>_id</code> field of the document in the <code>doc</code> column.</p>
<p>All MongoDB® commands that <em>mongdbprotocol</em> support (but for the ones that
do not require database access), basically access or manipulate the
content in the <code>doc</code> column using the
<a href="https://mariadb.com/kb/en/json-functions/">JSON functions</a> of MariaDB.</p>
<p>From within the mongo shell itself it is easy to find out just what SQL
a particular MongoDB command is translated into.</p>
<p>For instance, the SQL that the insert command with which the document was
added can be found out like:</p>
<div><pre><span></span>&gt; db.runCommand({mxsDiagnose: {insert: "collection", documents: [{_id: 1, "hello": "world"}]}});
{
    "kind" : "multi",
    "sql" : [
        "INSERT INTO `test`.`collection` (doc) VALUES ('{ \"_id\" : 1.0, \"hello\" : \"world\" }')"
    ],
    "ok" : 1
}
</pre></div>


<p>Similarily, the SQL of the <code>find</code> command can be find out like:</p>
<div><pre><span></span>&gt; db.runCommand({mxsDiagnose: {find: "collection"}});
{
    "kind" : "single",
    "sql" : "SELECT doc FROM `test`.`collection` ",
    "ok" : 1
}
</pre></div>


<p>The returned SQL can be directly pasted at the <code>mysql</code> prompt, which is
quite convenient in case the MongoDB® command does not behave as expected.</p>
<h2 id="mongodb-nodejs-driver">MongoDB® Node.JS Driver</h2>
<p>As all client libraries implement and depend on the MongoDB® wire protocol,
all client libraries should work with <em>nosqlprotocol</em>. However, the
only client library that has been used and that has been verified to work
is version 3.6 of the <em>MongoDB Node.JS Driver</em>.</p>
<p>In principle, the only thing that needs to be altered in an existing
program using the library is to change the uri string that typically
is something like</p>
<div><pre><span></span>const uri = "mongodb+srv://&lt;user&gt;:&lt;password&gt;@&lt;cluster-url&gt;?writeConcern=majority";
</pre></div>


<p>to</p>
<div><pre><span></span>const uri = "mongodb://&lt;maxscale-ip&gt;:17017";
</pre></div>


<p>with the assumption that the default <em>nosqlprotocol</em> port is used.</p>
<p>In practice, additional modifications may be needed since <em>nosqlprotocol</em>
does not implement all commands and does not in all cases implement the
full functionality of the commands that it supports.</p>
<h3 id="inserting-a-document">Inserting a Document</h3>
<p>Store the following into a file called <code>insert.js</code>.</p>
<div><pre><span></span>const { MongoClient } = require("mongodb");

const uri = "mongodb://127.0.0.1:17017";

const client = new MongoClient(uri, { useUnifiedTopology: true });
async function run() {
  try {
    await client.connect();
    const database = client.db("mydb");
    const movies = database.collection("movies");
    // create a document to be inserted
    const movie = { title: "Apocalypse Now", director: "Francis Ford Coppola" };
    const result = await movies.insertOne(movie);
    console.log(
      `${result.insertedCount} documents were inserted with the _id: ${result.insertedId}`,
    );
  } finally {
    await client.close();
  }
}
run().catch(console.dir);
</pre></div>


<p>Then, run the program like</p>
<div><pre><span></span>$ nodejs insert.js
1 documents were inserted with the _id: 60afca73bf486114e3fb48b8
</pre></div>


<p>As the id is not explicitly provided, it will not be the same.</p>
<h3 id="finding-a-document">Finding a Document</h3>
<p>Store the following into a file called <code>find.js</code>.</p>
<div><pre><span></span>const { MongoClient } = require("mongodb");

const uri = "mongodb://127.0.0.1:17017";

const client = new MongoClient(uri, { useUnifiedTopology: true });
async function run() {
  try {
    await client.connect();
    const database = client.db("mydb");
    const movies = database.collection("movies");
    // Query for a movie that has the title 'Apocalypse Now'
    const query = { title: "Apocalypse Now" };
    const options = {
      // Include only the 'director' field in the returned document
      projection: { _id: 0, director: 1 },
    };
    const movie = await movies.findOne(query, options);
    // Returns a document and not a cursor, so print directly.
    console.log(movie);
  } finally {
    await client.close();
  }
}
run().catch(console.dir);
</pre></div>


<p>Then, run the program like</p>
<div><pre><span></span>$ nodejs find.js
{ director: 'Francis Ford Coppola' }
</pre></div>
    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-mariadb-protocol-module/">
                        ← MaxScale 24.02 MariaDB Protocol Module
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/maxscale-24-02protocols/">
                        ↑ MaxScale 24.02Protocols ↑
                    </a>
                    </li>
                
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="13296" data-comments-url="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/+comments"
         data-reply-url="/kb/en/mariadb-maxscale-2402-maxscale-2402-nosql-protocol-module/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/maxscale-24-02protocols/">
                    ↑ MaxScale 24.02Protocols ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/maxscale-2402protocols-maxscale-24-02getting-started/">
                            
                            MaxScale 24.02Getting-Started
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-change-data-capture-cdc-protocol/">
                            
                            MaxScale 24.02 Change Data Capture (CDC) Protocol
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-change-data-capture-cdc-users/">
                            
                            MaxScale 24.02 Change Data Capture (CDC) users
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2402-maxscale-2402-mariadb-protocol-module/">
                            
                            MaxScale 24.02 MariaDB Protocol Module
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>MaxScale 24.02 NoSQL Protocol Module</span>
                        
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>