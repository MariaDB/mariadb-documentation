<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Setup Guide - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.9a0d7dcebefd.css" rel="stylesheet" type="text/css" />

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Setup Guide" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/aws-key-management-encryption-plugin-setup-guide/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Plugin that uses the AWS Key Management Service." />

    <meta name="description" content="Plugin that uses the AWS Key Management Service." />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/aws-key-management-encryption-plugin-setup-guide/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/aws-key-management-encryption-plugin-setup-guide/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-administration/">MariaDB Administration</a>
    

    
    » <a class="crumb" href="/kb/en/user-server-security/">User &amp; Server Security</a>
    

    
    » <a class="crumb" href="/kb/en/securing-mariadb/">Securing MariaDB</a>
    

    
    » <a class="crumb" href="/kb/en/securing-mariadb-encryption/">Encryption</a>
    

    
    » <a class="crumb" href="/kb/en/encryption-data-at-rest-encryption/">Data-at-Rest Encryption</a>
    

    
    » <a class="crumb" href="/kb/en/key-management-and-encryption-plugins/">Key Management and Encryption Plugins</a>
    


    » <a class="node_link crumb" href="/kb/en/aws-key-management-encryption-plugin-setup-guide/">Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Setup Guide</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+flag"
                data-flag-url="/kb/en/aws-key-management-encryption-plugin-setup-guide/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2016-02-25 19:36">7 years, 11 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2023-05-30 12:20">8 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <ul>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-copy-security-credentials">aws-kms-copy-security-credentials</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-create-key-alias">aws-kms-create-key-alias</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-create-key">aws-kms-create-key</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-create-new-user">aws-kms-create-new-user</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-enter-user-names">aws-kms-enter-user-names</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-key-list-console">aws-kms-key-list-console</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-key-usage-permissions">aws-kms-key-usage-permissions</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-show-security-credentials">aws-kms-show-security-credentials</a>
                    </li>
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin-setup-guide/+image/aws-kms-view-key-details">aws-kms-view-key-details</a>
                    </li>
                
            </ul>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Setup Guide</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#overview" title="Overview">Overview</a></li>

    <li class=""><a href="#installing-the-plugins-package" title="Installing the Plugin&#39;s Package">Installing the Plugin&#39;s Package</a>    <ol class="toc">

        <li class=""><a href="#installing-from-source" title="Installing from Source">Installing from Source</a>    </ol>
</li>

    <li class=""><a href="#installing-the-plugin" title="Installing the Plugin">Installing the Plugin</a></li>

    <li class=""><a href="#sign-up-for-amazon-web-services" title="Sign up for Amazon Web Services">Sign up for Amazon Web Services</a></li>

    <li class=""><a href="#create-an-iam-user-andor-role" title="Create an IAM User and/or Role">Create an IAM User and/or Role</a>    <ol class="toc">

        <li class=""><a href="#creating-an-iam-role" title="Creating an IAM Role">Creating an IAM Role</a></li>

        <li class=""><a href="#creating-an-iam-user" title="Creating an IAM User">Creating an IAM User</a>    </ol>
</li>

    <li class=""><a href="#create-a-master-encryption-key" title="Create a Master Encryption Key">Create a Master Encryption Key</a></li>

    <li class=""><a href="#configure-aws-credentials" title="Configure AWS Credentials">Configure AWS Credentials</a></li>

    <li class=""><a href="#configure-mariadb" title="Configure MariaDB">Configure MariaDB</a>    <ol class="toc">

        <li class=""><a href="#selinux-and-outbound-connections-from-mariadb" title="SELinux and Outbound Connections from MariaDB">SELinux and Outbound Connections from MariaDB</a>    </ol>
</li>

    <li class=""><a href="#start-mariadb" title="Start MariaDB">Start MariaDB</a></li>

    <li class=""><a href="#create-encrypted-tables" title="Create Encrypted Tables">Create Encrypted Tables</a></li>

    <li class=""><a href="#aws-kms-plugin-option-reference" title="AWS KMS Plugin Option Reference">AWS KMS Plugin Option Reference</a></li>

    <li class=""><a href="#next-steps" title="Next Steps">Next Steps</a> </ol>
</li>
</div>
<h2 class="anchored_heading" id="overview">Overview</h2>
<p>MariaDB contains a robust, full instance, at-rest encryption. This feature uses a flexible plugin interface to allow actual encryption to be done using a key management approach that meets the customer's needs. MariaDB Server, starting with <a href="/kb/en/what-is-mariadb-102/">MariaDB 10.2</a>, includes a plugin that uses the Amazon Web Services (AWS) Key Management Service (KMS) to facilitate separation of responsibilities and remote logging &amp; auditing of key access requests.</p>
<p>Rather than storing the encryption key in a local file, this plugin keeps the master key in AWS KMS. When you first start MariaDB, the AWS KMS plugin will connect to the AWS Key Management Service and ask it to generate a new key. MariaDB will store that key on-disk in an encrypted form. The key stored on-disk cannot be used to decrypt the data; rather, on each startup, MariaDB connects to AWS KMS and has the service decrypt the locally-stored key(s). The decrypted key is stored in-memory as long as the MariaDB server process is running, and that in-memory decrypted key is used to encrypt the local data.</p>
<p>This guide is based on CentOS 7, using systemd with SELinux enabled. Some steps will differ if you use other operating systems or configurations.</p>
<h2 class="anchored_heading" id="installing-the-plugins-package">Installing the Plugin's Package</h2>
<p>The AWS Key Management plugin depends on the <a href="https://github.com/aws/aws-sdk-cpp">AWS SDK for C++</a>, which uses the <a href="https://github.com/aws/aws-sdk-cpp/blob/master/LICENSE">Apache License, Version 2.0</a>. This license is not compatible with MariaDB Server's <a href="/kb/en/mariadb-license/">GPL 2.0 license</a>, so we are not able to distribute packages that contain the AWS Key Management plugin. Therefore, the only way to currently obtain the plugin is to install it from source.</p>
<h3 class="anchored_heading" id="installing-from-source">Installing from Source</h3>
<p>When <a href="/kb/en/compiling-mariadb-from-source/">compiling MariaDB from source</a>, the AWS Key Management plugin is not built by default in <a href="/kb/en/what-is-mariadb-101/">MariaDB 10.1</a>, but it is built by default in <a href="/kb/en/what-is-mariadb-102/">MariaDB 10.2</a> and later, on systems that support it.</p>
<p>Compilation is controlled by the <code>-DPLUGIN_AWS_KEY_MANAGEMENT=DYNAMIC -DAWS_SDK_EXTERNAL_PROJECT=1</code> <a href="/kb/en/generic-build-instructions/#using-cmake">cmake</a> arguments.</p>
<p>The plugin uses <a href="https://github.com/awslabs/aws-sdk-cpp">AWS C++ SDK</a>, which introduces the following restrictions:</p>
<ul start="1"><li>The plugin can only be built on Windows, Linux and macOS.
</li><li>The plugin requires that one of the following compilers is used: <code>gcc</code> 4.8 or later, <code>clang</code> 3.3 or later, Visual Studio 2013 or later.
</li><li>On Unix, the <code>libcurl</code> development package (e.g. <code>libcurl3-dev</code> on Debian Jessie), <code>uuid</code> development package and <code>openssl</code> need to be installed.
</li><li>You may need to use a newer version of <a href="/kb/en/generic-build-instructions/#using-cmake">cmake</a> than is provided by default in your OS.
</li></ul>
<h2 class="anchored_heading" id="installing-the-plugin">Installing the Plugin</h2>
<p>Even after the package that contains the plugin's shared library is installed on the operating system, the plugin is not actually installed by MariaDB by default. There are two methods that can be used to install the plugin with MariaDB.</p>
<p>The first method can be used to install the plugin without restarting the server. You can install the plugin dynamically by executing <a href="/kb/en/install-soname/">INSTALL SONAME</a> or <a href="/kb/en/install-plugin/">INSTALL PLUGIN</a>. For example:</p>
<pre class="fixed"><span class="n">INSTALL</span> <span class="n">SONAME</span> <span class="s1">&#39;aws_key_management&#39;</span><span class="p">;</span>
</pre><p>The second method can be used to tell the server to load the plugin when it starts up. The plugin can be installed this way by providing the <a href="/kb/en/mysqld-options/#-plugin-load">--plugin-load</a> or the <a href="/kb/en/mysqld-options/#-plugin-load-add">--plugin-load-add</a> options. This can be specified as a command-line argument to <a href="/kb/en/mysqld-options/">mysqld</a> or it can be specified in a relevant server <a href="/kb/en/configuring-mariadb-with-option-files/#option-groups">option group</a> in an <a href="/kb/en/configuring-mariadb-with-option-files/">option file</a>. For example:</p>
<pre class="fixed">[mariadb]
...
plugin_load_add = aws_key_management
</pre><h2 class="anchored_heading" id="sign-up-for-amazon-web-services">Sign up for Amazon Web Services</h2>
<p>If you already have an AWS account, you can skip this section.</p>
<ol start="1"><li>Load <a href="http://aws.amazon.com/">http://aws.amazon.com/</a>.
</li><li>Click "Create a Free Account" and complete the steps.
</li><li>You'll need to enter credit card information. Charges related only to your use of the AWS KMS service should be limited to about $1/month for the single master key we will create. If you use other services, additional charges may apply. Consult AWS Cloud Pricing Principles <a href="https://aws.amazon.com/pricing/">https://aws.amazon.com/pricing/</a> for more information about pricing of AWS services.
</li><li>You'll need to complete the AWS identify verification process.
</li></ol>
<h2 class="anchored_heading" id="create-an-iam-user-andor-role">Create an IAM User and/or Role</h2>
<p>After creating an account or logging in to an existing account, follow these steps to create an IAM User or Role with restricted privileges that will use (but not administer) your master encryption key.</p>
<p>If you intend to run MariaDB Server on an EC2 instance, you should create a Role (or modify an existing Role already attached to your instance). If you intent to run MariaDB Server outside of AWS, you may want to create a User.</p>
<h3 class="anchored_heading" id="creating-an-iam-role">Creating an IAM Role</h3>
<ol start="1"><li>Load the Identity and Access Management Console at <a href="https://console.aws.amazon.com/iam/">https://console.aws.amazon.com/iam/</a>.
</li><li>Click "Roles" in the left-hand sidebar
</li><li>Click "Create new role"
</li><li>Select "AWS Service Role"
</li><li>Click the "Select" button next to "Amazon EC2 / Allows EC2 instances to call AWS services on your behalf."
</li><li>Do not select any policies on the "Attach Policy" screen. Click "Next Step"
</li><li>Click "Next Step"
</li><li>Give your Role a "Role name"
</li><li>Click "Create role"
</li></ol>
<h3 class="anchored_heading" id="creating-an-iam-user">Creating an IAM User</h3>
<ol start="1"><li>Load the Identity and Access Management Console at <a href="https://console.aws.amazon.com/iam/">https://console.aws.amazon.com/iam/</a>.
</li><li>Click "Users" in the left-hand sidebar.<br>
<a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-create-new-user"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-create-new-user" style="max-height:300px;max-width:500px"></a>
</li><li>Click the "Create New Users" button
</li><li>Enter a single User Name of your choosing. We'll use "MDBEnc" for this demonstration. Keep the "Generate an access key for each user" box checked.<br>
<a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-enter-user-names"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-enter-user-names" style="max-height:300px;max-width:500px"></a>
</li><li>Click "Create".
</li><li>Click "Show User Security Credentials".<br>
<a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-show-security-credentials"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-show-security-credentials" style="max-height:300px;max-width:500px"></a>
</li><li>Copy the Access Key ID and Secret Access Key. Optionally, you can click "Download Credentials". We will need these in order for local programs to interact with AWS using its API.<br>
<a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-copy-security-credentials"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-copy-security-credentials" style="max-height:300px;max-width:500px"></a>
</li><li>Create a file on your computer to hold the credentials for this user. We'll use this file later. It should have this structure: <pre class="fixed">[default]
aws_access_key_id = AKIAIG6IZ6TKF52FVV5A
aws_secret_access_key = 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
</pre>
</li><li>Click "Close". If prompted because you did not Download Credentials, ensure that you've saved them somewhere, and click "Close".
</li></ol>
<h2 class="anchored_heading" id="create-a-master-encryption-key">Create a Master Encryption Key</h2>
<p>Now, we'll create a master encryption key. This key can <em>never</em> be retrieved by <em>any</em> application or user. This key is used remotely to encrypt (and decrypt) the actual encryption keys that will be used by MariaDB. If this key is deleted or you lose access to it, you will be unable to use the contents of your MariaDB data directory.</p>
<ol start="1"><li>Click "Encryption Keys" in the left-hand sidebar.
</li><li>Click the "Get Started Now" button.
</li><li>Use the "Filter" dropdown to choose the region where you'd like to create your master key. 
</li><li>Click the "Create Key" button.<br>
<a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-create-key"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-create-key" style="max-height:300px;max-width:500px"></a>
</li><li>Enter an Alias and Description of your choosing.
</li><li>Click "Next Step".
</li><li>Do <strong>not</strong> check the box to make your IAM Role or IAM User user a Key Administrator.
</li><li>Click "Next Step" again.
</li><li>Check the boxes to give your IAM Role and/or IAM User permissions to use this key.<br>
<a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-key-usage-permissions"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-key-usage-permissions" style="max-height:300px;max-width:500px"></a>
</li><li>Click "Next Step".
</li><li>Click "Finish".
</li></ol>
<p>You should now see your key listed in the console:</p>
<p><a href="/kb/en/mariadb-enterprise-aws-kms-encryption-plugin-setup-guide/+image/aws-kms-key-list-console"><img src="/kb/en/key-management-and-encryption-plugins-amazon-web-services-aws-key-managemen/+image/aws-kms-key-list-console" style="max-height:300px;max-width:500px"></a></p>
<p>You'll use the "Alias" you provided when you configure MariaDB later.</p>
<p>We now have a Customer Master Key and an IAM user that has privileges to access it using access credentials. This is enough to begin using the AWS KMS plugin.</p>
<h2 class="anchored_heading" id="configure-aws-credentials">Configure AWS Credentials</h2>
<p>There are a number of ways to give the IAM credentials to the AWS KMS plugin. The plugin supports reading credentials from all standard locations used across the various AWS API clients.</p>
<p>The easiest approach is to run MariaDB Server in an EC2 instance that has an IAM Role with User access to the CMK you wish to use. You can give key access privileges to a Role already attached to your EC2 instance, or you can create a new IAM Role and attach it to an already-running EC2 instance. If you've done that, no further credentials management is required and you do not need to create a <code>credentials</code> file.</p>
<p>If you're not running MariaDB Server on an EC2 instance, you can also place the credentials in the MariaDB data directory. The AWS API client looks for a <code>credentials</code> file in the <code>.aws</code> subdirectory of the home directory of the user running the client process. In the case of MariaDB, its home directory is its <code>datadir</code>.</p>
<ol start="1"><li>Create a <code>credentials</code> file that MariaDB can read. Use the region you selected when creating the key. Master keys cannot be used across regions. For example:<pre class="fixed">$ cat /var/lib/mysql/.aws/credentials
[default]
aws_access_key_id = AKIAIG6IZ6TKF52FVV5A
aws_secret_access_key = o7CEf7KhZfsVF9cS0a2roqqZNmuzXtIR869zpSBT
region = us-east-1
</pre>
</li><li>Change the permissions of the file so that it it is owned by, and can only be read by, the <code>mysql</code> user:<pre class="fixed">chown mysql /var/lib/mysql/.aws/credentials
chmod 600 /var/lib/mysql/.aws/credentials
</pre>
</li></ol>
<h2 class="anchored_heading" id="configure-mariadb">Configure MariaDB</h2>
<ol start="1"><li>Create a new option file to tell MariaDB to enable encryption functionality and to use the AWS KMS plugin. Create a new file under <code>/etc/my.cnf.d/</code> (or wherever your OS may have you create such files) with contents like this:
</li></ol>
<pre class="fixed">[mariadb]
plugin_load_add = aws_key_management
aws-key-management = FORCE_PLUS_PERMANENT
aws-key-management-master-key-id = alias/mariadb-encryption
aws-key-management-region = us-east-1
!include /etc/my.cnf.d/enable_encryption.preset
</pre><ol start="1"><li>Append the "Alias" value you copied above to <code>alias/</code> to use as the value for the <code>aws-key-management-master-key-id</code> option.
</li></ol>
<p>Note that you <strong>must</strong> include <code>aws-key-management-region</code> in your .cnf file if you are not using the us-east-1 region.</p>
<p>Now, you have told MariaDB to use the AWS KMS plugin and you've put credentials for the plugin in a location where the plugin will find them. The /etc/my.cnf.d/enable_encryption.preset file contains a set of options that enable all available encryption functionality.</p>
<p>When you start MariaDB, the AWS KMS plugin will connect to the AWS Key Management Service and ask it to generate a new key. MariaDB will store that key on-disk in an encrypted form. The key stored on-disk cannot be used to decrypt the data; rather, on each startup, MariaDB must connect to AWS KMS and have the service decrypt the locally-stored key. The decrypted version is stored in-memory as long as the MariaDB server process is running, and that in-memory decrypted key is used to encrypt the local data.</p>
<h3 class="anchored_heading" id="selinux-and-outbound-connections-from-mariadb">SELinux and Outbound Connections from MariaDB</h3>
<p>Because MariaDB needs to connect to the AWS KMS service, you must ensure that the host has outbound network connectivity over port 443 to AWS and you must ensure that local policies allow the MariaDB server process to make those outbound connections. By default, SELinux restricts MariaDB from making such connections.</p>
<p>The most simple way to cause SELinux to allow outbound HTTPS connections from MariaDB is to enable to mysql_connect_any boolean, like this:</p>
<pre class="fixed">setsebool -P mysql_connect_any 1
</pre><p>There are more complex alternatives that have a more granular effect, but those are beyond the scope of this document.</p>
<h2 class="anchored_heading" id="start-mariadb">Start MariaDB</h2>
<p>Start MariaDB using the <code>systemctl</code> tool:</p>
<pre class="fixed">systemctl start mariadb
</pre><p>If you do not use systemd, you may have to start MariaDB using some other mechanism.</p>
<p>You should see journal output similar to this:</p>
<pre class="fixed"># journalctl --no-pager -o cat -u mariadb.service

[Note] /usr/sbin/mysqld (mysqld 10.1.9-MariaDB-enterprise-log) starting as process 19831 ...
[Note] AWS KMS plugin: generated encrypted datakey for key id=1, version=1
[Note] AWS KMS plugin: loaded key 1, version 1, key length 128 bit
[Note] InnoDB: Using mutexes to ref count buffer pool pages
[Note] InnoDB: The InnoDB memory heap is disabled
[Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
[Note] InnoDB: Memory barrier is not used
[Note] InnoDB: Compressed tables use zlib 1.2.7
[Note] InnoDB: Using CPU crc32 instructions
[Note] InnoDB: Initializing buffer pool, size = 2.0G
[Note] InnoDB: Completed initialization of buffer pool
[Note] InnoDB: Highest supported file format is Barracuda.
[Note] InnoDB: 128 rollback segment(s) are active.
[Note] InnoDB: Waiting for purge to start
[Note] InnoDB:  Percona XtraDB (http://www.percona.com) 5.6.26-74.0 started; log sequence number 1616819
[Note] InnoDB: Dumping buffer pool(s) not yet started
[Note] Plugin 'FEEDBACK' is disabled.
[Note] AWS KMS plugin: generated encrypted datakey for key id=2, version=1
[Note] AWS KMS plugin: loaded key 2, version 1, key length 128 bit
[Note] Using encryption key id 2 for temporary files
[Note] Server socket created on IP: '::'.
[Note] Reading of all Master_info entries succeded
[Note] Added new Master_info '' to hash table
[Note] /usr/sbin/mysqld: ready for connections.
</pre><p>Note the several lines of output that refer explicitly to the "AWS KMS plugin". You can see that the plugin generates a "datakey", loads that data key, and then later generates and loads a second data key. The 2nd data key is used to encrypt temporary files and temporary tables.</p>
<p>You can see the encrypted keys stored on-disk in the datadir:</p>
<pre class="fixed"># ls -l /var/lib/mysql/aws*
-rw-rw----. 1 mysql mysql 188 Feb 25 18:55 /var/lib/mysql/aws-kms-key.1.1
-rw-rw----. 1 mysql mysql 188 Feb 25 18:55 /var/lib/mysql/aws-kms-key.2.1
</pre><p>Note that those keys are not useful alone. They are encrypted. When MariaDB starts up, the AWS KMS plugin decrypts those keys by interacting with AWS KMS.</p>
<p>For maximum security, you should start from an empty datadir and run <a href="/kb/en/mariadb-install-db/">mariadb-install-db</a> after configuring encryption. Then you should re-import your data so that it is fully encrypted. Use <code>sudo</code> to run <code>mariadb-install-db</code> so that it finds your credentials file:</p>
<pre class="fixed wrap"># sudo -u mysql mariadb-install-db
Installing MariaDB/MySQL system tables in '/var/lib/mysql' ...
2016-02-25 23:16:06 139731553998976 [Note] /usr/sbin/mysqld (mysqld 10.1.11-MariaDB-enterprise-log) starting as process 39551 ...
2016-02-25 23:16:07 139731553998976 [Note] AWS KMS plugin: generated encrypted datakey for key id=1, version=1
2016-02-25 23:16:07 139731553998976 [Note] AWS KMS plugin: loaded key 1, version 1, key length 128 bit
...
</pre><h2 class="anchored_heading" id="create-encrypted-tables">Create Encrypted Tables</h2>
<p>With <code>innodb-encrypt-tables=ON</code>, new InnoDB tables will be encrypted by default, using the key ID set in <code>innodb_default_encryption_key_id</code> (default 1). With <code>innodb-encrypt-tables=FORCE</code> enabled, it is not possible to manually bypass encryption when creating a table.</p>
<p>You can cause the AWS KMS plugin to create new encryption keys at-will by specifying a new ENCRYPTION_KEY_ID when creating a table:</p>
<pre class="fixed">MariaDB [test]&gt; create table t1 (id serial, v varchar(32)) ENCRYPTION_KEY_ID=3;
Query OK, 0 rows affected (0.91 sec)
</pre><pre class="fixed">[Note] AWS KMS plugin: generated encrypted datakey for key id=3, version=1
[Note] AWS KMS plugin: loaded key 3, version 1, key length 128 bit
</pre><pre class="fixed"># ls -l /var/lib/mysql/aws*
-rw-rw----. 1 mysql mysql 188 Feb 25 18:55 /var/lib/mysql/aws-kms-key.1.1
-rw-rw----. 1 mysql mysql 188 Feb 25 18:55 /var/lib/mysql/aws-kms-key.2.1
-rw-rw----. 1 mysql mysql 188 Feb 25 19:10 /var/lib/mysql/aws-kms-key.3.1
</pre><p>Read more about encrypting data in the <a href="/kb/en/data-at-rest-encryption/#encrypting-data">Data at Rest Encryption</a> section of the MariaDB Documentation.</p>
<h2 class="anchored_heading" id="aws-kms-plugin-option-reference">AWS KMS Plugin Option Reference</h2>
<ul start="1"><li><code>aws_key_management_master_key_id</code>: AWS KMS Customer Master Key ID (ARN or alias prefixed by <code>alias/</code>) for master encryption key. Used to create new data keys. If not set, no new data keys will be created.
</li><li><code>aws_key_management_rotate_key</code>: Set this variable to a data key ID to perform rotation of the key to the master key given in <code>aws_key_management_master_key_id</code>. Specify -1 to rotate all keys.
</li></ul>
<ul start="1"><li><code>aws_key_management_key_spec</code>: Encryption algorithm used to create new keys. Allowed values are AES_128 (default) or AES_256.
</li><li><code>aws_key_management_log_level</code>: Logging for AWS API. Allowed values, in increasing verbosity, are "Off" (default), "Fatal", "Error", "Warn", "Info", "Debug", and "Trace".
</li></ul>
<h2 class="anchored_heading" id="next-steps">Next Steps</h2>
<p>For more information about advanced usage, including strategies to manage credentials, enforce separation of responsibilities, and even require 2-factor authentication to start your MariaDB server, please review <a href="/kb/en/aws-key-management-encryption-plugin-advanced-usage/">Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage</a>.</p>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/aws-key-management-encryption-plugin-setup-guide/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/aws-key-management-encryption-plugin-setup-guide/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/aws-key-management-encryption-plugin/">
                        ← AWS Key Management Encryption Plugin
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/key-management-and-encryption-plugins/">
                        ↑ Key Management and Encryption Plugins ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/aws-key-management-encryption-plugin-advanced-usage/">
                        Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="5414" data-comments-url="/kb/en/aws-key-management-encryption-plugin-setup-guide/+comments"
         data-reply-url="/kb/en/aws-key-management-encryption-plugin-setup-guide/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/key-management-and-encryption-plugins/">
                    ↑ Key Management and Encryption Plugins ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/encryption-key-management/">
                            
                            Encryption Key Management
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/file-key-management-encryption-plugin/">
                            
                            File Key Management Encryption Plugin
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/hashicorp-key-management-plugin/">
                            
                            Hashicorp Key Management Plugin
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/aws-key-management-encryption-plugin/">
                            
                            AWS Key Management Encryption Plugin
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Setup Guide</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/aws-key-management-encryption-plugin-advanced-usage/">
                            
                            Amazon Web Services (AWS) Key Management Service (KMS) Encryption Plugin Advanced Usage
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/eperi-key-management-encryption-plugin/">
                            
                            Eperi Key Management Encryption Plugin
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/encryption-plugin-api/">
                            <span class="pull-right not_primary"></span>
                            Encryption Plugin API
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row row-10">
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/products" title="Products">Products</a>
                    </h5>
                    <ul>
                        <li id="menu-item-7816" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7816"><a href="https://mariadb.com/products/mariadb-platform/">MariaDB Platform</a></li>
                        <li id="menu-item-7815" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7815"><a href="https://mariadb.com/products/skysql/">MariaDB SkySQL</a></li>
                        <li id="menu-item-4172" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4172"><a href="https://mariadb.com/pricing/">Pricing</a></li>
                        <li id="menu-item-4163" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4163"><a href="https://mariadb.com/downloads/">Download MariaDB</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/services" title="Services">Services</a>
                    </h5>
                    <ul>
                        <li id="menu-item-4169" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4169"><a href="https://mariadb.com/services/remote-dba/">Remote DBA</a></li>
                        <li id="menu-item-41691" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4169"><a href="https://mariadb.com/services/skydba/">SkyDBA</a></li>
                        <li id="menu-item-4167" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4167"><a href="https://mariadb.com/services/enterprise-architect/">Enterprise Architect</a></li>
                        <li id="menu-item-4170" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4170"><a href="https://mariadb.com/services/technical-support-services/">Technical Support</a></li>
                        <li id="menu-item-4168" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4168"><a href="https://mariadb.com/services/migration-practice/">Migration Practice</a></li>
                        <li id="menu-item-4166" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4166"><a href="https://mariadb.com/services/consulting/">Consulting</a></li>
                        <li id="menu-item-4171" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4171"><a href="https://mariadb.com/services/training/">Training</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-xs-4 item">
                    <h5>
                        <a href="/resources" title="Resources">Resources</a>
                    </h5>
                    <ul>
                        <li id="menu-item-41751" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/docs/">Documentation</a></li>
                        <li id="menu-item-41752" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/developers/">Developers</a></li>
                        <li id="menu-item-4175" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4175"><a href="https://mariadb.com/resources/blog/">Blog</a></li>
                        <li id="menu-item-5462" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5462"><a href="https://support.mariadb.com">Support</a></li>
                        <li id="menu-item-6004" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6004"><a href="https://mariadb.com/openworks/">OpenWorks</a></li>
                        <li id="menu-item-60041" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6004"><a href="https://mariadb.com/resources/customer-stories/">Customer Stories</a></li>
                        <li id="menu-item-7817" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-7817"><a href="https://mariadb.com/resources/events/">Events</a></li>
                        <li id="menu-item-4177" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4177"><a href="https://mariadb.com/roadshow/">MariaDB Roadshow</a></li>
                    </ul>
                </div>
                <div class="visible-xs visible-sm clear"></div>
                <div class="col-md-2 col-xs-5 item">
                    <h5>
                        <a href="/about-us" title="About MariaDB">About</a>
                    </h5>
                    <ul>
                        <li id="menu-item-4173" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4173"><a href="https://mariadb.com/contact/">Contact</a></li>
                        <li id="menu-item-4161" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4161"><a href="https://mariadb.com/about-us/leadership/">Leadership</a></li>
                        <li id="menu-item-4162" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4162"><a href="https://mariadb.com/about-us/partners/">Partners</a></li>
                        <li id="menu-item-4174" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4174"><a href="https://mariadb.com/newsroom/">Newsroom</a></li>
                        <li id="menu-item-4160" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4160"><a href="https://mariadb.com/about-us/investors/">Investors</a></li>
                        <li id="menu-item-4159" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/about-us/careers/">Careers</a></li>
                        <li id="menu-item-41591" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/trust/">Trust Center</a></li>
                        <li id="menu-item-41592" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4159"><a href="https://mariadb.com/vulnerability-reporting/">Vulnerability Reporting</a></li>
                    </ul>
                </div>
                <div class="col-md-4 col-xs-7 item">
                    <div id="block-footercontact" class="block block-block-content block-block-content22b3af28-0754-44ec-a5c6-4466568f37e3">
                        <h5><a href="/contact" title="Contact">Contact</a></h5>
                    </div>
                    <div class="social">
                        <ul class="list-inline">
                            <li>
                                <a target="_blank" href="https://www.facebook.com/MariaDB.dbms/" title="Facebook">
                                    <i class="fa fa-facebook" aria-hidden="true"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="https://twitter.com/mariadb" title="Twitter">
                                    <i class="fa fa-twitter" aria-hidden="true"></i>
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="https://www.linkedin.com/company/mariadb-corporation?trk=company_logo " title="LinkedIn">
                                    <i class="fa fa-linkedin" aria-hidden="true"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <p>Subscribe to our newsletter!</p>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container text-center">
            <ul class="list-inline no-margin">
                <li>
                    <a href="/legal" title="Legal">Legal</a>
                </li>
                <li>
                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                </li>
                <li>
                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                </li>
            </ul>
            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
        </div>
    </div>
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>