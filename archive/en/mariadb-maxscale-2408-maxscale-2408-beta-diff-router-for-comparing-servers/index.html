<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>MaxScale 24.08 Beta  Diff - router for comparing servers - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="MaxScale 24.08 Beta  Diff - router for comparing servers" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Diff - router for comparing servers
NOTE The Diff router requires a MaxScale license. This license is included
with a MariaDB support agreement, but can also be purchased sepa..." />

    <meta name="description" content="Diff - router for comparing servers
NOTE The Diff router requires a MaxScale license. This license is included
with a MariaDB support agreement, but can also be purchased sepa..." />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/maxscale/">MariaDB MaxScale</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-maxscale-24-08-beta/">MariaDB MaxScale 24.08 Beta</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-maxscale-24-08-beta-routers/">MaxScale 24.08 Beta Routers</a>
    


    » <a class="node_link crumb" href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/">MaxScale 24.08 Beta  Diff - router for comparing servers</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+flag"
                data-flag-url="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2024-08-29 22:08">3 months, 1 week ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2024-08-29 22:08">3 months, 1 week ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
        <dt>Source</dt>
        <dd><a href="https://github.com/mariadb-corporation/MaxScale/blob/24.08.0/Documentation/Routers/Diff.md">GitHub</a></dd>
        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>MaxScale 24.08 Beta  Diff - router for comparing servers</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <h1 id="diff-router-for-comparing-servers">Diff - router for comparing servers</h1>
<p><strong>NOTE</strong> The Diff router requires a MaxScale license. This license is included
with a MariaDB support agreement, but can also be purchased separately. The
Diff router will be a standard part of MaxScale 24.08, but is available upon
request for evaluation with MaxScale 24.02.</p>
<div>
<ul>
<li><a href="#diff-router-for-comparing-servers">Diff - router for comparing servers</a><ul>
<li><a href="#overview">Overview</a><ul>
<li><a href="#histogram">Histogram</a></li>
<li><a href="#discrepancies">Discrepancies</a></li>
<li><a href="#explain">EXPLAIN</a></li>
<li><a href="#qps">QPS</a></li>
<li><a href="#reporting">Reporting</a></li>
</ul>
</li>
<li><a href="#setup">Setup</a><ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#running-diff">Running Diff</a><ul>
<li><a href="#create">Create</a></li>
<li><a href="#start">Start</a></li>
<li><a href="#status">Status</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#stop">Stop</a></li>
<li><a href="#destroy">Destroy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#visualizing">Visualizing</a></li>
<li><a href="#continuous-reporting">Continuous Reporting</a></li>
<li><a href="#mode">Mode</a></li>
<li><a href="#configuration-parameters">Configuration Parameters</a><ul>
<li><a href="#main">main</a></li>
<li><a href="#service">service</a></li>
<li><a href="#explain_1">explain</a></li>
<li><a href="#explain_entries">explain_entries</a></li>
<li><a href="#explain_period">explain_period</a></li>
<li><a href="#max_request_lag">max_request_lag</a></li>
<li><a href="#on_error">on_error</a></li>
<li><a href="#percentile">percentile</a></li>
<li><a href="#qps_window">qps_window</a></li>
<li><a href="#report">report</a></li>
<li><a href="#reset_replication">reset_replication</a></li>
<li><a href="#retain_faster_statements">retain_faster_statements</a></li>
<li><a href="#retain_slower_statements">retain_slower_statements</a></li>
<li><a href="#samples">samples</a></li>
</ul>
</li>
<li><a href="#limitations">Limitations</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="overview">Overview</h2>
<p>The <code>diff</code>-router, hereafter referred to as <em>Diff</em>, compares the
behaviour of one MariaDB server version to that of another.</p>
<p>Diff will send the workload both to the server currently being used -
called <em>main</em> - and to another server - called <em>other</em> - whose
behaviour needs to be assessed.</p>
<p>The responses from <em>main</em> are returned to the client, without
waiting for the responses from <em>other</em>. While running, Diff collects
latency histogram data that later can be used for evaluating the
behaviour of <em>main</em> and <em>other</em>.</p>
<p>Although Diff is a normal MaxScale router that can be configured
manually, typically it is created using commands provided by the
router itself. As its only purpose is to compare the behaviour of
different servers, it is only meaningful to start it provided certain
conditions are fulfilled and those conditions are easily ensured using
the router itself.</p>
<h3 id="histogram">Histogram</h3>
<p>Diff collects latency information separately for each <em>canonical
statement</em>, which simply means a statement where all literals have been
replaced with question marks. For instance, the canonical statement of
<code>SELECT f FROM t WHERE f = 10</code> and <code>SELECT f FROM t WHERE f = 20</code> is
in both cases <code>SELECT f FROM t WHERE f = ?</code>. The latency information
of both of those statements will be collected under the same canonical
statement.</p>
<p>Before starting to register histogram data, Diff will collect
<a href="#samples">samples</a> from <em>main</em> that will be used for defining the
edges and the number of bins of the histogram.</p>
<h3 id="discrepancies">Discrepancies</h3>
<p>The responses from <em>main</em> and <em>other</em> are considered to be different
- if the checksum of the response from <em>main</em> and <em>other differ, or
- if the response time of _other</em> is outside the boundaries of the
  histogram edges calculated from the samples from <em>main</em>.</p>
<p>A difference in the response time of individual queries is not a
meaningful criteria, as there for varying reasons (e.g. network
traffic) can be a significant amount of variance in the results. It
would only always cause a large number of false positives.</p>
<h3 id="explain">EXPLAIN</h3>
<p>When a discrepancy is detected, an EXPLAIN statement will be executed
if the query was a DELETE, SELECT, INSERT or UPDATE. The EXPLAIN will
be executed using the same connection that was used for executing the
original statement. In the normal case, the EXPLAIN will be executed
immediately after the original statement, but if the client is
streaming requests, an other statement may have been exceuted in
between.</p>
<p>EXPLAINs are not always executed, but the frequency is controlled by
<a href="#explain_entries">explain_entries</a> and
<a href="#explain_period">explain_period</a>. The EXPLAIN results are included in
the <a href="#reporting">output</a> of Diff.</p>
<h3 id="qps">QPS</h3>
<p>While running, Diff will also collect QPS information over a sliding
window whose size is defined by <a href="#qps_period">qps_period</a>.</p>
<h3 id="reporting">Reporting</h3>
<p>Diff produces two kinds of output:
- Output that is generated when Diff terminates or upon
  <a href="#summary">request</a>. That output can be visualized as explained
  <a href="#visualizing">here</a>.
- <a href="#report">Optionally</a> Diff can continuously report queries whose
  responses from <em>main</em> and other <em>differ</em> as described
  <a href="#discrepancies">here</a>.</p>
<p>When Diff starts it will create a directory <code>diff</code> in MaxScale's
data directory (typically <code>/var/lib/maxscale</code>). Under that it
will create a directory whose name is the same as that of the
service specified in <a href="#service">service</a>. The output files are created
in that directory.</p>
<h2 id="setup">Setup</h2>
<p>The behaviour and usage of Diff is most easily explained
using an example.</p>
<p>Consider the following simple configuration that only includes
the very essential.</p>
<div><pre><span></span>[MyServer1]
type=server
address=192.168.1.2
port=3306

[MyService]
type=service
router=readwritesplit
servers=MyServer1
...
</pre></div>


<p>There is a service <code>MyService</code> that uses a single server <code>MyServer1</code>,
which, for this example, is assumed to run MariaDB 10.5.</p>
<p>Suppose that the server should be upgraded to 11.2 and we want
to find out whether there would be some issues with that.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>In order to use Diff for comparing the behaviour of MariaDB 10.5
and MariaDB 11.2, the following steps must be taken.</p>
<ul>
<li>Install MariaDB 11.2 on a host that performance wise is
     similar to the host on which MariaDB 10.5 is running.</li>
<li>Configure the MariaDB 11.2 server to replicate from the
     MariaDB 10.5 server.</li>
<li>Create a server entry for the MariaDB 11.2 server in
     the MaxScale configuration.</li>
</ul>
<p>The created entry could be something like:</p>
<div><pre><span></span>[MariaDB_112]
type=server
address=192.168.1.3
port=3306
protocol=mariadbbackend
</pre></div>


<p>With these steps Diff is ready to be used.</p>
<h3 id="running-diff">Running Diff</h3>
<p>Diff is controlled using a number of module commands.</p>
<h4 id="create">Create</h4>
<p>Syntax: <code>create new-service existing-service used-server new-server</code></p>
<p>Where:
- <code>new-service</code>: The name of the service using the Diff router, to be
  created.
- <code>existing-service</code>: The name of an existing service in whose context
  the the new server is to be evaluated.
- <code>used-server</code>: A server used by <code>existing-service</code>
- <code>new-server</code>: The server that should be compared to <code>used-server</code>.</p>
<div><pre><span></span>maxctrl call command diff create DiffMyService MyService MyServer1 MariaDB_112
{
    "status": "Diff service 'DiffMyService' created. Server 'MariaDB_112' ready to be evaluated."
}
</pre></div>


<p>With this command, preparations for comparing the server <code>MariaDB_112</code>
against the server <code>MyServer1</code> of the service <code>MyService</code> will be made.
At this point it will be checked in what kind of replication relationship
<code>MariaDB_112</code> is with respect to <code>MyServer1</code>.  If the steps in
<a href="#prerequisites">prerequisites</a> were followed, it will be detected that
<code>MariaDB_112</code> replicates from <code>MyServer1</code>.</p>
<p>If everything seems to be in order, the service <code>DiffMyService</code> will be
created. Settings such as <em>user</em> and <em>password</em> that are needed by the
service <code>DiffMyService</code> will be copied from <code>MyService</code>.</p>
<p>Using maxctrl we can check that the service indeed has been created.</p>
<div><pre><span></span>maxctrl list services
┌───────────────┬────────────────┬─────────────┬───────────────────┬────────────────────────┐
│ Service       │ Router         │ Connections │ Total Connections │ Targets                │
├───────────────┼────────────────┼─────────────┼───────────────────┼────────────────────────┤
│ MyService     │ readwritesplit │ 0           │ 0                 │ MyServer1              │
├───────────────┼────────────────┼─────────────┼───────────────────┼────────────────────────┤
│ DiffMyService │ diff           │ 0           │ 0                 │ MyServer1, MariaDB_112 │
└───────────────┴────────────────┴─────────────┴───────────────────┴────────────────────────┘
</pre></div>


<p>Now the comparison can be started.</p>
<h4 id="start">Start</h4>
<p>Syntax: <code>start diff-service</code></p>
<p>Where:
- <code>diff-service: The name of the service created in the</code>create` step.</p>
<div><pre><span></span>maxctrl call command diff start DiffMyService
{
    "sessions": {
        "suspended": 0,
        "total": 0
    },
    "state": "synchronizing",
    "sync_state": "suspending_sessions"
}
</pre></div>


<p>When Diff is started, it performs the following steps:</p>
<ol>
<li>All sessions of <code>MyService</code> are suspended.</li>
<li>In the <code>MyService</code> service, the server target <code>MyServer1</code>
      is replaced with <code>DiffMyService</code>.</li>
<li>The replication from <code>MyServer1</code> to <code>MariaDB_112</code> is stopped.</li>
<li>The sessions are restarted, which will cause existing connections
      to <code>MyServer1</code> to be closed and new ones to be created, via Diff,
      to both <code>MyServer1</code> and <code>MariaDB_112</code>.</li>
<li>The sessions are resumed, which means that the client traffic
      will continue.</li>
</ol>
<p>In the first step, all sessions that are idle will immediately
be suspended, which simply means that nothing is read from
the client socket. Sessions that are waiting for a response
from the server and sessions that have an active transaction
continue to run. Immediately when a session becomes idle,
it is suspended.</p>
<p>Once all sessions have been suspended, the service is rewired.
In the case of <code>MyService</code> above, it means that the target
<code>MyServer1</code> is replaced with <code>DiffMyService</code>. That is, requests
that earlier were sent to <code>MyServer1</code>, will, once the sessions
are resumed, be sent to <code>DiffMyService</code>, which sends them forward
to both <code>MyServer1</code> and <code>MariaDB_112</code>.</p>
<p>Restarting the sessions means that the direct connections to
<code>MyServer1</code> will be closed and equivalent ones created via the
service <code>DiffMyService</code>, which will also create connections
to <code>MariaDB_112</code>.</p>
<p>When the sessions are resumed, client requests will again be
processed, but they will now be routed via <code>DiffMyService</code>.</p>
<p>With maxctrl we can can check that MyServer has been rewired.</p>
<div><pre><span></span>maxctrl list services
┌───────────────┬────────────────┬─────────────┬───────────────────┬────────────────────────┐
│ Service       │ Router         │ Connections │ Total Connections │ Targets                │
├───────────────┼────────────────┼─────────────┼───────────────────┼────────────────────────┤
│ MyService     │ readwritesplit │ 0           │ 0                 │ DiffMyService          │
├───────────────┼────────────────┼─────────────┼───────────────────┼────────────────────────┤
│ DiffMyService │ diff           │ 0           │ 0                 │ MyServer1, MariaDB_112 │
└───────────────┴────────────────┴─────────────┴───────────────────┴────────────────────────┘
</pre></div>


<p>The target of <code>MyService</code> is <code>DiffMyService</code> instead of <code>MyServer1</code>
that it used to be.</p>
<p>The output object returned by <code>create</code> tells the current state.</p>
<div><pre><span></span>{
    "sessions": {
        "suspended": 0,
        "total": 0
    },
    "state": "synchronizing",
    "sync_state": "suspending_sessions"
}
</pre></div>


<p>The <code>sessions</code> object shows how many sessions there are in total
and how many that currently are suspended. Since there were no
existing sessions in this example, they are both 0.</p>
<p>The <code>state</code> shows what Diff is currently doing. <code>synchronizing</code>
means that it is in the process of changing <code>MyService</code> to use
<code>DiffMyService</code>. <code>sync_state</code> shows that it is currently in the
process of suspending sessions.</p>
<h4 id="status">Status</h4>
<p>Syntax: <code>status diff-service</code></p>
<p>Where:
- <code>diff-service: The name of the service created in the</code>create` step.</p>
<p>When Diff has been started, its current status can be checked with the
command <code>status</code>. The output is the same as what was returned when
Diff was started.</p>
<div><pre><span></span>maxctrl call command diff status DiffMyService
{
    "sessions": {
        "suspended": 0,
        "total": 0
    },
    "state": "comparing",
    "sync_state": "not_applicable"
}
</pre></div>


<p>The state is now <code>comparing</code>, which means that everything is ready
and clients can connect in normal fashion.</p>
<h4 id="summary">Summary</h4>
<p>Syntax: <code>summary diff-service</code></p>
<p>Where:
- <code>diff-service: The name of the service created in the</code>create` step.</p>
<p>While Diff is running, it is possible at any point to request
a summary.</p>
<div><pre><span></span>maxctrl call command diff summary DiffMyService
OK
</pre></div>


<p>The summary consists of two files, one for the <em>main</em> server and
one for the <em>other</em> server. The files are written to a subdirectory
with the same name as the Diff service, which is created in the
subdirectory <code>diff</code> in the data directory of MaxScale.</p>
<p>Assuming the data directory is the default <code>/var/lib/maxscale</code>,
the directory would in this example be
<code>/var/lib/maxscale/diff/DiffMyService</code>.</p>
<p>The names of the files will be the server name, concatenated with a
timestamp. In this example, the names of the files could be:</p>
<div><pre><span></span>MyServer1_2024-05-07_140323.json
MariaDB_112_2024-05-07_140323.json
</pre></div>


<p>The visualization of the results is done using the
<a href="#visualizing">maxvisualize</a> program.</p>
<h4 id="stop">Stop</h4>
<p>Syntax: <code>stop diff-service</code></p>
<p>Where:
- <code>diff-service: The name of the service created in the</code>create` step.</p>
<p>The comparison can stopped with the command <code>stop</code>.</p>
<div><pre><span></span>maxctrl call command diff stop DiffMyService
{
    "sessions": {
        "suspended": 0,
        "total": 0
    },
    "state": "stopping",
    "sync_state": "suspending_sessions"
}
</pre></div>


<p>Stopping Diff reverses the effect of starting it:</p>
<ol>
<li>All sessions are suspended.</li>
<li>In the service, 'DiffMyService' is replaced with 'MyServer1'.</li>
<li>The sessions are restarted.</li>
<li>The sessions are resumed.</li>
</ol>
<p>As the sessions have to be suspended, it may take a while
before the operation has completed. The status can be checked with
the 'status' command.</p>
<h4 id="destroy">Destroy</h4>
<p>Syntax: <code>destroy diff-service</code></p>
<p>Where:
- <code>diff-service: The name of the service created in the</code>create` step.</p>
<p>As the final step, the command <code>destroy</code> can be called to
destroy the service.</p>
<div><pre><span></span>maxctrl call command diff destroy DiffMyService
OK
</pre></div>


<h2 id="visualizing">Visualizing</h2>
<p>The visualization of the data is done with the <code>maxvisualize</code> program,
which is part of the <em>Capture</em> functionality. The visualization will
open up a browser window to show the visualization.</p>
<p>If no browser opens up, the visualization URL is also printed into
the command line which by default should be <a href="http://localhost:8866/">http://localhost:8866/</a>.</p>
<p>In the case of the example above, the directory where the output files
are created would be <code>/var/lib/maxscale/diff/MyService</code>. And the files
to be used when visualizing would be called something like
<code>MyServer1_2024-05-07_140323.json</code> and
<code>MariaDB_112_2024-05-07_140323.json</code>. The timestamp will be different
every time <a href="#summary">summary</a> is executed.</p>
<div><pre><span></span>maxvisualize MyServer1_2024-05-07_140323.json MariaDB_112_2024-05-07_140323.json
</pre></div>


<p>The order is significant; the first argument is the baseline and the
second argument the results compared to the baseline.</p>
<h2 id="continuous-reporting">Continuous Reporting</h2>
<p>If the value of <a href="#report">report</a> is something else but <code>never</code>, Diff
will continously log results to a file whose name is the concatenation
for the main and other server followed by a timestamp. In the example
above, the name would be something like
<code>MyServer1_MariaDB_112_2024-02-15_152838.json</code>.</p>
<p>Each line (here expanded for readability) in the file will look like:</p>
<div><pre><span></span>{
  "id": 1,
  "session": 1,
  "command": "COM_QUERY",
  "query": "select @@version_comment limit 1",
  "results": [
    {
      "target": "MyServer1",
      "checksum": "0f491b37",
      "rows": 1,
      "warnings": 0,
      "duration": 257805,
      "type": "resultset",
      "explain": { ... }
    },
    {
      "target": "MariaDB_112",
      "checksum": "0f491b37",
      "rows": 1,
      "warnings": 0,
      "duration": 170043,
      "type": "resultset",
      "explain": { ... }
    }
  ]
}
</pre></div>


<p>The meaning of the fields are as follows:</p>
<ul>
<li><strong>id</strong>: Running number, increases for each query, but will not be in
  strict increasing order if a statement needed to be EXPLAINed and
  the following did not.</li>
<li><strong>session</strong>: The session id.</li>
<li><strong>command</strong>: The protocol packet type.</li>
<li><strong>query</strong>: The SQL of the query.</li>
<li><strong>results</strong>: Array of results.</li>
<li><strong>target</strong>: The server the result relates to.</li>
<li><strong>checksum</strong>: The checksum of the result.</li>
<li><strong>rows</strong>: How many rows were returned.</li>
<li><strong>warnings</strong>: The number of warnings.</li>
<li><strong>duration</strong>: The execution duration in nanonseconds.</li>
<li><strong>type</strong>: What type of result <code>resultset</code>, <code>ok</code> or <code>error</code>.</li>
<li><strong>explain</strong>: The result of <code>EXPLAIN FORMAT=JSON statement</code>.</li>
</ul>
<p>Instead of an <code>explain</code> object, there may be an <code>explained_by</code> array,
containing the ids of similar statements (i.e. their canonical
statement is the same) that were EXPLAINed.</p>
<h2 id="mode">Mode</h2>
<p>Diff can run in a read-only or read-write mode and the mode is
deduced from the replication relationship between <em>main</em> and
<em>other</em>.</p>
<p>If <em>other</em> replicates from <em>main</em>, it is assumed that <em>main</em> is
the primary. In this case Diff will, when started, stop the
replication from <em>main</em> to <em>other</em>. When the comparison ends
Diff will, depending on the value of
<a href="#reset_replication">reset_replication</a>
either reset the replication from <em>main</em> to <em>other</em> or leave
the situation as it is.</p>
<p>If <em>other</em> and <em>main</em> replicates from a third seriver, it is
assumed <em>main</em> is a replica. In this case, Diff will, when
started, leave the replication as it is and do nothing when
the comparison ends.</p>
<p>If the replication relationship between <em>main</em> and <em>other</em>
is anything else, Diff will refuse to start.</p>
<h2 id="configuration-parameters">Configuration Parameters</h2>
<h3 id="main"><code>main</code></h3>
<ul>
<li><strong>Type</strong>: server</li>
<li><strong>Mandatory</strong>: Yes</li>
<li><strong>Dynamic</strong>: No</li>
</ul>
<p>The main target from which results are returned to the client. Must be
a server and must be one of the servers listed in
<a href="/kb/en/maxscale-24-08-beta-mariadb-maxscale-configuration-guide/#targets">targets</a>.</p>
<p>If the connection to the main target cannot be created or is lost
mid-session, the client connection will be closed.</p>
<h3 id="service"><code>service</code></h3>
<ul>
<li><strong>Type</strong>: service</li>
<li><strong>Mandatory</strong>: Yes</li>
<li><strong>Dynamic</strong>: No</li>
</ul>
<p>Specifies the service Diff will modify.</p>
<h3 id="explain_1"><code>explain</code></h3>
<ul>
<li><strong>Type</strong>: <a href="#enumerations">enum</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Values</strong>: <code>none</code>, <code>other</code>, `both'</li>
<li><strong>Default</strong>: <code>both</code></li>
</ul>
<p>Specifies whether a request should be EXPLAINed on only <em>other</em>,
both <em>other</em> and <em>main</em> or neither.</p>
<h3 id="explain_entries"><code>explain_entries</code></h3>
<ul>
<li><strong>Type</strong>: non-negative integer</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Default</strong>: 2</li>
</ul>
<p>Specifies how many times at most a particular canonical statement
is EXPLAINed during the period specified by
<a href="#explain_period">explain_period</a>.</p>
<h3 id="explain_period"><code>explain_period</code></h3>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-08-beta-mariadb-maxscale-configuration-guide/#duration">duration</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Default</strong>: 15m</li>
</ul>
<p>Specifies the length of the period during which at most
<a href="#explain_entries">explain_entries</a> number of EXPLAINs are executed
for a statement.</p>
<h3 id="max_request_lag"><code>max_request_lag</code></h3>
<ul>
<li><strong>Type</strong>: non-negative integer</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Default</strong>: 10</li>
</ul>
<p>Specifies the maximum number of requests <em>other</em> may be lagging
behind <em>main</em> before the execution of SELECTs against <em>other</em>
are skipped to bring it back in line with <em>main</em>.</p>
<h3 id="on_error"><code>on_error</code></h3>
<ul>
<li><strong>Type</strong>: <a href="#enumerations">enum</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Values</strong>: <code>close</code>, <code>ignore</code></li>
<li><strong>Default</strong>: <code>ignore</code></li>
</ul>
<p>Specifies whether an error from <em>other</em>, will cause the session to
be closed. By default it will not.</p>
<h3 id="percentile"><code>percentile</code></h3>
<ul>
<li><strong>Type</strong>: count</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Min</strong>: 1</li>
<li><strong>Max</strong>: 100</li>
<li><strong>Default</strong>: 99</li>
</ul>
<p>Specifies the percentile of sampels that will be considered when
calculating the width and number of bins of the histogram.</p>
<h3 id="qps_window"><code>qps_window</code></h3>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-08-beta-mariadb-maxscale-configuration-guide/#duration">duration</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: No</li>
<li><strong>Default</strong>: 15m</li>
</ul>
<p>Specifies the size of the sliding window during which QPS is calculated
and stored. When a <a href="#summary">summary</a> is requested, the QPS information
will also be saved.</p>
<h3 id="report"><code>report</code></h3>
<ul>
<li><strong>Type</strong>: <a href="#enumerations">enum</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Values</strong>: <code>always</code>, <code>on_discrepancy</code>, <code>never</code></li>
<li><strong>Default</strong>: <code>on_discrepancy</code></li>
</ul>
<p>Specifies when the results of executing a statement on <em>other</em> and <em>main</em>
should be logged; <em>always</em>, when there is a significant difference or
<em>never</em>.</p>
<h3 id="reset_replication"><code>reset_replication</code></h3>
<ul>
<li><strong>Type</strong>: <a href="/kb/en/maxscale-24-08-beta-mariadb-maxscale-configuration-guide/#booleans">boolean</a></li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Default</strong>: <code>true</code></li>
</ul>
<p>If Diff has started in read-write mode and the value of
<code>reset_replication</code> is <code>true</code>, when the comparison ends
it will execute the following on <em>other</em>:</p>
<div><pre><span></span>RESET SLAVE
START SLAVE
</pre></div>


<p>If Diff has started in read-only mode, the value of <code>reset_replication</code>
will be ignored.</p>
<p>Note that since Diff writes updates directly to both <em>main</em> and
<em>other</em> there is no guarantee that it will be possible to simply
start the replication. Especially not if <code>gtid_strict_mode</code>
is on.</p>
<h3 id="retain_faster_statements"><code>retain_faster_statements</code></h3>
<ul>
<li><strong>Type</strong>: non-negative integer</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Default</strong>: 5</li>
</ul>
<p>Specifies the number of faster statements that are retained in memory.
The statements will be saved in the summary when the comparison ends,
or when Diff is explicitly instructed to do so.</p>
<h3 id="retain_slower_statements"><code>retain_slower_statements</code></h3>
<ul>
<li><strong>Type</strong>: non-negative integer</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Default</strong>: 5</li>
</ul>
<h3 id="samples"><code>samples</code></h3>
<ul>
<li><strong>Type</strong>: count</li>
<li><strong>Mandatory</strong>: No</li>
<li><strong>Dynamic</strong>: Yes</li>
<li><strong>Min</strong>: 100</li>
<li><strong>Default</strong>: 1000</li>
</ul>
<p>Specifies the number of samples that will be collected in order to
define the edges and number of bins of the histograms.</p>
<h2 id="limitations">Limitations</h2>
<p>Diff is currently not capable of adapting to any changes made in
the cluster configuration. For instance, if Diff starts up in
read-only mode and <em>main</em> is subsequently made <em>primary</em>, Diff
will not sever the replication from <em>main</em> to <em>other</em>. The result
will be that <em>other</em> receives the same writes twice; once via the
replication from the server it is replicating from and once when
Diff executes the same writes.</p>
    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-cat/">
                        ← MaxScale 24.08 Beta  Cat
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/maxscale-24-08-beta-routers/">
                        ↑ MaxScale 24.08 Beta Routers ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-hintrouter/">
                        MaxScale 24.08 Beta  HintRouter →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="15073" data-comments-url="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/+comments"
         data-reply-url="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-diff-router-for-comparing-servers/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/maxscale-24-08-beta-routers/">
                    ↑ MaxScale 24.08 Beta Routers ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-binlogrouter/">
                            
                            MaxScale 24.08 Beta   Binlogrouter
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-avrorouter/">
                            
                            MaxScale 24.08 Beta  Avrorouter
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-cat/">
                            
                            MaxScale 24.08 Beta  Cat
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>MaxScale 24.08 Beta  Diff - router for comparing servers</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-hintrouter/">
                            
                            MaxScale 24.08 Beta  HintRouter
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-kafkacdc/">
                            
                            MaxScale 24.08 Beta  KafkaCDC
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-kafkaimporter/">
                            
                            MaxScale 24.08 Beta  KafkaImporter
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-mirror/">
                            
                            MaxScale 24.08 Beta  Mirror
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-readconnroute/">
                            
                            MaxScale 24.08 Beta  Readconnroute
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-readwritesplit/">
                            
                            MaxScale 24.08 Beta  Readwritesplit
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-schemarouter/">
                            
                            MaxScale 24.08 Beta  SchemaRouter
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-maxscale-2408-maxscale-2408-beta-smartrouter/">
                            
                            MaxScale 24.08 Beta  SmartRouter
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>