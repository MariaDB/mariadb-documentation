<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>MariaDB Feature Backport - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="MariaDB Feature Backport - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/mariadb-feature-backport/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-feature-backport/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-feature-backport/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/training-tutorials/">Training &amp; Tutorials</a>
    

    
    » <a class="crumb" href="/kb/en/advanced-mariadb-articles/">Advanced MariaDB Articles</a>
    

    
    » <a class="crumb" href="/kb/en/development-articles/">Development Articles</a>
    

    
    » <a class="crumb" href="/kb/en/general-development-information/">General Development Information</a>
    

    
    » <a class="crumb" href="/kb/en/development-plans/">Plans</a>
    

    
    » <a class="crumb" href="/kb/en/old-plans/">Old Plans</a>
    


    » <a class="node_link crumb" href="/kb/en/mariadb-feature-backport/">MariaDB Feature Backport</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/mariadb-feature-backport/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>MariaDB Feature Backport - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/mariadb-feature-backport/+r/76047/">76047</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-2">
<a href="/kb/user/id/2" title="Daniel Bartholomew">Daniel Bartholomew</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2018-12-06 11:28">2018-12-06 11:28</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;include slug=&#34;obsolete&#34;&gt;&gt;

== Some background

If case you didn&#39;t know: 

=== What features were in 6.0

Features that were in 6.0 and that we can rescue from there and provide value
for the users:

* MRR+BKA
** There are known bugs in the implementation of MRR/InnoDB (but not in
   MRR/Maria or MRR/MyISAM) which has caused Oracle to request a patch that
   disables MRR/InnoDB, which SergeyP has given them this May.
** BKA itself was used by a customer with a proprietary engine, and also by
   NDB, so can be assumed tested.

 //note: unless said otherwise, by MRR we mean MRR and ICP, everywhere//

* The first two batches of subquery optimizations:
* LWL#2980: Subquery optimization: Semijoin
** LWL#3740: Subquery optimization: Semijoin: Pull-out of inner tables
** LWL#3741: Subquery optimization: Semijoin: Duplicate elimination strategy
** LWL#3750: Subquery optimization: Semijoin: First-match strategy
** LWL#3751: Subquery optimization: Semijoin: Inside-out strategy 
* LWL#1110: Subquery optimization: Materialization 
* LWL#3985: Subquery optimization: smart choice between semi-join and
  materialization

* Semi-join optimizations, including semi-join materialization has issues:
** The &#34;outer join and semi-join problem&#34;
** The different-datatypes-comparison problem

* Subquery optimizations rely on the following WLs to be present in the tree:
** LWL#4165 Prepared statements: validation
** LWL#4166 Prepared statements: automatic re-prepare


=== Related unfinished 6.x tasks

There are also unfinished tasks, in various degrees of public availability and readyness:

* LWL#3485: Subquery optimization: FROM (SELECT) (Evgen)
* LWL#4389: Subquery optimizations: Make IN optimizations also handle EXISTS (Roy Lyseng)
* LWL#3830: Subquery optimization: Materialization: Partial matching of tuples with NULL components (Timour)

* LWL#4800: Optimizer trace/debugger
* : (this is an utitlity task that might be useful for implementation of some
  of the other WLs. SergeyP has already ported it to MariaDB for such utility
  purposes, but its code is not ready for being pushed yet.

=== Directions for improvement

Some (but not all) of the following might be needed to make a well-rounded
release:

* [No WL]: Single table &#34;UPDATE/DELETE one_table WHERE
  subquery_predicate&#34;&lt;br/&gt;such query will not be executed by semi-join runtime.
  Ironically, multi-table UPDATE/DELETEs will be, so not multi-table UPDATEs
  may work faster than single-table.
* LWL#3341: Subquery optimization: Shortcut the evaluation as soon as there is a match
* LWL#1117: Subquery optimization: Avoid recalculating subquery if external fields have not changed
* LWL#4614: Subquery optimization: Materialization: avoid double subquery materialization
* LWL#3490: Subquery optimization: Subqueries and multiple columns comparison with ALL
* LWL#4690: Insideout order for materialized non-semijoin subqueries at top-level of the WHERE
* LWL#3808: Subquery optimization: Materialize and use as ranges for MRR scan of outer tables
* LWL#4245: Subquery optimization: FirstMatch strategy for anti-semi-join
* LWL#3489: Subquery optimization: Subquery and loose index scan
* LWL#4691: Subqueries: No-startup-cost execution for SJ-Materialization-Scan
* [No WL#]: Support ORDER BY .. LIMIT clause within a subquery (a quite common user request).

* [No WL]: Make the join optimizer take BKA into account

== Feature-wise plan for 5.4
The following is the &#34;Igor&#39;s list&#34;:

&lt;&lt;code&gt;&gt;
 1. MRR/ICP
 ---------------
 WL#2474: Batched range read handler functions
 WL#2475: Batched range read functions for MyISAM/InnoDB
 2. BKA
 ---------
 WL #2771: Usage of multi_read_range in nested loop join
 3. Metadata integrity
 -------------------------
 WL #4284 (bug #989): Transactional DDL locking
 WL#4165: Prepared statements: validation
 WL#4166: Prepared statements: automatic re-prepare
 4. Subqueries
 -----------------
 4.1 Materialization of non-correlated IN subqueries
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 WL #1110: Materialization
 WL #4614: Materialization: avoid double subquery materialization
 WL #4690: Insideout order for materialized non-semijoin subqueries at top-level  of the WHERE
 4.2. Semi-joins
 ~~~~~~~~~~~
 WL #3740: Subquery optimization: Semijoin: Pull-out of inner tables
 WL #3741: Subquery optimization: Semijoin: Duplicate elimination strategy
 WL #3750: Subquery optimization: Semijoin: Duplicate elimination strategy
 WL #3751: Subquery optimization: Semijoin: Inside-out strategy
 4.3. Smart choice between materialization and semi-join
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 WL #3985: Subquery optimization: smart choice between semi-join and
 materialization
 4.4. Derived tables
 ~~~~~~~~~~~~~~
 WL #3485: Subquery optimization: FROM (SELECT) 
 4.5. EXISTs convertible to IN
 ~~~~~~~~~~~~~~~~~~~~~~
 WL #4389: Make IN optimizations also handle EXISTS
 4.6. Materialization for non-correlated NOT IN subqueries
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 WL #3830: Materialization: Partial matching of tuples with NULL components
 
 4.7. Direct evaluation of subqueries with caching
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 WL #3341: Shortcut the evaluation as soon as there is a match
 WL #1117: Avoid recalculating subquery if external fields have not changed
&lt;&lt;/code&gt;&gt;

LWL#4614 and LWL#4690 are considered droppable.

== Plan for action (committed)

=== General considerations 

It seems to be infeasible to take mysql-6.0 and fix it until it has release
quality. We&#39;ll have to do it other way around: start from mariadb-5.2 codebase
and pull features to there, one by one. This process will be called &#34;backport&#34;.

=== Backport MRR/BKA (SergeyP) 

MRR/BKA has been there for longer time than other features and so is more
stable and so is a natural candidate for the first step.

Needed actions:

* Backport MRR/BKA code
** According to Igor, code at SQL layer should be easy to move
** Code inside MyISAM and Maria should be easily movable
** TODO what to do about MRR/NDB? We need to get it to compile at least.
** The trickest engine is InnoDB/XtraDB
*** will need to take changes that we&#39;ve made to InnoDB and apply them to
    XtraDB (TODO will Percona accept that? Or we&#39;ll have to maintain
    patches-to-patches?)
* We&#39;ll also need to fix the known MRR/InnoDB bugs

After MRR has been pushed, it received a number of code cleanups, bugfixes, and
interface adjustments (motivated by BKA and NDB/Falcon implementations).  This
means that there is no single MRR patch, instead one should go through
revisions and cherry-pick MRR-related patches (one of the ways to narrow down
the number of revisions: most (all?) MRR fixes were made by sergefp@mysql.com,

with exception of this fix:
&lt;&lt;code&gt;&gt;
 2726 Guilhem Bichot    2009-03-13
      Fix for multiple symptoms sharing the same cause:
      BUG#42297 Maria: crash in multi-range-read code
      BUG#42298 Maria: SELECT with join returns no rows
      ...
&lt;&lt;/code&gt;&gt;

In addition to backport, we need the following adjustments:

* Let DS-MRR support clustered primary keys (needed when using BKA). 
* &lt;&lt;strike&gt;&gt;Remove conditions used for key access from the condition pushed to
  index (We sometimes get &#34;Using index condition&#34; where there was no &#34;Using
  where&#34;)&lt;&lt;/strike&gt;&gt; Considered done as we&#39;re unable to find any examples for
  this.
* &lt;&lt;strike&gt;&gt;Introduce a separate @@optimizer_switch flag for turning on/out
  ICP.&lt;&lt;/strike&gt;&gt; DONE.
* Rename multi_range_read_info_const() to look like it is not a part of MRR
  interface

All of the above is filed as MWL#67:
http://askmonty.org/worklog/Server-Sprint/index.pl?tid=67

==== Milestone BKA-1: BKA backported

After the above is done, BKA will work in MariaDB 5.2 codebase in the same way
as it worked in MySQL 6.0, but without MRR/InnoDB bugs.

===  Subquery optimization: Efficient NOT IN execution with NULL (Timour) 

Implement http://askmonty.org/worklog/Server-Sprint/index.pl?tid=68

== Plan for action (planned)

=== Step: Take BKA into account in join optimizer (SergeyP or Igor)

Implement this item

* [No WL]: Make the join optimizer account for BKA.

According to Igor:

Within this milestone, assume a certain join_cache_level setting (it is likely
the estimates will be so rough that it won&#39;t matter)

TODO: clarify if this includes making the choice between doing MRR scan and
then filesorting vs doing non-MRR scan but not having to sort.

==== Milestone BKA-2: BKA with cost-based optimization 

After the above is done, we&#39;ll have MRR/BKA with cost-based optimization.

=== Step: Subqueries, start: backport and bugfixing

This step includes backporting all pushed 6.0&#39;s subquery optimizations and
fixing open wrong-result or crash bugs, including addressing of these
problems:

* Semi-join optimizations, including semi-join materialization has issues:
** The &#34;outer join and semi-join problem&#34;
** The different-datatypes-comparison problem

At the moment it seems the preferred course of action is to first fix the bugs
and then backport.

==== Milestone SUBQ-GET-ON-TRACK 

After the above is done, we&#39;ll be able to assume that we &#34;got on track&#34; with
subquery development and will be able to proceed further in many directions.

NOTE: it is not fully known what we&#39;ll discover when this milestone is
reacheed. Perhaps, we&#39;ll discover that subquery cost model needs some 
adjustments (but there&#39;s always a way out, penalize all non-5.1 plans so that 
the 5.1 plan wins in near competitions and thus there are no regressions).

=== Step: FROM subqueries

After the semi-join subqueries are done, the biggest and most annoying gap in
subquery optimizations will be poor FROM subquery handling. Thus, the next
item is to take the available code for

* LWL#3485: Subquery optimization: FROM (SELECT)

and finish that.

==== Milestone SUBQ-FROM-SUBQUERIES 

* This milestone adds LWL#3485.

(is there really sense to have a linear plan that extends further than this?
 Let&#39;s reach this point and release?)

=== Step: More subqueries 1

This is a step that has high ROI, can be done more-or-less indepdendently of 
the other work, and doesn&#39;t require in-depth knowlege of new subquery 
code/features:

* LWL#1117: Subquery optimization: Avoid recalculating subquery if external 
  fields have not changed

this can be passed over to somebody who haven&#39;t worked with subquery code
before.

(note: this task has a natural extension: create and use a cache of 
external_field_values-&gt;subquery_result mappings.

Btw, certain nose-trunk databases do not seem to handle this case.

=== Step: More subqueries 2

Another separate, high-ROI item:

* LWL#3341: Subquery optimization: Shortcut the evaluation as soon as there is a match

(TODO check if that&#39;s really that WL entry).


(note: after &#34;More subqueries #1/#2 we&#39;ll also need LWL#3830 before we could
count non-WHERE clause subqueries as covered).

=== Step: Backport Metadata integrity code (Timour)
Backport the following:

&lt;&lt;code&gt;&gt;
 WL #2771: Usage of multi_read_range in nested loop join
 3. Metadata integrity
 -------------------------
 WL #4284 (bug #989): Transactional DDL locking
 WL#4165: Prepared statements: validation
 WL#4166: Prepared statements: automatic re-prepare
&lt;&lt;/code&gt;&gt;</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>