<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>LevelDB Storage Engine MS2 - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="LevelDB Storage Engine MS2 - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/leveldb-storage-engine-ms2/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/leveldb-storage-engine-ms2/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/leveldb-storage-engine-ms2/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/training-tutorials/">Training &amp; Tutorials</a>
    

    
    » <a class="crumb" href="/kb/en/advanced-mariadb-articles/">Advanced MariaDB Articles</a>
    

    
    » <a class="crumb" href="/kb/en/development-articles/">Development Articles</a>
    

    
    » <a class="crumb" href="/kb/en/outdated-pages/">Outdated pages</a>
    


    » <a class="node_link crumb" href="/kb/en/leveldb-storage-engine-ms2/">LevelDB Storage Engine MS2</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/leveldb-storage-engine-ms2/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>LevelDB Storage Engine MS2 - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/leveldb-storage-engine-ms2/+r/130924/">130924</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-115">
<a href="/kb/user/id/115" title="Sergei Petrunia">Sergei Petrunia</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2015-01-28 12:25">2015-01-28 12:25</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;toc&gt;&gt;

== Remove the need for a second database

MS1 code needs to use two databases, because

* ##leveldb## database uses type-aware key comparison. This means, one must have knowledge about types of values in indexes before the database can be opened.

* ##leveldb-ddl## stores information about 
** datatypes used by various indexes. 
** Mapping from ##dbname.tablename.index_no## to ##index_number##.

The database itself uses default key comparison function, so one can open it without any knowledge.

It is possible to switch to having one database, if the keys can use the default key comparison function, memcmp(). The database will store 

* table/index data
* Mapping from ##dbname.tablename.index_no## to ##index_number##.

It seems, it is possible to convert MySQL field values into values comparable with memcmp() by using Field::make_sort_key() function.

=== Index-only scans

Index-only scans require that it is possible to restore key value from its memcmp()&#39;able form.

In general, it is not possible. For some particular datatypes, it is possible. We want to target the following types:

* ##INT##, ##BIGINT##, ##TINYINT##, and their ##UNSIGNED## variants (i.e., all INT-based types)
* ##CHAR(n) COLLATE latin1_bin##, ##VARCHAR(n) COLLATE latin1_bin##, possibly support ##utf8_bin##.

==== INT-based types 
For INT-based types, mem-comparable form is the integer stored in most-significant-bytes-first order. For SIGNED types, one needs to make negative values precede positive ones (memcmp() assumes all bytes are unsigned). This can be achieved by adding MAX_VALUE/2 to the number.

It is apparent that one can restore integer values back from their mem-comparable form.

==== String-based types


For string-based types, getting the value back from its mem-comparable form is harder.

===== Problem#1: case-insensitivity

For case-insensitive collations, conversion to mem-comparable form is, roughly speaking, conversion of all characters to upper case (it&#39;s actually more complex, but that&#39;s the idea)

For example, for column=&#39;foo&#39; and column=&#39;FOO&#39; the mem-comparable form is &#39;FOO&#39;, and there is no way to get the original case back.

===== Problem#2: VARCHAR and end-spaces

Consider a [VAR]CHAR(n) type. The mem-comparable form must have the same length for all values. If some values have different length, we won&#39;t be able to support multi-part keys.

In MySQL charset functions, mem-comparable form does have a fixed length. Fixed length is achieved by end-padding the value with spaces (more precisely, with mem-comparable images of spaces). This raises a question of, how do we get rid of these spaces when we&#39;re decoding the value back?

For ##CHAR(n)## fields, the problem doesn&#39;t exist, because MySQL strips all trailing spaces:
&lt;&lt;sql&gt;&gt;
create table t10 (a char(10) primary key); 
insert into t10 values (&#39;abc   &#39;);
select a, length(a) from t10;
+-----+-----------+
| a   | length(a) |
+-----+-----------+
| abc |         3 |
+-----+-----------+
&lt;&lt;/sql&gt;&gt;

(@@sql_mode has a PAD_CHAR_TO_FULL_LENGTH flag which will make MySQL to pad strings with as many spaces as possible instead of stripping. But either way, we don&#39;t have to care about how many end-spaces are in a CHAR(n) value).

For VARCHAR fields, end-spaces are not removed:
&lt;&lt;sql&gt;&gt;
create table t11 (a varchar(10) primary key);
insert into t11 values (&#39;abc   &#39;);
select a, length(a) from t11;
+--------+-----------+
| a      | length(a) |
+--------+-----------+
| abc    |         6 |
+--------+-----------+
&lt;&lt;/sql&gt;&gt;

When we try to decode a string from its mem-comparable form, we will not know how many end-spaces were in the original value.  We need to store the length somewhere.

===== Solution for case-insensitivity

We will avoid the problem of upper-casing by supporting index-only reads when used  collations do not map two different characters to the same mem-comparable value. The following collations are ok:

* ##BINARY## - characters are not transformed
* ##latin1_bin## - characters are not transformed
* ##utf8_bin## - characters are transformed into 2-byte images with ##my_utf8_uni()## and can be restored with ##my_uni_utf8()##. The functions are stored in ##cs-&gt;cset-&gt;mb_wc## and ##cs-&gt;cset-&gt;wc_mb##.
* ##utf8mb4_bin## - characters are transformed into 3-byte images with ##my_mb_wc_utf8mb4()## and can be restored with ##my_wc_mb_utf8mb4()##


===== Solution for end-spaces
We need to store the original length of the value somewhere.  There is no way we could put it into a mem-comparable form. If we put it there, we would have

&lt;&lt;code&gt;&gt;
memcmp(mem_comparable(&#39;abc&#39;), mem_comparable(&#39;abc  &#39;), len) != 0
&lt;&lt;/code&gt;&gt;

which would make equal values be compared as non equal. 

The solution is: don&#39;t store length in leveldb key. 
* For PRIMARY KEY, length is stored in leveldb&#39;s Value (we have entire table-&gt;record[0] there, with special encoding for blobs).
* For secondary indexes, we will store length in the leveldb&#39;s Value (which is currently empty).


== Fix CANT-SEE-OWN-CHANGES
The property is described at [[leveldb-storage-engine-ms1]] page. A solution is also described there:


&gt; After MS1, LevelDB SE will make sure that CANT-SEE-OWN changes is not observed. It will use the following approach:
&gt; * keep track of what records have been modified by this transaction in a buffer $R.
&gt; * If SQL layer makes a request to read a row, then
&gt; ** Consult $R if the record was INSERTed. If yes, return what was inserted.
&gt; ** Consult $R if the record was modified. if yes, return what was recorded as the result of modification
&gt; ** Consult $R if the record was deleted. If yes, return &#34;record not found&#34;.
&gt; ** Finally, try reading the row from the LevelDB.


Note: this allows us to keep only the last update if the transaction has made multiple updates in the same row. (as long as we didn&#39;t use to store both transaction and statement&#39;s changes together. In that case, we need to keep both transaction&#39;s and statement&#39;s changes)


== More test coverage
Adopt a storage-engine-independent testsuite to be used together with leveldb.


== Statement rollback inside a transaction

A truly transactional MySQL engine needs to support two kinds of rollback

# Rollback a statement
# Rollback a transaction

If a statement fails inside a transaction, the engine will need to rollback the statement, but not the transaction.  Currently, leveldb SE is unable to do so, because transaction&#39;s changes and statement&#39;s changes are stored in a single ##leveldb::WriteBatch## object.

The solution will be to keep transaction&#39;s changes and statement&#39;s changes separate, and put statement&#39;s changes into transaction&#39;s changes on statement end.

Another way: when we maintain a hashtable of changes, remember query_id of every change. If we need to roll back a statement, go through the changes and remove those that have query_id equal to the last query (TODO: is statement the same as query here, or not?)

== Fix the build process
MDEV-4154: Currently, leveldb SE hardcodes paths to leveldb library. Lift this limitation.

== @@leveldb_max_row_locks
Transaction locks are held in memory. Hence, there is an idea: prevent transactions from getting too big - have a variable that explicitly limits how many locks a transaction can take.  (there was a similar variable in BDB storage engine).  If a transaction attempts to take more locks than allowed, an error will be returned.

== Tasks
=== Remove the need for a second database
* Store mem-comparable values as keys (no index-only support)
* Switch rowlock table to use the same hash value?

=== Index-only scans
* Analyze index definition and set HA_KEYREAD_ONLY only when appropriate
* Unpack functions for integer columns
* Unpack function for CHAR(n)
* Storage an unpack for VARCHAR(n)

=== Fix CANT-SEE-OWN-CHANGES
* Maintain a hash table of changes made by the transaction
* Have read functions consult the hashtable before reading actual data

=== Statement rollback inside a transaction

* Maintain transaction&#39;s changes and last statement&#39;s changes separately.
** Roll back the right set of changes on statement/transaction abort.

=== More test coverage
* Adopt the engine-independent testsuite to be used with leveldb

== Misc
* (from skype discussion)_Currently max. auto_increment value is loaded every time a TABLE is opened. Make it to be loaded only when TABLE_SHARE is opened.</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>