<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Using MariaDB with TCMalloc or jemalloc - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Using MariaDB with TCMalloc or jemalloc - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/solutions" title="Solutions">Solutions</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="Company">Company</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-administration/">MariaDB Administration</a>
    

    
    » <a class="crumb" href="/kb/en/getting-installing-and-upgrading-mariadb/">Getting, Installing, and Upgrading MariaDB</a>
    

    
    » <a class="crumb" href="/kb/en/compiling-mariadb-from-source/">Compiling MariaDB From Source</a>
    

    
    » <a class="crumb" href="/kb/en/compiling-mariadb-with-extra-modulesoptions/">Compiling MariaDB with Extra Modules/Options</a>
    


    » <a class="node_link crumb" href="/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/">Using MariaDB with TCMalloc or jemalloc</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Using MariaDB with TCMalloc or jemalloc - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/using-mariadb-with-tcmalloc-or-jemalloc/+r/147718/">147718</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-27">
<a href="/kb/user/id/27" title="Sergei Golubchik">Sergei Golubchik</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2025-02-19 11:44">2025-02-19 11:44</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;style class=&#34;greenbox&#34;&gt;&gt;
Read the [[profiling-memory-usage|Profiling Memory Usage]] page for more information on how to debug high memory consumption.
&lt;&lt;/style&gt;&gt;

===Using tcmalloc or jemalloc
[[http://goog-perftools.sourceforge.net/doc/tcmalloc.html|TCMalloc]] is a malloc replacement library optimized for multi-threaded usage. It also features a built-in heap debugger and profiler.

Another malloc replacement that may speed up MariaDB is [[https://jemalloc.net/|jemalloc]].

The procedures to use one of these libraries with MariaDB are the same. Many other malloc replacement libraries (as well as heap debuggers and profilers) can be used with MariaDB in a similar fashion.

==== Checking the malloc Implementation in Use

If you are unsure which malloc implementation is in use, or if you used one of the procedures explained in this page and you want to verify if it succeeded, you can run this query:

&lt;&lt;code&gt;&gt;
SHOW GLOBAL VARIABLES LIKE &#39;version_malloc_library&#39;;
&lt;&lt;/code&gt;&gt;

A value of &#34;system&#34; indicates the system default, which is normally malloc. If another library is used, this query will return the name and version of the library.


==== Building MariaDB with an alternative to malloc

To build MariaDB 5.5 with ##TCMalloc##, you need to use the following command
&lt;&lt;code&gt;&gt;
cmake -DCMAKE_EXE_LINKER_FLAGS=&#39;-ltcmalloc&#39;  -DWITH_SAFEMALLOC=OFF
&lt;&lt;/code&gt;&gt;

To use jemalloc, the option should be ##-ljemalloc##.

==== Starting mariadbd-safe with an alternative to malloc

If you want to do this only one time, as a test, you can also start a standard MariaDB server with ##TCmalloc## with:

&lt;&lt;code&gt;&gt;
/usr/sbin/mariadbd-safe --malloc-lib=tcmalloc
&lt;&lt;/code&gt;&gt;

If you want to configure [[mariadbd-safe/|mariadbd-safe]] to use tcmalloc or jemalloc, edit your [[configuring-mariadb-with-option-files|configuration file]], in the ##[server]## or ##[mariadbd]## group:

&lt;&lt;code&gt;&gt;
malloc-lib=tcmalloc
&lt;&lt;/code&gt;&gt;

==== Starting mariadbd with an alternative to malloc

First, locate the library file that needs to be used:

&lt;&lt;code&gt;&gt;
# jemalloc
find /usr/lib -name &#34;libjemalloc.so.*&#34;
# tcmalloc
find /usr/lib -name &#34;libtcmalloc.so.*&#34;
&lt;&lt;/code&gt;&gt;

Now pass it to ##mariadbd## using the ##LD_PRELOAD## variable:
&lt;&lt;code&gt;&gt;
LD_PRELOAD=/path/to/library mariadbd
&lt;&lt;/code&gt;&gt;
For example, on OpenSuse 15.4 one would do:

==== Configuring systemd

If you use systemd to run MariaDB, first locate the library as explained above. The locate the service configuration file:

&lt;&lt;code&gt;&gt;
systemctl status mariadb |grep Loaded
&lt;&lt;/code&gt;&gt;

Now edit the ##mariadb.service## file by adding a line to the ##[Service]## group:

&lt;&lt;code&gt;&gt;
Environment=LD_PRELOAD=&lt;path-to-library&gt;
&lt;&lt;/code&gt;&gt;

For example:

&lt;&lt;code&gt;&gt;
[Service]
Environment=LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
&lt;&lt;/code&gt;&gt;

Now you should reload the configuration, so that the news setting will take effect, and restart MariaDB:

&lt;&lt;code&gt;&gt;
systemctl daemon-reload
systemctl restart mariadb
&lt;&lt;/code&gt;&gt;

==== Dockerfile

If you run [[docker-and-mariadb|MariaDB on Docker]] and use an image from a Dockerfile that is publicly available, most probably you have an entrypoint that is a Bash script, which starts ##mariadbd## directly. You can edit this Bash script as explained above. Or you can set the ##LD_PRELOAD## variable from the Dockerfile:

&lt;&lt;code&gt;&gt;
ENV LD_PRELOAD=&lt;path-to-library&gt;
&lt;&lt;/code&gt;&gt;

To find the library file you can run one of these commands while the container is running:

&lt;&lt;code&gt;&gt;
# jemalloc
docker exec -ti &lt;container-name&gt; find /usr/lib -name &#34;libjemalloc.so.*&#34;
# tcmalloc
docker exec -ti &lt;container-name&gt; find /usr/lib -name &#34;libtcmalloc.so.*&#34;
&lt;&lt;/code&gt;&gt;

Example:

&lt;&lt;code&gt;&gt;
docker run -P -d --name mariadb --env LD_PRELOAD=&#34;/usr/lib/x86_64-linux-gnu/libjemalloc.so.2&#34; --env MARIADB_ROOT_PASSWORD=Password123! mariadb:latest
&lt;&lt;/code&gt;&gt;

==== Vagrantfile

Usually [[vagrant-and-mariadb|Vagrant]] is used to start a complete system in a virtual machine. If this is your case, you can use one of the methods above, for example you can modify your Vagrantfile to copy a modified version of the ##mariadb.service## file into the guest system to configure systemd.

If you use Vagrant with the Docker provider, you can follow the instructions above to modify the Dockerfile.

=== Finding memory leaks with jemalloc

jemalloc can provide a report of memory leaks at program exit:

&lt;&lt;code&gt;&gt;
MALLOC_CONF=prof_leak:true,lg_prof_sample:0,prof_final:true \
LD_PRELOAD=${JEMALLOC_PATH}/lib/libjemalloc.so.2  path-to-mariadbd
&lt;&lt;/code&gt;&gt;

This will produce something like:
&lt;&lt;code&gt;&gt;
&lt;jemalloc&gt;: Leak summary: 267184 bytes, 473 objects, 20 contexts
&lt;jemalloc&gt;: Run jeprof on &#34;jeprof.19678.0.f.heap&#34; for leak detail
&lt;&lt;/code&gt;&gt;

You can learn more about the memory leaks with jeprof, that is included with jemalloc:
&lt;&lt;code&gt;&gt;
jeprof --show_bytes path-to-mariadbd jeprof.19678.0.f.heap
&lt;&lt;/code&gt;&gt;

You can also generate a PDF call graph of the leak:
&lt;&lt;code&gt;&gt;
jeprof --show_bytes --pdf path-to-mariadbd  jeprof.19678.0.f.heap &gt; /tmp/mariadbd.pdf
&lt;&lt;/code&gt;&gt;

=== See Also
* [[profiling-memory-usage|Profiling memory usage]]
* [[debugging-a-running-server-on-linux|Debugging a running server on Linux]]
* [[https://github.com/jemalloc/jemalloc/wiki/Use-Case:-Leak-Checking|Jemalloc leak checking]]</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/solutions" title="Solutions">Solutions</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">Company</a></h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        
                        
                        <li>
                            <h5><a href="https://mariadb.com/downloads" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>