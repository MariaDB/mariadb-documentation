<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Big DELETEs  - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Big DELETEs " />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/big-deletes/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="How to DELETE lots of rows from a large table" />

    <meta name="description" content="How to DELETE lots of rows from a large table" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/big-deletes/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/big-deletes/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/replication-cluster-multi-master/">High Availability &amp; Performance Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/optimization-and-tuning/">Optimization and Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/query-optimizations/">Query Optimizations</a>
    


    » <a class="node_link crumb" href="/kb/en/big-deletes/">Big DELETEs </a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/big-deletes/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/big-deletes/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/big-deletes/+flag"
                data-flag-url="/kb/en/big-deletes/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/big-deletes/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2016-06-08 15:14">8 years, 7 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2016-06-08 16:44">8 years, 7 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/big-deletes/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/big-deletes/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/big-deletes/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/big-deletes/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Big DELETEs </h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#the-problem" title="The problem">The problem</a></li>

    <li class=""><a href="#why-it-is-a-problem" title="Why it is a problem">Why it is a problem</a></li>

    <li class=""><a href="#innodb-and-undo" title="InnoDB and undo">InnoDB and undo</a></li>

    <li class=""><a href="#partition" title="PARTITION">PARTITION</a></li>

    <li class=""><a href="#deleting-in-chunks" title="Deleting in chunks">Deleting in chunks</a></li>

    <li class=""><a href="#innodb-chunking-recommendation" title="InnoDB chunking recommendation">InnoDB chunking recommendation</a></li>

    <li class=""><a href="#iterating-through-a-compound-key" title="Iterating through a compound key">Iterating through a compound key</a></li>

    <li class=""><a href="#reclaiming-the-disk-space" title="Reclaiming the disk space">Reclaiming the disk space</a></li>

    <li class=""><a href="#deleting-more-than-half-a-table" title="Deleting more than half a table">Deleting more than half a table</a></li>

    <li class=""><a href="#non-deterministic-replication" title="Non-deterministic replication">Non-deterministic replication</a></li>

    <li class=""><a href="#replication-and-kill" title="Replication and KILL">Replication and KILL</a></li>

    <li class=""><a href="#sbr-vs-rbr-galera" title="SBR vs RBR; Galera">SBR vs RBR; Galera</a></li>

    <li class=""><a href="#postlog" title="Postlog">Postlog</a></li>

    <li class=""><a href="#see-also" title="See also">See also</a> </ol>
</li>
</div>
<h2 class="anchored_heading" id="the-problem">The problem</h2>
<p>How to <a href="/kb/en/delete/">DELETE</a> lots of rows from a large table? Here is an example of purging items older than 30 days:</p>
<pre class="fixed"><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">tbl</span> <span class="k">WHERE</span> 
  <span class="n">ts</span> <span class="o">&lt;</span> <span class="k">CURRENT_DATE</span><span class="p">()</span> <span class="o">-</span> <span class="nb">INTERVAL</span> <span class="mi">30</span> <span class="k">DAY</span>
</pre><p>If there are millions of rows in the table, this statement may take minutes, maybe hours.</p>
<p>Any suggestions on how to speed this up?</p>
<h2 class="anchored_heading" id="why-it-is-a-problem">Why it is a problem</h2>
<ul><li><a href="/kb/en/myisam/">MyISAM</a> will lock the table during the entire operation, thereby nothing else can be done with the table.
</li><li><a href="/kb/en/innodb/">InnoDB</a> won't lock the table, but it will chew up a lot of resources, leading to sluggishness.
</li><li>InnoDB has to write the undo information to its transaction logs; this significantly increases the I/O required.
</li><li><a href="/kb/en/replication/">Replication</a>, being asynchronous, will effectively be delayed (on Slaves) while the DELETE is running.
</li></ul>
<h2 class="anchored_heading" id="innodb-and-undo">InnoDB and undo</h2>
<p>To be ready for a crash, a transactional engine such as InnoDB will record what it is doing to a log file. To make that somewhat less costly, the log file is sequentially written. If the log files you have (there are usually 2) fill up because the delete is really big, then the undo information spills into the actual data blocks, leading to even more I/O.</p>
<p>Deleting in chunks avoids some of this excess overhead.</p>
<p>Limited benchmarking of total delete elapsed time show two observations:</p>
<ul><li>Total delete time approximately doubles above some 'chunk' size (as opposed to below that threshold). I do not have a formula relating the log file size with the threshold cutoff.
</li><li>Chunk size below several hundred rows is slower. This is probably because the overhead of starting/ending each chunk dominates the timing.
</li></ul>
<p>Solutions</p>
<ul><li>PARTITION -- Requires some careful setup, but is excellent for purging a time-base series.
</li><li>DELETE in chunks -- Carefully walk through the table N rows at a time.
</li></ul>
<h2 class="anchored_heading" id="partition">PARTITION</h2>
<p>The idea here is to have a sliding window of <a href="/kb/en/managing-mariadb-partitioning/">partitions</a>. Let's say you need to purge news articles after 30 days. The "partition key" would be the <a href="/kb/en/datetime/">datetime</a> (or <a href="/kb/en/timestamp/">timestamp</a>) that is to be used for purging, and the PARTITIONs would be "range". Every night, a cron job would come along and build a new partition for the next day, and drop the oldest partition.</p>
<p>Dropping a partition is essentially instantaneous, much faster than deleting that many rows. However, you must design the table so that the entire partition can be dropped. That is, you cannot have some items living longer than others.</p>
<p>PARTITION tables have a lot of restrictions, some are rather weird. You can either have no UNIQUE (or PRIMARY) key on the table, or every UNIQUE key must include the partition key. In this use case, the partition key is the datetime. It should not be the first part of the PRIMARY KEY (if you have a PRIMARY KEY).</p>
<p>You can PARTITION InnoDB or MyISAM tables.</p>
<p>Since two news articles could have the same timestamp, you cannot assume the partition key is sufficient for uniqueness of the PRIMARY KEY, so you need to find something else to help with that.</p>
<p>Reference implementation for Partition maintenance</p>
<p><a href="/kb/en/managing-mariadb-partitioning/">MariaDB docs on PARTITION</a></p>
<h2 class="anchored_heading" id="deleting-in-chunks">Deleting in chunks</h2>
<p>Although the discussion in this section talks about DELETE, it can be used for any other "chunking", such as, say, UPDATE, or SELECT plus some complex processing.</p>
<p>(This discussion applies to both MyISAM and InnoDB.)</p>
<p>When deleting in chunks, be sure to avoid doing a table scan. The code below is good at that; it scans no more than 1001 rows in any one query. (The 1000 is tunable.)</p>
<p>Assuming you have news articles that need to be purged, and you have a schema something like</p>
<pre class="fixed">   <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tbl</span>
      <span class="n">id</span> <span class="nb">INT</span> <span class="n">UNSIGNED</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
      <span class="n">ts</span> <span class="k">TIMESTAMP</span><span class="p">,</span>
      <span class="p">...</span>
      <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</pre><p>Then, this pseudo-code is a good way to delete the rows older than 30 days:</p>
<pre class="fixed">   @a = 0
   LOOP
      DELETE FROM tbl
         WHERE id BETWEEN @a AND @a+999
           AND ts &lt; DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
      SET @a = @a + 1000
      sleep 1  -- be a nice guy
   UNTIL end of table
</pre><p>Notes (Most of these caveats will be covered later):</p>
<ul><li>It uses the PK instead of the secondary key. This gives much better locality of disk hits, especially for InnoDB.
</li><li>You could (should?) do something to avoid walking through recent days but doing nothing. Caution -- the code for this could be costly.
</li><li>The 1000 should be tweaked so that the DELETE usually takes under, say, one second.
</li><li>No INDEX on ts is needed. (This helps INSERTs a little.)
</li><li>If your PRIMARY KEY is compound, the code gets messier.
</li><li>This code will not work without a numeric PRIMARY or UNIQUE key.
</li><li>Read on, we'll develop messier code to deal with most of these caveats.
</li></ul>
<p>If there are big gaps in `id` values (and there will after the first purge), then</p>
<pre class="fixed">   @a = SELECT MIN(id) FROM tbl
   LOOP
      SELECT @z := id FROM tbl WHERE id &gt;= @a ORDER BY id LIMIT 1000,1
      If @z is null
         exit LOOP  -- last chunk
      DELETE FROM tbl
         WHERE id &gt;= @a
           AND id &lt;  @z
           AND ts &lt; DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
      SET @a = @z
      sleep 1  -- be a nice guy, especially in replication
   ENDLOOP
   # Last chunk:
   DELETE FROM tbl
      WHERE id &gt;= @a
        AND ts &lt; DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
</pre><p>That code works whether id is numeric or character, and it mostly works even if id is not UNIQUE. With a non-unique key, the risk is that you could be caught in a loop whenever @z==@a. That can be detected and fixed thus:</p>
<pre class="fixed">   ...
      SELECT @z := id FROM tbl WHERE id &gt;= @a ORDER BY id LIMIT 1000,1
      If @z == @a
         SELECT @z := id FROM tbl WHERE id &gt; @a ORDER BY id LIMIT 1
   ...
</pre><p>The drawback is that there could be more than 1000 items with a single id. In most practical cases, that is unlikely.</p>
<p>If you do not have a primary (or unique) key defined on the table, and you have an INDEX on ts, then consider</p>
<pre class="fixed">   LOOP
      DELETE FROM tbl
         WHERE ts &lt; DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
         ORDER BY ts   -- to use the index, and to make it deterministic
         LIMIT 1000
   UNTIL no rows deleted
</pre><p>This technique is NOT recommended because the LIMIT leads to a warning on replication about it being non-deterministic (discussed below).</p>
<h2 class="anchored_heading" id="innodb-chunking-recommendation">InnoDB chunking recommendation</h2>
<ul><li>Have a 'reasonable' size for <a href="/kb/en/xtradbinnodb-server-system-variables/#innodb_log_file_size">innodb_log_file_size</a>.
</li><li>Use AUTOCOMMIT=1 for the session doing the deletions.
</li><li>Pick about 1000 rows for the chunk size.
</li><li>Adjust the row count down if asynchronous replication (Statement Based) causes too much delay on the Slaves or hogs the table too much.
</li></ul>
<h2 class="anchored_heading" id="iterating-through-a-compound-key">Iterating through a compound key</h2>
<p>To perform the chunked deletes recommended above, you need a way to walk through the PRIMARY KEY. This can be difficult if the PK has more than one column in it.</p>
<p>To efficiently to do compound 'greater than':</p>
<p>Assume that you left off at ($g, $s) (and have handled that row):</p>
<pre class="fixed">   INDEX(Genus, species)
   SELECT/DELETE ...
      WHERE Genus &gt;= '$g' AND ( species  &gt; '$s' OR Genus &gt; '$g' )
      ORDER BY Genus, species
      LIMIT ...
</pre><p>Addenda: The above AND/OR works well in older versions of MySQL; this works better in MariaDB and newer versions of MySQL:</p>
<pre class="fixed">      WHERE ( Genus = '$g' AND species  &gt; '$s' ) OR Genus &gt; '$g' )
</pre><p>A caution about using @variables for strings. If, instead of '$g', you use @g, you need to be careful to make sure that @g has the same CHARACTER SET and COLLATION as `Genus`, else there could be a charset/collation conversion on the fly that prevents the use of the INDEX. Using the INDEX is vital for performance. It may require a COLLATE clause on SET NAMES and/or the @g in the SELECT.</p>
<h2 class="anchored_heading" id="reclaiming-the-disk-space">Reclaiming the disk space</h2>
<p>This is costly. (Switch to the PARTITION solution if practical.)</p>
<p>MyISAM leaves gaps in the table (.MYD file); <a href="/kb/en/optimize-table/">OPTIMIZE TABLE</a> will reclaim the freed space after a big delete. But it may take a long time and lock the table.</p>
<p>InnoDB is block-structured, organized in a BTree on the PRIMARY KEY. An isolated deleted row leaves a block less full. A lot of deleted rows can lead to coalescing of adjacent blocks. (Blocks are normally 16KB - see <a href="/kb/en/xtradbinnodb-server-system-variables/#innodb_page_size">innodb_page_size</a>.)</p>
<p>In InnoDB, there is no practical way to reclaim the freed space from ibdata1, other than to reuse the freed blocks eventually.</p>
<p>The only option with <a href="/kb/en/xtradbinnodb-server-system-variables/#innodb_file_per_table">innodb_file_per_table = 0</a> is to dump ALL tables, remove ibdata*, restart, and reload. That is rarely worth the effort and time.</p>
<p>InnoDB, even with innodb_file_per_table = 1, won't give space back to the OS, but at least it is only one table to rebuild with. In this case, something like this should work:</p>
<pre class="fixed">   <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">new</span> <span class="k">LIKE</span> <span class="n">main</span><span class="p">;</span>
   <span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">new</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">main</span><span class="p">;</span>  <span class="c1">-- This could take a long time</span>
   <span class="k">RENAME</span> <span class="k">TABLE</span> <span class="n">main</span> <span class="k">TO</span> <span class="k">old</span><span class="p">,</span> <span class="k">new</span> <span class="k">TO</span> <span class="n">main</span><span class="p">;</span>   <span class="c1">-- Atomic swap</span>
   <span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">old</span><span class="p">;</span>   <span class="c1">-- Space freed up here</span>
</pre><p>You do need enough disk space for both copies. You must not write to the table during the process.</p>
<h2 class="anchored_heading" id="deleting-more-than-half-a-table">Deleting more than half a table</h2>
<p>The following technique can be used for any combination of</p>
<ul><li>Deleting a large portion of the table more efficiently
</li><li>Add PARTITIONing
</li><li>Converting to <a href="/kb/en/xtradbinnodb-server-system-variables/#innodb_file_per_table">innodb_file_per_table = ON</a>
</li><li>Defragmenting
</li></ul>
<p>This can be done by chunking, or (if practical) all at once:</p>
<pre class="fixed">   <span class="c1">-- Optional:  SET GLOBAL innodb_file_per_table = ON;</span>
   <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">New</span> <span class="k">LIKE</span> <span class="n">Main</span><span class="p">;</span>
   <span class="c1">-- Optional:  ALTER TABLE New ADD PARTITION BY RANGE ...;</span>
   <span class="c1">-- Do this INSERT..SELECT all at once, or with chunking:</span>
   <span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">New</span>
      <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Main</span>
         <span class="k">WHERE</span> <span class="p">...;</span>  <span class="c1">-- just the rows you want to keep</span>
   <span class="k">RENAME</span> <span class="k">TABLE</span> <span class="n">main</span> <span class="k">TO</span> <span class="k">Old</span><span class="p">,</span> <span class="k">New</span> <span class="k">TO</span> <span class="n">Main</span><span class="p">;</span>
   <span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">Old</span><span class="p">;</span>   <span class="c1">-- Space freed up here</span>
</pre><p>Notes:</p>
<ul><li>You do need enough disk space for both copies.
</li><li>You must not write to the table during the process. (Changes to Main may not be reflected in New.)
</li></ul>
<h2 class="anchored_heading" id="non-deterministic-replication">Non-deterministic replication</h2>
<p>Any UPDATE, DELETE, etc with LIMIT that is replicated to slaves (via <a href="/kb/en/binary-log-formats/">Statement Based Replication</a>) <em>may</em> cause inconsistencies between the Master and Slaves. This is because the actual order of the records discovered for updating/deleting may be different on the slave, thereby leading to a different subset being modified. To be safe, add ORDER BY to such statements. Moreover, be sure the ORDER BY is deterministic -- that is, the fields/expressions in the ORDER BY are unique.</p>
<p>An example of an ORDER BY that does not quite work: Assume there are multiple rows for each 'date':</p>
<pre class="fixed">   <span class="k">DELETE</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">tbl</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">date</span> <span class="k">LIMIT</span> <span class="mi">111</span>
</pre><p>Given that id is the PRIMARY KEY (or UNIQUE), this will be safe:</p>
<pre class="fixed">   <span class="k">DELETE</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">tbl</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">,</span> <span class="n">id</span> <span class="k">LIMIT</span> <span class="mi">111</span>
</pre><p>Unfortunately, even with the ORDER BY, MySQL has a deficiency that leads to a bogus warning in mysqld.err. See Spurious "Statement is not safe to log in statement format." warnings</p>
<p>Some of the above code avoids this spurious warning by doing</p>
<pre class="fixed">   <span class="k">SELECT</span> <span class="o">@</span><span class="n">z</span> <span class="p">:</span><span class="o">=</span> <span class="p">...</span> <span class="k">LIMIT</span> <span class="mi">1000</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">-- not replicated</span>
   <span class="k">DELETE</span> <span class="p">...</span> <span class="k">BETWEEN</span> <span class="o">@</span><span class="n">a</span> <span class="k">AND</span> <span class="o">@</span><span class="n">z</span><span class="p">;</span>   <span class="c1">-- deterministic</span>
</pre><p>That pair of statements guarantees no more than 1000 rows are touched, not the whole table.</p>
<h2 class="anchored_heading" id="replication-and-kill">Replication and KILL</h2>
<p>If you KILL a DELETE (or any? query) on the master in the middle of its execution, what will be replicated?</p>
<p>If it is InnoDB, the query should be rolled back. (Exceptions??)</p>
<p>In MyISAM, rows are DELETEd as the statement is executed, and there is no provision for ROLLBACK. Some of the rows will be deleted, some won't. You probably have no clue of how much was deleted. In a single server, simply run the delete again. The delete is put into the binlog, but with error 1317. Since replication is supposed to keep the master and slave in sync, and since it has no clue of how to do that, replication stops and waits for manual intervention. In a HA (High Available) system using replication, this is a minor disaster. Meanwhile, you need to go to each slave(s) and verify that it is stuck for this reason, then do</p>
<pre class="fixed">   <span class="k">SET</span> <span class="k">GLOBAL</span> <span class="n">SQL_SLAVE_SKIP_COUNTER</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">START</span> <span class="n">SLAVE</span><span class="p">;</span>
</pre><p>Then (presumably) re-executing the DELETE will finish the aborted task.</p>
<p>(That is yet another reason to move all your tables <a href="/kb/en/converting-tables-from-myisam-to-innodb/">from MyISAM to InnoDB</a>.)</p>
<h2 class="anchored_heading" id="sbr-vs-rbr-galera">SBR vs RBR; Galera</h2>
<p>TBD -- "Row Based Replication" may impact this discussion.</p>
<h2 class="anchored_heading" id="postlog">Postlog</h2>
<p>The tips in this document apply to MySQL, MariaDB, and Percona. </p>
<h2 class="anchored_heading" id="see-also">See also</h2>
<p>Rick James graciously allowed us to use this article in the Knowledge Base.</p>
<p><a href="http://mysql.rjweb.org/">Rick James' site</a> has other useful tips, how-tos,
optimizations, and debugging tips.</p>
<p>
Original source: <a href="http://mysql.rjweb.org/doc.php/deletebig">http://mysql.rjweb.org/doc.php/deletebig</a></p>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/big-deletes/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/big-deletes/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/partition-pruning-and-selection/">
                        ← Partition Pruning and Selection
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/query-optimizations/">
                        ↑ Query Optimizations ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/charset-narrowing-optimization/">
                        Charset Narrowing Optimization →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="5678" data-comments-url="/kb/en/big-deletes/+comments"
         data-reply-url="/kb/en/big-deletes/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/query-optimizations/">
                    ↑ Query Optimizations ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/index-hints-how-to-force-query-plans/">
                            
                            Index Hints: How to Force Query Plans
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/subquery-optimizations/">
                            
                            Subquery Optimizations
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimization-strategies/">
                            
                            Optimization Strategies
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizations-for-derived-tables/">
                            
                            Optimizations for Derived Tables
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/table-elimination/">
                            
                            Table Elimination
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/statistics-for-optimizing-queries/">
                            
                            Statistics for Optimizing Queries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/filesort-with-small-limit-optimization/">
                            
                            Filesort with Small LIMIT Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/limit-rows-examined/">
                            
                            LIMIT ROWS EXAMINED
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/index_merge-sort_intersection/">
                            
                            index_merge sort_intersection
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-53-optimizer-debugging/">
                            
                            MariaDB 5.3 Optimizer Debugging
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer-switch/">
                            
                            optimizer_switch
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/how-to-quickly-insert-data-into-mariadb/">
                            
                            How to Quickly Insert Data Into MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/index-condition-pushdown/">
                            
                            Index Condition Pushdown
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/query-limits-and-timeouts/">
                            
                            Query Limits and Timeouts
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/aborting-statements/">
                            
                            Aborting Statements that Exceed a Certain Time to Execute
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/partition-pruning-and-selection/">
                            <span class="pull-right not_primary"></span>
                            Partition Pruning and Selection
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Big DELETEs </span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/charset-narrowing-optimization/">
                            
                            Charset Narrowing Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-sampling-techniques-for-efficiently-finding-a-random-row/">
                            
                            Data Sampling: Techniques for Efficiently Finding a Random Row
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-high-speed-ingestion/">
                            
                            Data Warehousing High Speed Ingestion
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-summary-tables/">
                            
                            Data Warehousing Summary Tables
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-techniques/">
                            
                            Data Warehousing Techniques
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/query-optimizations-distinct-removal-in-aggregate-functions/">
                            
                            DISTINCT removal in aggregate functions
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/equality-propagation-optimization/">
                            
                            Equality propagation optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/force-index/">
                            
                            FORCE INDEX
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/groupwise-max-in-mariadb/">
                            
                            Groupwise Max in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/guiduuid-performance/">
                            
                            GUID/UUID Performance
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/hash_join_cardinality-optimizer_switch-flag/">
                            
                            hash_join_cardinality optimizer_switch Flag
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/ignore-index/">
                            
                            IGNORE INDEX
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/not_null_range_scan-optimization/">
                            
                            not_null_range_scan Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer_adjust_secondary_key_costs/">
                            
                            optimizer_adjust_secondary_key_costs
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer_join_limit_pref_ratio-optimization/">
                            
                            optimizer_join_limit_pref_ratio optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizing-for-latest-news-style-queries/">
                            
                            Optimizing for &#34;Latest News&#34;-style Queries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pagination-optimization/">
                            
                            Pagination Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pivoting-in-mariadb/">
                            
                            Pivoting in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rollup-unique-user-counts/">
                            
                            Rollup Unique User Counts
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rowid-filtering-optimization/">
                            
                            Rowid Filtering Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sargable-date-and-year/">
                            
                            Sargable DATE and YEAR
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sargable-upper/">
                            
                            Sargable UPPER
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/use-index/">
                            
                            USE INDEX
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>