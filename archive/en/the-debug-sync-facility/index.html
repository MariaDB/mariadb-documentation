<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>The Debug Sync Facility - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="The Debug Sync Facility" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/the-debug-sync-facility/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="DEBUG_SYNC synchronization points in server code" />

    <meta name="description" content="DEBUG_SYNC synchronization points in server code" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/the-debug-sync-facility/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/the-debug-sync-facility/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/using-mariadb-server/">Using MariaDB Server</a>
    

    
    » <a class="crumb" href="/kb/en/clients-utilities/">Clients &amp; Utilities</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-test/">mariadb-test</a>
    


    » <a class="node_link crumb" href="/kb/en/the-debug-sync-facility/">The Debug Sync Facility</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/the-debug-sync-facility/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/the-debug-sync-facility/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/the-debug-sync-facility/+flag"
                data-flag-url="/kb/en/the-debug-sync-facility/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/the-debug-sync-facility/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2014-03-02 10:06">10 years, 9 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2023-07-03 12:05">1 year, 5 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/the-debug-sync-facility/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/the-debug-sync-facility/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/the-debug-sync-facility/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/the-debug-sync-facility/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>The Debug Sync Facility</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
    <ol class="toc">

        <li class=""><a href="#formal-syntax" title="Formal Syntax">Formal Syntax</a></li>

        <li class=""><a href="#activationdeactivation" title="Activation/Deactivation">Activation/Deactivation</a></li>

        <li class=""><a href="#implementation" title="Implementation">Implementation</a></li>

        <li class=""><a href="#a-typical-synchronization-pattern" title="A typical synchronization pattern">A typical synchronization pattern</a></li>

        <li class=""><a href="#co-work-with-the-dbug-facility" title="Co-work with the DBUG facility">Co-work with the DBUG facility</a></li>

        <li class=""><a href="#synchronizing-debug_sync-actions" title="Synchronizing DEBUG_SYNC Actions">Synchronizing DEBUG_SYNC Actions</a>    </ol>
 </ol>
</li>
</div><p>
The Debug Sync Facility allows placement of synchronization points in
the server code by using the DEBUG_SYNC macro:</p>
<pre class="fixed">open_tables(...)

DEBUG_SYNC(thd, &#34;after_open_tables&#34;);

lock_tables(...)
</pre><p>When activated, a sync point can</p>
<ul start="1"><li>Emit a signal and/or
</li><li>Wait for a signal
</li></ul>
<div class="cstm-style darkheader-nospace-borders"><table><tr><th>Nomenclature</th><th>Description</th></tr>
<tr><td>signal</td><td>A value of a global variable that persists until overwritten by a new signal. The global variable can also be seen as a "signal post" or "flag mast". Then the signal is what is attached to the "signal post" or "flag mast".</td></tr>
<tr><td>emit a signal</td><td>Assign the value (the signal) to the global variable ("set a flag") and broadcast a global condition to wake those waiting for a signal.</td></tr>
<tr><td>wait for a signal</td><td>Loop over waiting for the global condition until the global value matches the wait-for signal.</td></tr>
</table>
</div><p>By default, all sync points are inactive. They do nothing (except to
burn a couple of CPU cycles for checking if they are active).</p>
<p>A sync point becomes active when an action is requested for it.
To do so, put a line like this in the test case file:</p>
<pre class="fixed">SET DEBUG_SYNC= 'after_open_tables SIGNAL opened WAIT_FOR flushed';
</pre><p>This activates the sync point
<code class="highlight fixed" style="white-space:pre-wrap">'after_open_tables'</code>. It requests it to emit the
signal <code class="highlight fixed" style="white-space:pre-wrap">'opened'</code> and wait for another thread to emit
the signal <code class="highlight fixed" style="white-space:pre-wrap">'flushed'</code> when the thread's execution
runs through the sync point.</p>
<p>For every sync point there can be one action per thread only. Every
thread can request multiple actions, but only one per sync point. In
other words, a thread can activate multiple sync points.</p>
<p>Here is an example how to activate and use the sync points:</p>
<pre class="fixed">--connection conn1
SET DEBUG_SYNC= 'after_open_tables SIGNAL opened WAIT_FOR flushed';
send INSERT INTO t1 VALUES(1);
    --connection conn2
    SET DEBUG_SYNC= 'now WAIT_FOR opened';
    SET DEBUG_SYNC= 'after_abort_locks SIGNAL flushed';
    FLUSH TABLE t1;
</pre><p>When <code class="highlight fixed" style="white-space:pre-wrap">conn1</code> runs through the
<code class="highlight fixed" style="white-space:pre-wrap">INSERT</code> statement, it hits the sync point
<code class="highlight fixed" style="white-space:pre-wrap">'after_open_tables'</code>. It notices that it is active
and executes its action. It emits the signal
<code class="highlight fixed" style="white-space:pre-wrap">'opened'</code> and waits for another thread to emit the
signal <code class="highlight fixed" style="white-space:pre-wrap">'flushed'</code>.</p>
<p><code class="highlight fixed" style="white-space:pre-wrap">conn2</code> waits immediately at the special sync point <code class="highlight fixed" style="white-space:pre-wrap">'now'</code> for another thread to emit the <code class="highlight fixed" style="white-space:pre-wrap">'opened'</code> signal.</p>
<p>A signal remains in effect until it is overwritten. If
<code class="highlight fixed" style="white-space:pre-wrap">conn1</code> signals <code class="highlight fixed" style="white-space:pre-wrap">'opened'</code> before
<code class="highlight fixed" style="white-space:pre-wrap">conn2</code> reaches <code class="highlight fixed" style="white-space:pre-wrap">'now'</code>,
<code class="highlight fixed" style="white-space:pre-wrap">conn2</code> will still find the
<code class="highlight fixed" style="white-space:pre-wrap">'opened'</code> signal. It does not wait in this case.</p>
<p>When <code class="highlight fixed" style="white-space:pre-wrap">conn2</code> reaches <code class="highlight fixed" style="white-space:pre-wrap">'after_abort_locks'</code>, it signals <code class="highlight fixed" style="white-space:pre-wrap">'flushed'</code>, which lets <code class="highlight fixed" style="white-space:pre-wrap">conn1</code> awake.</p>
<p>Normally the activation of a sync point is cleared when it has been
executed. Sometimes it is necessary to keep the sync point active for
another execution. You can add an execute count to the action:</p>
<pre class="fixed">SET DEBUG_SYNC= 'name SIGNAL sig EXECUTE 3';
</pre><p>This sets the signal point's activation counter to 3. Each execution
decrements the counter. After the third execution the sync point
becomes inactive.</p>
<p>One of the primary goals of this facility is to eliminate sleeps from
the test suite. In most cases it should be possible to rewrite test
cases so that they do not need to sleep. (But this facility cannot
synchronize multiple processes.) However, to support test development,
and as a last resort, sync point waiting times out. There is a default
timeout, but it can be overridden:</p>
<pre class="fixed">SET DEBUG_SYNC= 'name WAIT_FOR sig TIMEOUT 10 EXECUTE 2';
</pre><p><code class="highlight fixed" style="white-space:pre-wrap">TIMEOUT 0</code> is special: If the signal is not present,
the wait times out immediately.</p>
<p>When a wait timed out (even on <code class="highlight fixed" style="white-space:pre-wrap">TIMEOUT 0</code>), a
warning is generated so that it shows up in the test result.</p>
<p>You can throw an error message and kill the query when a synchronization
point is hit a certain number of times:</p>
<pre class="fixed">SET DEBUG_SYNC= 'name HIT_LIMIT 3';
</pre><p>Or combine it with signal and/or wait:</p>
<pre class="fixed">SET DEBUG_SYNC= 'name SIGNAL sig EXECUTE 2 HIT_LIMIT 3';
</pre><p>Here the first two hits emit the signal, the third hit returns the error
message and kills the query.</p>
<p>For cases where you are not sure that an action is taken and thus
cleared in any case, you can force to clear (deactivate) a sync point:</p>
<pre class="fixed">SET DEBUG_SYNC= 'name CLEAR';
</pre><p>If you want to clear all actions and clear the global signal, use:</p>
<pre class="fixed">SET DEBUG_SYNC= 'RESET';
</pre><p>This is the only way to reset the global signal to an empty string.</p>
<p>For testing of the facility itself you can execute a sync point just
as if it had been hit:</p>
<pre class="fixed">SET DEBUG_SYNC= 'name TEST';
</pre><h3 class="anchored_heading" id="formal-syntax">Formal Syntax</h3>
<p>The string to "assign" to the DEBUG_SYNC variable can contain:</p>
<pre class="fixed">RESET |
&lt;sync point name&gt; TEST |
&lt;sync point name&gt; CLEAR |
&lt;sync point name&gt; {{SIGNAL &lt;signal name&gt; |
                   WAIT_FOR &lt;signal name&gt; [TIMEOUT &lt;seconds&gt;]}
                   [EXECUTE &lt;count&gt;] &amp;| HIT_LIMIT &lt;count&gt;}
</pre><p>Here '&amp;|' means 'and/or'. This means that one of the sections
separated by '&amp;|' must be present or both of them.</p>
<h3 class="anchored_heading" id="activationdeactivation">Activation/Deactivation</h3>
<p>With a <a href="/kb/en/compiling-mariadb-for-debugging/">MariaDB for debug build</a>, it can be enabled by a mysqld command line option:</p>
<pre class="fixed"> --debug-sync-timeout[=default_wait_timeout_value_in_seconds]
</pre><p><code class="highlight fixed" style="white-space:pre-wrap">'default_wait_timeout_value_in_seconds'</code> is the default timeout for the <code class="highlight fixed" style="white-space:pre-wrap">WAIT_FOR</code> action. If set to zero, the facility stays disabled.</p>
<p>The facility is enabled by default in the test suite, but can be
disabled with:</p>
<pre class="fixed">mariadb-test-run.pl ... --debug-sync-timeout=0 ...
</pre><p>Likewise the default wait timeout can be set:</p>
<pre class="fixed">mariadb-test-run.pl ... --debug-sync-timeout=10 ...
</pre><p>The command line option influences the readable value of the <a href="/kb/en/server-system-variables/#debug_sync">debug_sync</a> system variable.</p>
<ul start="1"><li>If the facility is not compiled in, the system variable does not exist.
</li></ul>
<ul start="1"><li>If <code class="highlight fixed" style="white-space:pre-wrap">--debug-sync-timeout=0</code> the value of the variable reads as <code class="highlight fixed" style="white-space:pre-wrap">"OFF"</code>.
</li></ul>
<ul start="1"><li>Otherwise the value reads as <code class="highlight fixed" style="white-space:pre-wrap">"ON - current signal: "</code> followed by the current signal string, which can be empty.
</li></ul>
<p>The readable variable value is the same, regardless if read as a global
or session value.</p>
<p>Setting the <a href="/kb/en/server-system-variables/#debug_sync">debug_sync</a>  system variable requires the <code class="highlight fixed" style="white-space:pre-wrap">'SUPER'</code> privilege.  You can never read back the
string that you assigned to the variable, unless you assign the value
that the variable already has. But that would give a parse
error. A syntactically correct string is parsed into a debug sync
action and stored apart from the variable value.</p>
<h3 class="anchored_heading" id="implementation">Implementation</h3>
<p>Pseudo code for a sync point:</p>
<pre class="fixed">#define DEBUG_SYNC(thd, sync_point_name)
        if (unlikely(opt_debug_sync_timeout))
          debug_sync(thd, STRING_WITH_LEN(sync_point_name))
</pre><p>The sync point performs a binary search in a sorted array of actions
for this thread.</p>
<p>The <code class="highlight fixed" style="white-space:pre-wrap">SET DEBUG_SYNC</code> statement adds a requested
action to the array or overwrites an existing action for the same sync
point. When it adds a new action, the array is sorted again.</p>
<h3 class="anchored_heading" id="a-typical-synchronization-pattern">A typical synchronization pattern</h3>
<p>There are quite a few places in MariaDB and MySQL where we use a
synchronization pattern like this:</p>
<pre class="fixed">mysql_mutex_lock(&amp;mutex);
thd-&gt;enter_cond(&amp;condition_variable, &amp;mutex, new_message);
#if defined(ENABLE_DEBUG_SYNC)
if (!thd-&gt;killed &amp;&amp; !end_of_wait_condition)
   DEBUG_SYNC(thd, &#34;sync_point_name&#34;);
#endif
while (!thd-&gt;killed &amp;&amp; !end_of_wait_condition)
  mysql_cond_wait(&amp;condition_variable, &amp;mutex);
thd-&gt;exit_cond(old_message);
</pre><p>Here are some explanations:</p>
<p><code class="highlight fixed" style="white-space:pre-wrap">thd-&gt;enter_cond()</code> is used to register the condition
variable and the mutex in <code class="highlight fixed" style="white-space:pre-wrap">thd-&gt;mysys_var</code>. This is
done to allow the thread to be interrupted (killed) from its
sleep. Another thread can find the condition variable to signal and
mutex to use for synchronization in this thread's <code class="highlight fixed" style="white-space:pre-wrap">THD::mysys_var</code>.</p>
<p><code class="highlight fixed" style="white-space:pre-wrap">thd-&gt;enter_cond()</code> requires the mutex to be acquired
in advance.</p>
<p><code class="highlight fixed" style="white-space:pre-wrap">thd-&gt;exit_cond()</code> unregisters the condition variable
and mutex and releases the mutex.</p>
<p>If you want to have a Debug Sync point with the wait, please place it
behind <code class="highlight fixed" style="white-space:pre-wrap">enter_cond()</code>. Only then you can safely
decide, if the wait will be taken. Also you will have
<code class="highlight fixed" style="white-space:pre-wrap">THD::proc_info</code> correct when the sync point emits a
signal. <code class="highlight fixed" style="white-space:pre-wrap">DEBUG_SYNC</code> sets its own proc_info, but
restores the previous one before releasing its internal mutex. As soon
as another thread sees the signal, it does also see the proc_info from
before entering the sync point. In this case it will be "new_message",
which is associated with the wait that is to be synchronized.</p>
<p>In the example above, the wait condition is repeated before the sync
point. This is done to skip the sync point, if no wait takes place.
The sync point is before the loop (not inside the loop) to have it hit
once only. It is possible that the condition variable is signaled
multiple times without the wait condition to be true.</p>
<p>A bit off-topic: At some places, the loop is taken around the whole
synchronization pattern:</p>
<pre class="fixed">while (!thd-&gt;killed &amp;&amp; !end_of_wait_condition)
{
  mysql_mutex_lock(&amp;mutex);
  thd-&gt;enter_cond(&amp;condition_variable, &amp;mutex, new_message);
  if (!thd-&gt;killed [&amp;&amp; !end_of_wait_condition])
  {
    [DEBUG_SYNC(thd, &#34;sync_point_name&#34;);]
    mysql_cond_wait(&amp;condition_variable, &amp;mutex);
  }
  thd-&gt;exit_cond(old_message);
}
</pre><p>Note that it is important to repeat the test for thd-&gt;killed after
<code class="highlight fixed" style="white-space:pre-wrap">enter_cond()</code>. Otherwise the killing thread may kill
this thread after it tested <code class="highlight fixed" style="white-space:pre-wrap">thd-&gt;killed</code> in the loop
condition and before it registered the condition variable and mutex in
<code class="highlight fixed" style="white-space:pre-wrap">enter_cond()</code>. In this case, the killing thread does
not know that this thread is going to wait on a condition variable. It
would just set <code class="highlight fixed" style="white-space:pre-wrap">THD::killed</code>. But if we would not
test it again, we would go asleep though we are killed. If the killing
thread would kill us when we are after the second test, but still
before sleeping, we hold the mutex, which is registered in mysys_var.
The killing thread would try to acquire the mutex before signaling the
condition variable. Since the mutex is only released implicitly in
<code class="highlight fixed" style="white-space:pre-wrap">mysql_cond_wait()</code>, the signaling happens at the
right place. We have a safe synchronization.</p>
<h3 class="anchored_heading" id="co-work-with-the-dbug-facility">Co-work with the DBUG facility</h3>
<p>When running the MariaDB test suite with the
<code class="highlight fixed" style="white-space:pre-wrap">--debug-dbug</code> command line option, the Debug Sync
Facility writes trace messages to the DBUG trace. The following shell
commands proved very useful in extracting relevant information:</p>
<pre class="fixed">egrep 'query:|debug_sync_exec:' mysql-test/var/log/mysqld.1.trace
</pre><p>It shows all executed SQL statements and all actions executed by
synchronization points.</p>
<p>Sometimes it is also useful to see, which synchronization points have
been run through (hit) with or without executing actions. Then add
<code class="highlight fixed" style="white-space:pre-wrap">"|debug_sync_point:"</code> to the egrep pattern.</p>
<h3 class="anchored_heading" id="synchronizing-debug_sync-actions">Synchronizing DEBUG_SYNC Actions</h3>
<p>Tests may need additional synchronization mechanisms between
<code class="highlight fixed" style="white-space:pre-wrap">DEBUG_SYNC</code> actions, because certain combinations
of actions can result in lost signals. More specifically, once a
<code class="highlight fixed" style="white-space:pre-wrap">SIGNAL</code> action is issued, it is stored in a global variable
for any waiting threads to determine if they are depending on that signal for
continuing. However, if a subsequent action overwrites that variable before a
waiting thread is able to check against it, the original signal is lost. Examples
of actions which would change the variable state are another
<code class="highlight fixed" style="white-space:pre-wrap">SIGNAL</code> or a <code class="highlight fixed" style="white-space:pre-wrap">RESET</code>. Therefore,
before issuing these commands, the test writer should verify the previous
signal has been acknowledged. The following code snippets show an
example of a problematic pattern and a potential solution.</p>
<pre class="fixed wrap">SET DEBUG_SYNC='now SIGNAL sig';
SET DEBUG_SYNC='RESET'; # Problematic because sig can be cleared before a waiting thread can acknowledge it
</pre><pre class="fixed wrap">SET DEBUG_SYNC='now SIGNAL sig';

# Don't issue the RESET until we have proven the waiting thread has received the signal
let $wait_condition= select count(*)=0 from information_schema.processlist where state like &#34;debug sync point%&#34;;
source include/wait_condition.inc;

SET DEBUG_SYNC='RESET'; # Now this is safe
</pre>
    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/the-debug-sync-facility/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/the-debug-sync-facility/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/debugging-mariadb-with-a-debugger/">
                        ← Debugging MariaDB With a Debugger
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/mariadb-test/">
                        ↑ mariadb-test ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/dgcov/">
                        Code Coverage with dgcov →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="4297" data-comments-url="/kb/en/the-debug-sync-facility/+comments"
         data-reply-url="/kb/en/the-debug-sync-facility/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/mariadb-test/">
                    ↑ mariadb-test ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/mariadb-test-overview/">
                            
                            mariadb-test Overview
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-test-auxiliary-files/">
                            
                            mariadb-test Auxiliary Files
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-test-run-pl-options/">
                            
                            mariadb-test-run.pl Options
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pausing-mariadb-test-run-pl/">
                            
                            Pausing mariadb-test-run.pl
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-test-and-mariadb-test-embedded/">
                            <span class="pull-right not_primary"></span>
                            mariadb-test and mariadb-test-embedded
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/new-features-for-mysqltest-in-mariadb/">
                            
                            New Features for mysqltest in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/debugging-mariadb-with-a-debugger/">
                            <span class="pull-right not_primary"></span>
                            Debugging MariaDB With a Debugger
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>The Debug Sync Facility</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/dgcov/">
                            <span class="pull-right not_primary"></span>
                            Code Coverage with dgcov
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/installing-minio-for-usage-with-mariadb-test-run/">
                            
                            Installing MinIO for Usage With mariadb-test-run
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>