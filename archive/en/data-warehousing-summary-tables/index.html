<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Data Warehousing Summary Tables - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Data Warehousing Summary Tables" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/data-warehousing-summary-tables/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Creation and maintenance of summary tables" />

    <meta name="description" content="Creation and maintenance of summary tables" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/data-warehousing-summary-tables/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/data-warehousing-summary-tables/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/replication-cluster-multi-master/">High Availability &amp; Performance Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/optimization-and-tuning/">Optimization and Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/query-optimizations/">Query Optimizations</a>
    


    » <a class="node_link crumb" href="/kb/en/data-warehousing-summary-tables/">Data Warehousing Summary Tables</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/data-warehousing-summary-tables/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/data-warehousing-summary-tables/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/data-warehousing-summary-tables/+flag"
                data-flag-url="/kb/en/data-warehousing-summary-tables/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/data-warehousing-summary-tables/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2016-06-09 09:15">8 years, 5 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2016-12-03 00:51">8 years ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/data-warehousing-summary-tables/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/data-warehousing-summary-tables/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/data-warehousing-summary-tables/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/data-warehousing-summary-tables/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Data Warehousing Summary Tables</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#preface" title="Preface">Preface</a></li>

    <li class=""><a href="#summary-tables-for-data-warehouse-reports" title="Summary tables for data warehouse &quot;reports&quot;">Summary tables for data warehouse &quot;reports&quot;</a></li>

    <li class=""><a href="#general-structure-of-a-summary-table" title="General structure of a summary table">General structure of a summary table</a></li>

    <li class=""><a href="#example" title="Example">Example</a></li>

    <li class=""><a href="#when-to-augment-the-summary-tables" title="When to augment the summary table(s)?">When to augment the summary table(s)?</a></li>

    <li class=""><a href="#summarizing-while-inserting-one-row-at-a-time" title="Summarizing while Inserting (one row at a time)">Summarizing while Inserting (one row at a time)</a></li>

    <li class=""><a href="#summarizing-periodically-vs-as-needed" title="Summarizing periodically vs as-needed">Summarizing periodically vs as-needed</a></li>

    <li class=""><a href="#summarizing-while-batch-inserting" title="Summarizing while batch inserting">Summarizing while batch inserting</a></li>

    <li class=""><a href="#summarizing-when-using-a-staging-table" title="Summarizing when using a staging table">Summarizing when using a staging table</a></li>

    <li class=""><a href="#summary-table-pk-or-not" title="Summary table: PK or not?">Summary table: PK or not?</a></li>

    <li class=""><a href="#averages-etc" title="Averages, etc.">Averages, etc.</a></li>

    <li class=""><a href="#staging-table" title="Staging table">Staging table</a></li>

    <li class=""><a href="#extreme-design" title="Extreme design">Extreme design</a></li>

    <li class=""><a href="#left-off" title="&quot;Left Off&quot;">&quot;Left Off&quot;</a></li>

    <li class=""><a href="#flip-flop-staging" title="Flip-flop staging">Flip-flop staging</a></li>

    <li class=""><a href="#multiple-summary-tables" title="Multiple summary tables">Multiple summary tables</a></li>

    <li class=""><a href="#games-on-summary-tables" title="Games on summary tables">Games on summary tables</a></li>

    <li class=""><a href="#see-also" title="See also">See also</a> </ol>
</li>
</div>
<h2 class="anchored_heading" id="preface">Preface</h2>
<p>This document discusses the creation and maintenance of "Summary Tables". It is a companion to the document on <a href="/kb/en/data-warehousing-techniques/">Data Warehousing Techniques</a>.</p>
<p>The basic terminology ("Fact Table", "<a href="/kb/en/database-normalization/">Normalization</a>", etc) is covered in that document.</p>
<h2 class="anchored_heading" id="summary-tables-for-data-warehouse-reports">Summary tables for data warehouse "reports"</h2>
<p>Summary tables are a performance necessity for large tables. MariaDB and MySQL do not provide any automated way to create such, so I am providing techniques here.</p>
<p>(Other vendors provide something similar with "materialized views".)</p>
<p>When you have millions or billions of rows, it takes a long time to summarize the data to present counts, totals, averages, etc, in a size that is readily digestible by humans. By computing and saving subtotals as the data comes in, one can make "reports" run much faster. (I have seen 10x to 1000x speedups.) The subtotals go into a "summary table". This document guides you on efficiency in both creating and using such tables.</p>
<h2 class="anchored_heading" id="general-structure-of-a-summary-table">General structure of a summary table</h2>
<p>A summary table includes two sets of columns:</p>
<ul><li>Main KEY: date + some dimension(s)
</li><li>Subtotals: COUNT(*), SUM(...), ...; but not AVG()
</li></ul>
<p>The "date" might be a DATE (a 3-byte native datatype), or an hour, or some other time interval. A 3-byte MEDIUMINT UNSIGNED 'hour' can be derived from a DATETIME or TIMESTAMP via</p>
<pre class="fixed">   FLOOR(UNIX_TIMESTAMP(dt) / 3600)
   FROM_UNIXTIME(hour * 3600)
</pre><p>The "dimensions" (a DW term) are some of the columns of the "Fact" table. Examples: Country, Make, Product, Category, Host Non-dimension examples: Sales, Quantity, TimeSpent</p>
<p>There would be one or more indexes, usually starting with some dimensions and ending with the date field.   By ending with the date, one can efficiently get a range of days/weeks/etc. even when each row summarizes only one day.</p>
<p>There will typically be a "few" summary tables. Often one summary table can serve multiple purposes sufficiently efficiently.</p>
<p>As a rule of thumb, a summary table will have one-tenth the number of rows as the Fact table. (This number is very loose.)</p>
<h2 class="anchored_heading" id="example">Example</h2>
<p>Let's talk about a large chain of car dealerships.
The Fact table has all the sales with columns such as
datetime, salesman_id, city, price, customer_id, make, model, model_year.
One Summary table might focus on sales:</p>
<pre class="fixed">   <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="n">datetime</span><span class="p">),</span>
   <span class="n">Aggregations</span><span class="p">:</span> <span class="n">ct</span><span class="p">,</span> <span class="n">sum_price</span>
   
   <span class="o">#</span> <span class="n">Core</span> <span class="k">of</span> <span class="k">INSERT</span><span class="p">..</span><span class="k">SELECT</span><span class="p">:</span>
   <span class="nb">DATE</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ct</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sum_price</span>
   
   <span class="o">#</span> <span class="n">Reporting</span> <span class="n">average</span> <span class="n">price</span> <span class="k">for</span> <span class="k">last</span> <span class="k">month</span><span class="p">,</span> <span class="n">broken</span> <span class="n">down</span> <span class="k">by</span> <span class="n">city</span><span class="p">:</span>
   <span class="k">SELECT</span> <span class="n">city</span><span class="p">,</span>
          <span class="k">SUM</span><span class="p">(</span><span class="n">sum_price</span><span class="p">)</span> <span class="o">/</span> <span class="k">SUM</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="k">AS</span> <span class="s1">&#39;AveragePrice&#39;</span>
      <span class="k">FROM</span> <span class="n">SalesSummary</span>
      <span class="k">WHERE</span> <span class="n">datetime</span> <span class="k">BETWEEN</span> <span class="p">...</span>
      <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">city</span><span class="p">;</span>
   
   <span class="o">#</span> <span class="n">Monthly</span> <span class="n">sales</span><span class="p">,</span> <span class="n">nationwide</span><span class="p">,</span> <span class="k">from</span> <span class="n">same</span> <span class="n">summary</span> <span class="k">table</span><span class="p">:</span>
   <span class="k">SELECT</span> <span class="k">MONTH</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span> <span class="k">AS</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span>
          <span class="k">SUM</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>         <span class="k">AS</span> <span class="s1">&#39;TotalSalesCount&#39;</span>
          <span class="k">SUM</span><span class="p">(</span><span class="n">sum_price</span><span class="p">)</span>  <span class="k">AS</span> <span class="s1">&#39;TotalDollars&#39;</span>
      <span class="k">FROM</span> <span class="n">SalesSummary</span>
      <span class="k">WHERE</span> <span class="n">datetime</span> <span class="k">BETWEEN</span> <span class="p">...</span>
      <span class="k">GROUP</span> <span class="k">BY</span> <span class="k">MONTH</span><span class="p">(</span><span class="n">datetime</span><span class="p">);</span>
   <span class="o">#</span> <span class="n">This</span> <span class="n">might</span> <span class="n">benefit</span> <span class="k">from</span> <span class="n">a</span> <span class="n">secondary</span> <span class="k">INDEX</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
</pre><h2 class="anchored_heading" id="when-to-augment-the-summary-tables">When to augment the summary table(s)?</h2>
<p>"Augment" in this section means to add new rows into the summary table or increment the counts in existing rows.</p>
<p>Plan A: "While inserting" rows into the Fact table, augment the summary table(s). This is simple, and workable for a smaller DW database (under 10 Fact table rows per second). For larger DW databases, Plan A likely to be too costly to be practical.</p>
<p>Plan B: "Periodically", via cron or an EVENT.</p>
<p>Plan C: "As needed". That is, when someone asks for a report, the code first updates the summary tables that will be needed.</p>
<p>Plan D: "Hybrid" of B and C. C, by itself, can led to long delays for the report. By also doing B, those delays can be kept low.</p>
<p>Plan E: (This is not advised.) "Rebuild" the entire summary table from the entire Fact table. The cost of this is prohibitive for large tables. However, Plan E may be needed when you decide to change the columns of a Summary Table, or discover a flaw in the computations.
To lessen the impact of an entire build, adapt the chunking techniques in
<a href="/kb/en/big-deletes/#deleting_in_chunks">Deleting in chunks</a> .</p>
<p>Plan F: "Staging table". This is primarily for very high speed ingestion. It is mentioned briefly in this blog, and discussed more thoroughly in the companion blog: High Speed Ingestion</p>
<h2 class="anchored_heading" id="summarizing-while-inserting-one-row-at-a-time">Summarizing while Inserting (one row at a time)</h2>
<pre class="fixed">    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Fact</span> <span class="p">...;</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Summary</span> <span class="p">(...,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="p">...)</span> <span class="k">VALUES</span> <span class="p">(...,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="p">...)</span>
        <span class="k">ON</span> <span class="n">DUPLICATE</span> <span class="k">KEY</span> <span class="k">UPDATE</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sum_foo</span> <span class="o">=</span> <span class="n">sum_foo</span> <span class="o">+</span> <span class="k">VALUES</span><span class="p">(</span><span class="n">foo</span><span class="p">),</span> <span class="p">...;</span>
</pre><p>IODKU (Insert On Duplicate Key Update) will update an existing row or create a new row. It knows which to do based on the Summary table's PRIMARY KEY.</p>
<p>Caution: This approach is costly, and will not scale to an ingestion rate of over, say, 10 rows per second (Or maybe 50/second on SSDs). More discussion later.</p>
<h2 class="anchored_heading" id="summarizing-periodically-vs-as-needed">Summarizing periodically vs as-needed</h2>
<p>If your reports need to be up-to-the-second, you need "as needed" or "hybrid". If your reports have less urgency (eg, weekly reports that don't include 'today'), then "periodically" might be best.</p>
<p>For a daily summaries, augmenting the summary tables could be done right after midnight. But, beware of data coming "late".</p>
<p>For both "periodic" and "as needed", you need a definitive way of keeping track of where you "left off".</p>
<p>Case 1: You insert into the Fact table first and it has an AUTO_INCREMENT id: Grab MAX(id) as the upper bound for summarizing and put it either into some other secure place (an extra table), or put it into the row(s) in the Summary table as you insert them. (Caveat: AUTO_INCREMENT ids do not work well in multi-master, including Galera, setups.)</p>
<p>Case 2: If you are using a 'staging' table, there is no issue. (More on staging tables later.)</p>
<h2 class="anchored_heading" id="summarizing-while-batch-inserting">Summarizing while batch inserting</h2>
<p>This applies to multi-row (batch) INSERT and LOAD DATA.</p>
<p>The Fact table needs an AUTO_INCREMENT id, and you need to be able to find the exact range of ids inserted. (This may be impractical in any multi-master setup.)</p>
<p>Then perform bulk summarization using</p>
<pre class="fixed">   FROM Fact
   WHERE id BETWEEN min_id and max_id
</pre><h2 class="anchored_heading" id="summarizing-when-using-a-staging-table">Summarizing when using a staging table</h2>
<p>Load the data (via INSERTs or <a href="/kb/en/load-data-infile/">LOAD DATA) en masse into a "staging table". Then perform batch summarization from the Staging table. And batch copy from the Staging table to the Fact table. Note that the Staging table is handy for batching "normalization" during ingestion.
See also [[data-warehousing-high-speed-ingestion|High Speed Ingestion</a></p>
<h2 class="anchored_heading" id="summary-table-pk-or-not">Summary table: PK or not?</h2>
<p>Let's say your summary table has a DATE, `dy`, and a dimension, `foo`. The question is: Should (foo, dy) be the PRIMARY KEY? Or a non-UNIQUE index?</p>
<p>Case 1: PRIMARY KEY (foo, dy) and summarization is in lock step with, say, changes in `dy`.</p>
<p>This case is clean and simple -- until you get to endcases. How will you handle the case of data arriving 'late'? Maybe you will need to recalculate some chunks of data? If so, how?</p>
<p>Case 2: (foo, dy) is a non-UNIQUE INDEX.</p>
<p>This case is clean and simple, but it can clutter the summary table because multiple rows can occur for a given (foo, dy) pair. The report will always have to <a href="/kb/en/sum/">SUM()</a> up values because it cannot assume there is only one row, even when it is reporting on a single `foo` for a single `dy`. This forced-SUM is not really bad -- you should do it anyway; that way all your reports are written with one pattern.</p>
<p>Case 3: PRIMARY KEY (foo, dy) and summarization can happen anytime.</p>
<p>Since you should be using InnoDB, there needs to be an explicit PRIMARY KEY.
One approach when you do not have a 'natural' PK is this:</p>
<pre class="fixed">   <span class="n">id</span> <span class="nb">INT</span> <span class="n">UNSIGNED</span> <span class="n">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
   <span class="p">...</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">id</span><span class="p">),</span>  <span class="c1">-- `id` added to make unique</span>
   <span class="k">INDEX</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>                  <span class="c1">-- sufficient to keep AUTO_INCREMENT happy</span>
</pre><p>This case pushes the complexity onto the summarization by doing a IODKU.</p>
<p>Advice? Avoid Case 1; too messy. Case 2 is ok if the extra rows are not too common. Case 3 may be the closest to "once size fits all".</p>
<h2 class="anchored_heading" id="averages-etc">Averages, etc.</h2>
<p>When summarizing, include <code>COUNT(*) AS ct and SUM(foo) AS sum_foo</code>. When reporting, the "average" is computed as SUM(sum_foo) / SUM(ct). That is mathematically correct.</p>
<p>Exception... Let's say you are looking at weather temperatures. And you monitoring station gets the temp periodically, but unreliably. That is, the number of readings for a day varies. Further, you decide that the easiest way to compensate for the inconsistency is to do something like: Compute the avg temp for each day, then average those across the month (or other timeframe).</p>
<p>Formula for Standard Deviation:</p>
<pre class="fixed">    <span class="n">SQRT</span><span class="p">(</span> <span class="k">SUM</span><span class="p">(</span><span class="n">sum_foo2</span><span class="p">)</span><span class="o">/</span><span class="k">SUM</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">-</span> <span class="n">POWER</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">sum_foo</span><span class="p">)</span><span class="o">/</span><span class="k">SUM</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</pre><p>Where sum_foo2 is SUM(foo * foo) from the summary table. sum_foo and sum_foo2 should be FLOAT. FLOAT gives you about 7 significant digits, which is more than enough for things like average and standard deviation. FLOAT occupies 4 bytes. DOUBLE would give you more precision, but occupies 8 bytes. INT and BIGINT are not practical because they may lead to complaints about overflow.</p>
<h2 class="anchored_heading" id="staging-table">Staging table</h2>
<p>The idea here is to first load a set of Fact records into a "staging table", with the following characteristics (at least):</p>
<ul><li>The table is repeatedly populated and truncated
</li><li>Inserts could be individual or batched, and from one or many clients
</li><li>SELECTs will be table scans, so no indexes needed
</li><li>Inserting will be fast (InnoDB may be the fastest)
</li><li>Normalization can be done in bulk, hence efficiently
</li><li>Copying to the Fact table will be fast
</li><li>Summarization can be done in bulk, hence efficiently
</li><li>"Bursty" ingestion is smoothed by this process
</li><li>Flip-flop a pair of Staging tables
</li></ul>
<p>If you have bulk inserts (Batch INSERT or LOAD DATA) then consider doing the normalization and summarization immediately after each bulk insert.</p>
<p>More details: High Speed Ingestion</p>
<h2 class="anchored_heading" id="extreme-design">Extreme design</h2>
<p>Here is a more complex way to design the system, with the goal of even more scaling.</p>
<ul><li>Use master-slave setup: ingest into master; report from slave(s).
</li><li>Feed ingestion through a staging table (as described above)
</li><li>Single-source of data: ENGINE=MEMORY; multiple sources: InnoDB
</li><li><a href="/kb/en/replication-and-binary-log-server-system-variables/#binlog_format">binlog_format = ROW</a>
</li><li>Use <a href="/kb/en/replication-and-binary-log-server-system-variables/#binlog_ignore_db">binlog_ignore_db</a> to avoid replicating staging -- necessitating putting it in a separate database.
</li><li>Do the summarization from Staging
</li><li>Load Fact via INSERT INTO Fact ... SELECT FROM Staging ...
</li></ul>
<p>Explanation and comments:</p>
<ul><li>ROW + ignore_db avoids replicating Staging, yet replicates the INSERTs based on it. Hence, it lightens the write load on the Slaves
</li><li>If using MEMORY, remember that it is volatile -- recover from a crash by starting the ingestion over.
</li><li>To aid with debugging, TRUNCATE or re-CREATE Staging at the start of the next cycle.
</li><li>Staging needs no indexes -- all operations read all rows from it.
</li></ul>
<p>Stats on the system that this 'extreme design' came from: Fact Table: 450GB, 100M rows/day (batch of 4M/hour), 60 day retention (60+24 partitions), 75B/row, 7 summary tables, under 10 minutes to ingest and summarize the hourly batch. The INSERT..SELECT handled over 20K rows/sec going into the Fact table.
Spinning drives (not SSD) with RAID-10.</p>
<h2 class="anchored_heading" id="left-off">"Left Off"</h2>
<p>One technique involves summarizing some of the data, then recording where you "left off", so that next time, you can start there. There are some subtle issues with "left off" that you should be cautious of.</p>
<p>If you use a DATETIME or TIMESTAMP as "left off", beware of multiple rows with the same value.</p>
<ul><li>Plan A: Use a compound "left off" (eg, TIMESTAMP + ID). This is messy, error prone, etc.
</li><li>Plan B: WHERE ts &gt;= $left_off AND ts &lt; $max_ts -- avoids dups, but has other problems (below)
</li><li>Separate threads could COMMIT TIMESTAMPs out of order.
</li></ul>
<p>If you use an AUTO_INCREMENT as "left off" beware of:</p>
<ul><li>In InnoDB, separate threads could COMMIT ids in the 'wrong' order.
</li><li>Multi-master (including Galera and InnoDB Cluster), could lead to ordering issues.
</li></ul>
<p>So, nothing works, at least not in a multi-threaded environment?</p>
<p>If you can live with an occasional hiccup (skipped record), then maybe this is 'not a problem' for you.</p>
<p>The "Flip-Flop Staging" is a safe alternative, optionally combined with the "Extreme Design".</p>
<h2 class="anchored_heading" id="flip-flop-staging">Flip-flop staging</h2>
<p>If you have many threads simultaneously INSERTing into one staging table, then here is an efficient way to handle a large load: Have a process that flips that staging table with another, identical, staging table, and performs bulk normalization, Fact insertion, and bulk summarization.</p>
<p>The flipping step uses a fast, atomic, RENAME.</p>
<p>Here is a sketch of the code:</p>
<pre class="fixed">    # Prep for flip:
    CREATE TABLE new LIKE Staging;

    # Swap (flip) Staging tables:
    RENAME TABLE Staging TO old, new TO Staging;

    # Normalize new `foo`s:
    # (autocommit = 1)
    INSERT IGNORE INTO Foos SELECT fpp FROM old LEFT JOIN Foos ...

    # Prep for possible deadlocks, etc
    while...
    START TRANSACTION;

    # Add to Fact:
    INSERT INTO Fact ... FROM old JOIN Foos ...

    # Summarize:
    INSERT INTO Summary ... FROM old ... GROUP BY ...

    COMMIT;
    end-while

    # Cleanup:
    DROP TABLE old;
</pre><p>Meanwhile, ingestion can continue writing to `Staging`. The ingestion INSERTs will conflict with the RENAME, but will be resolved gracefully and silently and quickly.</p>
<p>How fast should you flip-flop? Probably the best scheme is to</p>
<ul><li>Have a job that flip-flops in a tight loop (no delay, or a small delay, between iterations), and
</li><li>Have a CRON that serves only as a "keep-alive" to restart the job if it dies.
</li></ul>
<p>If Staging is 'big', an iteration will take longer, but run more efficiently. Hence, it is self-regulating.</p>
<p>In a <a href="/kb/en/galera/">Galera</a> (or InnoDB Cluster?) environment, each node could be receiving input. If can afford to loose a few rows, have `Staging` be a non-replicated MEMORY table. Otherwise, have one `Staging` per node and be InnoDB; it will be more secure, but slower and not without problems. In particular, if a node dies completely, you somehow need to process its `Staging` table.</p>
<h2 class="anchored_heading" id="multiple-summary-tables">Multiple summary tables</h2>
<ul><li>Look at the reports you will need.
</li><li>Design a summary table for each.
</li><li>Then look at the summary tables -- you are likely to find some similarities.
</li><li>Merge similar ones.
</li></ul>
<p>To look at what a report needs, look at the WHERE clause that would provide the data. Some examples, assuming data about service records for automobiles: The GROUP BY to gives a clue of what the report might be about.</p>
<p>    1. WHERE make = ? AND model_year = ?  GROUP BY service_date, service_type
    2. WHERE make = ? AND model = ?       GROUP BY service_date, service_type
    3. WHERE service_type = ?             GROUP BY make, model, service_date
    4. WHERE service_date between ? and ? GROUP BY make, model, model_year</p>
<p>You need to allow for 'ad hoc' queries? Well, look at all the ad hoc queries -- they all have a date range, plus nail down one or two other things. (I rarely see something as ugly as '%CL%' for nailing down another dimension.) So, start by thinking of date plus one or two other dimensions as the 'key' into a new summary table. Then comes the question of what data might be desired -- counts, sums, etc. Eventually you have a small set of summary tables. Then build a front end to allow them to pick only from those possibilities. It should encourage use of the existing summary tables, not not be truly 'open ended'.</p>
<p>Later, another 'requirement' may surface. So, build another summary table. Of course, it may take a day to initially populate it.</p>
<h2 class="anchored_heading" id="games-on-summary-tables">Games on summary tables</h2>
<p>Does one ever need to summarize a summary table? Yes, but only in extreme situations. Usually a 'weekly' report can be derived from a 'daily' summary table; building a separate weekly summary table not being worth the effort.</p>
<p>Would one ever PARTITION a Summary Table? Yes, in extreme situations, such as the table being large, and</p>
<ul><li>Need to purge old data (unlikely), or
</li><li>Recent' data is usually requested, and the index(es) fail to prevent table scans (rare). ("Partition pruning" to the rescue.)
</li></ul>
<h2 class="anchored_heading" id="see-also">See also</h2>
<p>Rick James graciously allowed us to use this article in the Knowledge Base.</p>
<p><a href="http://mysql.rjweb.org/">Rick James' site</a> has other useful tips, how-tos,
optimizations, and debugging tips.</p>
<p>
Original source: <a href="http://mysql.rjweb.org/doc.php/summarytables">http://mysql.rjweb.org/doc.php/summarytables</a></p>
<p>Examples</p>
<ul start="1"><li><a href="http://dba.stackexchange.com/a/144723/1876">http://dba.stackexchange.com/a/144723/1876</a>
</li><li><a href="http://stackoverflow.com/a/39403194/1766831">http://stackoverflow.com/a/39403194/1766831</a>
</li><li><a href="http://stackoverflow.com/a/40310314/1766831">http://stackoverflow.com/a/40310314/1766831</a></li></ul>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/data-warehousing-summary-tables/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/data-warehousing-summary-tables/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/data-warehousing-high-speed-ingestion/">
                        ← Data Warehousing High Speed Ingestion
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/query-optimizations/">
                        ↑ Query Optimizations ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/data-warehousing-techniques/">
                        Data Warehousing Techniques →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="5696" data-comments-url="/kb/en/data-warehousing-summary-tables/+comments"
         data-reply-url="/kb/en/data-warehousing-summary-tables/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/query-optimizations/">
                    ↑ Query Optimizations ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/index-hints-how-to-force-query-plans/">
                            
                            Index Hints: How to Force Query Plans
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/subquery-optimizations/">
                            
                            Subquery Optimizations
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimization-strategies/">
                            
                            Optimization Strategies
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizations-for-derived-tables/">
                            
                            Optimizations for Derived Tables
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/table-elimination/">
                            
                            Table Elimination
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/statistics-for-optimizing-queries/">
                            
                            Statistics for Optimizing Queries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/filesort-with-small-limit-optimization/">
                            
                            Filesort with Small LIMIT Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/limit-rows-examined/">
                            
                            LIMIT ROWS EXAMINED
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/index_merge-sort_intersection/">
                            
                            index_merge sort_intersection
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-53-optimizer-debugging/">
                            
                            MariaDB 5.3 Optimizer Debugging
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer-switch/">
                            
                            optimizer_switch
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/how-to-quickly-insert-data-into-mariadb/">
                            
                            How to Quickly Insert Data Into MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/index-condition-pushdown/">
                            
                            Index Condition Pushdown
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/query-limits-and-timeouts/">
                            
                            Query Limits and Timeouts
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/aborting-statements/">
                            
                            Aborting Statements that Exceed a Certain Time to Execute
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/partition-pruning-and-selection/">
                            <span class="pull-right not_primary"></span>
                            Partition Pruning and Selection
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/big-deletes/">
                            
                            Big DELETEs 
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/charset-narrowing-optimization/">
                            
                            Charset Narrowing Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-sampling-techniques-for-efficiently-finding-a-random-row/">
                            
                            Data Sampling: Techniques for Efficiently Finding a Random Row
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-high-speed-ingestion/">
                            
                            Data Warehousing High Speed Ingestion
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Data Warehousing Summary Tables</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-techniques/">
                            
                            Data Warehousing Techniques
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/query-optimizations-distinct-removal-in-aggregate-functions/">
                            
                            DISTINCT removal in aggregate functions
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/equality-propagation-optimization/">
                            
                            Equality propagation optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/force-index/">
                            
                            FORCE INDEX
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/groupwise-max-in-mariadb/">
                            
                            Groupwise Max in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/guiduuid-performance/">
                            
                            GUID/UUID Performance
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/hash_join_cardinality-optimizer_switch-flag/">
                            
                            hash_join_cardinality optimizer_switch Flag
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/ignore-index/">
                            
                            IGNORE INDEX
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/not_null_range_scan-optimization/">
                            
                            not_null_range_scan Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer_adjust_secondary_key_costs/">
                            
                            optimizer_adjust_secondary_key_costs
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer_join_limit_pref_ratio-optimization/">
                            
                            optimizer_join_limit_pref_ratio optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizing-for-latest-news-style-queries/">
                            
                            Optimizing for &#34;Latest News&#34;-style Queries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pagination-optimization/">
                            
                            Pagination Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pivoting-in-mariadb/">
                            
                            Pivoting in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rollup-unique-user-counts/">
                            
                            Rollup Unique User Counts
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rowid-filtering-optimization/">
                            
                            Rowid Filtering Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sargable-date-and-year/">
                            
                            Sargable DATE and YEAR
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sargable-upper/">
                            
                            Sargable UPPER
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/use-index/">
                            
                            USE INDEX
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>