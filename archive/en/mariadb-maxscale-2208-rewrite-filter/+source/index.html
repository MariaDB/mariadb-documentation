<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title> Rewrite Filter - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content=" Rewrite Filter - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/mariadb-maxscale-2208-rewrite-filter/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-maxscale-2208-rewrite-filter/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/mariadb-maxscale-2208-rewrite-filter/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/mariadb-maxscale-2208/">MariaDB MaxScale 22.08</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-maxscale-2208--filters/">MaxScale 22.08 Filters</a>
    


    » <a class="node_link crumb" href="/kb/en/mariadb-maxscale-2208-rewrite-filter/"> Rewrite Filter</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/mariadb-maxscale-2208-rewrite-filter/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1> Rewrite Filter - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/mariadb-maxscale-2208-rewrite-filter/+r/133052/">133052</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-5571">
<a href="/kb/user/id/5571" title="Kirk Brown">Kirk Brown</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2022-08-17 22:05">2022-08-17 22:05</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow"># Rewrite Filter

## Overview

The rewrite filter allows modification of sql queries on the fly.
Reasons for modifying queries can be to rewrite a query for performance,
or to change a specific query when the client query is incorrect and
cannot be changed in a timely manner.

The examples will use Rewrite Filter file format. See below.

### Syntax

#### Native syntax

Rewriter native syntax uses placeholders to grab and replace parts of text.

##### Placeholders

The syntax for a plain placeholder is `@{N}` where N is a positive integer.

The syntax for a placeholder regex is `@{N:regex}`. It allows more control
when needed.

The below is a valid entry in rf format. For demonstration, all options are set.
This entry is a do-nothing entry, but illustrates placeholders.

```
%%
# options
regex_grammar: Native
case_sensitive: true
what_if: false
continue_if_matched: false
ignore_whitespace: true
%
# match template
@{1:^}select @{2} from my_table where id = @{3}
%
# replace template
select @{2} from my_table where id = @{3}
```

If the input sql is `select id, name from my_table where id = 42`
then `@{2} = &#34;id, name&#34;` and `@{3} = &#34;42&#34;`. Since the replace template
is identical to the match template the end result is that the output sql
will be the same as the input sql.

Placeholders can be used as forward references.
`@{1:^}select @{2}, count(*) from @{3} group by @{2}`.
For a match, the two ``@{2}`` text grabs must be equal.

###### Match template

The match template is used to match against the sql to be rewritten.

The match template can be partial `from mytable`. But the actual underlying
regex match is always for the whole sql. If the match template does not
start or end with a placeholder, placeholders are automatically added so
that the above becomes `@{1}from mytable@{2}`. The automatically added
placeholders cannot be used in the replace template.

Matching the whole input also means that Native syntax does not support
(and is not intended to support) scan and replace. Only the first occurrance
of the above `from mytable` can be modified in the replace template.
However, one can selectively choose to modify e.g. the first through
third occurrance of `from mytable` by writing
`from mytable @{1} from mytable @{2} from mytable @{3}`.

For scan and replace use a different regex_grammar (see below).

##### Replace template

The replace template uses the placeholders from the match template to
rewrite sql.

```
%%
# use default options by leaving this blank
%
@{1:^}select count(distinct @{2}) from @{3}
%
select count(*) from (select distinct @{1} from @{2}) as t123

Input: select count(distinct author) from books where entity != &#34;AI&#34;

Rewritten: select count(*) from (select distinct author from books where entity != &#34;AI&#34;) as t123
```

An important option for smooth matching is `ignore_whitespace`, which
is on (true) by default. It creates the match regex in such a way that
the amount and kind of whitespace does not affect matching. However,
to make `ignore_whitespace` always work, it is important to add
whitespace where allowed. If &#34;id=42&#34; is in the match template then
only the exact &#34;id=42&#34; can match. But if &#34;id = 42&#34; is used, and
`ignore_whitespace` is on, both &#34;id=42&#34; and &#34;id = 42&#34; will match.

Another example, and what not to do:
```
%%
%
from mytable
%
from mytable force index (myindex)

Input: select name from mytable where id=42

Rewritten: select name from mytable force index (myindex) where id=42
```
That works, but because the match lacks specific detail about the
expected sql, things are likely to break. In this case
`show indexes from my_table` would no longer work.

The minimum detail in this case could be:
```
%%
%
@{1:^}select @{2} from mytable
%
select @{2} from mytable force index (myindex)
```
but if more detail is known, like something specific in the where clause,
that too should be added.

##### Placeholder Regex

Syntax: @{N:regex}

In a placeholder regex the character `}` must be escaped to `\}`
(for literal matching). Plain parenthesis &#34;()&#34; indicate capturing
groups, which are internally used by the Native grammar.
Thus plain parentheses in a placeholder regex will break matching.
However, non-capturing groups can be used: e.g. `@{1:(:?Jane|Joe)}`.
To match a literal parenthesis use an escape, e.g. `\(`.

Suppose an application is misbehaving after an upgrade and a quick fix is needed.
This query `select zip from address_book where str_id = &#34;AZ-124&#34;` is correct,
but if the id is an integer the where clause should be `id = 1234`.
```
%%
%
@{1:^}select zip_code from address_book where str_id = @{1:[&#34;]}@{2:[[:digit:]]+}@{3:[&#34;]}
%
select zip_code from address_book where id = @{2}

Input: select zip_code from address_book where str_id = &#34;1234&#34;

Rewritten: select zip_code from address_book where id = 1234
```
#### Using plain regular expressions

For scan and replace the regex_grammar must be set to something else than
Native. An example will illustrate the usage.

Replace all occurrances of &#34;wrong_table_name&#34; with &#34;correct_table_name&#34;.
Further, if the replacement was made then replace all occurrances
of wrong_column_name with correct_column_name.
```
%%
regex_grammar: EPosix
continue_if_matched: true
%
wrong_table_name
%
correct_table_name

%%
regex_grammar: EPosix
%
wrong_column_name
%
correct_column_name
```
## Configuration

Adding a rewrite filter.

```
[Rewrite]
type = filter
module = rewritefilter
template_file = /path/to/template_file.rf
...

[Router]
type=service
...
filters=Rewrite
```

### Parameters in maxscale.cnf

#### `template_file`

- **Type**: string
- **Mandatory**: Yes
- **Dynamic**: Yes
- **Default**: No default value

Path to the template file.

#### `regex_grammar`

- **Type**: string
- **Mandatory**: No
- **Dynamic**: Yes
- **Default**: Native
- **Values**: `Native`, `ECMAScript`, `Posix`, `EPosix`, `Awk`, `Grep`, `EGrep`

Default regex_grammar for templates

#### `case_sensitive`

- **Type**: boolean
- **Mandatory**: No
- **Dynamic**: Yes
- **Default**: true

Default case sensitivity for templates

#### `log_replacement`

- **Type**: boolean
- **Mandatory**: No
- **Dynamic**: Yes
- **Default**: false

Log replacements at NOTICE level.

### Parameters per template in the template file

#### `regex_grammar`
- **Type**: string
- **Values**: `Native`, `ECMAScript`, `Posix`, `EPosix`, `Awk`, `Grep`, `EGrep`
- **Default**: From maxscale.cnf

Overrides the global regex_grammar of a template.

#### `case_sensitive`

- **Type**: boolean
- **Default**: From maxscale.cnf

Overrides the global case sensitivity of a template.

#### `ignore_whitespace`

- **Type**: boolean
- **Default**: true

Ignore whitespace differences in the match template and input sql.

#### `continue_if_matched`

- **Type**: boolean
- **Default**: false

If a template matches and the replacement is done, continue to the
next template and apply it to the result of the previous rewrite.

#### `what_if`

- **Type**: boolean
- **Default**: false

Do not make the replacement, only log what would have
been replaced (NOTICE level).

## Rewrite file format

The rf format for an entry is:
```
%%
options
%
match template
%
replace template
```
The character `#` starts a single line comment when it is the
first character on a line.

Empty lines are ignored.

The rf format does not need any additional escaping to what the basic
format requires (see Placeholder Regex).

Options are specified as follows:
```
case_sensitive: true
```
The colon must stick to the option name.

The separators `%` and `%%` must be the exact content of
their respective separator lines.

The templates can span multiple lines. Whitespace does not
matter as long as `ignore_whitespace = true`. Always use space
where space is allowed to maximize the utility of
`ignore_whitespace`.

Example
```
%%
case_sensitive: false
%
@{1:^}select @{2}
from mytable
where user = @{3}
%
select @{2} from mytable where user = @{3}
and @{3} in (select user from approved_users)
```
## Json file format

The json file format is harder to read and edit manually.
It will be needed if support for editing of rewrite templates
is added to the GUI.

All double quotes and escape characters have to be escaped in json,
i.e &#39;\&#34;&#39; and &#39;\\\\&#39;.

The same example as above is:
```
{ &#34;templates&#34; :
    [
        {
            &#34;case_sensitive&#34; : false,
            &#34;match_template&#34; : &#34;@{1:^}select @{2} from mytable where user = @{3}&#34;,
            &#34;replace_template&#34; : &#34;select @{2} from mytable where user = @{3}
and @{3} in (select user from approved_users)&#34;
        }
    ]
}
```
## Reload template file

The configuration is re-read if any dynamic value is updated
even if the value does not change.
```
maxctrl alter filter Rewrite log_replacement=false
```
## Reference

- ECMAScript  https://cplusplus.com/reference/regex/ECMAScript
- Posix       http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html#tag_09_03
- EPosix      http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html#tag_09_04
- Awk         http://pubs.opengroup.org/onlinepubs/9699919799/utilities/awk.html#tag_20_06_13_04
- Grep        Same as Posix with the addition of newline &#39;\n&#39; as an alternation separator.
- EGrep       Same as EPosix with the addition of newline &#39;\n&#39; as an alternation separator in addition to &#39;|&#39;.
</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>