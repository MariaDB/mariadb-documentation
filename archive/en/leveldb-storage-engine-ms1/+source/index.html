<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>LevelDB Storage Engine MS1 - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="LevelDB Storage Engine MS1 - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/leveldb-storage-engine-ms1/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/leveldb-storage-engine-ms1/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/leveldb-storage-engine-ms1/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/training-tutorials/">Training &amp; Tutorials</a>
    

    
    » <a class="crumb" href="/kb/en/advanced-mariadb-articles/">Advanced MariaDB Articles</a>
    

    
    » <a class="crumb" href="/kb/en/development-articles/">Development Articles</a>
    

    
    » <a class="crumb" href="/kb/en/outdated-pages/">Outdated pages</a>
    


    » <a class="node_link crumb" href="/kb/en/leveldb-storage-engine-ms1/">LevelDB Storage Engine MS1</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/leveldb-storage-engine-ms1/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>LevelDB Storage Engine MS1 - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/leveldb-storage-engine-ms1/+r/130922/">130922</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-115">
<a href="/kb/user/id/115" title="Sergei Petrunia">Sergei Petrunia</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2015-01-28 12:25">2015-01-28 12:25</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">This page describes what will be implemented for milestone#1 of [[leveldb-storage-engine|LevelDB Storage Engine]]. //For development after MS1, see [[leveldb-storage-engine-development|LevelDB Storage Engine Development]]//

&lt;&lt;toc&gt;&gt;
= Feature Description =

== How the data is stored in LevelDB ==

=== One leveldb instance ===
We will use one LevelDB instance for mysqld process. LevelDB keys will be 
prefixed with &#39;dbname.table_name.PRIMARY&#39; for the table itself, and
&#39;dbname.table_name.index_name&#39; for the secondary indexes. This allows to 
store arbitrary number of tables/indexes in one LevelDB instance.

=== Data encoding ===
We will rely on LevelDB&#39;s compression to make the storage compact.
Data that goes into LevelDB&#39;s key will be stored in KeyTupleFormat (which 
allows mysql&#39;s lookup/index ordering functions to work). 

Data that goes into LevelDB&#39;s value will be stored in table-&gt;record[0] format, 
except blobs. (Blobs will require special storage convention because they 
store a char* pointer in table-&gt;record[0]). 

We will need to support blobs because table ##nodetable## has a ##mediumtext## field.

=== Secondary indexes ===
Non-unique secondary indexes will be supported.

LevelDB stores {KEY-&gt;VALUE} mappings. Non-unique index will need to have some unique values for KEY.  This can be arranged by using this mapping:

&lt;&lt;code&gt;&gt;
KEY = {index_columns, primary_key_columns}.   
VALUE = {nothing}
&lt;&lt;/code&gt;&gt;

Using primary key as suffix will make DB::Get() useless. Instead, we will have to do lookups with:

&lt;&lt;code&gt;&gt;
get(secondary_index_key_val)
{
  open cursor for (secondary_index_key_val)
  read the first record
  if (record &gt; secondary_index_key_val)
    return NOT_FOUND;
  else
    return FOUND;
}
&lt;&lt;/code&gt;&gt;

//TODO: we will not support unique secondary indexes in MS1. ALTER/CREATE TABLE statements attempting to add a unique index will fail. Is this ok?//

== Concurrency handling ==

We will use what was discussed in the &#34;Pessimistic locking proposal&#34;.

Basic idea is: LevelDB&#39;s operations do blind overwrites. In order to make sure we&#39;re not overwriting anything, we will use this pattern:
&lt;&lt;code&gt;&gt;
  acqure record lock;
  read;
  modify as necessary;
  write;
  release record lock;
&lt;&lt;/code&gt;&gt;

record locks can be obtained for {table_name, primary_key}. Locks are
exclusive, for a given record, only one lock can obtained at a time.  A lock can
be obtained when its record doesn&#39;t exist (see INSERT below)

=== C1. UPDATE ===

UPDATE will use the above scheme. It will get row locks for the keys it is
reading in order to prevent concurrent updates.

=== C.2 INSERT ===

INSERT will use a row lock to make sure the record of interest does not exist.

=== C.3 DELETE ===

If a DELETE statement has a form of

&lt;&lt;code&gt;&gt;
DELETE FROM tbl WHERE tbl.primary_key=const
&lt;&lt;/code&gt;&gt;

then it theoretically can be translated into a DB::Delete() call, that is, into a write-without-read. In other cases, we will need to do reads and put locks on the rows that we want to delete.

MS1 will only implement the variant with locking DELETE.

=== C.4 SELECT ===
SELECT statements will use a read snapshot. They will not put (or check) whether there are any locks for records they are reading. This is similar to the definition of ##read-committed## isolation level.

We will also support ##SELECT FOR UPDATE##. In this mode, the read records will be locked with a write lock until the end of the transaction.

=== C.5 Locking mechanism ===
As specified in previous sections, we will be employing locks on the values of {dbname, tablename, primary_key_value}. Locks will be exclusive: only one transaction can hold a lock at a time.

Locks are acquired one-by-one, which allows for deadlocks. There will be no deadlock detection or deadlock prevention systems. Instead, lock waits will time out after @@leveldb_lock_wait_timeout milliseconds.  When @@leveldb_lock_wait_timeout==0, lock system will not wait at all, attempt to acquire a lock that&#39;s occupied will result in an immediate transaction abort.

Locks will be stored in a highly-concurrent hashtable. Current candidate for it is mysys/lf_hash.

=== C.6 Applying transaction changes ===
The changes made by transaction will be accumulated as a LevelDB batch operation, and applied at transaction commit.  This has a consequence: 

**the transaction is unable to see its own changes until it commits** 

We&#39;ll call the above CANT-SEE-OWN-CHANGES property.  The property is contrary to the SQL&#39;s semantics. In SQL, one expects to see the changes they&#39;ve made in preceding statements.  However, the set of transactions we&#39;re targeting can live with CANT-SEE-OWN-CHANGES, so we&#39;ll live with the property for MS1.

After MS1, LevelDB SE will make sure that CANT-SEE-OWN changes is not observed. It will use the following approach:
* keep track of what records have been modified by this transaction in a buffer $R.
* If SQL layer makes a request to read a row, then
** Consult $R if the record was INSERTed. If yes, return what was inserted.
** Consult $R if the record was modified. if yes, return what was recorded to be the result of modification
** Consult $R if the record was deleted. If yes, return &#34;record not found&#34;.
** Finally, try reading the row from the LevelDB.

== Table Access methods ==

MS1 will support:
* Full table scan. 
* index lookups and range scans over primary and secondary indexes.

=== Optimizer statistics ===
* Estimate of #records in the table will be obtained from DB::GetApproximateSizes() (see below for details)
* Estimate of #records-in-range  will be obtained from DB::GetApproximateSizes()
* There is no acceptable estimate for #rec_per_key of secondary indexes (or for prefixes of the primary key).  MS1 will perform some trivial guesswork.

Note: DB::GetApproximateSizes() returns amount of disk space occupied by the data. The number cannot be directly translated to #rows, because
* We do not always know average record length
* Disk data is compressed.

Because of this, optimizer will have very imprecise input. It is expected to be still sufficient for MS1.

== Write-optimized INSERTs ==
We will need to do fast bulk data loads. During the bulk load, writes-without-reads are ok: the user knows he&#39;s not overwriting data, he doesn&#39;t care about @@rows_affected.

These will be achieved as follows: 
* there will be a thread-local @@leveldb_bulk_load variable. 
* Its default value is FALSE.  
* When it is set to true, INSERTS (which make ha_leveldb::write() calls) will work in bulk-loading mode.

Bulk-loading mode means:
* INSERTs will be done in batches of @@leveldb_bulk_load_size each
* INSERTs will take no locks, and do no-read-writes.  In other words, they will silently overwrite data
* @@affected_rows will return the value that will show that all records were successfully inserted.

== What will not be supported ==
* Non-blocking schema changes will not be supported at all in the first milestone. All DDL-modifying operations will use pump all the data from the original table to the table with the new DDL.
* Binlog XA on the master will not be supported.
* Crash-proof slave will not be supported.
* Building server packages (*.rpm, *.deb, etc) will not be supported (leveldb dependency may be challenging).

== Other details ==
* The patch will be against mysql-5.6
* //TODO: How to run DROP TABLE // The only way we implement DROP TABLE is to delete record by record. The size of changes may become too big to be in RAM. If we split into multiple transactions, we&#39;ll have to handle crashes in the middle of DROP TABLE.
//Q: can we avoid that for the first milestone? //
* //TODO: There is no efficient way to run TRUNCATE TABLE. Is this ok?//
* //TODO: In the above spec, nothing is said about max. transaction size. Is it ok not to have it for MS1? //
</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>