<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Data Warehousing Techniques - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Data Warehousing Techniques" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/data-warehousing-techniques/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="Improving performance for data-warehouse-like tables" />

    <meta name="description" content="Improving performance for data-warehouse-like tables" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/data-warehousing-techniques/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/data-warehousing-techniques/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/replication-cluster-multi-master/">High Availability &amp; Performance Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/optimization-and-tuning/">Optimization and Tuning</a>
    

    
    » <a class="crumb" href="/kb/en/query-optimizations/">Query Optimizations</a>
    


    » <a class="node_link crumb" href="/kb/en/data-warehousing-techniques/">Data Warehousing Techniques</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/data-warehousing-techniques/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/data-warehousing-techniques/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/data-warehousing-techniques/+flag"
                data-flag-url="/kb/en/data-warehousing-techniques/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/data-warehousing-techniques/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2016-06-09 08:22">8 years, 5 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2020-05-20 19:30">4 years, 6 months ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/data-warehousing-techniques/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/data-warehousing-techniques/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/data-warehousing-techniques/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/data-warehousing-techniques/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    






</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Data Warehousing Techniques</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#preface" title="Preface">Preface</a></li>

    <li class=""><a href="#terminology" title="Terminology">Terminology</a></li>

    <li class=""><a href="#fact-table" title="Fact table">Fact table</a></li>

    <li class=""><a href="#why-keep-the-fact-table" title="Why keep the Fact table?">Why keep the Fact table?</a></li>

    <li class=""><a href="#batching-the-load-of-the-fact-table" title="Batching the load of the Fact table">Batching the load of the Fact table</a></li>

    <li class=""><a href="#batched-insert-statement" title="Batched INSERT Statement">Batched INSERT Statement</a></li>

    <li class=""><a href="#normalization-dimension-table" title="Normalization (Dimension) table">Normalization (Dimension) table</a></li>

    <li class=""><a href="#batched-normalization" title="Batched normalization">Batched normalization</a></li>

    <li class=""><a href="#too-many-choices" title="Too many choices?">Too many choices?</a></li>

    <li class=""><a href="#purging-old-data" title="Purging old data">Purging old data</a></li>

    <li class=""><a href="#master-slave" title="Master / slave">Master / slave</a></li>

    <li class=""><a href="#sharding" title="Sharding">Sharding</a></li>

    <li class=""><a href="#how-fast-how-big" title="How fast? How big?">How fast? How big?</a></li>

    <li class=""><a href="#how-fast" title="How fast?">How fast?</a></li>

    <li class=""><a href="#not-so-fast" title="Not so fast?">Not so fast?</a></li>

    <li class=""><a href="#references" title="References">References</a></li>

    <li class=""><a href="#see-also" title="See also">See also</a> </ol>
</li>
</div>
<h2 class="anchored_heading" id="preface">Preface</h2>
<p>This document discusses techniques for improving performance for data-warehouse-like tables in MariaDB and MySQL.</p>
<ul><li>How to load large tables.
</li><li><a href="/kb/en/database-normalization/">Normalization</a>.
</li><li>Developing 'summary tables' to make 'reports' efficient.
</li><li>Purging old data.
</li></ul>
<p>Details on summary tables is covered in the companion document: <a href="/kb/en/data-warehousing-summary-tables/">Summary Tables</a>.</p>
<h2 class="anchored_heading" id="terminology">Terminology</h2>
<p>This list mirrors "Data Warehouse" terminology.</p>
<ul><li>Fact table -- The one huge table with the 'raw' data.
</li><li>Summary table -- a redundant table of summarized data that could -- use for efficiency
</li><li>Dimension -- columns that identify aspects of the dataset (region, country, user, SKU, zipcode, ...)
</li><li>Normalization table (dimension table) -- mapping between strings an ids; used for space and speed.
</li><li>Normalization -- The process of building the mapping ('New York City' &lt;-&gt; 123)
</li></ul>
<h2 class="anchored_heading" id="fact-table">Fact table</h2>
<p>Techniques that should be applied to the huge Fact table.</p>
<ul><li>id INT/BIGINT UNSIGNED NOT NULL AUTO_INCREMENT
</li><li>PRIMARY KEY (id)
</li><li>Probably no other INDEXes
</li><li>Accessed only via id
</li><li>All VARCHARs are "normalized"; ids are stored instead
</li><li>ENGINE = InnoDB
</li><li>All "reports" use summary tables, not the Fact table
</li><li>Summary tables may be populated from ranges of id (other techniques described below)
</li></ul>
<p>There are exceptions where the Fact table must be accessed to retrieve multiple rows. However, you should minimize the number of INDEXes on the table because they are likely to be costly on INSERT.</p>
<h2 class="anchored_heading" id="why-keep-the-fact-table">Why keep the Fact table?</h2>
<p>Once you have built the Summary table(s), there is not much need for the Fact table. One option that you should seriously consider is to not have a Fact table. Or, at least, you could purge old data from it sooner than you purge the Summary tables. Maybe even keep the Summary tables forever.</p>
<p>Case 1: You need to find the raw data involved in some event. But how will you find those row(s)? This is where a secondary index may be required.</p>
<p>If a secondary index is bigger than can be cached in RAM, and if the column(s) being indexed is random, then each row inserted may cause a disk hit to update the index. This limits insert speed to something like 100 rows per second (on ordinary disks). Multiple random indexes slow down insertion further. RAID striping and/or SSDs speed up insertion. Write caching helps, but only for bursts.</p>
<p>Case 2: You need some event, but you did not plan ahead with the optimal INDEX. Well, if the data is PARTITIONed on date, so even if you have a clue of when the event occurred, "partition pruning" will keep the query from being too terribly slow.</p>
<p>Case 3: Over time, the application is likely to need new 'reports', which may lead to a new Summary table. At this point, it would be handy to scan through the old data to fill up the new table.</p>
<p>Case 4: You find a flaw in the summarization, and need to rebuild an existing Summary table.</p>
<p>Cases 3 and 4 both need the "raw" data. But they don't necessarily need the data sitting in a database table. It could be in the pre-database format (such as log files). So, consider not building the Fact table, but simply keep the raw data, comressed, on some file system.</p>
<h2 class="anchored_heading" id="batching-the-load-of-the-fact-table">Batching the load of the Fact table</h2>
<p>When talking about billions of rows in the Fact table, it is essentially mandatory that you "batch" the inserts. There are two main ways:</p>
<ul><li>INSERT INTO Fact (.,.,.) VALUES (.,.,.), (.,.,.), ...; -- "Batch insert"
</li><li>LOAD DATA ...;
</li></ul>
<p>A third way is to INSERT or LOAD into a Staging table, then</p>
<ul><li>INSERT INTO Fact SELECT * FROM Staging;
This INSERT..SELECT allows you to do other things, such as normalization. More later.
</li></ul>
<h2 class="anchored_heading" id="batched-insert-statement">Batched INSERT Statement</h2>
<p>Chunk size should usually be 100-1000 rows.</p>
<ul><li>100-1000 an insert will run 10 times as fast as single-row inserts.
</li><li>Beyond 100, you may be interfering replication and SELECTs.
</li><li>Beyond 1000, you are into diminishing returns -- virtually no further performance gains.
</li><li>Don't go past, say, 1MB for the constructed INSERT statement. This deals with packet sizes, etc. (1MB is unlikely to be hit for a Fact table.)
Decide whether your application should lean toward the 100 or the 1000.
</li></ul>
<p>If your data is coming in continually, and you are adding a batching layer, let's do some math. Compute your ingestion rate -- R rows per second.</p>
<ul><li>If R &lt; 10 (= 1M/day = 300M/year) -- single-row INSERTs would probably work fine (that is, batching is optional)
</li><li>If R &lt; 100 (3B records per year) -- secondary indexes on Fact table may be ok
</li><li>If R &lt; 1000 (100M records/day) -- avoid secondary indexes on Fact table.
</li><li>If R &gt; 1000 -- Batching may not work.
Decide how long (S seconds) you can stall loading the data in order to collect a batch of rows.
</li><li>If S &lt; 0.1s -- May not be able to keep up
</li></ul>
<p>If batching seems viable, then design the batching layer to gather for S seconds or 100-1000 rows, whichever comes first.</p>
<p>(Note: Similar math applies to rapid UPDATEs of a table.)</p>
<h2 class="anchored_heading" id="normalization-dimension-table">Normalization (Dimension) table</h2>
<p>Normalization is important in Data Warehouse applications because it significantly cuts down on the disk footprint and improves performance. There are other reasons for normalizing, but space is the important one for DW.</p>
<p>Here is a typical pattern for a Dimension table:</p>
<pre class="fixed">    <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Emails</span> <span class="p">(</span>
        <span class="n">email_id</span> <span class="n">MEDIUMINT</span> <span class="n">UNSIGNED</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>  <span class="c1">-- don&#39;t make bigger than needed</span>
        <span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(...)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
        <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">email</span><span class="p">),</span>  <span class="c1">-- for looking up one way</span>
        <span class="k">INDEX</span><span class="p">(</span><span class="n">email_id</span><span class="p">)</span>  <span class="c1">-- for looking up the other way (UNIQUE is not needed)</span>
    <span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">;</span>  <span class="c1">-- to get clustering</span>
</pre><p>Notes:</p>
<ul><li>MEDIUMINT is 3 bytes with UNSIGNED range of 0..16M; pick SMALLINT, INT, etc, based on a conservative estimate of how many 'foo's you will eventually have.
</li><li>datatype sizes
</li><li>There may be more than one VARCHAR in the table. Example: For cities, you might have City and Country.
</li><li>InnoDB is better than MyISAM because of way the two keys are structured.
</li><li>The secondary key is effectively (email_id, email), hence 'covering' for certain queries.
</li><li>It is OK to not specify an AUTO_INCREMENT to be UNIQUE.
</li></ul>
<h2 class="anchored_heading" id="batched-normalization">Batched normalization</h2>
<p>I bring this up as a separate topic because of some of the subtle issues that can happen.</p>
<p>You may be tempted to do</p>
<pre class="fixed">    <span class="k">INSERT</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="n">Foos</span>
        <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">foo</span> <span class="k">FROM</span> <span class="n">Staging</span><span class="p">;</span>  <span class="c1">-- not wise</span>
</pre><p>It has the problem of "burning" AUTO_INCREMENT ids. This is because MariaDB pre-allocates ids before getting to "IGNORE". That could rapidly increase the AUTO_INCREMENT values beyond what you expected.</p>
<p>Better is this...</p>
<pre class="fixed">    <span class="k">INSERT</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="n">Foos</span>
        <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">foo</span>
            <span class="k">FROM</span> <span class="n">Staging</span>
            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">Foos</span> <span class="k">ON</span> <span class="n">Foos</span><span class="p">.</span><span class="n">foo</span> <span class="o">=</span> <span class="n">Staging</span><span class="p">.</span><span class="n">foo</span>
            <span class="k">WHERE</span> <span class="n">Foos</span><span class="p">.</span><span class="n">foo_id</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">;</span>
</pre><p>Notes:</p>
<ul><li>The LEFT JOIN .. IS NULL finds the `foo`s that are not yet in Foos.
</li><li>This INSERT..SELECT must not be done inside the transaction with the rest of the processing. Otherwise, you add to deadlock risks, leading to burned ids.
</li><li>IGNORE is used in case you are doing the INSERT from multiple processes simultaneously.
</li></ul>
<p>Once that INSERT is done, this will find all the foo_ids it needs:</p>
<pre class="fixed">    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Fact</span> <span class="p">(...,</span> <span class="n">foo_id</span><span class="p">,</span> <span class="p">...)</span>
        <span class="k">SELECT</span> <span class="p">...,</span> <span class="n">Foos</span><span class="p">.</span><span class="n">foo_id</span><span class="p">,</span> <span class="p">...</span>
            <span class="k">FROM</span> <span class="n">Staging</span>
            <span class="k">JOIN</span> <span class="n">Foos</span> <span class="k">ON</span> <span class="n">Foos</span><span class="p">.</span><span class="n">foo</span> <span class="o">=</span> <span class="n">Staging</span><span class="p">.</span><span class="n">foo</span><span class="p">;</span>
</pre><p>An advantage of "Batched Normalization" is that you can summarize directly from the Staging table. Two approaches:</p>
<p>Case 1: PRIMARY KEY (dy, foo) and summarization is in lock step with, say, changes in `dy`.</p>
<ul><li>This approach can have troubles if new data arrives after you have summarized the day's data.
</li></ul>
<pre class="fixed">    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Summary</span> <span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">blah_total</span><span class="p">)</span>
        <span class="k">SELECT</span>  <span class="nb">DATE</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">as</span> <span class="n">dy</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span>
                <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">ct</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">blah</span><span class="p">)</span> <span class="k">as</span> <span class="n">blah_total</span><span class="p">)</span>
            <span class="k">FROM</span> <span class="n">Staging</span>
            <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">;</span>
</pre><p>Case 2: (dy, foo) is a non-UNIQUE INDEX.</p>
<ul><li>Same code as Case 1.
</li><li>By having the index be non-UNIQUE, delayed data simply shows up as extra rows.
</li><li>You need to take care to avoid summarizing the data twice. (The id on the Fact table may be a good tool for that.)
</li></ul>
<p>Case 3: PRIMARY KEY (dy, foo) and summarization can happen anytime.</p>
<pre class="fixed">    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Summary</span> <span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">blah_total</span><span class="p">)</span>
        <span class="k">ON</span> <span class="n">DUPLICATE</span> <span class="k">KEY</span> <span class="k">UPDATE</span>
            <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span> <span class="o">+</span> <span class="n">VALUE</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span>
            <span class="n">blah_total</span> <span class="o">=</span> <span class="n">blah_total</span> <span class="o">+</span> <span class="n">VALUE</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>
        <span class="k">SELECT</span>  <span class="nb">DATE</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">as</span> <span class="n">dy</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span>
                <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">ct</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">blah</span><span class="p">)</span> <span class="k">as</span> <span class="n">bt</span><span class="p">)</span>
            <span class="k">FROM</span> <span class="n">Staging</span>
            <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">;</span>
</pre><h2 class="anchored_heading" id="too-many-choices">Too many choices?</h2>
<p>This document lists a number of ways to do things. Your situation may lead to one approach being more/less acceptable. But, if you are thinking "Just tell me what to do!", then here:</p>
<ul><li>Batch load the raw data into a temporary table (`Staging`).
</li><li>Normalize from `Staging` -- use code in Case 3.
</li><li>INSERT .. SELECT to move the data from `Staging` into the Fact table
</li><li>Summarize from `Staging` to Summary table(s) via IODKU (Insert ... On Duplicate Key Update).
</li><li>Drop the Staging
</li></ul>
<p>Those techniques should perform well and scale well in most cases. As you develop your situation, you may discover why I described alternative solutions.</p>
<h2 class="anchored_heading" id="purging-old-data">Purging old data</h2>
<p>Typically the Fact table is PARTITION BY RANGE (10-60 ranges of days/weeks/etc) and needs purging (DROP PARTITION) periodically. This discusses a safe/clean way to design the partitioning and do the DROPs: Purging PARTITIONs</p>
<h2 class="anchored_heading" id="master-slave">Master / slave</h2>
<p>For "read scaling", backup, and failover, use master-slave replication or something fancier. Do ingestion only on a single active master; it replicate to the slave(s). Generate reports on the slave(s).</p>
<h2 class="anchored_heading" id="sharding">Sharding</h2>
<p>"Sharding" is the splitting of data across multiple servers. (In contrast, <a href="/kb/en/replication/">replication</a> and <a href="/kb/en/galera/">Galera</a> have the same data on all servers, requiring all data to be written to all servers.)</p>
<p>With the non-sharding techniques described here, terabyte(s) of data can be handled by a single machine. Tens of terabytes probably requires sharding.</p>
<p>Sharding is beyond the scope of this document.</p>
<h2 class="anchored_heading" id="how-fast-how-big">How fast? How big?</h2>
<p>With the techniques described here, you may be able to achieve the following performance numbers. I say "may" because every data warehouse situation is different, and you may require performance-hurting deviations from what I describe here. I give multiple options for some aspects; these may cover some of your deviations.</p>
<p>One big performance killer is UUID/GUID keys. Since they are very 'random', updates of them (at scale) are limited to 1 row = 1 disk hit. Plain disks can handle only 100 hits/second. RAID and/or SSD can increase that to something like 1000 hits/sec. Huge amounts of RAM (for caching the random index) are a costly solution. It is possible to turn type-1 UUIDs into roughly-chronological keys, thereby mittigating the performance problems if the UUIDs are written/read with some chronological clustering. UUID discussion</p>
<p>Hardware, etc:</p>
<ul><li>Single SATA drive: 100 IOPs (Input/Output operations per second)
</li><li>RAID with N physical drives -- 100*N IOPs (roughly)
</li><li>SSD -- 5 times as fast as rotating media (in this context)
</li><li>Batch INSERT -- 100-1000 rows is 10 times as fast as INSERTing 1 row at a time (see above)
</li><li>Purge "old" data -- Do not use DELETE or TRUNCATE, design so you can use DROP PARTITION (see above)
</li><li>Think of each INDEX (except the PRIMARY KEY on InnoDB) as a separate table
</li><li>Consider access patterns of each table/index: random vs at-the-end vs something in between
</li></ul>
<p>"Count the disk hits" -- back-of-envelope performance analysis</p>
<ul><li>Random accesses to a table/index -- count each as a disk hit.
</li><li>At-the-end accesses (INSERT chronologically or with AUTO_INCREMENT; range SELECT) -- count as zero hits.
</li><li>In between (hot/popular ids, etc) -- count as something in between
</li><li>For INSERTs, do the analysis on each index; add them up.
</li><li>For SELECTs, do the analysis on the one index used, plus the table. (Use of 2 indexes is rare.)
Insert cost, based on datatype of first column in an index:
</li><li>AUTO_INCREMENT -- essentially 0 IOPs
</li><li>DATETIME, TIMESTAMP -- essentially 0 for 'current' times
</li><li>UUID/GUID -- 1 per insert (terrible)
</li><li>Others -- depends on their patterns
SELECT cost gets a little tricky:
</li><li>Range on PRIMARY KEY -- think of it as getting 100 rows per disk hit.
</li><li>IN on PRIMARY KEY -- 1 disk hit per item in IN
</li><li>"=" -- 1 hit (for 1 row)
</li><li>Secondary key -- First compute the hits for the index, then...
</li><li>Think of each row as needing 1 disk hit.
</li><li>However, if the rows are likely to be 'near' each other (based on the PRIMARY KEY), then it could be &lt; 1 disk hit/row.
</li></ul>
<p>More on Count the Disk Hits</p>
<h2 class="anchored_heading" id="how-fast">How fast?</h2>
<p>Look at your data; compute raw rows per second (or hour or day or year). There are about 30M seconds in a year; 86,400 seconds per day. Inserting 30 rows per second becomes a billion rows per year.</p>
<p>10 rows per second is about all you can expect from an ordinary machine (after allowing for various overheads). If you have less than that, you don't have many worries, but still you should probably create Summary tables. If more than 10/sec, then batching, etc, becomes vital. Even on spiffy hardware, 100/sec is about all you can expect without utilizing the techniques here.</p>
<h2 class="anchored_heading" id="not-so-fast">Not so fast?</h2>
<p>Let's say your insert rate is only one-tenth of your disk IOPs (eg, 10 rows/sec vs 100 IOPs). Also, let's say your data is not "bursty"; that is, the data comes in somewhat soothly throughout the day.</p>
<p>Note that 10 rows/sec (300M/year) implies maybe 30GB for data + indexes + normalization tables + summary tables for 1 year. I would call this "not so big".</p>
<p>Still, the <a href="/kb/en/database-normalization/">normalization</a> and summarization are important. Normalization keeps the data from being, say, twice as big. Summarization speeds up the reports by orders of magnitude.</p>
<p>Let's design and analyse a "simple ingestion scheme" for 10 rows/second, without 'batching'.</p>
<pre class="fixed">    # Normalize:
    $foo_id = SELECT foo_id FROM Foos WHERE foo = $foo;
    if no $foo_id, then
        INSERT IGNORE INTO Foos ...

    # Inserts:
    BEGIN;
        INSERT INTO Fact ...;
        INSERT INTO Summary ... ON DUPLICATE KEY UPDATE ...;
    COMMIT;
    # (plus code to deal with errors on INSERTs or COMMIT)
</pre><p>Depending on the number and randomness of your indexes, etc, 10 Fact rows may (or may not) take less than 100 IOPs.</p>
<p>Also, note that as the data grows over time, random indexes will become less and less likely to be cached. That is, even if runs fine with 1 year's worth of data, it may be in trouble with 2 year's worth.</p>
<p>For those reasons, I started this discussion with a wide margin (10 rows versus 100 IOPs).</p>
<h2 class="anchored_heading" id="references">References</h2>
<ul start="1"><li><a href="http://www.redbooks.ibm.com/redbooks/pdfs/sg247138.pdf">sec. 3.3.2: Dimensional Model and "Star schema"</a>
</li><li>Summary Tables
</li></ul>
<h2 class="anchored_heading" id="see-also">See also</h2>
<p>Rick James graciously allowed us to use this article in the Knowledge Base.</p>
<p><a href="http://mysql.rjweb.org/">Rick James' site</a> has other useful tips, how-tos,
optimizations, and debugging tips.</p>
<p>
Original source: <a href="http://mysql.rjweb.org/doc.php/datawarehouse">http://mysql.rjweb.org/doc.php/datawarehouse</a></p>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/data-warehousing-techniques/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/data-warehousing-techniques/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/data-warehousing-summary-tables/">
                        ← Data Warehousing Summary Tables
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/query-optimizations/">
                        ↑ Query Optimizations ↑
                    </a>
                    </li>
                
                
                    <li class="pull-right"><a href="/kb/en/query-optimizations-distinct-removal-in-aggregate-functions/">
                        DISTINCT removal in aggregate functions →
                    </a>
                    </li>
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="5695" data-comments-url="/kb/en/data-warehousing-techniques/+comments"
         data-reply-url="/kb/en/data-warehousing-techniques/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/query-optimizations/">
                    ↑ Query Optimizations ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/index-hints-how-to-force-query-plans/">
                            
                            Index Hints: How to Force Query Plans
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/subquery-optimizations/">
                            
                            Subquery Optimizations
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimization-strategies/">
                            
                            Optimization Strategies
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizations-for-derived-tables/">
                            
                            Optimizations for Derived Tables
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/table-elimination/">
                            
                            Table Elimination
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/statistics-for-optimizing-queries/">
                            
                            Statistics for Optimizing Queries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/filesort-with-small-limit-optimization/">
                            
                            Filesort with Small LIMIT Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/limit-rows-examined/">
                            
                            LIMIT ROWS EXAMINED
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/index_merge-sort_intersection/">
                            
                            index_merge sort_intersection
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/mariadb-53-optimizer-debugging/">
                            
                            MariaDB 5.3 Optimizer Debugging
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer-switch/">
                            
                            optimizer_switch
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/how-to-quickly-insert-data-into-mariadb/">
                            
                            How to Quickly Insert Data Into MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/index-condition-pushdown/">
                            
                            Index Condition Pushdown
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/query-limits-and-timeouts/">
                            
                            Query Limits and Timeouts
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/aborting-statements/">
                            
                            Aborting Statements that Exceed a Certain Time to Execute
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/partition-pruning-and-selection/">
                            <span class="pull-right not_primary"></span>
                            Partition Pruning and Selection
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/big-deletes/">
                            
                            Big DELETEs 
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/charset-narrowing-optimization/">
                            
                            Charset Narrowing Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-sampling-techniques-for-efficiently-finding-a-random-row/">
                            
                            Data Sampling: Techniques for Efficiently Finding a Random Row
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-high-speed-ingestion/">
                            
                            Data Warehousing High Speed Ingestion
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/data-warehousing-summary-tables/">
                            
                            Data Warehousing Summary Tables
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Data Warehousing Techniques</span>
                        
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/query-optimizations-distinct-removal-in-aggregate-functions/">
                            
                            DISTINCT removal in aggregate functions
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/equality-propagation-optimization/">
                            
                            Equality propagation optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/force-index/">
                            
                            FORCE INDEX
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/groupwise-max-in-mariadb/">
                            
                            Groupwise Max in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/guiduuid-performance/">
                            
                            GUID/UUID Performance
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/hash_join_cardinality-optimizer_switch-flag/">
                            
                            hash_join_cardinality optimizer_switch Flag
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/ignore-index/">
                            
                            IGNORE INDEX
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/not_null_range_scan-optimization/">
                            
                            not_null_range_scan Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer_adjust_secondary_key_costs/">
                            
                            optimizer_adjust_secondary_key_costs
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizer_join_limit_pref_ratio-optimization/">
                            
                            optimizer_join_limit_pref_ratio optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/optimizing-for-latest-news-style-queries/">
                            
                            Optimizing for &#34;Latest News&#34;-style Queries
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pagination-optimization/">
                            
                            Pagination Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/pivoting-in-mariadb/">
                            
                            Pivoting in MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rollup-unique-user-counts/">
                            
                            Rollup Unique User Counts
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/rowid-filtering-optimization/">
                            
                            Rowid Filtering Optimization
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sargable-date-and-year/">
                            
                            Sargable DATE and YEAR
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/sargable-upper/">
                            
                            Sargable UPPER
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/use-index/">
                            
                            USE INDEX
                        </a>
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>