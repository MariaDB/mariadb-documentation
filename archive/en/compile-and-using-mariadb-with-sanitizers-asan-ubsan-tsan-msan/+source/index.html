<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN) - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN) - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/solutions" title="Solutions">Solutions</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="Company">Company</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-administration/">MariaDB Administration</a>
    

    
    » <a class="crumb" href="/kb/en/getting-installing-and-upgrading-mariadb/">Getting, Installing, and Upgrading MariaDB</a>
    

    
    » <a class="crumb" href="/kb/en/compiling-mariadb-from-source/">Compiling MariaDB From Source</a>
    


    » <a class="node_link crumb" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/">Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN)</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN) - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+r/151742/">151742</a></dd>
            <dt>User</dt>
            <dd>
<span class="user" id="user-7">
<a href="/kb/user/id/7" title="Michael Widenius">Michael Widenius</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2025-05-05 23:37">2025-05-05 23:37</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">&lt;&lt;toc&gt;&gt;

== What are Sanitizers?

Sanitizers are open source runtime error detectors developed by Google that are enabled during the compile step. These sanitizers add extra code during compilation that will throw exceptions when certain errors are detected.

[[https://github.com/google/sanitizers/wiki/AddressSanitizer|AddressSanitizer (aka ASAN)]] is a memory error detector for C/C++. It finds a lot of the same things as [[compiling-mariadb-for-debugging|valgrind]], but with a lot less overhead.

 *  Use after free (dangling pointer dereference)
 *  Heap buffer overflow
 *  Stack buffer overflow
 *  Global buffer overflow
 *  Use after return
 *  Use after scope
 *  Initialization order bugs
 *  Memory leaks

At the moment the clang based sanitizers are more comprehensive than gcc.

In addition to ASAN there are sanitizers for Undefined Behaviour, Thread and Memory related errors.

[[https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html|UndefinedBehaviourSanitizer (aka UBSAN)]] 

[[https://clang.llvm.org/docs/ThreadSanitizer.html|ThreadSanitizer (aka TSAN)]]

[[https://clang.llvm.org/docs/MemorySanitizer.html|MemorySanitizer (aka MSAN)]]

== How to Compile MariaDB with Sanitizers

Before using ASAN locally, please ensure that it is installed on the system:

You can use one of the two following build commands:
&lt;&lt;code&gt;&gt;
cmake  -DWITH_ASAN=ON /source
&lt;&lt;/code&gt;&gt;

Additionally, UBSAN, TSAN, and MSAN can be enabled in a similar way:

UBSAN:
&lt;&lt;code&gt;&gt;
cmake -DWITH_UBSAN=ON /source
&lt;&lt;/code&gt;&gt;

TSAN:
&lt;&lt;code&gt;&gt;
cmake -DWITH_TSAN=ON /source
&lt;&lt;/code&gt;&gt;

MSAN:

Note: keep in mind that only clang supports MSAN, g++ or other compilers will not work.
&lt;&lt;code&gt;&gt;
cmake -DWITH_MSAN=ON /source
&lt;&lt;/code&gt;&gt;

== Running an MSAN Build

The time consuming aspect of building with MSAN is having [[instrumented system libraries|https://github.com/MariaDB/buildbot/blob/main/ci_build_images/msan.instrumentedlibs.sh]]. As MariaDB Foundation have built the MSAN container already for buildbot, this is how you re-use this for building locally.

First, run the container where your current directory is the source directory:
&lt;&lt;code&gt;&gt;
podman run -v $PWD:/source:z \
  --rm \
  -ti \
  --entrypoint bash \
  --mount=type=tmpfs,tmpfs-size=10G,dst=/build \
  --workdir /build \
   quay.io/mariadb-foundation/bb-worker:debian12-msan-clang-20
&lt;&lt;/code&gt;&gt;

== Docker/Podman Command Table ==

| **Command Component** | **Purpose** | **Notes** |
| podman run | run a container | other implementations use docker syntax (or at at least close) |
| --rm | remove container on termination | |
| -ti | a tty and a stdin are connected | for interactive container use |
| -v &#34;$PWD&#34;:/source:z | mount current directory as /source inside the container - :z - read selinux label | |
| --mount=type=tmpfs,tmpfs-size=10G,dst=/build | a 10G build directory and mtr | keeps as transient, big enough for some mtr tests |
| --workdir /build | default directory | |
| --entrypoint bash | Ensure the cmd of buildbot start isn&#39;t executed | |
| --cap-add=SYS_PTRACE | capability for tracing used by gdb | for debugging |
| **Extra options** || ||
| --name containername | useful if running multiple to keep track | Used as a name for a new session in the container (podman exec -ti containername bash) |
| --shm-size=10g | Size of /dev/shm as alternate for mtr tests | Default is unsable 64k, This is large enough for most --big-tests with some parallelism |
| --privileged | Allow rr recording | Note security impacting, don&#39;t run untrusted code as root |
| -v $DATADIR:/var/lib/mysql:Z | Mount an existing datadir | For testing against some prepared data |

Notes:
* docker can be used instead of the lighter weight podman if you so desired.
* /dev/shm is mounted no-exec so it rr recording here cannot be replayed while in that location
* optionally can make /build a filesystem mount to preserve the build.

All the following instructions are executed within the container - there is a document in /etc/motd that contains the latest information. Now run the configure stage of cmake:
&lt;&lt;code&gt;&gt;
cmake \
      -DWITH_MSAN=ON  \
      -DCMAKE_{EXE,MODULE}_LINKER_FLAGS=&#34;-L${MSAN_LIBDIR} -Wl,-rpath=${MSAN_LIBDIR}&#34; \
      -DHAVE_CXX_NEW=1  \
      -DWITH_INNODB_{BZIP2,LZ4,LZMA,LZO,SNAPPY}=OFF \
      -DWITH_ZLIB=bundled  \
      -DWITH_NUMA=NO  \
      -DWITH_SYSTEMD=no \
      -DHAVE_LIBAIO_H=0    \
      -DCMAKE_DISABLE_FIND_PACKAGE_{URING,LIBAIO}=1  \
      -DPLUGIN_{MROONGA,ROCKSDB,OQGRAPH}=NO  \
      -DWITH_EMBEDDED_SERVER=OFF \
      /source
&lt;&lt;/code&gt;&gt;

| **CMake Options** | **Why** |
| ##WITH_MSAN=ON## | Enables MSAN build in compile options |
| ##CMAKE_{EXE,MODULE}_LINKER_FLAGS## | links executables and shared libraries against the instrumented libraries with a rpath so a LD_LIBRARY_PATH env isn&#39;t required |
| ##WITH_INNODB_{BZIP2,LZ4,LZMA,LZO,SNAPPY}=OFF## | system libraries for these haven&#39;t been MSAN instrumented currently |
| ##HAVE_CXX_NEW## | Works around a ODR violation |
| ##WITH_ZLIB=bundled## | This hasn&#39;t been MSAN instrumented currently |
| ##WITH_NUMA## / ##WITH_SYSTEMD## | both uninstrumented  |
| ##HAVE_LIBAIO_H=0 / CMAKE_DISABLE_FIND_PACKAGE_LIBAIO## | AIO currently not MSAN instrumented |
| ##CMAKE_DISABLE_FIND_PACKAGE_URING=NO## |  Uninstrumented MDEV-36482, and required seccomp adjustment or --privileged to work |
| ## PLUGIN_OQGRAPH## (and ##PLUGIN_COLUMNSTORE##) | Dependency on boost libraries are instrumented | 
| ##WITH_EMBEDDED_SERVER=OFF## |  reduce build time |
| ##WITH_DBUG_TRACE=OFF## | reduce runtime overhead if ##CMAKE_BUILD_TYPE=Debug## chosen |

Run the build stage:
&lt;&lt;code&gt;&gt;
cmake --build . 
...
[100%] Built target mariadbd
[100%] Linking CXX executable mariadb-backup
Creating mariabackup link
[100%] Built target mariadb-backup
&lt;&lt;/code&gt;&gt;

As the MSAN has rpath defined in its compile option there is no need for LD_LIBRARY_PATH manipulation.

To run tests:
&lt;&lt;code&gt;&gt;
mysql-test/mtr   (usual mtr options)
&lt;&lt;/code&gt;&gt;

As newer versions occur and improvements happen these instructions may change. Look at the execution on the [[https://buildbot.mariadb.org/#/builders/amd64-debian-11-msan|buildbot builder]] to see if any changes have been made.

== Running an ASAN Build

To run mariadbd with instrumentation you have to set the ##ASAN_OPTIONS## environment variable before starting ##mariadbd## including starting ##mariadbd## when running mtr.
&lt;&lt;code&gt;&gt;
export ASAN_OPTIONS=abort_on_error=1
&lt;&lt;/code&gt;&gt;

The above command will abort any instrumented executable if any errors are found, which is good for debugging.  If you set abort_on_error=0 all server errors are logged to your error log file (mysqld.err).

To catch errors for other processes than the server, you can set more options, like this:
&lt;&lt;code&gt;&gt;
export ASAN_OPTIONS=abort_on_error=1:log_path=/tmp/asan
&lt;&lt;/code&gt;&gt;
If you are seeing an incomplete stack trace for a memory allocation, you may rerun the failing test with
&lt;&lt;code&gt;&gt;
export ASAN_OPTIONS=abort_on_error=1:log_path=/tmp/asan:fast_unwind_on_malloc=0
&lt;&lt;/code&gt;&gt;
To get core dumps of failures:
&lt;&lt;code&gt;&gt;
export ASAN_OPTIONS=abort_on_error=1:disable_coredump=0
&lt;&lt;/code&gt;&gt;
To see all the options (or to check if an executable is instrumented), you may try the following:
&lt;&lt;code&gt;&gt;
ASAN_OPTIONS=help=1 extra/perror 0
&lt;&lt;/code&gt;&gt;

=== Using Valgrind

The [[mysqltest|MariaDB test system]] can use [[http://www.valgrind.org|Valgrind]] for finding memory leaks and wrong memory accesses. Valgrind is an instrumentation framework for building dynamic analysis tools.  If Valgrind is installed on your system, you can simply use [[mysql-test-runpl-options/#options-for-valgrind|mysql-test-run --valgrind]] to run the test under Valgrind.

== See Also
* [[compiling-mariadb-for-debugging|Compiling MariaDB for debugging]]</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/solutions" title="Solutions">Solutions</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">Company</a></h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        
                        
                        <li>
                            <h5><a href="https://mariadb.com/downloads" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>