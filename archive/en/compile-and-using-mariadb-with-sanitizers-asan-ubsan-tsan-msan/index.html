<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN) - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN)" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="How to compile and use MariaDB with AddressSanitizer (ASAN), MemorySanitizer (MSAN), UndefinedBehaviorSantiizer (UBSAN), or ThreadSantizer (TSAN)" />

    <meta name="description" content="How to compile and use MariaDB with AddressSanitizer (ASAN), MemorySanitizer (MSAN), UndefinedBehaviorSantiizer (UBSAN), or ThreadSantizer (TSAN)" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes products nodes_view jqui" id="nodes_view">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/en/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/en/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/solutions" title="Solutions">Solutions</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="Company">Company</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/en/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/en/documentation/">MariaDB Server Documentation</a>
    

    
    » <a class="crumb" href="/kb/en/mariadb-administration/">MariaDB Administration</a>
    

    
    » <a class="crumb" href="/kb/en/getting-installing-and-upgrading-mariadb/">Getting, Installing, and Upgrading MariaDB</a>
    

    
    » <a class="crumb" href="/kb/en/compiling-mariadb-from-source/">Compiling MariaDB From Source</a>
    


    » <a class="node_link crumb" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/">Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN)</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/en/">Home</a></li>
                            
                                
                                    <li><a href="/kb/en/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/en/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/en/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/en/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/en/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
<div>



<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+history" rel="nofollow">History</a>
        
        
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+source/">Source</a>
        
        <a class="btn btn-block btn-blue btn-sm flag" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+flag"
                data-flag-url="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+flag" rel="nofollow">
                Flag as Spam / Inappropriate</a>
        
        <a class="btn btn-block btn-blue btn-sm" href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+translate/">
                Translate</a>
        

</div>
</div>





<div class="well well-small box node_info"><div>

    <dl>
        <dt>Created</dt>
        <dd>

<span class="datetime" title="2018-09-06 10:06">6 years, 8 months ago</span></dd>

        <dt>Modified</dt>
        <dd>

<span class="datetime" title="2025-05-06 23:44">18 minutes ago</span></dd>

        <dt>Type</dt>
        <dd>article</dd>

        <dt>Status</dt>
        <dd>active</dd>

        <dt>License</dt>
        <dd>
            
                <a href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+license/">CC BY-SA / Gnu FDL</a>
            
        </dd>

        
    </dl>

    
    <ul class="rss_feeds">
        <li><a href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+history/feed/">
            History</a>
        </li>
        <li><a href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+comments/feed/">
            Comments</a>
        </li>
    </ul>
    

</div>
</div>





    
    
    

<div class="well well-small box attachments"><div><div class="edit_link pull-right"><a href="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+edit/attachments/">Edit</a></div><h5>Attachments</h5></div><div>

        
            <div class="no_data">No attachments exist</div>
        
    
</div>
</div>

    



    
    





    

<div class="well well-small box"><div><h5>Parents</h5></div><div>

        <ul>
            
                <li><a href="/kb/en/compiling-mariadb-from-source/">Compiling MariaDB From Source</a></li>
            
                <li><a href="/kb/en/debugging-mariadb/">Debugging MariaDB</a></li>
            
        </ul>
    
</div>
</div>



</div>


                    

































                </aside>
            
            
            
                
            
            
                
            
            <section id="content" class="limited_width col-md-8 clearfix">
                
                    <h1>Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN)</h1>
                

                



                <div>
                    
    

    
    
    

    <div class="node creole">
        
        
        


    
    <div class="answer formatted">
        <div class="table_of_contents well well-small">
<h3>Contents</h3>
 <ol class="toc">

    <li class=""><a href="#what-are-sanitizers" title="What are Sanitizers?">What are Sanitizers?</a></li>

    <li class=""><a href="#how-to-compile-mariadb-with-sanitizers" title="How to Compile MariaDB with Sanitizers">How to Compile MariaDB with Sanitizers</a></li>

    <li class=""><a href="#buildbots-msan-container" title="Buildbot&#39;s MSAN container">Buildbot&#39;s MSAN container</a>    <ol class="toc">

        <li class=""><a href="#running-the-msan-container" title="Running the MSAN container">Running the MSAN container</a></li>

        <li class=""><a href="#running-an-msan-build" title="Running an MSAN Build">Running an MSAN Build</a>        <ol class="toc">

            <li class=""><a href="#bug-reporting" title="Bug Reporting">Bug Reporting</a>        </ol>
</li>

        <li class=""><a href="#running-an-combined-asan-and-ubsan-build" title="Running an combined ASAN and UBSAN Build">Running an combined ASAN and UBSAN Build</a>        <ol class="toc">

            <li class=""><a href="#bug-reporting" title="Bug Reporting">Bug Reporting</a>        </ol>
</li>

        <li class=""><a href="#using-rr" title="Using RR">Using RR</a>    </ol>
</li>

    <li class=""><a href="#asan-options" title="ASAN Options">ASAN Options</a>    <ol class="toc">

        <li class=""><a href="#using-valgrind" title="Using Valgrind">Using Valgrind</a>    </ol>
</li>

    <li class=""><a href="#see-also" title="See Also">See Also</a> </ol>
</li>
</div>
<h2 class="anchored_heading" id="what-are-sanitizers">What are Sanitizers?</h2>
<p>Sanitizers are open source runtime error detectors developed by Google that are enabled during the compile step. These sanitizers add extra code during compilation that will throw exceptions when certain errors are detected.</p>
<p>Sanitizers find server bugs bug instrumenting the runtime MariaDB during compile time, and performing runtime checks on the executed test. Sanitizers detect a variety of implementation defects:</p>
<p>The sanitizers for clang are:</p>
<ul start="1"><li><a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer (aka ASAN)</a>
</li><li><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UndefinedBehaviourSanitizer (aka UBSAN)</a> 
</li><li><a href="https://clang.llvm.org/docs/ThreadSanitizer.html">ThreadSanitizer (aka TSAN)</a>
</li><li><a href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer (aka MSAN)</a>
</li></ul>
<h2 class="anchored_heading" id="how-to-compile-mariadb-with-sanitizers">How to Compile MariaDB with Sanitizers</h2>
<p>Before using ASAN locally, please ensure that it is installed on the system:</p>
<p>You can use one of the two following build commands:</p>
<pre class="fixed">cmake  -DWITH_ASAN=ON /source
</pre><p>Additionally, UBSAN, TSAN, and MSAN can be enabled in a similar way:</p>
<p>UBSAN:</p>
<pre class="fixed">cmake -DWITH_UBSAN=ON /source
</pre><p>TSAN:</p>
<pre class="fixed">cmake -DWITH_TSAN=ON /source
</pre><p>MSAN:</p>
<pre class="fixed">cmake -DWITH_MSAN=ON /source
</pre><p>Important to note MSAN requires instrumented c++ and system libraries to have a functioning build per container guide below. </p>
<h2 class="anchored_heading" id="buildbots-msan-container">Buildbot's MSAN container</h2>
<p>The time consuming aspect of building with MSAN is having <a href="https://github.com/MariaDB/buildbot/blob/main/ci_build_images/msan.instrumentedlibs.sh">instrumented system libraries</a>. To help with this MariaDB Foundation has built the MSAN container for buildbot, but this is reusable locally.</p>
<p>The MariaDB Buildbot MSAN container,  <code>quay.io/mariadb-foundation/bb-worker/debian12-msan-clang-20</code>  a container with:</p>
<ul start="1"><li>the instrumented libraries required for MSAN
</li><li>a very modern clang version
</li><li>the latest stable Debian as a base image
</li><li>a compiled <a href="https://rr-project.org/">rr</a> for debugging
</li></ul>
<p>The build of this container isn't hard coded to MSAN so it can be used for:</p>
<ul start="1"><li>A general Debian build container
</li><li>Using the gcc/g++ of Debian (by removing the CC and CXX environment variables
</li><li>Compiling with a latest clang
</li><li>Compiling with the ASAN/UBSAN feature available in the latest clang
</li></ul>
<h3 class="anchored_heading" id="running-the-msan-container">Running the MSAN container</h3>
<p>First, run the container where your current directory is the source directory:</p>
<pre class="fixed">podman run -v $PWD:/source:z \
  --rm \
  -ti \
  --entrypoint bash \
  --mount=type=tmpfs,tmpfs-size=10G,dst=/build \
  --workdir /build \
   quay.io/mariadb-foundation/bb-worker:debian12-msan-clang-20
</pre><p>The purposes of these, and other options include:</p>
<div class="cstm-style darkheader-nospace-borders"><table><tr><th>Command Component</th><th>Purpose</th><th>Notes</th></tr>
<tr><td>podman run</td><td>run a container</td><td>other implementations use docker syntax (or at at least close)</td></tr>
<tr><td>--rm</td><td>remove container on termination</td><td></td></tr>
<tr><td>-ti</td><td>a tty and a stdin are connected</td><td>for interactive container use</td></tr>
<tr><td>-v "$PWD":/source:z</td><td>mount current directory as /source inside the container - :z - read selinux label</td><td></td></tr>
<tr><td>--mount=type=tmpfs,tmpfs-size=10G,dst=/build</td><td>a 10G build directory and mtr</td><td>keeps as transient, big enough for some mtr tests</td></tr>
<tr><td>--workdir /build</td><td>default directory</td><td></td></tr>
<tr><td>--entrypoint bash</td><td>Ensure the cmd of buildbot start isn't executed</td><td></td></tr>
<tr><td>--cap-add=SYS_PTRACE</td><td>capability for tracing used by gdb</td><td>for debugging</td></tr>
<tr><td><strong>Extra options</strong></td><td></td></tr>
<tr><td>--name containername</td><td>useful if running multiple to keep track</td><td>Used as a name for a new session in the container (podman exec -ti containername bash)</td></tr>
<tr><td>--shm-size=10g</td><td>Size of /dev/shm as alternate for mtr tests</td><td>Default is unsable 64k, This is large enough for most --big-tests with some parallelism</td></tr>
<tr><td>--privileged</td><td>Allow rr recording</td><td>Note security impacting, don't run untrusted code as root</td></tr>
<tr><td>-v $DATADIR:/var/lib/mysql:Z</td><td>Mount an existing datadir</td><td>For testing against some prepared data</td></tr>
</table>
</div><p>Notes:</p>
<ul start="1"><li>docker can be used instead of the lighter weight podman if you so desired.
</li><li>/dev/shm is mounted no-exec so it rr recording here cannot be replayed while in that location
</li><li>optionally can make /build a filesystem mount to preserve the build.
</li></ul>
<p>There are environment variables that affect the cmake configure options and mtr are:</p>
<pre class="fixed">CXX=clang++
CC=clang
MSAN_LIBDIR=/msan-libs
CMAKE_GENERATOR=Ninja
MSAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer-20
WSREP_PROVIDER=/usr/lib/galera/libgalera_smm.so
MTR_PARALLEL=auto
ASAN_OPTIONS=quarantine_size_mb=512:atexit=0:detect_invalid_pointer_pairs=3:dump_instruction_bytes=1:allocator_may_return_null=1
UBSAN_OPTIONS=print_stacktrace=1:report_error_type=1
MSAN_OPTIONS=abort_on_error=1:poison_in_dtor=0
</pre><p>Note: galera WSREP_PROVIDER isn't instrumented with any sanitizer</p>
<p>Check the latest version of these running <code>env</code>.</p>
<h3 class="anchored_heading" id="running-an-msan-build">Running an MSAN Build</h3>
<p>Once you have started the MSAN container this is how you perform a MSAN build.</p>
<p>The time consuming aspect of building with MSAN is having <a href="https://github.com/MariaDB/buildbot/blob/main/ci_build_images/msan.instrumentedlibs.sh">instrumented system libraries</a>.</p>
<p>All the following instructions are executed within the container - there is a document in /etc/motd that contains the latest information. Start by running the configure stage of <code>cmake</code>:</p>
<pre class="fixed">cmake \
      -DUPDATE_SUBMODULES=OFF \
      -DWITH_MSAN=ON  \
      -DCMAKE_{EXE,MODULE}_LINKER_FLAGS=&#34;-L${MSAN_LIBDIR} -Wl,-rpath=${MSAN_LIBDIR}&#34; \
      -DHAVE_CXX_NEW=1  \
      -DWITH_INNODB_{BZIP2,LZ4,LZMA,LZO,SNAPPY}=OFF \
      -DWITH_ZLIB=bundled  \
      -DWITH_NUMA=NO  \
      -DWITH_SYSTEMD=NO \
      -DHAVE_LIBAIO_H=0    \
      -DCMAKE_DISABLE_FIND_PACKAGE_{URING,LIBAIO}=1  \
      -DPLUGIN_{MROONGA,ROCKSDB,OQGRAPH}=NO  \
      -DWITH_EMBEDDED_SERVER=OFF \
      /source
</pre><p> MSAN is a clang only compile options and other compilers will not work.</p>
<div class="cstm-style darkheader-nospace-borders"><table><tr><th>CMake Options</th><th>Why</th></tr>
<tr><td><code>UPDATE_SUBMODULES=OFF</code></td><td>The source directory is read-only so cannot be updated from within the container</td></tr>
<tr><td><code>WITH_MSAN=ON</code></td><td>Enables MSAN build in compile options</td></tr>
<tr><td><code>CMAKE_{EXE,MODULE}_LINKER_FLAGS</code></td><td>links executables and shared libraries against the instrumented libraries with a rpath so a LD_LIBRARY_PATH environment variable isn't required</td></tr>
<tr><td><code>WITH_INNODB_{BZIP2,LZ4,LZMA,LZO,SNAPPY}=OFF</code></td><td>system libraries for these haven't been MSAN instrumented currently</td></tr>
<tr><td><code>HAVE_CXX_NEW</code></td><td>Works around a ODR violation</td></tr>
<tr><td><code>WITH_ZLIB=bundled</code></td><td>This hasn't been MSAN instrumented currently</td></tr>
<tr><td><code>WITH_NUMA</code> / <code>WITH_SYSTEMD</code></td><td>both uninstrumented</td></tr>
<tr><td><code>HAVE_LIBAIO_H=0 / CMAKE_DISABLE_FIND_PACKAGE_LIBAIO</code></td><td>AIO currently not MSAN instrumented</td></tr>
<tr><td><code>CMAKE_DISABLE_FIND_PACKAGE_URING=NO</code></td><td>Uninstrumented <a href="https://jira.mariadb.org/browse/MDEV-36482">MDEV-36482</a>, and required seccomp adjustment or --privileged to work</td></tr>
<tr><td><code> PLUGIN_OQGRAPH</code> (and <code>PLUGIN_COLUMNSTORE</code>)</td><td>Dependency on boost libraries are instrumented</td></tr>
<tr><td><code>WITH_EMBEDDED_SERVER=OFF</code></td><td>reduce build time</td></tr>
<tr><td><code>WITH_DBUG_TRACE=OFF</code></td><td>reduce runtime overhead if <code>CMAKE_BUILD_TYPE=Debug</code> chosen</td></tr>
<tr><td><code>CMAKE_CXX_FLAGS=-O2</code></td><td>Required with <code>CMAKE_BUILD_TYPE=Debug</code> to avoid <a href="https://jira.mariadb.org/browse/MDEV-36316">MDEV-36316</a>. Plan to incorporate into the basic build</td></tr>
</table>
</div><p>Run the build stage:</p>
<pre class="fixed">cmake --build . 
...
[100%] Built target mariadbd
[100%] Linking CXX executable mariadb-backup
Creating mariabackup link
[100%] Built target mariadb-backup
</pre><p>As the MSAN has rpath defined in its compile option there is no need for LD_LIBRARY_PATH manipulation.</p>
<p>To run tests:</p>
<pre class="fixed">mysql-test/mtr   (usual mtr options)
</pre><p>As newer versions occur and improvements happen these instructions may change. Look at the execution on the <a href="https://buildbot.mariadb.org/#/builders/amd64-debian-11-msan">buildbot builder</a> to see if any changes have been made.</p>
<h4 class="anchored_heading" id="bug-reporting">Bug Reporting</h4>
<p>Use the MSAN in the label when reporting bugs.</p>
<p>Current outstanding MSAN bugs can be found on <a href="https://jira.mariadb.org/issues/?jql=labels%20%3D%20MSAN%20and%20status%20!%3D%20Closed">JIRA by searching for this label</a>.</p>
<h3 class="anchored_heading" id="running-an-combined-asan-and-ubsan-build">Running an combined ASAN and UBSAN Build</h3>
<p>The clang implemented instrumentation of the MemoryStanitizer (MSAN) conflicts with the AddressSanitizer (ASAN) and UndefinedBehaviour (UBSAN) mechanisms, however ASAN and UBSAN can be combined into the same build.</p>
<p>After starting the MSAN container the following will configure a combined ASAN and UBSAN build:</p>
<pre class="fixed">cmake \
      -DUPDATE_SUBMODULES=OFF \
      -DWITH_ASAN=ON  \
      -DWITH_ASAN_SCOPED=ON \
      -DWITH_UBSAN=ON  \
      -DWITH_UNIT_TESTS=OFF \
     /source
</pre><div class="cstm-style darkheader-nospace-borders"><table><tr><th>CMake Options</th><th>Why</th></tr>
<tr><td><code>UPDATE_SUBMODULES=OFF</code></td><td>The source directory is read-only so cannot be updated from within the container</td></tr>
<tr><td><code>WITH_ASAN=ON</code></td><td>Enables ASAN build in compile options</td></tr>
<tr><td><code>WITH_ASAN_SCOPED=ON</code></td><td>Enables <a href="https://github.com/google/sanitizers/wiki/AddressSanitizerUseAfterScope">Address Sanitizer User after Scope checking</a></td></tr>
<tr><td><code>WITH_UBSAN=ON</code></td><td>Enables UBSAN build in compile options</td></tr>
<tr><td><code>WITH_UNIT_TESTS=OFF</code> or <code>PLUGIN_PERFSCHEMA=OFF</code></td><td>clang is incompatible with performance schema unit tests, at least one must be disabled (ref: <a href="https://jira.mariadb.org/browse/MDEV-22940">MDEV-22940</a>)</td></tr>
</table>
</div><p>Build and test run are standard.</p>
<p>Note: list of unfixed <a href="https://github.com/mariadb-corporation/mariadb-qa/blob/master/UBSAN.filter">UBSAN issues by MariaDB Corporation Testing</a>.</p>
<h4 class="anchored_heading" id="bug-reporting">Bug Reporting</h4>
<p>UBSAN bugs are labelled with <code>UBSAN</code> and also the short form of the undefined behaviour.</p>
<p>For example in the following output, the <code>insufficient-object-size</code> would be used as the additional short form of the label.</p>
<pre class="fixed">SUMMARY: UndefinedBehaviorSanitizer: insufficient-object-size /source/sql/item_strfunc.cc:5256:44 
 /source/sql/item_strfunc.cc:5256:44 
</pre><p>Likewise for ASAN, should use <code>ASAN</code> as the label with the short form of the ASAN type from the output.</p>
<h3 class="anchored_heading" id="using-rr">Using RR</h3>
<p>In the MSAN container there is a build version of the latest rr at the time of the container build.</p>
<p>A recording of the execution can be make with the <a href="%5Bmariadb-test-run-pl-options/#options-for-debugging-the-product">mariadb-test-run.pl option --rr</a>. Or alternately you can execute:</p>
<pre class="fixed">$ rr record sql/mariadbd ......
</pre><p>To replay a recording adjust per the test worker and instance used in the test:</p>
<pre class="fixed">$ rr replay mysql-test/var/log/mysqld.1.rr/mariadbd-0/
</pre><p>Using curl in the container its possible to save up this directory for another user or developer to use with the same container. This can also be shared with our <a href="/kb/en/mariadb-public-ftp-server/">public ftp server</a> for assistance diagnosing validating a bug report.</p>
<h2 class="anchored_heading" id="asan-options">ASAN Options</h2>
<p>To run <code>mariadbd</code> with instrumentation you have to set the <code>ASAN_OPTIONS</code> environment variable before starting <code>mariadbd</code> including starting <code>mariadbd</code> when running mtr.</p>
<pre class="fixed">export ASAN_OPTIONS=abort_on_error=1
</pre><p>The above command will abort any instrumented executable if any errors are found, which is good for debugging.  If you set abort_on_error=0 all server errors are logged to your error log file (mysqld.err).</p>
<p>To catch errors for other processes than the server, you can set more options, like this:</p>
<pre class="fixed">export ASAN_OPTIONS=abort_on_error=1:log_path=/tmp/asan
</pre><p>If you are seeing an incomplete stack trace for a memory allocation, you may rerun the failing test with</p>
<pre class="fixed">export ASAN_OPTIONS=abort_on_error=1:log_path=/tmp/asan:fast_unwind_on_malloc=0
</pre><p>To get core dumps of failures:</p>
<pre class="fixed">export ASAN_OPTIONS=abort_on_error=1:disable_coredump=0
</pre><p>To see all the options (or to check if an executable is instrumented), you may try the following:</p>
<pre class="fixed">ASAN_OPTIONS=help=1 extra/perror 0
</pre><h3 class="anchored_heading" id="using-valgrind">Using Valgrind</h3>
<p>The <a href="/kb/en/mysqltest/">MariaDB test system</a> can use <a href="http://www.valgrind.org">Valgrind</a> for finding memory leaks and wrong memory accesses. Valgrind is an instrumentation framework for building dynamic analysis tools.  If Valgrind is installed on your system, you can simply use <a href="/kb/en/mysql-test-runpl-options/#options-for-valgrind">mysql-test-run --valgrind</a> to run the test under Valgrind.</p>
<h2 class="anchored_heading" id="see-also">See Also</h2>
<ul start="1"><li><a href="/kb/en/compiling-mariadb-for-debugging/">Compiling MariaDB for debugging</a></li></ul>

    </div>


        
            <div id="subscribe" class="well well-small hide hidden-print"
                 data-subscribe-url="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+subscriptions/add"
                 data-unsubscribe-url="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+subscriptions/remove">
            </div>
        

        
        
    
        <div class="simple_section_nav">
            <ul class="nav nav-pills">
                
                    <li><a href="/kb/en/building-rpm-packages-from-source/">
                        ← Building RPM Packages From Source
                    </a>
                    </li>
                
                
                    <li><a href="/kb/en/compiling-mariadb-from-source/">
                        ↑ Compiling MariaDB From Source ↑
                    </a>
                    </li>
                
                
            </ul>
        </div>
    

        

        
        <h2>Comments</h2>
        
    
    <div id="comments" data-node-id="7875" data-comments-url="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/+comments"
         data-reply-url="/kb/en/compile-and-using-mariadb-with-sanitizers-asan-ubsan-tsan-msan/comments/post/">
        Comments loading...
    </div>

        

    </div>


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
                <div id="right_bar" class="col-md-2">
                    
    
        
        <ul class="section_navigation well well-small hidden-xs hidden-sm">
            
                <li class="parent"><a href="/kb/en/compiling-mariadb-from-source/">
                    ↑ Compiling MariaDB From Source ↑
                </a>
                </li>
            
            
                
                    <li>
                        <a href="/kb/en/get-build-and-test-latest-mariadb-the-lazy-way/">
                            
                            Get, Build and Test Latest MariaDB the Lazy Way
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/getting-the-mariadb-source-code/">
                            <span class="pull-right not_primary"></span>
                            MariaDB Source Code
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/Build_Environment_Setup_for_Linux/">
                            
                            Build Environment Setup for Linux
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/generic-build-instructions/">
                            
                            Generic Build Instructions
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/compiling-mariadb-with-extra-modulesoptions/">
                            
                            Compiling MariaDB with Extra Modules/Options
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/Creating_the_MariaDB_Source_Tarball/">
                            
                            Creating the MariaDB Source Tarball
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/creating-the-mariadb-binary-tarball/">
                            
                            Creating the MariaDB Binary Tarball
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/Build_Environment_Setup_for_Mac/">
                            
                            Build Environment Setup for Mac
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-from-a-source-rpm/">
                            
                            Building MariaDB from a Source RPM
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/source-building-mariadb-on-centos/">
                            
                            Building MariaDB on CentOS
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-on-fedora/">
                            
                            Building MariaDB on Fedora
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-on-debian/">
                            
                            Building MariaDB on Debian
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-on-freebsd/">
                            
                            Building MariaDB on FreeBSD
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/Building_MariaDB_on_Gentoo/">
                            
                            Building MariaDB on Gentoo
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-on-solaris-and-opensolaris/">
                            
                            Building MariaDB on Solaris and OpenSolaris
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-on-ubuntu/">
                            
                            Building MariaDB on Ubuntu
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/Building_MariaDB_on_Windows/">
                            
                            Building MariaDB on Windows
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/installing-mariadb-on-macos-using-homebrew/">
                            <span class="pull-right not_primary"></span>
                            Installing MariaDB Server on macOS Using Homebrew
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/compiling-with-the-innodb-plugin-from-oracle/">
                            
                            Compiling with the InnoDB Plugin from Oracle
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/Creating_a_Debian_Repository/">
                            
                            Creating a Debian Repository
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-mariadb-from-source-using-musl-based-gnulinux/">
                            
                            Building MariaDB From Source Using musl-based GNU/Linux
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/compiling-mariadb-for-debugging/">
                            <span class="pull-right not_primary"></span>
                            Compiling MariaDB for Debugging
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/cross-compiling-mariadb/">
                            
                            Cross-compiling MariaDB
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/compiling-mariadb-from-source-mariadb-source-configuration-options/">
                            
                            MariaDB Source Configuration Options
                        </a>
                    </li>
                
            
                
                    <li>
                        <a href="/kb/en/building-rpm-packages-from-source/">
                            
                            Building RPM Packages From Source
                        </a>
                    </li>
                
            
                
                    <li class="active">
                        <span>Compile and Using MariaDB with Sanitizers (ASAN, UBSAN, TSAN, MSAN)</span>
                        
                    </li>
                
            
        </ul>
    
    

                </div>
            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/solutions" title="Solutions">Solutions</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">Company</a></h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        
                        
                        <li>
                            <h5><a href="https://mariadb.com/downloads" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>