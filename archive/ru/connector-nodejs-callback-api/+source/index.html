<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>Connector/Node.js Callback API - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.f7633538c846.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="Connector/Node.js Callback API - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/ru/connector-nodejs-callback-api/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/ru/connector-nodejs-callback-api/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2025 MariaDB. All rights reserved.</p>
    </div>
</div>
<div class="violator-wrap d-none" id="top_violator">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12">
                <div class="violator-outer">
                    <div class="violator-inner">
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-lg-7 col-lg-offset-2" id="top_violator_content">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="content-link" target="_blank" rel="nofollow noreferrer">
                                    <span>The Ultimate Guide to High Availability with MariaDB</span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-sm-3" id="top_violator_cta">
                                <a href="https://go.mariadb.com/high-availability-guide-MariaDB-whitepaper.html" class="btn btn-mariadb" target="_blank" rel="nofollow noreferrer">Download Now</a>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link close-btn">
                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="15px" height="15px"><path d="M 4.9902344 3.9902344 A 1.0001 1.0001 0 0 0 4.2929688 5.7070312 L 10.585938 12 L 4.2929688 18.292969 A 1.0001 1.0001 0 1 0 5.7070312 19.707031 L 12 13.414062 L 18.292969 19.707031 A 1.0001 1.0001 0 1 0 19.707031 18.292969 L 13.414062 12 L 19.707031 5.7070312 A 1.0001 1.0001 0 0 0 18.980469 3.9902344 A 1.0001 1.0001 0 0 0 18.292969 4.2929688 L 12 10.585938 L 5.7070312 4.2929688 A 1.0001 1.0001 0 0 0 4.9902344 3.9902344 z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/ru/connector-nodejs-callback-api/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/ru/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/ru/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/ru/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/ru/mariadb/">MariaDB - Russian</a>
    


    » <a class="node_link crumb" href="/kb/ru/connector-nodejs-callback-api/">Connector/Node.js Callback API</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/ru/">Начало</a></li>
                            
                                
                                <li><a href="/kb/ru/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/ru/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/ru/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/ru/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/ru/connector-nodejs-callback-api/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>Connector/Node.js Callback API - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/ru/connector-nodejs-callback-api/+r/114354/">114354</a></dd>
            <dt>Пользователь</dt>
            <dd>
<span class="user" id="user-12018">
<a href="/kb/user/id/12018" title="Nikita Ivanov">Nikita Ivanov</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2022-03-03 15:59">2022-03-03 15:59</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">= Документация

Существует две различные реализации соединения: одна, по умолчанию, использует Promise, а другая - Callback, что обеспечивает совместимость с API mysql и mysql2.  В документации, представленной на этой странице, используется Callback.  Если вам нужна информация об API Promise, смотрите   [[connector-nodejs-promise-api|documentation]]. 


== Быстрый старт

Установите mariadb Connector используя npm

&lt;&lt;code&gt;&gt;
$ npm install mariadb
&lt;&lt;/code&gt;&gt;

Затем вы можете использовать коннектор в коде вашего приложения с помощью Callback API. Например,

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
  const mariadb = require(&#39;mariadb/callback&#39;);
  const conn = mariadb.createConnection({host: &#39;mydb.com&#39;, user:&#39;myUser&#39;, password: &#39;myPwd&#39;});
  conn.query(&#34;SELECT 1 as val&#34;, (err, rows) =&gt; {
      console.log(rows); //[ {val: 1}, meta: ... ]
      conn.query(&#34;INSERT INTO myTable value (?, ?)&#34;, [1, &#34;mariadb&#34;], (err, res) =&gt; {
        console.log(res); // { affectedRows: 1, insertId: 1, warningStatus: 0 }
        conn.end();
      });
  });
&lt;&lt;/code&gt;&gt;


== Установка

Чтобы использовать коннектор, сначала необходимо установить его в вашей системе. Процесс установки для Promise и Callback API управляется одним и тем же пакетом через npm. 

&lt;&lt;code&gt;&gt;
$ npm install mariadb
&lt;&lt;/code&gt;&gt;

Чтобы использовать коннектор, необходимо импортировать пакет в код вашего приложения.  Учитывая, что Callback API не используется по умолчанию, оператор `require()` немного отличается.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
&lt;&lt;/code&gt;&gt;

Это инициализирует константу `mariadb`, которая настроена на использование Callback API, а не Promise API по умолчанию.


== Часовой пояс

Это не рекомендуется, но в некоторых случаях Node.js и база данных настроены на разный часовой пояс. 

По умолчанию опция `timezone` установлена в значение &#39;local&#39;, что указывает на использование часового пояса клиента, поэтому преобразование не будет производиться.

Если часовой пояс клиента и сервера отличается, опция `timezone` должна быть установлена на часовой пояс сервера.
- Значение &#39;auto&#39; означает, что клиент будет запрашивать часовой пояс сервера при создании соединения, а в дальнейшем будет использовать часовой пояс сервера. 
- Чтобы избежать этой дополнительной команды при подключении, `timezone` может быть установлен в значение [[https://en.wikipedia.org/wiki/List_of_tz_database_time_zones|IANA time zone]]. 

Коннектор будет преобразовывать дату в часовой пояс сервера, а не в текущий часовой пояс Node.js. 


= Callback API

Коннектор с Callback API похож на коннектор с использованием Promise, но с некоторыми отличиями.


**Base:**

* [[#createconnectionoptions-connection|createConnection(options) → Connection]]: Создает соединение с сервером MariaDB.
* [[#createpooloptions-pool|createPool(options) → Pool]] : Создает новый пул.
* [[#createpoolclusteroptions-poolcluster|createPoolCluster(options) → PoolCluster]] : Создает новый кластер пула.


**Connect:**

* [[#connectionquerysql-values-callback-emitter|connection.query(sql[, values][, callback]) → Emitter]]: Выполняет запрос.
* [[#connectionbatchsql-values-callback|connection.batch(sql, values[, callback])]]: быстрая пакетная обработка.
* [[#connectionbegintransactioncallback|connection.beginTransaction([callback])]]: Начинает транзакцию.
* [[#connectioncommitcallback|connection.commit([callback])]]: Зафиксировать текущую транзакцию, если таковая имеется.
* [[#connectionrollbackcallback|connection.rollback([callback])]]: Откатывает текущую транзакцию, если таковая имеется.
* [[#connectionchangeuseroptions-callback|connection.changeUser(options[, callback])]]: Изменяет текущего пользователя соединения.
* [[#connectionpingcallback|connection.ping([callback])]]: Отправляет пустой пакет на сервер, чтобы проверить, что соединение активно.
* [[#connectionendcallback|connection.end([callback])]]: Закрывает соединение.
* [[#connectionreset|connection.reset([callback])]]: сброс текущего состояния соединения.
* [[#connectionisvalid-boolean|connection.isValid() → boolean]]: Проверяет, активно ли соединение без проверки состояния сокета.
* [[#connectiondestroy|connection.destroy()]]: Принудительное закрытие соединения. 
* [[#connectionpause|connection.pause()]]: Приостанавливает вывод сокета.
* [[#connectionresume|connection.resume()]]: Возобновляет вывод сокета.
* [[#connectionserverversion|connection.serverVersion()]]: Получает текущую версию сервера.
* [[#events|events]]: Подписка на события об ошибках соединения.

**Pool:**

* [[#poolgetconnectioncallback|pool.getConnection([callback])]] : Создает новое соединение.
* [[#poolquerysql-values-callback|pool.query(sql[, values][, callback])]]: Выполняет запрос.
* [[#poolbatchsql-values-callback|pool.batch(sql, values[, callback])]]: Выполняет пакет.
* [[#poolendcallback|pool.end([callback])]]: Благородно закрывает соединение.
* pool.activeConnections() → Number: Получает номер текущего активного соединения.
* pool.totalConnections() → Number: Получает текущее общее количество соединений.
* pool.idleConnections() → Number: Получает текущее количество неиспользуемых соединений.
* pool.taskQueueSize() → Number: Получает текущий стекированный запрос.
* [[#pool-events-1|pool events]]: Подписка на события пула.

**PoolCluster:**

* [[#poolclusteraddid-config|poolCluster.add(id, config)]] : добавить пул в кластер.
* [[#poolclusterremovepattern|poolCluster.remove(pattern)]] : удаление и завершение пула в соответствии с шаблоном.
* [[#poolclusterendcallback|poolCluster.end([callback])]] : завершить кластер.
* [[#poolclustergetconnectionpattern-selector-callback|poolCluster.getConnection([pattern, ][selector, ]callback)]] : возвращает соединение из кластера.
* [[#poolcluster-events|poolCluster events]]: подписывается на события кластера пула.
* [[#poolclusterofpattern-selector-filteredpoolcluster|poolCluster.of(pattern, selector) → FilteredPoolCluster]] : возвращает подмножество кластера.


= Base API

== createConnection(options) → Connection

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `options`: *JSON/String* Использует те же опции, что и Promise API. Для получения полного списка см. [[/documentation/connection-options.md|option documentation]].

 Возвращает объект Connection.
&lt;&lt;/style&gt;&gt;

Создает новое соединение.

Разница между этим методом и аналогичным методом с Promise API заключается в том, что этот метод возвращает объект `Connection`, а не Promise, который разрешается в объект `Connection`.

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const conn = mariadb.createConnection({
      host: &#39;mydb.com&#39;, 
      user:&#39;myUser&#39;,
      password: &#39;myPwd&#39;
    });
conn.connect(err =&gt; {
  if (err) {
    console.log(&#34;не удалось подключиться из-за ошибки: &#34; + err);
  } else {
    console.log(&#34;подключено ! идентификатор соединения равен &#34; + conn.threadId);
  }
});
&lt;&lt;/code&gt;&gt;

=== Connection options

Список основных опций:

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**user** | Пользователь для доступа к базе данных. |*string* | | 
|=**user** | Пользователь для доступа к базе данных. |*string* | |  
|=**password** | Пароль пользователя. |*string* | |  
|=**host** | IP-адрес или DNS сервера базы данных. *Не используется при использовании опции `socketPath`*. |*string*| &#34;localhost&#34;|.
|=**port** | Номер порта сервера базы данных. *Не используется при использовании опции `socketPath`*|*integer*| 3306|.
|=**ssl** | Включает поддержку TLS. Для получения дополнительной информации смотрите документацию [[/documentation/connection-options.md#ssl|ssl option]]. |*mixed*| | 
|=**database** | База данных по умолчанию, используемая при установлении соединения. | *string* | |   
|=**socketPath** | Разрешает соединения с базой данных через сокет домена Unix или именованный канал. | *string* | |  
|=**compress** | Сжимает обмен с базой данных с помощью gzip.  Это позволяет повысить производительность, когда база данных находится в другом месте.  |*boolean*| false|
|=**connectTimeout** | Устанавливает таймаут соединения в миллисекундах. |*integer* | 10 000|
|=**socketTimeout** | Устанавливает таймаут сокета в миллисекундах после успешного соединения. Значение `0` отключает таймаут. |*integer* | 0|
|=**rowsAsArray** | Возвращает наборы результатов в виде массивов, а не JSON. Это более быстрый способ получения результатов. Для получения дополнительной информации смотрите раздел Запрос. |*boolean* | false|
&lt;&lt;/style&gt;&gt;

Для получения дополнительной информации см. [[/documentation/connection-options.md|Connection Options]] documentation. 

=== Подключение к локальным базам данных 
При работе с локальной базой данных (то есть в случаях, когда MariaDB и ваше приложение Node.js работают на одном хосте), вы можете подключиться к MariaDB через сокет Unix или именованную трубу Windows для лучшей производительности, а не использовать уровень TCP/IP.

Чтобы настроить это, вам нужно присвоить соединению значение `socketPath`.  Когда это сделано, коннектор игнорирует параметры `host` и `port`.

Конкретный путь к сокету, который необходимо задать, определяется параметром 
[[https://mariadb.com/kb/en/library/server-system-variables/#socket|socket]] системной переменной сервера.  Если вы не знаете ее, вы можете получить ее с сервера.

&lt;&lt;code lang=&#34;sql&#34;&gt;&gt;
SHOW VARIABLES LIKE &#39;socket&#39;;
&lt;&lt;/code&gt;&gt;

По умолчанию это `/tmp/mysql.sock` в Unix-подобных операционных системах и `MySQL` в Windows.  Кроме того, в Windows эта функция работает только тогда, когда сервер запущен с опцией `--enable-named-pipe`.

Например, на Unix соединение может выглядеть следующим образом:

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const conn = mariadb.createConnection({ socketPath: &#39;/tmp/mysql.sock&#39;, user: &#39;root&#39; });
conn.connect(err =&gt; {
  //do something with connection
  conn.end();
});

&lt;&lt;/code&gt;&gt;

Это же имеет аналогичный синтаксис в Windows: 

&lt;&lt;code  lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const conn = mariadb.createConnection({ socketPath: &#39;\\\\.\\pipe\\MySQL&#39;, user: &#39;root&#39; });
&lt;&lt;/code&gt;&gt;


=== createPool(options) → Pool

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `options`: *JSON/string* [[#pool-options|pool options]]

 Возварщает объект [[#pool-api|Pool]]
&lt;&lt;/style&gt;&gt;

Создает новый пул.

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
pool.getConnection((err, conn) =&gt; {
  if (err) {
	console.log(&#34;не удалось подключиться из-за ошибки: &#34; + err);
  } else {
	console.log(&#34;подключено ! идентификатор соединения - &#34; + conn.threadId);
	conn.end(); //передача в пул
  }
});
&lt;&lt;/code&gt;&gt;

==== Варианты pool&#39;ов

Опции пула включают [[#connection-options| документацию по опциям соединения]], которые будут использоваться при создании новых соединений.

Конкретные варианты для pool&#39;ов - это :

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**acquireTimeout** | Время ожидания получения нового соединения из пула в мс. |*целое* | 10000 |
|=**connectionLimit** | Максимальное количество соединений в пуле. |*целое* | 10 |
|=**idleTimeout** | Укажите время простоя, после которого соединение с пулом будет освобождено. Значение должно быть меньше, чем [[https://mariadb.com/kb/en/library/server-system-variables/#wait_timeout]]. В секундах (0 означает никогда не освобождать|@@wait_timeout]] |*целое число* | 1800 |
|=**minimumIdle** | Разрешает установить минимальное количество соединений в пуле. **Рекомендация - использовать фиксированный пул, поэтому не устанавливать это значение**.|*integer* | *set to connectionLimit value* | *set to connectionLimit value*.
|=**minDelayValidation** | При запросе соединения в пул, пул будет проверять состояние соединения. &#34;minDelayValidation&#34; позволяет отключить эту проверку, если соединение было заимствовано недавно, избегая бесполезных проверок в случае частого повторного использования соединений. 0 означает, что проверка выполняется каждый раз, когда запрашивается соединение. (в мс)|*целое*| 500|
|=**noControlAfterUse** | После возврата соединения в пул (connection.end) коннектор сбросит или откатит соединение, чтобы убедиться, что оно действительно. Эта опция позволяет отключить эти элементы управления|*boolean*| false|
&lt;&lt;/style&gt;&gt;

== События в pool&#39;е

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**acquire** | Это событие означает, что соединение было получено из пула.  |
|=**connection** | Это событие возникает, когда в пул добавляется новое соединение. Имеет параметр объекта соединения |
|=**enqueue** | Это событие возникает, когда команда не может быть немедленно удовлетворена пулом и ставится в очередь. |
|=**release** | Это событие возникает, когда соединение возвращается обратно в пул. Имеет параметр объекта соединения|
&lt;&lt;/style&gt;&gt;

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
pool.on(&#39;connection&#39;, (conn) =&gt; console.log(`соединение ${conn.threadId} было создано в пуле`);
&lt;&lt;/code&gt;&gt;


=== createPoolCluster(options) → PoolCluster

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `options`: *JSON* [[#poolCluster-options|poolCluster options]]

 Возвращает объект [[#poolCluster-api|PoolCluster]],
&lt;&lt;/style&gt;&gt;

Создает новый кластер пулов. Кластер обрабатывает несколько пулов, обеспечивая высокую доступность / распределяя нагрузку (с использованием круговой / случайной / упорядоченной).

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);

const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });

//получение соединения от slave1 или slave2 с использованием round-robin
cluster.getConnection(/^slave*$/, &#34;RR&#34;, (err, conn) =&gt; {
  conn.query(&#34;SELECT 1&#34;, (err, rows) =&gt; {
	conn.end();
	return row[0][&#34;@node&#34;];
  });
});
&lt;&lt;/code&gt;&gt;


==== Параметры PoolCluster

Опции кластера пулов включают [[#pool-options|pool option documentation]], которые будут использоваться при создании новых пулов.

Специфическими опциями для кластера пулов являются :

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**canRetry** | Когда получение соединения из пула не удалось, кластер может повторить попытку с другими пулами |*boolean* | true |
|=**removeNodeErrorCount** | Максимальное количество последовательных ошибок соединения из пула перед удалением пула из конфигурации кластера. null означает, что узел не будет удален|*integer* | 5 | |
|=**restoreNodeTimeout** | Задержка перед повторным использованием пула после разрыва соединения. 0 = может быть использован немедленно (в мс) |*integer*| 0|
|=**defaultSelector** | Селектор пулов по умолчанию. Может быть &#39;RR&#39; (round-robin), &#39;RANDOM&#39; или &#39;ORDER&#39; (use in sequence = всегда использовать первые пулы, если не происходит сбой) |*string*| &#39;RR&#39;|
&lt;&lt;/style&gt;&gt;

= API подключения

== connection.query(sql[, values][, callback])` -&gt; `Emitter

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* Строковое значение SQL или объект JSON, заменяющий стандартные параметры соединений.  Если это объект JSON, он должен иметь свойство `` sql``.  Например: `{dateStrings:true, sql:&#39;SELECT NOW()&#39;}`.
 * ``значения``: *массив | объект* Значения заполнителя. Обычно это массив, но в случаях, когда есть только одно значение, его можно указать как есть.
 * `callback`: *function* Функция обратного вызова с аргументами (ошибка, результаты, метаданные).

Возвращает объект Emitter, который может испускать четыре различных типа событий:
  * error : Выдает объект [[#error|Error]], если запрос завершился неудачно.
  * columns : Выдается при получении метаданных колонок из набора результатов (параметр представляет собой массив [[#metadata-field)|полей метаданных]].
  * data : Выдается каждый раз при получении строки (параметр - строка).
  * end : Выдается, когда запрос заканчивается (без параметра).
&lt;&lt;/style&gt;&gt;

Отправляет запрос в базу данных с функцией обратного вызова, которая вызывается после завершения.

В случаях, когда запрос возвращает огромные наборы результатов, это означает, что все данные хранятся в памяти.  Возможно, вам покажется более практичным использовать объект `Emitter` для обработки строк по одной, чтобы избежать перегрузки ресурсов памяти.


Например, выдача запроса с SQL-строкой:

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
connection.query(&#34;SELECT NOW()&#34;, (err, rows, meta) =&gt; {
  if (err) throw err;
  console.log(rows); //[ { { &#39;now()&#39;: 2018-07-02T17:06:38.000Z } ]
});
&lt;&lt;/code&gt;&gt;

Использование объектов JSON:

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
connection.query({dateStrings:true, sql:&#39;SELECT now()&#39;}, (err, rows, meta) =&gt; {
  if (err) throw err;
  console.log(rows); //[ { { &#39;now()&#39;: &#39;2018-07-02 19:06:38&#39; } }
});
&lt;&lt;/code&gt;&gt;

=== Placeholder

Чтобы избежать атак SQL Injection, в запросах разрешается использовать вопросительный знак в качестве заполнителя.  Коннектор экранирует значения в соответствии с их типом.  Вы можете использовать в этих значениях любой собственный тип JavaScript, Buffer, Readable или любой объект с методом `toSqlString`.  Все остальные объекты строятся с помощью метода `JSON.stringify`.

Коннектор автоматически передает потоки объектов, реализующих Readable.  В этих случаях проверьте значения следующих системных переменных сервера, так как они могут мешать:

- [[https://mariadb.com/kb/en/library/server-system-variables/#net_write_timeout|net_read_timeout]]: Сервер должен полностью получить запрос от коннектора, прежде чем произойдет таймаут.  Значение по умолчанию для этой системной переменной - 30 секунд.
- [[https://mariadb.com/kb/en/library/server-system-variables/#max_allowed_packet|max_allowed_packet]]: С помощью этой системной переменной вы можете контролировать максимальный объем данных, который коннектор может отправить на сервер.


&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
// Отправляет INSERT INTO someTable VALUES (1, _BINARY &#39;.\&#39;.st&#39;, &#39;mariadb&#39;)
connection.query(
  &#34;INSERT INTO someTable VALUES (?, ?, ?)&#34;,
  [1, Buffer.from(&#34;c327a97374&#34;, &#34;hex&#34;), &#34;mariadb&#34;],
  (err, result) =&gt; {
    if (err) throw err;
    console.log(result);
    //log : { affectedRows: 1, insertId: 1, warningStatus: 0 }
  }
);
&lt;&lt;/code&gt;&gt;

Вы также можете выполнить тот же запрос, используя Streaming.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const https = require(&#34;https&#34;);
https.get(&#34;https://node.green/#ES2018-features-Promise-prototype-finally-basic-support&#34;,
  readableStream =&gt; {
	connection.query(&#34;INSERT INTO StreamingContent (b) VALUE (?)&#34;, [readableStream], (err, res) =&gt; {
	if (err) throw err;
	//inserted
	});
  }
)
&lt;&lt;/code&gt;&gt;

=== Результаты запроса

Запросы, выполняемые из коннектора, возвращают два различных вида результатов: объект JSON и массив, в зависимости от типа выполняемого запроса.  Запросы, которые записывают данные в базу данных, такие как команды `INSERT`, `DELETE` и `UPDATE`, возвращают объект JSON со следующими свойствами:

* `affectedRows`: Указывает количество строк, затронутых запросом.
* `insertId`: Показывает последнее автоинкрементное значение из `INSERT`.
* `warningStatus`: Указывает, завершился ли запрос предупреждением.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
connection.query(
  &#34;CREATE TABLE animals (&#34; +
    &#34;id MEDIUMINT NOT NULL AUTO_INCREMENT,&#34; +
    &#34;name VARCHAR(30) NOT NULL,&#34; +
    &#34;PRIMARY KEY (id))&#34;,
  err =&gt; {
    connection.query(&#34;INSERT INTO animals(name) value (?)&#34;, [&#34;морские львы&#34;], (err, res) =&gt; {
      if (err) throw err;
      console.log(res);
      //log : { affectedRows: 1, insertId: 1, warningStatus: 0 }
    });
  }
);
&lt;&lt;/code&gt;&gt;

==== Массив набора результатов

Запросы, выполняемые с помощью Коннектора, возвращают два различных вида результатов: объект JSON и массив, в зависимости от типа запроса.  Если запрос возвращает несколько строк, коннектор возвращает массив, представляющий данные для каждой строки в массиве.  Он также возвращает объект `meta`, содержащий метаданные запроса.

Вы можете формировать результаты данных с помощью опций `nestTables` и `rowsAsArray`.  По умолчанию возвращается объект JSON для каждой строки.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
connection.query(&#39;select * from animals&#39;, (err, res, meta) =&gt; {
  console.log(res);
  // [
	  //{id: 1, name: &#39;sea lions&#39; },
	  //{id: 2, name: &#39;bird&#39; },
	  //meta: [ ... ]
  // ]  
});
&lt;&lt;code&gt;&gt;

=== Потоковое вещание

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
connection.query(&#34;SELECT * FROM mysql.user&#34;)
	.on(&#34;error&#34;, err =&gt; {
	console.log(err); //если ошибка
	})
	.on(&#34;fields&#34;, meta =&gt; {
	console.log(meta); // [ ... ].
	})
	.on(&#34;data&#34;, row =&gt; {
	console.log(row);
	})
	.on(&#34;end&#34;, () =&gt; {
	//ended
	});
&lt;&lt;/code&gt;&gt;

== connection.batch(sql, values [, callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* Строковое значение SQL или объект JSON для замены опций соединений по умолчанию.  Объекты JSON должны иметь свойство `` sql``.  Например, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * ``значения``: *array* Массив параметра (массив массива или массив объекта, если используются именованные заполнители).
 * `callback`: *function* Функция обратного вызова с аргументами (ошибка, результаты, метаданные).

 обратный вызов либо возвращает [[#error|Error]] с нулевыми результатами/метаданными, либо с пустой ошибкой и результатами/метаданными
&lt;&lt;/style&gt;&gt;

Реализация зависит от типа и версии сервера.
для сервера MariaDB версии 10.2.7+, реализация использует выделенный протокол bulk.

В других случаях запросы на вставку будут переписаны для оптимизации.
пример:
insert into ab (i) values (?) со значениями первой партии = 1, второй = 2 будет переписано
вставьте в ab (i) значения (1), (2).

Если запрос не может быть переписан, будет выполнен запрос для каждого значения.

Разница в результате по сравнению с выполнением нескольких вставок по одному запросу заключается в том, что возвращается только первый сгенерированный идентификатор вставки.

Например,

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
  connection.query(
	&#34;CREATE TEMPORARY TABLE batchExample(id int, id2 int, id3 int, t varchar(128), id4 int)&#34;
  );
  подключение
	.batch(&#34;INSERT INTO `batchExample` values (1, ?, 2, ?, 3)&#34;, [[1, &#34;john&#34;], [2, &#34;jack&#34;]], (err, res) =&gt; {
	if (err) {
	console.log(&#39;ошибка обработки&#39;);
	} else {
	console.log(res.affectedRows); // 2
	}
	});

&lt;&lt;/code&gt;&gt;

== connection.beginTransaction([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *function* Функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

Начинает новую транзакцию.

== connection.commit([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `callback`: *функция* функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

Завершает текущую транзакцию, если она активна.  Коннектор отслеживает состояние текущей транзакции на сервере.  Когда активной транзакции нет, этот метод не посылает никаких команд на сервер.


== connection.rollback([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *function* Функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

Откатывает текущую транзакцию, если она активна.  Коннектор отслеживает текущее состояние транзакции на сервере.  Если активной транзакции нет, этот метод не посылает никаких команд на сервер.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
conn.beginTransaction(err =&gt; {
  if (err) {
	// обработка ошибки
  } else {
	conn.query(&#34;INSERT INTO testTransaction values (&#39;test&#39;)&#34;, (err) =&gt; {
	if (err) {
	// обработка ошибки
	} else {
	conn.query(&#34;INSERT INTO testTransaction values (&#39;test2&#39;)&#34;, (err) =&gt; {
	if (err) {
	conn.rollback(err =&gt; {
	if (err) {
	// обработка ошибки
	}
	});
	} else {
	conn.commit(err =&gt; {
	if (err) {
	// обработка ошибки
	}
	});
	}
	});
	}
	})
  }
});
&lt;&lt;/code&gt;&gt;

== connection.changeUser(options[, callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``options``: *JSON*, подмножество [[#connection-options| документация по опциям подключения]] = база данных / charset / пароль / пользователь
 * `callback`: *функция* функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

Сброс соединения и повторная аутентификация с заданными учетными данными.  Это эквивалентно созданию нового соединения с новым пользователем, повторно используя существующий открытый сокет.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
conn.changeUser({user: &#39;changeUser&#39;, password: &#39;mypassword&#39;}, err =&gt; {
  if (err) {
	// обработка ошибки
  } else {
	//Пользователь соединения теперь изменен.
  }
});
&lt;&lt;/code&gt;&gt;

== connection.ping([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *function* Функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

Отправляет однобайтовый пакет на сервер, чтобы проверить, что соединение все еще активно.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
conn.ping(err =&gt; {
  if (err) {
	// обработка ошибки
  } else {
	//соединение действительно
  }
})
&lt;&lt;/code&gt;&gt;

== connection.end([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *function* Функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

Закрывает соединение изящно.  То есть коннектор ожидает завершения выполнения текущих запросов, после чего закрывает соединение.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
conn.end(err =&gt; {
  // обработка ошибки
})
&lt;&lt;/code&gt;&gt;

== connection.reset([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *function* Функция обратного вызова с аргументом [[#error|Error]], если произошла ошибка.
&lt;&lt;/style&gt;&gt;

сбросить соединение. Сброс будет:

   * откат любой открытой транзакции
   * сброс уровня изоляции транзакций
   * сброс переменных сессии
   * удалить пользовательские переменные
   * удалить временные таблицы
   * удалить все утверждения PREPARE


== connection.isValid() → boolean

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 Возвращает булево значение
&lt;&lt;/style&gt;&gt;

Указывает состояние соединения, известное Коннектору.  Если возвращается false, значит, с соединением возникли проблемы, например, сокет отключился без ведома Коннектора.


== connection.destroy()

Закрывает соединение, не дожидаясь выполнения текущих запросов.  Эти запросы прерываются.  MariaDB регистрирует это событие как неожиданное закрытие сокета.


== connection.pause()

Приостанавливает считывание данных.

== connection.resume()

Возобновляет чтение данных после паузы.


== connection.serverVersion()

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 Возвращает строку
&lt;&lt;/style&gt;&gt;

Получает версию текущего подключенного сервера.  Выбрасывает ошибку при отсутствии подключения к серверу.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
  console.log(connection.serverVersion()); //10.2.14-MariaDB
&lt;&lt;/code&gt;&gt;

== Ошибка

Когда коннектор сталкивается с ошибкой, Promise возвращает объект [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error|Error]].  В дополнение к стандартным свойствам, этот объект имеет следующие свойства:
* `fatal`: Булево значение, указывающее, остается ли соединение действительным.
* `errno`: Номер ошибки.
* `sqlState`: Код состояния SQL.
* `code`: Код ошибки.

Пример на `console.log(error)`:
&lt;&lt;code&gt;&gt;
{ Error: (conn=116, no: 1146, SQLState: 42S02) Таблица &#39;testn.falsetable&#39; не существует
  sql: INSERT INTO falseTable(t1, t2, t3, t4, t5) values (?, ?, ?, ?, ?, ?) - parameters:[1,0x01ff,&#39;hh&#39;,&#39;01/01/2001 00:00:00.000&#39;,null]
	  	...
	at Socket.Readable.push (_stream_readable.js:134:10)
	at TCP.onread (net.js:559:20)
	От события:
	at C:\mariadb-connector-nodejs\lib\connection.js:185:29
	at Connection.query (C:\mariadb-connector-nodejs\lib\connection.js:183:12)
	at Context.&lt;anonymous&gt; (C:\mariadb-connector-nodejs\test\integration\test-error.js:250:8)
	fatal: false,
	errno: 1146,
	sqlState: &#39;42S02&#39;,
	код: &#39;ER_NO_SUCH_TABLE&#39; } }
&lt;&lt;/code&gt;&gt;

Ошибки содержат стек ошибок, запрос и значения параметров (длина которых по умолчанию ограничена 1024 символами).  Чтобы получить начальную трассировку стека (показанную как `From event...` в примере выше), у вас должна быть включена опция Connection `trace`.

Для получения дополнительной информации о номерах ошибок и обозначениях состояний SQL смотрите документацию [[https://mariadb.com/kb/en/library/mariadb-error-codes/|MariaDB Error Code]].


== события

Объект соединения, который наследуется от Node.js [[https://nodejs.org/api/events.html|EventEmitter]].  Выдает событие ошибки при неожиданном закрытии соединения.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
  const conn = mariadb.createConnection({user: &#39;root&#39;, password: &#39;myPwd&#39;, host: &#39;localhost&#39;, socketTimeout: 100})
  conn.on(&#39;error&#39;, err =&gt; {
	//будет выполнен через 100 мс из-за бездействия, сокет закрылся.
	console.log(err);
	//log :
	//{ Ошибка: (conn=6283, no: 45026, SQLState: 08S01) таймаут сокета
		//		...
		//atSocket.emit (events.js:208:7)
		//atSocket._onTimeout (net.js:410:8)
		//atontimeout (timers.js:498:11)
		//attryOnTimeout (timers.js:323:5)
		//atTimer.listOnTimeout (timers.js:290:5)
	// fatal: true,
	// errno: 45026,
	// sqlState: &#39;08S01&#39;,
	// код: &#39;ER_SOCKET_TIMEOUT&#39; }
  });
&lt;&lt;/code&gt;&gt;

= API пула

При каждом запросе соединения, если пул содержит соединение, которое не используется, пул будет проверять соединение,
обмен пустым пакетом MySQL с сервером, чтобы убедиться в состоянии соединения, а затем отдать соединение.
Пул интенсивно использует соединения, поэтому эта проверка выполняется только в том случае, если соединение не использовалось в течение определенного периода времени
(задается параметром &#34;minDelayValidation&#34; со значением по умолчанию 500 мс).

Если соединение недоступно, запрос на соединение будет помещен в очередь до истечения времени соединения.
Когда соединение становится доступным (новое создание или освобождение в пул), оно будет использоваться для удовлетворения запросов в очереди в порядке FIFO.

Когда соединение передается обратно в пул, все оставшиеся транзакции будут откатаны.

== pool.getConnection(callback)

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `callback`: *function* Функция обратного вызова с аргументами ([[#connection-api)|Error](#error), [Connection]].
&lt;&lt;/style&gt;&gt;

Создает новый объект [[#connection-api|Connection]].
Соединение должно быть передано обратно пулу с помощью метода connection.end().

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user:&#39;myUser&#39; });
pool.getConnection((err, conn =&gt; {
  if (err) {
	console.log(&#34;не удалось подключиться из-за ошибки: &#34; + err);
  } else {
	console.log(&#34;подключено ! идентификатор соединения - &#34; + conn.threadId);
	conn.end(); //передача в пул
  }
}));
&lt;&lt;/code&gt;&gt;

== pool.query(sql[, values][, callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* Строка SQL или объект JSON для замены стандартных опций подключения.  При использовании объекта JSON, объект должен иметь ключ &#34;sql&#34;. Например, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * ``значения``: *массив | объект* Значения заполнителя. Обычно это массив, но в случаях, когда есть только один заполнитель, его можно указать как есть.
 * `callback`: *function* Функция обратного вызова с аргументами (ошибка, результаты, метаданные).
&lt;&lt;/style&gt;&gt;

Это быстрый способ получить соединение из пула, выполнить запрос и освободить соединение.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user:&#39;myUser&#39; });
pool.query(&#34;SELECT NOW()&#34;, (err, rows, metadata) =&gt; {
  if (err) {
	// обработка ошибки
  } else {
	console.log(rows); //[ { { &#39;NOW()&#39;: 2018-07-02T17:06:38.000Z }, meta: [ ... ] ]
  }
});
&lt;&lt;/code&gt;&gt;

== pool.batch(sql, values[, callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `sql`: *string | JSON* Строка SQL или объект JSON для замены стандартных опций подключения.  При использовании объекта JSON, объект должен иметь ключ &#34;sql&#34;. Например, `{ dateStrings: true, sql: &#39;SELECT now()&#39; }`
 * `values`: *массив* массив значений плейсхолдеров. Обычно это массив массивов, но в случаях, когда на одно значение приходится только один плейсхолдер, он может быть задан как один массив.
 * `callback`: *function* Функция обратного вызова с аргументами (ошибка, результаты, метаданные).
&lt;&lt;/style&gt;&gt;

Это быстрый способ получить соединение из пула, выполнить пакет и освободить соединение.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const pool = mariadb.createPool({ host: &#39;mydb.com&#39;, user:&#39;myUser&#39; });
pool.query(
  &#34;CREATE TABLE parse(autoId int not null primary key auto_increment, c1 int, c2 int, c3 int, c4 varchar(128), c5 int)&#34;
);
pool
  .batch(&#34;INSERT INTO `parse`(c1,c2,c3,c4,c5) values (1, ?, 2, ?, 3)&#34;,
	[[1, &#34;john&#34;], [2, &#34;jack&#34;]],
	(err, res) =&gt; {
	if (err) {
	// обработка ошибки
	} else {
	//res = { affectedRows: 2, insertId: 1, warningStatus: 0 }
	assert.equal(res.affectedRows, 2);
	pool.query(&#34;select * from `parse`&#34;, (err, res) =&gt; {
	/*
	res = [
	{ autoId: 1, c1: 1, c2: 1, c3: 2, c4: &#39;john&#39;, c5: 3 },
	{ autoId: 2, c1: 1, c2: 2, c3: 2, c4: &#39;jack&#39;, c5: 3 },
	meta: ...
	}
	*/
	});
	}
  });
&lt;&lt;/code&gt;&gt;

== pool.end([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *функция* Функция обратного вызова с аргументом ([[#error)|Error]]).
&lt;&lt;/style&gt;&gt;

Изящно закрывает пул и базовые соединения.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
pool.end(err =&gt; {
  if (err) {
	// обработка ошибки
	console.log(err);
  } else {
	//соединения были завершены должным образом    
  }
});
&lt;&lt;/code&gt;&gt;

== События в pool&#39;е

&lt;&lt;style class=&#34;newspaper-side table-head-align-top&#34;&gt;&gt;
|=**acquire** | Это событие означает, что соединение было получено из пула.  |
|=**connection** | Это событие возникает, когда в пул добавляется новое соединение. Имеет параметр объекта соединения |
|=**enqueue** | Это событие возникает, когда команда не может быть немедленно удовлетворена пулом и ставится в очередь. |
|=**release** | Это событие возникает, когда соединение возвращается обратно в пул. Имеет параметр объекта соединения|
&lt;&lt;/style&gt;&gt;

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
pool.on(&#39;connection&#39;, (conn) =&gt; console.log(`соединение ${conn.threadId} было создано в пуле`);
&lt;&lt;/code&gt;&gt;



= API кластера пула

Кластер обрабатывает несколько пулов в соответствии с шаблонами и обрабатывает обход отказа / распределенную нагрузку (круговая / случайная / упорядоченная).

== poolCluster.add(id, config)

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * `id`: *строка* идентификатор узла. пример : &#39;master&#39;.
 * `config`: *JSON* [[#pool-options|pool options]] для создания пула.
&lt;&lt;/style&gt;&gt;

Добавьте новый пул в кластер.

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
&lt;&lt;/code&gt;&gt;

== poolCluster.remove(pattern)

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``шаблон&#39;&#39;: *строка* regex-шаблон для выбора пулов. Пример, `&#34;slave*&#34;.
&lt;&lt;/style&gt;&gt;

удалить и завершить пул(ы), сконфигурированные в кластере.


== poolCluster.end([callback])

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``callback``: *функция* Функция обратного вызова с аргументом ([[#error)|Error]]).
&lt;&lt;/style&gt;&gt;

Закрывает кластер пулов и базовые пулы.

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
poolCluster(err =&gt; {
  if (err) {
	// обработка ошибки
	console.log(err);
  } else {
	//pool&#39;ы были завершены должным образом    
  }
});
&lt;&lt;/code&gt;&gt;


== poolCluster.getConnection([pattern, ][selector, ]callback)

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``шаблон&#39;&#39;:  *строка* regex-шаблон для выбора пулов. Пример, `&#34;slave*&#34;`. По умолчанию `&#39;*&#39;`.
 * `селектор`: *строка* селектор пулов. Может быть &#39;RR&#39; (round-robin), &#39;RANDOM&#39; или &#39;ORDER&#39; (использовать по порядку = всегда использовать первые пулы, если нет неудач). по умолчанию - &#39;RR&#39;.  
 * `callback`: *function* Функция обратного вызова с аргументами ([[#connection-api)|Error](#error), [Connection]].
&lt;&lt;/style&gt;&gt;

Создает новый объект [[#connection-api|Connection]].
Соединение должно быть передано обратно пулу с помощью метода connection.end().

**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.getConnection(&#34;slave*&#34;, (err, conn) =&gt; {
  //использовать соединение и обработать возможную ошибку
})
&lt;&lt;/code&gt;&gt;

== события poolCluster

Объект PoolCluster наследуется от объекта Node.js [[https://nodejs.org/api/events.html|EventEmitter]].
Выдает событие &#39;remove&#39;, когда узел удаляется из конфигурации, если определена опция `removeNodeErrorCount`.
(по умолчанию 5) и коннектору не удается подключиться более `removeNodeErrorCount` раз.
(если присутствуют другие узлы, каждая попытка будет ждать значения опции `restoreNodeTimeout`)

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;);
const cluster = mariadb.createPoolCluster({ removeNodeErrorCount: 20, restoreNodeTimeout: 5000 });
cluster.add(&#34;master&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });*
cluster.on(&#39;remove&#39;, node =&gt; {
  console.log(`узел ${node} был удален`);
})
&lt;&lt;/code&gt;&gt;

== poolCluster.of(pattern, selector) → FilteredPoolCluster

&lt;&lt;style class=&#34;bluebox&#34;&gt;&gt;
 * ``шаблон&#39;&#39;:  *строка* regex-шаблон для выбора пулов. Пример, `&#34;slave*&#34;`. По умолчанию `&#39;*&#39;`.
 * `селектор`: *строка* селектор пулов. Может быть &#39;RR&#39; (round-robin), &#39;RANDOM&#39; или &#39;ORDER&#39; (использовать по порядку = всегда использовать первые пулы, если нет неудач). по умолчанию - &#39;RR&#39;.  

 Возвращается
 * разрешается с помощью объекта [[#filteredpoolcluster|filtered pool cluster]],
 * вызывает [[#error|Error]].
&lt;&lt;/style&gt;&gt;

Создает новый объект [[#filteredpoolcluster|filtered pool cluster]], который является подмножеством кластера.


**Пример:**

&lt;&lt;code lang=&#34;javascript&#34;&gt;&gt;
const mariadb = require(&#39;mariadb/callback&#39;)

const cluster = mariadb.createPoolCluster();
cluster.add(&#34;master-north&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;master-south&#34;, { host: &#39;mydb1.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1-north&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave2-north&#34;, { host: &#39;mydb3.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });
cluster.add(&#34;slave1-south&#34;, { host: &#39;mydb2.com&#39;, user: &#39;myUser&#39;, connectionLimit: 5 });

const masterCluster = cluster.of(&#39;master*&#39;);
const northSlaves = cluster.of(/^slave?-north/, &#39;RANDOM&#39;);
northSlaves.getConnection((err, conn) =&gt; {
	//использовать это соединение
});
&lt;&lt;/code&gt;&gt;

=== Кластер фильтрованных pool&#39;ов

* `filteredPoolCluster.getConnection(callback)` : Создает новое соединение из пулов, соответствующих шаблону.
* `filteredPoolCluster.query(sql[, values][, callback])` : это быстрый способ получить соединение из пулов, соответствующих шаблону, выполнить запрос и освободить соединение.</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2025 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.1587e3a666fc.js" charset="utf-8"></script>

</html>