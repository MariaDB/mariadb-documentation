<!DOCTYPE html>
<html>
<head data-cookie-domain=""
      data-cookie-path="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/kb/static/images/favicons/apple-touch-icon.159e713979be.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/kb/static/images/favicons/favicon-32x32.bc0ac1d5d11e.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/kb/static/images/favicons/favicon-16x16.5801f8f0f34e.png">
    <link rel="shortcut icon" href="/kb/static/images/favicons/favicon.d122d305dee4.ico" type="image/x-icon" />

    <title>0 - Packet - Source - MariaDB Knowledge Base</title>

    <link href="/kb/static/css/main.b9e1e104f007.css" rel="stylesheet" type="text/css" />

    
        <meta name="robots" content="noindex, nofollow">
    

    <!-- FB Open Graph tags -->
    <meta property="og:title" content="0 - Packet - Source" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://mariadb.com/kb/ja/0-packet/+source/" />
    <meta property="og:image" content="http://mariadb.comaskmonty-logo.png" />
    <meta property="og:site_name" content="MariaDB KnowledgeBase" />
    <meta property="fb:admins" content="514852603" />
    <meta property="og:description" content="" />

    <meta name="description" content="" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    
</head>
<body class="mpkb nodes autoresize nodes_source jqui" id="nodes_source">





<div id="menu-mobile" class="visible-sm visible-xs">

    <div>
        <div id="mobile-close-menu" class="text-right">
            <a href="javascript:void(0)" title="Close Menu" id="back-main" class="toggle-menu">X<span></span></a>
        </div>
    </div>
    <div class="mainmenu-mobile">
        <ul class="ls-none ul-menu">
            <li data-sub="submenu5"><a class="open-form-search" href="/kb/search/" title="Search">Search </a></li>
            <li data-sub="submenu0"><a href="/products" title="Products">Products</a><span class="arrow-main"></span></li>
            <li data-sub="submenu1"><a href="/services" title="Services">Services</a><span class="arrow-main"></span></li>
            <li data-sub="submenu2"><a href="/resources" title="Resources">Resources</a><span class="arrow-main"></span></li>
            <li data-sub="submenu3"><a href="/about-us" title="About">About</a><span class="arrow-main"></span></li>
            <li data-sub="submenu4"><a href="/contact" title="Contact">Contact</a></li>
        </ul>
    </div>

    <div class="nav-top-mobile">
        <div class="select-box form">

            <ul class="inline-block-md mb-none top-nav">
                <li>

                </li>
                
                    <li>
                        <a href="/kb/user/login?next=/kb/ja/0-packet/+source/"> Login</a>
                    </li>
                
            </ul>



        </div>
        <p class="text-center copyright">Copyright &copy; 2024 MariaDB. All rights reserved.</p>
    </div>
</div>
<div id="wrapper">
<div id="top-nav">
    <div class="container">
        <ul class="hidden-sm hidden-xs" >
            <li><a href="https://mariadb.com/kb/">Knowledge Base</a></li>
            <li><a href="https://mariadb.com/contact/">Contact</a></li>
            
                
                    <li>
                        <a href="/kb/user/login?next=/kb/ja/0-packet/+source/" rel="nofollow">Login</a>
                    </li>
                
            
            
            <li id="search-form">
                <form action="/kb/ja/+search/" method="get" id="search-block-form" accept-charset="UTF-8">
                    <input id="search" title="Enter the terms you wish to search for."
                           placeholder="Search . . ." type="text"
                           name="q" value="" size="15" maxlength="128" class="form-text"
                           data-autocomplete-url="/kb/ja/+search/autocomplete/">
                    <input type="hidden" name="quick" value="1" />
                    <input type="hidden" name="source" value="kb" />
                </form>
            </li>
            <li><a id="search-toggler" href="/kb/search/">Search</a></li>
            
        </ul>
    </div>
</div>
<div id="navbar-bottom" class="navbar">
    <div class="container">
        
        
        
        
        <div class="row">
            <div class="col-md-3 col-sm-9 col-xs-9">
                <a class="brand" href="/" title="MariaDB">
                    <img src="/kb/static/images/logo-2018-black.95f5978ae14d.png">
                </a>
            </div>
            <div class="col-md-9 hidden-sm hidden-xs">
                <div class="main-menu">
                    <ul id="main-menu" class="nav navbar-nav inline-block-sm">
    <li class="has-sub full-menu">
        <a href="/products" title="Products">Products</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/services" title="Services">Services</a>
    </li>
    <li class="has-sub full-menu active">
        <a href="/pricing" title="Pricing">Pricing</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/resources" title="Resources">Resources</a>
    </li>
    <li class="has-sub full-menu">
        <a href="/about-us" title="About Us">About Us</a>
    </li>
    <li class="">
        <a class="button electric-eel small top-bar-right-download" href="/downloads/">Download</a>
    </li>
</ul>
                </div>
            </div>
            <div class="col-md-3 visible-sm visible-xs col-sm-3 col-xs-3 ps-rv">
                <div class="navbar-header text-right pull-right">
                    <button type="button" class="menu-control toggle-menu" id="open-menu">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="main">
    <div class="container">
        

        <div id="subheader1" class="clearfix">
            <div class="pull-left">
                
                <div id="breadcrumbs" class="breadcrumb">
                    <a href="/kb/ja/">Knowledge Base</a>
                    


    
    » <a class="crumb" href="/kb/ja/mariadb/">MariaDB – 日本語</a>
    

    
    » <a class="crumb" href="/kb/ja/client-libraries/">クライアントライブラリ</a>
    

    
    » <a class="crumb" href="/kb/ja/clientserver-protocol/">Client/Server Protocol</a>
    


    » <a class="node_link crumb" href="/kb/ja/0-packet/">0 - Packet</a>


                </div>
                
            </div>
        </div>
    </div>
    <div class="container" id="container-main">
        <div class="row">
            
            
                
                <aside id="sidebar-first" class="sidebar col-md-2 hidden-xs hidden-sm hidden-print">
                    
                        
                        <ul id="category_menu" class="nav nav-pills nav-stacked">
                            <li><a href="/kb/ja/">ホーム</a></li>
                            
                                
                                    <li><a href="/kb/ja/+questions/">Open Questions</a></li>
                                
                                <li><a href="/kb/ja/documentation/">MariaDB Server</a></li>
                                <li><a href="/kb/ja/maxscale/">MariaDB MaxScale</a></li>
                                <li><a href="/kb/ja/mariadb-columnstore/">MariaDB ColumnStore</a></li>
                                <li><a href="/kb/ja/connectors/">Connectors</a></li>
                            

                        </ul>
                    

                    
                        <div>
    

<div class="well well-small box actions"><div>

        <a class="btn btn-block btn-small" href="/kb/ja/0-packet/">Return to article</a>
    
</div>
</div>

</div>
                    

                    

































                </aside>
            
            
            
                
            
            
            <section id="content" class="limited_width col-md-10 clearfix">
                
                    <h1>0 - Packet - Source</h1>
                

                



                <div>
                    

    

    
    <div class="revision_info">
        <dl class="table">
            <dt>Revision</dt>
            <dd><a href="/kb/ja/0-packet/+r/92054/">92054</a></dd>
            <dt>ユーザー</dt>
            <dd>
<span class="user" id="user-6405">
<a href="/kb/user/id/6405" title="Maeda Tomoki">Maeda Tomoki</a>
</span></dd>
            <dt>Date</dt>
            <dd>

<span class="datetime" title="2020-01-13 12:50">2020-01-13 12:50</span></dd>
        </dl>
    </div>
    


    

    
        
        <textarea id="answer_source" class="creole_source autogrow">クライアント-サーバー間のやり取りは下記の形式で行われます。

== 標準的なパケット

標準的なMySQL/MariaDBのパケットは4バイトのヘッダー+パケットbodyから成ります。

&lt;&lt;style style=&#34;padding: 16px;background-color: #f7f7f7;border-radius: 3px;&#34;&gt;&gt;
* [[protocol-data-types/#fixed-length-integers|int&lt;3&gt;]] パケット長
* [[protocol-data-types/#fixed-length-integers|int&lt;1&gt;]] シーケンス番号
* [[protocol-data-types/#fixed-length-bytes|byte&lt;n&gt;]] パケットbody
&lt;&lt;/style&gt;&gt;
 
パケット長とは、パケットbodyの長さのことです。
パケット長は最大で3バイトです。実際のパケット長は3バイトからパケット長 = byte[0] + (byte[1]&lt;&lt;8) + (byte[2]&lt;&lt;16)で計算されます。パケット長の最大値(全て3バイト0xff)は16777215バイト、または 2^24 - 1、惜しくは16MB - 1バイトになります。
 
シーケンス番号は交換番号を意味します。クライエントがクエリを送信するたび、シーケンス番号はまず0にセットされます。そしてクライエントがパケットを分割する必要がある場合、シーケンス番号はインクリメントされます。
より複雑な状況として、クライアントとサーバーが複数パケットを交換するケース(例. 認証用ハンドシェイク)では、シーケンス番号(nr) = 受信したサーバーのパケットの最後のシーケンス番号(seq.nr) + 1にセットします。

例:  [[com_ping|COM_PING]] パケットを COM_PING 本体に１バイト (0x10)だけ送信する場合: 
{{{
01 00 00 00 10
}}}
サーバーは [[ok_packet|OK_Packet]] を返します。その時のシーケンス番号は1です。

=== パケットの分割

前述の通り、パケット長は3バイトで、最大で2^24 - 1バイトもしくは16Mバイト - 1バイトです。
しかし、このプロトコルでは、より大きなデータの送受信が可能です。この場合、クライアントは同じデータに対して多数のパケットを送信します。その際、各パケットのシーケンス番号をインクリメントしていきます。
 
原則として、データを16Mバイトのチャンクで分割します。サーバーが長さ0xffffffのパケットを受信すると、次のパケットの読み取りを続けます。データがちょうど16MBになった時、空のパケットはシーケンスを強制終了する必要があります。
  
\\

例 max_allowed_packet が40Mバイトに設定されており、40Mバイトのパケットbodyを送信する場合:
{{standard_packet}}\\
最初のパケット: 
{{{
ff ff ff 00 ...
}}}

2番目のパケット:
{{{
ff ff ff 01 ...
}}}

3番目のパケット:
{{{
02 00 80 02 ...
}}}

\\

クライアント側は[[server-system-variables#max_allowed_packet|max_allowed_packet]] の設定値を認識している必要があります。サーバー側には、mac_allowed_packetの設定値に対応したサイズで、パケットbodyを保持するためのバッファがあります。仮にクライアント側がmax_allowed_packetの設定値よりも大きなデータを送った場合は、ソケットがクローズされます。 

2^24 - 1バイトのデータは2パケットで送信する必要があることに注意してください。最初のパケットは長さプレフィックス0xffffffで、2番目のパケットは長さ0(0x000000バイト, seqno インクリメント)です。一般的に、データ長は2^24 - 1の倍数であり、空のパケットが付属します。

\\\\

== パケットの圧縮

接続に時間がかかる場合、パケットは圧縮されます。
圧縮は [[1-connecting-connecting#handshake-response-packet|ハンドシェイク・レスポンス・パケット]] の後、クライアント側が[[1-connecting-connecting#capabilities|COMPRESS]]を設定し、サーバー側が圧縮機能を備えている場合に有効になります。

圧縮が有効になると、パケットはヘッダー＋データで7バイトになります。圧縮アルゴリズムにはZLIBが利用されます。ZLIBは幅広く利用されており、多くの言語やランタイムでサポートされています。

&lt;&lt;style style=&#34;padding: 16px;background-color: #f7f7f7;border-radius: 3px;&#34;&gt;&gt;
* [[protocol-data-types/#fixed-length-integers|int&lt;3&gt;]] 圧縮パケット長 
* [[protocol-data-types/#fixed-length-integers|int&lt;1&gt;]] 圧縮シーケンス番号
* [[protocol-data-types/#fixed-length-integers|int&lt;3&gt;]] 非圧縮パケット長
* [[protocol-data-types/#fixed-length-bytes|byte&lt;n&gt;]] 圧縮body
** 圧縮bodyには少なくとも1つ以上の標準パケットが含まれますが、圧縮可能です。: 
*** 1つ以上の標準パケット : 
**** [[protocol-data-types/#fixed-length-integers|int&lt;3&gt;]] パケット長
**** [[protocol-data-types/#fixed-length-integers|int&lt;1&gt;]] シーケンス番号
**** [[protocol-data-types/#fixed-length-bytes|byte&lt;n&gt;]] パケットbody
&lt;&lt;/style&gt;&gt;

圧縮bodyには多くの標準パケットが含まれるため、圧縮シーケンス番号はシーケンス番号とは別にインクリメントされます。

小さなパケットに対しては圧縮は有効ではありません。そのためクライアント側は非圧縮データによる送信を選択することが可能です。\\
非圧縮データを送信するためには、圧縮されたパケット長を実際の長さに設定し、圧縮されていないパケット長を0に設定します。(データは圧縮されていない必要があります。)

例:  COMPRESSが有効な状態で [[com_ping|COM_PING]] パケットの COM_PING 本体を送信する場合。 1バイトのデータのため、圧縮する理由はありません。
{{{
01 00 00 00 00 00 00 01 00 00 00 10
}}}
サーバー側は[[ok_packet|OK_Packet]]を返します。レスポンスには圧縮シーケンス番号1とシーケンス番号1 が付いています。

\\

=== 圧縮パケットの分割
サーバー側はデータを解凍し、送信側と同じパケット(圧縮されていないパケット)を受け取る必要があります。データサイズを分割する必要がある場合、圧縮パケットを分割することが推奨されます。

{{compress_packet}}\\

\\</textarea>
    


                    <div id="content_disclaimer" class="graybox">
                        Content reproduced on this site is the property of its respective owners,
                        and this content is not reviewed in advance by MariaDB. The views, information and opinions
                        expressed by this content do not necessarily represent those of MariaDB or any other party.
                    </div>
                </div>
            </section>

            
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="footer">
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul class="list-inline text-center footer-nav">
                        <li>
                            <h5>
                                <a href="https://mariadb.com/products" title="Products">Products</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/services" title="Services">Services</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/pricing" title="Pricing">Pricing</a>
                            </h5>
                        </li>
                        <li>
                            <h5>
                                <a href="https://mariadb.com/resources" title="Resources">Resources</a>
                            </h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/about-us" title="About MariaDB">About Us</a></h5>
                        </li>
                        <li>
                            <h5><a href="https://mariadb.com/download" title="Download">Download MariaDB</a></h5>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row row-10">
                
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div id="block-footerformcontact" class="block block-block-content block-block-contentd754ee1b-3cc9-40e7-9ef4-f504f1197fb1">
                        
                            <h5 style="font-weight: 400;">Subscribe to our newsletter!</h5>
                            <script src="//app-sj15.marketo.com/js/forms2/js/forms2.min.js"></script><form id="mktoForm_1498"></form>
                            <script>
                                <!--//--><![CDATA[// ><!--
                                MktoForms2.loadForm("//app-sj15.marketo.com", "573-PXI-984", 1498);
                                //--><!]]]]><![CDATA[>
                                //--><!]]>
                            </script>
                        
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-xs-12 item col-md-offset-4">
                    <div class="footer-copyright">
                        <div class="text-center">
                            <ul class="list-inline no-margin">
                                <li>
                                    <a href="/legal" title="Legal">Legal</a>
                                </li>
                                <li>
                                    <a href="/privacy-policy" title="Privacy Policy">Privacy Policy</a>
                                </li>
                                <li>
                                    <a href="/cookie-policy/" title="Cookies">Cookie Policy</a>
                                </li>
                            </ul>
                            <p>Copyright &copy; 2024 MariaDB. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</footer>
</div>

<div id="ajax_loading">
    <img src="/kb/static/images/ajax-loader.a51c5608d01a.gif" />
</div>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MK2847"
                      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MK2847');</script>
    <!-- End Google Tag Manager -->

</body>

<script type="text/javascript" src="/kb/static/js/main.fed4ec768178.js" charset="utf-8"></script>

</html>